

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>posydon_run_pipeline &mdash; posydon v2.0.0-dev documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=d66fa8e6" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=f4b7fd8b"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/posydon_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction-acknowledgements/intro.html">Introduction, Objectives, and Scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction-acknowledgements/collaborative-team.html">Collaborative Team</a></li>
<li class="toctree-l1"><a class="reference external" href="https://posydon.org/papers.html">Publications</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/verification.html">Verification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user-guides/user-roadmap.html">Roadmap to Becoming an Expert POSYDON User</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials and Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/population-synthesis/binary-pop-syn.html">Binary-Star Population Synthesis with POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/generating-datasets/generating-datasets.html">Crafting the Core Datasets for POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/MESA-grids/running-grids.html">Architecting MESA Simulation Grids with POSYDON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">In-Depth Components Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/mesa-grids.html">MESA Grids API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/processing-pipeline.html">Processing Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/machine-learning-components.html">Machine Learning Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/stellar-binary-simulation.html">Stellar &amp; Binary-star Simulation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/posydon.html">posydon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/bin.html">executables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Troubleshooting and FAQs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting-faqs/installation-issues.html">Installation Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting-faqs/code-questions.html">Code Usage Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to POSYDON</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/how-to-contribute.html">How To Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/code-style-guidelines.html">Code Style Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/reporting-issues.html">Reporting issues</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases and Datasets</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON/releases">Releases</a></li>
<li class="toctree-l1"><a class="reference external" href="https://zenodo.org/communities/posydon/">Datasets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contact and Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contact-support/contact-information.html">Contact Information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">posydon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">posydon_run_pipeline</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for posydon_run_pipeline</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">MESA low_res_grids were run. This includes random grids and reruns.</span>

<span class="sd">This is an EXAMPLE of the pipeline for a grid_type=HMS-HMS,</span>
<span class="sd">metallicity=1e-01_Zsun, compression=LITE/ORIGINAL</span>

<span class="sd">STEP 1: grid slices creation</span>
<span class="sd">[&#39;grid_low_res_0&#39;,&#39;grid_low_res_1&#39;,&#39;grid_low_res_2&#39;,&#39;grid_low_res_3&#39;,</span>
<span class="sd">&#39;grid_low_res_4&#39;,&#39;grid_low_res_5&#39;,&#39;grid_random_1&#39;,</span>
<span class="sd">&#39;grid_low_res_rerun_opacity_max&#39;] --&gt; output *.h5</span>

<span class="sd">STEP 2: grid slices concatenation</span>
<span class="sd">[[&#39;grid_low_res_0&#39;,&#39;grid_low_res_1&#39;,&#39;grid_low_res_2&#39;,&#39;grid_low_res_3&#39;,</span>
<span class="sd">&#39;grid_low_res_4&#39;,&#39;grid_low_res_5&#39;],[&#39;grid_low_res_0&#39;,&#39;grid_low_res_1&#39;,</span>
<span class="sd">&#39;grid_low_res_2&#39;,&#39;grid_low_res_3&#39;,&#39;grid_low_res_4&#39;,&#39;grid_low_res_5&#39;,</span>
<span class="sd">&#39;grid_low_res_rerun_opacity_max&#39;]] --&gt;</span>
<span class="sd">grid_low_res_combined.h5, grid_low_res_combined_rerun1.h5</span>

<span class="sd">STEP 2.1: plot grid slices</span>
<span class="sd">[&#39;grid_low_res_combined&#39;,&#39;grid_random_1&#39;,&#39;grid_low_res_combined_rerun1&#39;]</span>
<span class="sd">--&gt; loop over all plot types</span>

<span class="sd">STEP 2.2: check failure rate</span>
<span class="sd">[&#39;grid_low_res_combined&#39;,&#39;grid_random_1&#39;,&#39;grid_low_res_combined_rerun1&#39;]</span>
<span class="sd">--&gt; check failure rate</span>

<span class="sd">STEP 3: calculate extra values</span>
<span class="sd">[&#39;grid_low_res_combined&#39;,&#39;grid_random_1&#39;,&#39;grid_low_res_combined_rerun1&#39;]</span>
<span class="sd">--&gt; do post processing on the ORIGINAL grid and append back on the LITE gird</span>
<span class="sd">the post processed quantities</span>

<span class="sd">STEP 3.1: plot extra values</span>
<span class="sd">[&#39;grid_low_res_combined&#39;,&#39;grid_random_1&#39;,&#39;grid_low_res_combined_rerun1&#39;]</span>
<span class="sd">--&gt; loop over all plot types</span>

<span class="sd">STEP 3.2: check rates of compact object types</span>
<span class="sd">[&#39;grid_low_res_combined&#39;,&#39;grid_random_1&#39;,&#39;grid_low_res_combined_rerun1&#39;]</span>
<span class="sd">--&gt; check rates of compact object types</span>

<span class="sd">STEP 4: train interpolators</span>
<span class="sd">[&#39;grid_low_res_combined_rerun1&#39;] --&gt; train the interpolators</span>

<span class="sd">STEP 4.1: plot interpolator accuracy and confusion matricies</span>
<span class="sd">[&#39;grid_random_1&#39;]</span>
<span class="sd">--&gt; loop over all plot types</span>

<span class="sd">STEP 5: train profile interpolators</span>
<span class="sd">uses gird and initial-final interpolators to train the profile interpolators</span>

<span class="sd">STEP 9: export dataset</span>

<span class="sd">STEP RERUN: rerun grid with a fix</span>
<span class="sd">grid_low_res_combined.rerun(index=logic) --&gt; grid_low_res_rerun_1/grid.csv</span>
<span class="sd">                                         --&gt; grid_random_1_rerun_1/grid.csv</span>
<span class="sd">-- run gird fix and do next post processing</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">__authors__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Simone Bavera &lt;Simone.Bavera@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Matthias Kruckow &lt;Matthias.Kruckow@unige.ch&gt;&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backends.backend_pdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdfPages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.grids.psygrid</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">PSyGrid</span><span class="p">,</span>
                                   <span class="n">join_grids</span><span class="p">,</span>
                                   <span class="n">DEFAULT_HISTORY_DS_EXCLUDE</span><span class="p">,</span>
                                   <span class="n">DEFAULT_PROFILE_DS_EXCLUDE</span><span class="p">,</span>
                                   <span class="n">EXTRA_COLS_DS_EXCLUDE</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.grids.post_processing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">post_process_grid</span><span class="p">,</span>
                                           <span class="n">add_post_processed_quantities</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.grids.MODELS</span><span class="w"> </span><span class="kn">import</span> <span class="n">MODELS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.common_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">PATH_TO_POSYDON</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.gridutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_new_grid_name</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.posydonwarning</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">Pwarn</span><span class="p">,</span><span class="n">print_stats</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.interpolation.IF_interpolation</span><span class="w"> </span><span class="kn">import</span> <span class="n">IFInterpolator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.visualization.plot_defaults</span><span class="w"> </span><span class="kn">import</span> <span class="n">PRE_SET_PLOTS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.visualization.interpolation</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvaluateIFInterpolator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.visualization.combine_TF</span><span class="w"> </span><span class="kn">import</span> <span class="n">TF1_POOL_ERROR</span>


<span class="c1"># pre defined compressions</span>
<span class="n">COMPRESSIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ORIGINAL&#39;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;history_DS_error&#39;</span>    <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;profile_DS_error&#39;</span>    <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;profile_DS_interval&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;history_DS_exclude&#39;</span>  <span class="p">:</span> <span class="n">DEFAULT_HISTORY_DS_EXCLUDE</span><span class="p">,</span>
        <span class="s1">&#39;profile_DS_exclude&#39;</span>  <span class="p">:</span> <span class="n">DEFAULT_PROFILE_DS_EXCLUDE</span>
    <span class="p">},</span>
    <span class="s1">&#39;LITE&#39;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;history_DS_error&#39;</span>    <span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s1">&#39;profile_DS_error&#39;</span>    <span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s1">&#39;profile_DS_interval&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span>
        <span class="s1">&#39;history_DS_exclude&#39;</span>  <span class="p">:</span> <span class="n">EXTRA_COLS_DS_EXCLUDE</span><span class="p">,</span>
        <span class="s1">&#39;profile_DS_exclude&#39;</span>  <span class="p">:</span> <span class="n">EXTRA_COLS_DS_EXCLUDE</span>
    <span class="p">}</span>
<span class="p">}</span>


<div class="viewcode-block" id="create_grid_slice">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.create_grid_slice">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_grid_slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">path_to_csv_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite_psygrid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a new PSyGrid slice.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index in csv file.</span>
<span class="sd">    path_to_csv_file : str</span>
<span class="sd">        Path to csv file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Enable/Disable additional output.</span>
<span class="sd">    overwrite_psygrid : bool</span>
<span class="sd">        Whether existing file(s) should be overwritten.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># read csv file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> not available in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># get values from csv file</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_grid&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">grid_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_grid in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;compression&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">compression</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;compression&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No compression in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;grid_type&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No grid_type in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;stop_before_carbon_depletion&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">stop_before_carbon_depletion</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;stop_before_carbon_depletion&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;HMS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
            <span class="n">stop_before_carbon_depletion</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;stop_before_carbon_depletion set to False for non HMS&#39;</span><span class="o">+</span>\
                  <span class="sa">f</span><span class="s1">&#39; grid: </span><span class="si">{</span><span class="n">grid_type</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stop_before_carbon_depletion</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">grid_output</span> <span class="o">=</span> <span class="n">get_new_grid_name</span><span class="p">(</span><span class="n">grid_path</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span>
                                    <span class="n">create_missing_directories</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># get compression dependent attributes</span>
    <span class="n">pure_compression</span> <span class="o">=</span> <span class="n">compression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pure_compression</span> <span class="ow">in</span> <span class="n">COMPRESSIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">history_DS_error</span> <span class="o">=</span> <span class="n">COMPRESSIONS</span><span class="p">[</span><span class="n">pure_compression</span><span class="p">][</span><span class="s1">&#39;history_DS_error&#39;</span><span class="p">]</span>
        <span class="n">profile_DS_error</span> <span class="o">=</span> <span class="n">COMPRESSIONS</span><span class="p">[</span><span class="n">pure_compression</span><span class="p">][</span><span class="s1">&#39;profile_DS_error&#39;</span><span class="p">]</span>
        <span class="n">profile_DS_interval</span> <span class="o">=</span> <span class="n">COMPRESSIONS</span><span class="p">[</span><span class="n">pure_compression</span><span class="p">][</span><span class="s1">&#39;profile_DS_interval&#39;</span><span class="p">]</span>
        <span class="n">history_DS_exclude</span> <span class="o">=</span> <span class="n">COMPRESSIONS</span><span class="p">[</span><span class="n">pure_compression</span><span class="p">][</span><span class="s1">&#39;history_DS_exclude&#39;</span><span class="p">]</span>
        <span class="n">profile_DS_exclude</span> <span class="o">=</span> <span class="n">COMPRESSIONS</span><span class="p">[</span><span class="n">pure_compression</span><span class="p">][</span><span class="s1">&#39;profile_DS_exclude&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pure_compression = </span><span class="si">{</span><span class="n">pure_compression</span><span class="si">}</span><span class="s1"> not &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;supported! (compression=</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;CO&#39;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;RLO&#39;</span> <span class="ow">in</span> <span class="n">compression</span><span class="p">):</span>
        <span class="n">start_at_RLO</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_at_RLO</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;processing: </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> with compression: </span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_output</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">overwrite_psygrid</span><span class="p">:</span>
                <span class="n">Pwarn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;replacing file: </span><span class="si">{</span><span class="n">grid_output</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;file </span><span class="si">{</span><span class="n">grid_output</span><span class="si">}</span><span class="s1"> already exists!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;saving to file: </span><span class="si">{</span><span class="n">grid_output</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># create the new PSyGrid</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">grid_path</span><span class="p">,</span>
                <span class="n">grid_output</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite_psygrid</span><span class="p">,</span>
                <span class="n">history_DS_error</span><span class="o">=</span><span class="n">history_DS_error</span><span class="p">,</span>
                <span class="n">profile_DS_error</span><span class="o">=</span><span class="n">profile_DS_error</span><span class="p">,</span>
                <span class="n">history_DS_exclude</span><span class="o">=</span><span class="n">history_DS_exclude</span><span class="p">,</span>
                <span class="n">profile_DS_exclude</span><span class="o">=</span><span class="n">profile_DS_exclude</span><span class="p">,</span>
                <span class="n">profile_DS_interval</span><span class="o">=</span><span class="n">profile_DS_interval</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip9&quot;</span><span class="p">,</span>
                <span class="n">start_at_RLO</span><span class="o">=</span><span class="n">start_at_RLO</span><span class="p">,</span>
                <span class="n">stop_before_carbon_depletion</span><span class="o">=</span><span class="n">stop_before_carbon_depletion</span><span class="p">,</span>
                <span class="n">initial_RLO_fix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="combine_grid_slices">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.combine_grid_slices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">combine_grid_slices</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">path_to_csv_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combining grid slices to one grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index in csv file.</span>
<span class="sd">    path_to_csv_file : str</span>
<span class="sd">        Path to csv file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Enable/Disable additional output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># read csv file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not enought keys in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">: &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&gt;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># get values from csv file</span>
    <span class="n">grid_combined_key</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">gird_names</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">grid_combined_key</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Combinining: </span><span class="si">{</span><span class="n">gird_names</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;into: </span><span class="si">{</span><span class="n">grid_combined_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">join_grids</span><span class="p">(</span><span class="n">gird_names</span><span class="p">,</span> <span class="n">grid_combined_key</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>



<div class="viewcode-block" id="calculate_extra_values">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.calculate_extra_values">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_extra_values</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">path_to_csv_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculating extra values, e.g. values derived from the final profile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index in csv file.</span>
<span class="sd">    path_to_csv_file : str</span>
<span class="sd">        Path to csv file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Enable/Disable additional output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># read csv file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> not available in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># get values from csv file</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_grid&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_grid in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;grid_type&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No grid_type in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_processed_grid&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">processed_grid_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_processed_grid&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_processed_grid in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_grid_ORIGINAL&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_ORIGINAL_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_grid_ORIGINAL&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_ORIGINAL_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grid_ORIGINAL_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_grid_ORIGINAL in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Compute processed quantities for </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;CO&#39;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
        <span class="n">star_2_CO</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">star_2_CO</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="c1"># load grid with ORIGINAL compression and get extra colums</span>
    <span class="n">grid_ORIGINAL</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">(</span><span class="n">grid_ORIGINAL_path</span><span class="p">)</span>
    <span class="n">MESA_dirs_EXTRA_COLUMNS</span><span class="p">,</span> <span class="n">EXTRA_COLUMNS</span> <span class="o">=</span> <span class="n">post_process_grid</span><span class="p">(</span><span class="n">grid_ORIGINAL</span><span class="p">,</span>
                                              <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">star_2_CO</span><span class="o">=</span><span class="n">star_2_CO</span><span class="p">,</span>
                                              <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    
    <span class="c1"># post processed quantities are appended to the grid object, hence</span>
    <span class="c1"># we create a copy of it and append back to it</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">processed_grid_path</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Post processed grid file already exists, removing it.&#39;</span><span class="p">,</span>
              <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">processed_grid_path</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">,</span> <span class="n">processed_grid_path</span><span class="p">)</span>
    
    <span class="c1"># load processed grid and append values</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">(</span><span class="n">processed_grid_path</span><span class="p">)</span>
    <span class="n">add_post_processed_quantities</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">MESA_dirs_EXTRA_COLUMNS</span><span class="p">,</span>
                                  <span class="n">EXTRA_COLUMNS</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Added processed quantities to grid: </span><span class="si">{</span><span class="n">processed_grid_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="train_interpolators">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.train_interpolators">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">train_interpolators</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">path_to_csv_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train an interpolator on a grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index in csv file.</span>
<span class="sd">    path_to_csv_file : str</span>
<span class="sd">        Path to csv file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Enable/Disable additional output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># read csv file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> not available in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># get values from csv file</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_grid&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_grid in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;grid_type&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No grid_type in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;interpolation_method&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">interpolation_method</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;interpolation_method&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No interpolation_method in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_interpolator&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">interpolator_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_interpolator&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_interpolator in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">method</span> <span class="o">=</span> <span class="n">interpolation_method</span>
    <span class="k">if</span> <span class="s1">&#39;_RLO&#39;</span> <span class="ow">in</span> <span class="n">method</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_RLO&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train interpolators on </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> with method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># check interpolation_objects directory exists</span>
    <span class="n">interp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">interpolator_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">interp_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">interp_path</span><span class="p">)</span>
    
    <span class="c1"># load grid</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">grid_path</span><span class="p">)</span>
    
    <span class="n">interp_method</span> <span class="o">=</span> <span class="p">[</span><span class="n">method</span><span class="p">,</span> <span class="n">method</span><span class="p">]</span>
    <span class="n">interp_classes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stable_MT&quot;</span><span class="p">,</span> <span class="s2">&quot;unstable_MT&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;_RLO&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interpolation_method</span><span class="p">:</span>
        <span class="n">interp_method</span> <span class="o">+=</span> <span class="p">[</span><span class="n">method</span><span class="p">]</span>
        <span class="n">interp_classes</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;no_MT&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;CO&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
        <span class="n">interp_method</span> <span class="o">+=</span> <span class="p">[</span><span class="n">method</span><span class="p">]</span>
        <span class="n">interp_classes</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;stable_reverse_MT&quot;</span><span class="p">]</span>
    
    <span class="c1"># all magnitues that are not model numbers, supernova properites or strings</span>
    <span class="c1"># are interpolated with respect to interpolation_class</span>
    <span class="n">out_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="p">(</span>
                                   <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;model_number&quot;</span> <span class="ow">and</span>
                                   <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">)</span>
                                   <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                                   <span class="ow">and</span> <span class="s2">&quot;MODEL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">)]</span>
    

    <span class="n">out_nan_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="p">(</span>
                             <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;model_number&quot;</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                            <span class="ow">and</span> <span class="s2">&quot;MODEL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">)]</span>
    
    <span class="c1"># define all string keys in final values</span>
    <span class="n">c_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;interpolation_class&#39;</span><span class="p">,</span> <span class="s1">&#39;S1_state&#39;</span><span class="p">,</span> <span class="s1">&#39;S2_state&#39;</span><span class="p">,</span> <span class="s1">&#39;mt_history&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">MODEL_NAME</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">c_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s1">_SN_type&#39;</span><span class="p">)</span>
            <span class="n">c_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s1">_CO_type&#39;</span><span class="p">)</span>
    
    <span class="c1"># specify the interpolation methods</span>
    <span class="n">interpolators</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;interp_method&quot;</span><span class="p">:</span> <span class="n">interp_method</span><span class="p">,</span>
            <span class="s2">&quot;interp_classes&quot;</span><span class="p">:</span> <span class="n">interp_classes</span><span class="p">,</span>
            <span class="s2">&quot;out_keys&quot;</span><span class="p">:</span> <span class="n">out_keys</span><span class="p">,</span>
            <span class="s2">&quot;out_nan_keys&quot;</span><span class="p">:</span> <span class="n">out_nan_keys</span><span class="p">,</span>
            <span class="s2">&quot;class_method&quot;</span><span class="p">:</span> <span class="s2">&quot;kNN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;c_keys&quot;</span><span class="p">:</span> <span class="n">c_keys</span><span class="p">,</span>
            <span class="s2">&quot;c_key&quot;</span><span class="p">:</span> <span class="s2">&quot;interpolation_class&quot;</span>
        <span class="p">},</span>
    <span class="p">]</span>
    
    <span class="c1"># core collapse quantities are interpolated with respect to the</span>
    <span class="c1"># compact object type</span>
    <span class="c1"># TODO: we need to train core collapse for secondary star as well</span>
    <span class="c1"># to catch reverse mass transfer cases where the secondary undergoes</span>
    <span class="c1"># core collapse first</span>
    <span class="k">for</span> <span class="n">MODEL_NAME</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span> <span class="c1">#TODO: range(1,3):</span>
            <span class="n">out_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="p">(</span>
                                   <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;model_number&quot;</span> <span class="ow">and</span>
                                   <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">)</span>
                                   <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                                   <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">)]</span>
            
            <span class="n">out_nan_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="p">(</span>
                                <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;model_number&quot;</span> 
                                <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                                <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">)]</span>
            
            <span class="c1"># get interpolations classes dynamically</span>
            <span class="n">interp_method</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">interp_classes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">CO_interpolation_class</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;BH&quot;</span><span class="p">,</span> <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;WD&quot;</span><span class="p">,</span> <span class="s2">&quot;BH_reverse_MT&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">CO_interpolation_class</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s1">_CO_interpolation_class&#39;</span><span class="p">]:</span>
                    <span class="n">interp_method</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
                    <span class="n">interp_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CO_interpolation_class</span><span class="p">)</span>

            <span class="n">interpolators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;interp_method&quot;</span><span class="p">:</span> <span class="n">interp_method</span><span class="p">,</span>
                    <span class="s2">&quot;interp_classes&quot;</span><span class="p">:</span> <span class="n">interp_classes</span><span class="p">,</span>
                    <span class="s2">&quot;out_keys&quot;</span><span class="p">:</span> <span class="n">out_keys</span><span class="p">,</span>
                    <span class="s2">&quot;out_nan_keys&quot;</span><span class="p">:</span> <span class="n">out_nan_keys</span><span class="p">,</span>
                    <span class="s2">&quot;class_method&quot;</span><span class="p">:</span> <span class="s2">&quot;kNN&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;c_keys&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s1">_CO_interpolation_class&#39;</span><span class="p">,</span> 
                               <span class="sa">f</span><span class="s1">&#39;S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s1">_CO_type&#39;</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s1">_SN_type&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;c_key&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s1">_CO_interpolation_class&#39;</span>
                <span class="p">},</span>   
            <span class="p">)</span>
    
    <span class="c1"># initialize initial to final interpolator</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">IFInterpolator</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">interpolators</span><span class="o">=</span><span class="n">interpolators</span><span class="p">)</span>

    <span class="c1"># training and saving</span>
    <span class="n">interp</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">interp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">interpolator_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="train_profile_interpolators">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.train_profile_interpolators">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">train_profile_interpolators</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">path_to_csv_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train a profile interpolator on a grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index in csv file.</span>
<span class="sd">    path_to_csv_file : str</span>
<span class="sd">        Path to csv file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Enable/Disable additional output.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load module only if needed</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">posydon.interpolation.profile_interpolation</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompileData</span><span class="p">,</span> <span class="n">ProfileInterpolator</span>

    <span class="c1"># read csv file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> not available in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># get values from csv file</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_grid&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_grid in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;grid_type&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No grid_type in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;profile_names&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">profile_names</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;profile_names&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">profile_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;profile_names is not a list in line </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No profile_names in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_IF_interpolator&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">IF_interpolator_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_IF_interpolator&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">IF_interpolator_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">IF_interpolator_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_IF_interpolator in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_profile_interpolator&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">profile_interpolator_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_profile_interpolator&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_profile_interpolator in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train profile interpolators on </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> with the &#39;</span>
              <span class="sa">f</span><span class="s1">&#39;initial-final interpolator </span><span class="si">{</span><span class="n">IF_interpolator_path</span><span class="si">}</span><span class="s1"> to get &#39;</span>
              <span class="sa">f</span><span class="s1">&#39;profiles of </span><span class="si">{</span><span class="n">profile_names</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># check interpolation_objects directory exists</span>
    <span class="n">interp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">profile_interpolator_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">interp_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">interp_path</span><span class="p">)</span>

    <span class="n">train_second_star</span> <span class="o">=</span> <span class="s1">&#39;CO&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_type</span>
    <span class="c1"># load grid profiles</span>
    <span class="n">grid_profiles</span> <span class="o">=</span> <span class="n">CompileData</span><span class="p">(</span><span class="n">grid_path</span><span class="p">,</span> <span class="n">grid_path</span><span class="p">,</span>
                                <span class="n">hms_s2</span><span class="o">=</span><span class="n">train_second_star</span><span class="p">,</span>
                                <span class="n">profile_names</span><span class="o">=</span><span class="n">profile_names</span><span class="p">)</span>
    <span class="c1"># save the profiles in a temporary pickle</span>
    <span class="n">tmp_profile_interpolator_path</span> <span class="o">=</span> <span class="n">profile_interpolator_path</span><span class="o">+</span><span class="s2">&quot;.tmp&quot;</span>
    <span class="n">grid_profiles</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_profile_interpolator_path</span><span class="p">)</span>

    <span class="c1"># create interpolator</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">ProfileInterpolator</span><span class="p">()</span>
    <span class="c1"># load profile pickle</span>
    <span class="n">interp</span><span class="o">.</span><span class="n">load_profiles</span><span class="p">(</span><span class="n">tmp_profile_interpolator_path</span><span class="p">)</span>
    <span class="c1"># training</span>
    <span class="n">interp</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">IF_interpolator_path</span><span class="p">)</span>
    <span class="c1"># saving</span>
    <span class="n">interp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">profile_interpolator_path</span><span class="p">)</span></div>

    
    <span class="c1"># TODO: consider to remove the temporary pickle with the grid profiles</span>
    <span class="c1"># os.remove(tmp_profile_interpolator_path)</span>


<div class="viewcode-block" id="export_dataset">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.export_dataset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">export_dataset</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">path_to_csv_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Moving the data set to a place containing all, what is needed to run a</span>
<span class="sd">    population synthesis with POSYDON.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index in csv file.</span>
<span class="sd">    path_to_csv_file : str</span>
<span class="sd">        Path to csv file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Enable/Disable additional output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># read csv file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> not available in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># get values from csv file</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_grid&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_grid in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;export_path&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">export_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;export_path&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No export_path in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">export_path</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Replace </span><span class="si">{</span><span class="n">export_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;copying </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">export_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># copy the file</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">,</span> <span class="n">export_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="zams_file_name">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.zams_file_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">zams_file_name</span><span class="p">(</span><span class="n">metallicity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gives the name of the ZAMS file depending on the metallicity.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    metallicity : str</span>
<span class="sd">        String representation of the metallicity (e.g. 1e+00_Zsun).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Name of ZAMS file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="s1">&#39;2e+00_Zsun&#39;</span> <span class="ow">in</span> <span class="n">metallicity</span><span class="p">:</span>
        <span class="n">zams_filename</span> <span class="o">=</span> <span class="s1">&#39;zams_z2.84m2_y0.2915.data&#39;</span>
    <span class="k">elif</span> <span class="p">((</span><span class="s1">&#39;1e+00_Zsun&#39;</span> <span class="ow">in</span> <span class="n">metallicity</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">metallicity</span><span class="p">))):</span>
        <span class="c1"># in v1 there is no metallicity, hence an empty string</span>
        <span class="n">zams_filename</span> <span class="o">=</span> <span class="s1">&#39;zams_z1.42m2_y0.2703.data&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;4.5e-01_Zsun&#39;</span> <span class="ow">in</span> <span class="n">metallicity</span><span class="p">:</span>
        <span class="n">zams_filename</span> <span class="o">=</span> <span class="s1">&#39;zams_z6.39m3_y0.2586.data&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;2e-01_Zsun&#39;</span> <span class="ow">in</span> <span class="n">metallicity</span><span class="p">:</span>
        <span class="n">zams_filename</span> <span class="o">=</span> <span class="s1">&#39;zams_z2.84m3_y0.2533.data&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;1e-01_Zsun&#39;</span> <span class="ow">in</span> <span class="n">metallicity</span><span class="p">:</span>
        <span class="n">zams_filename</span> <span class="o">=</span> <span class="s1">&#39;zams_z1.42m3_y0.2511.data&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;1e-02_Zsun&#39;</span> <span class="ow">in</span> <span class="n">metallicity</span><span class="p">:</span>
        <span class="n">zams_filename</span> <span class="o">=</span> <span class="s1">&#39;zams_z1.42m4_y0.2492.data&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;1e-03_Zsun&#39;</span> <span class="ow">in</span> <span class="n">metallicity</span><span class="p">:</span>
        <span class="n">zams_filename</span> <span class="o">=</span> <span class="s1">&#39;zams_z1.42m5_y0.2490.data&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;1e-04_Zsun&#39;</span> <span class="ow">in</span> <span class="n">metallicity</span><span class="p">:</span>
        <span class="n">zams_filename</span> <span class="o">=</span> <span class="s1">&#39;zams_z1.42m6_y0.2490.data&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Metallicity unknown: </span><span class="si">{</span><span class="n">metallicity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">zams_filename</span></div>



<div class="viewcode-block" id="copy_ini_file">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.copy_ini_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">copy_ini_file</span><span class="p">(</span><span class="n">grid_type</span><span class="p">,</span> <span class="n">rerun_metallicity</span><span class="p">,</span> <span class="n">rerun_type</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span>
    <span class="n">cluster</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copies the ini file and make replacements according to the rerun.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid_type : str</span>
<span class="sd">        Type of the grid.</span>
<span class="sd">    rerun_metallicity : str</span>
<span class="sd">        String representation of the metallicity (e.g. 1e+00_Zsun).</span>
<span class="sd">    rerun_type : str</span>
<span class="sd">        Type of rerun (e.g. PISN).</span>
<span class="sd">    destination : str</span>
<span class="sd">        Path to the directory for the new runs.</span>
<span class="sd">    cluster : str</span>
<span class="sd">        Cluster name (e.g. yggdrasil or quest).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check that the &#39;destination&#39; exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>
    <span class="c1"># copy the default ini file to directory</span>
    <span class="k">if</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;quest&#39;</span><span class="p">,</span><span class="s1">&#39;yggdrasil&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">PATH_TO_POSYDON</span><span class="p">):</span>
            <span class="n">ini_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_POSYDON</span><span class="p">,</span>
                <span class="s1">&#39;grid_params/POSYDON-MESA-INLISTS/r11701/running_scripts&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">PATH_TO_POSYDON</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ini_dir_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PATH_TO_POSYDON=</span><span class="si">{</span><span class="n">PATH_TO_POSYDON</span><span class="si">}</span><span class="s1"> not &#39;</span>
                                     <span class="s1">&#39;found!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;single_HMS&quot;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
            <span class="n">ini_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ini_dir_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;single_HMS_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
            <span class="n">ini_file_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;single_HMS_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;single_HeMS&quot;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
            <span class="n">ini_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ini_dir_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;single_HeMS_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
            <span class="n">ini_file_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;single_HeMS_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;HMS-HMS&quot;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
            <span class="n">ini_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ini_dir_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;HMS-HMS_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
            <span class="n">ini_file_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;HMS-HMS_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;CO-HMS&quot;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
            <span class="n">ini_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ini_dir_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;CO-HMS_RLO_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
            <span class="n">ini_file_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;CO-HMS_RLO_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;CO-HeMS&quot;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
            <span class="n">ini_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ini_dir_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;CO-HeMS_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
            <span class="n">ini_file_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;CO-HeMS_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">.ini&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported grid type: </span><span class="si">{</span><span class="n">grid_type</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ini_file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ini_file_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ini_file_path</span><span class="p">,</span> <span class="n">ini_file_dest</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

    <span class="c1"># substitue the inlist sceario with the one for the rerun</span>
    <span class="k">if</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;PISN&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;matthias_PISN-d68228338b91fd487ef5d55c9b6ebb8cc5f0e668&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;reverse_MT&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;zepei_fix_implicit-afa1860ddf9894aa1d82742ee2a73e8e92acd4a9&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;opacity_max&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;matthias_PISN-d68228338b91fd487ef5d55c9b6ebb8cc5f0e668&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;opacity_max_hms-hms&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;zepei_fix_implicit-afa1860ddf9894aa1d82742ee2a73e8e92acd4a9&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;TPAGBwind&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;development-22c1bb9e730343558c3e70984a99b3fc1f3c346e&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;thermohaline_mixing&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;development-22c1bb9e730343558c3e70984a99b3fc1f3c346e&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;HeMB_MLTp_mesh&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;development-435d16c9158e4608530f21b8169ce6f31160e23e&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;more_mesh&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;development-435d16c9158e4608530f21b8169ce6f31160e23e&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;conv_bdy_weight&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;development-435d16c9158e4608530f21b8169ce6f31160e23e&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;initial_He&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;fix_iniHe_pre_rerun5-0e736a853c3c2e522b76299a54aea8f5eea15d08&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s2">&quot;dedt_energy_eqn&quot;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;seth_dedt_energy_eqn-f1803afe400ed16a4fad47b0bad6abbf0965cae1&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s2">&quot;dedt_hepulse&quot;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;seth_dedt_hepulse-0274be9895480cae3aa2a4d14b056a2447d5921b&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;LBV_wind&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;matthias_LBV_wind-051343856f50dc5518abdf28904d62df4caacaff&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;LBV_wind+thermohaline_mixing&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;matthias_LBV_wind-051343856f50dc5518abdf28904d62df4caacaff&quot;</span>
<span class="c1">#    elif rerun_type == &#39;LBV_wind+HeMB_MLTp_mesh&#39;:</span>
<span class="c1">#        raise ValueError(f&#39;Not yet supported rerun type {rerun_type}!&#39;)</span>
<span class="c1">#        replace_text = &quot;matthias_LBV_wind-051343856f50dc5518abdf28904d62df4caacaff&quot; #TODO: update to new MESA-INLIST branch/commit</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;LBV_wind+dedt_energy_eqn&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;seth_lbv_thermo_dedt-936f76f82d44b16139ff89e41e5b0f2232fd9b30&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;LBV_wind+dedt_hepulse&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;seth_lbv_thermo_dedt_hepulse-2737b3bce69066751477c802a6e515183e13d303&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;no_age_limit&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;matthias_no_age_limit-a119ea9548cca9b6b7ddfe31309ced1ae40c271e&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;no_age_limit+thermohaline_mixing&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;matthias_no_age_limit-a119ea9548cca9b6b7ddfe31309ced1ae40c271e&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;no_age_limit+dedt_energy_eqn&#39;</span><span class="p">:</span>
        <span class="n">replace_text</span> <span class="o">=</span> <span class="s2">&quot;matthias_lbv_thermo_dedt_noAgeLimit-dcc42e1d6d89fc267826970643e7f4f1bf463171&quot;</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;other&#39;</span><span class="p">:</span> <span class="c1"># e.g. &#39;envelope_mass_limit&#39;, &#39;fe_core_infall_limit&#39;</span>
        <span class="c1"># this rerun uses the default inlist commit</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported rerun type </span><span class="si">{</span><span class="n">rerun_type</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
    
    <span class="c1"># make replacements in ini file</span>
    <span class="n">search_text1</span> <span class="o">=</span> <span class="s2">&quot;main-18710e943edd926a5653c4cdb7d6e18e5bdb35a2&quot;</span>
    <span class="n">search_text2</span> <span class="o">=</span> <span class="s2">&quot;main-a060b7bf1a4d94d693f77be9a1b0b3a522c1eadf&quot;</span>
    <span class="n">search_text3</span> <span class="o">=</span> <span class="s1">&#39;zams_z1.42m3_y0.2511.data&#39;</span>
    <span class="n">replace_zams_filename</span> <span class="o">=</span> <span class="n">zams_file_name</span><span class="p">(</span><span class="n">rerun_metallicity</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ini_file_dest</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">search_text1</span><span class="p">,</span> <span class="n">replace_text</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">search_text2</span><span class="p">,</span> <span class="n">replace_text</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">search_text3</span><span class="p">,</span> <span class="n">replace_zams_filename</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;grid_test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;grid.csv&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ini_file_dest</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>



<div class="viewcode-block" id="logic_rerun">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.logic_rerun">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">logic_rerun</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">rerun_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the runs, which need a rerun.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : PSyGrid</span>
<span class="sd">        PSyGrid to select runs from.</span>
<span class="sd">    rerun_type : str</span>
<span class="sd">        Type of rerun (e.g. PISN).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    runs_to_rerun : list</span>
<span class="sd">        Indecies of runs to be rerun.</span>
<span class="sd">    termination_flags : list</span>
<span class="sd">        Termination flags to select reruns by.</span>
<span class="sd">    new_mesa_flag : dict</span>
<span class="sd">        Name and value of MESA inlist parameters to change to for this rerun.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">PSyGrid</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;grid must be a PSyGrid, but it is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="n">runs_to_rerun</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">termination_flags</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">new_mesa_flag</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># handle different rerun types</span>
    <span class="k">if</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;opacity_max&#39;</span> <span class="ow">or</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;opacity_max_hms-hms&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: consider using TF1_POOL_ERROR</span>
        <span class="n">termination_flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reach cluster timelimit&#39;</span><span class="p">,</span> <span class="s1">&#39;min_timestep_limit&#39;</span><span class="p">]</span>
        <span class="n">new_mesa_flag</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;opacity_max&#39;</span> <span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;PISN&#39;</span><span class="p">:</span>
        <span class="n">N_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_runs</span><span class="p">):</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">MESA_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                <span class="c1"># TODO: handle the case when grids were moved location</span>
                <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="s1">&#39;Grid directory not found at &#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;single_HMS&quot;</span> <span class="ow">in</span> <span class="n">dirname</span><span class="p">:</span>
                <span class="n">out_txt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span>
                                            <span class="s2">&quot;out_star1_formation_step0.txt&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;single_HeMS&quot;</span> <span class="ow">in</span> <span class="n">dirname</span><span class="p">:</span>
                <span class="n">out_txt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span>
                                            <span class="s2">&quot;out_star1_formation_step2.txt&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_txt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;out.txt&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">out_txt_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_txt_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_txt_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_file</span><span class="p">:</span>
                    <span class="n">log_lines</span> <span class="o">=</span> <span class="n">log_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">log_lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;have reached gamma1 integral limit&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">runs_to_rerun</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">runs_to_rerun</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;reverse_MT&#39;</span><span class="p">:</span>
        <span class="n">N_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_runs</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">binary_history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="n">rl1</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">binary_history</span><span class="p">[</span><span class="s1">&#39;rl_relative_overflow_1&#39;</span><span class="p">]</span>
                <span class="n">rl2</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">binary_history</span><span class="p">[</span><span class="s1">&#39;rl_relative_overflow_2&#39;</span><span class="p">]</span>
                <span class="n">w_wcrit</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;surf_avg_omega_div_omega_crit&#39;</span><span class="p">]</span>
                <span class="n">reverse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rl1</span><span class="o">&lt;-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">rl2</span><span class="o">&gt;-</span><span class="mf">0.05</span><span class="p">)</span>
                <span class="n">transfer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">w_wcrit</span><span class="o">&gt;</span><span class="mf">0.9</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">transfer</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">runs_to_rerun</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">runs_to_rerun</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;TPAGBwind&#39;</span><span class="p">:</span>
        <span class="n">N_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hot_wind_full_on_T</span> <span class="o">=</span> <span class="mf">1.2e4</span> <span class="c1"># inlist value</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_runs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s1_Teff</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;log_Teff&#39;</span><span class="p">]</span>
                <span class="n">s1_Yc</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;center_he4&#39;</span><span class="p">]</span>
                <span class="n">s1_he_shell_mass</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;he_core_mass&#39;</span><span class="p">]</span> <span class="o">-</span>\
                                   <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;co_core_mass&#39;</span><span class="p">]</span>
                <span class="n">tpagb_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s1_Teff</span> <span class="o">&lt;=</span> <span class="n">hot_wind_full_on_T</span><span class="p">,</span>\
                                         <span class="n">s1_Yc</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">)</span>
                <span class="n">tpagb_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">tpagb_1</span><span class="p">,</span> <span class="n">s1_he_shell_mass</span> <span class="o">&lt;=</span> <span class="mf">1e-1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tpagb_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s2_Teff</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;log_Teff&#39;</span><span class="p">]</span>
                <span class="n">s2_Yc</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;center_he4&#39;</span><span class="p">]</span>
                <span class="n">s2_he_shell_mass</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;he_core_mass&#39;</span><span class="p">]</span> <span class="o">-</span>\
                                   <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;co_core_mass&#39;</span><span class="p">]</span>
                <span class="n">tpagb_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s2_Teff</span> <span class="o">&lt;=</span> <span class="n">hot_wind_full_on_T</span><span class="p">,</span>\
                                         <span class="n">s2_Yc</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">)</span>
                <span class="n">tpagb_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">tpagb_2</span><span class="p">,</span> <span class="n">s2_he_shell_mass</span> <span class="o">&lt;=</span> <span class="mf">1e-1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tpagb_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">tpagb_1</span><span class="p">,</span> <span class="n">tpagb_2</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">runs_to_rerun</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">runs_to_rerun</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;thermohaline_mixing&#39;</span><span class="p">)</span> <span class="ow">or</span>
          <span class="p">(</span><span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;LBV_wind+thermohaline_mixing&#39;</span><span class="p">)</span> <span class="ow">or</span>
          <span class="p">(</span><span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;no_age_limit+thermohaline_mixing&#39;</span><span class="p">)):</span>
        <span class="n">termination_flags</span> <span class="o">=</span> <span class="n">TF1_POOL_ERROR</span>
        <span class="n">new_mesa_flag</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;thermohaline_coeff&#39;</span> <span class="p">:</span> <span class="mf">17.5</span><span class="p">}</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;HeMB_MLTp_mesh&#39;</span><span class="p">)</span>
<span class="c1">#          or (rerun_type == &#39;LBV_wind+HeMB_MLTp_mesh&#39;)</span>
         <span class="p">):</span>
        <span class="n">termination_flags</span> <span class="o">=</span> <span class="n">TF1_POOL_ERROR</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;more_mesh&#39;</span><span class="p">:</span>
        <span class="n">termination_flags</span> <span class="o">=</span> <span class="n">TF1_POOL_ERROR</span>
        <span class="c1"># may put this in a MESA-inlist PR</span>
        <span class="n">new_mesa_flag</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mesh_Pgas_div_P_exponent&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>\
                         <span class="s1">&#39;max_allowed_nz&#39;</span> <span class="p">:</span> <span class="mi">50000</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;conv_bdy_weight&#39;</span><span class="p">:</span>
        <span class="n">N_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_runs</span><span class="p">):</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">MESA_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                <span class="c1"># TODO: handle the case when grids were moved location</span>
                <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="s1">&#39;Grid directory not found at &#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;single_HMS&quot;</span> <span class="ow">in</span> <span class="n">dirname</span><span class="p">:</span>
                <span class="n">out_txt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span>
                                            <span class="s2">&quot;out_star1_formation_step0.txt&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;single_HeMS&quot;</span> <span class="ow">in</span> <span class="n">dirname</span><span class="p">:</span>
                <span class="n">out_txt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span>
                                            <span class="s2">&quot;out_star1_formation_step2.txt&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_txt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;out.txt&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">out_txt_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_txt_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_txt_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_file</span><span class="p">:</span>
                    <span class="n">log_lines</span> <span class="o">=</span> <span class="n">log_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">log_lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">((</span><span class="s2">&quot;STOP prepare_for_new_try: bad num omega&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="s2">&quot;Segmentation fault&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)):</span>
                        <span class="n">runs_to_rerun</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">runs_to_rerun</span><span class="p">)</span>
        <span class="n">new_mesa_flag</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;convective_bdy_weight&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;initial_He&#39;</span><span class="p">:</span>
        <span class="n">N_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_runs</span><span class="p">):</span>
            <span class="n">iniY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;S1_center_he4&#39;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">initial_values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">iniY</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">initial_values</span><span class="p">[</span><span class="s1">&#39;S1_center_he4&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;Y&#39;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">initial_values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">iniY</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">initial_values</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">iniY</span><span class="p">)</span> <span class="ow">or</span> <span class="n">iniY</span><span class="o">&lt;</span><span class="mf">0.96</span><span class="p">:</span>
                <span class="n">runs_to_rerun</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">runs_to_rerun</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;dedt_energy_eqn&#39;</span><span class="p">)</span> <span class="ow">or</span>
          <span class="p">(</span><span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;LBV_wind+dedt_energy_eqn&#39;</span><span class="p">)</span> <span class="ow">or</span>
          <span class="p">(</span><span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;no_age_limit+dedt_energy_eqn&#39;</span><span class="p">)):</span>
        <span class="n">termination_flags</span> <span class="o">=</span> <span class="n">TF1_POOL_ERROR</span>    
    <span class="k">elif</span> <span class="p">((</span><span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;dedt_hepulse&#39;</span><span class="p">)</span>
          <span class="ow">or</span> <span class="p">(</span><span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;LBV_wind+dedt_hepulse&#39;</span><span class="p">)):</span>
        <span class="n">termination_flags</span> <span class="o">=</span> <span class="n">TF1_POOL_ERROR</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;LBV_wind&#39;</span><span class="p">:</span>
        <span class="n">N_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hot_wind_full_on_T</span> <span class="o">=</span> <span class="mf">1.2e4</span> <span class="c1"># inlist value</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_runs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s1_L</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;log_L&#39;</span><span class="p">]</span>
                <span class="n">s1_R</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;log_R&#39;</span><span class="p">]</span>
                <span class="n">s1_HD_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0e-5</span> <span class="o">*</span> <span class="n">s1_R</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s1_L</span><span class="p">))</span>
                <span class="n">lbv_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s1_L</span> <span class="o">&gt;</span> <span class="mf">6.0e5</span><span class="p">,</span> <span class="n">s1_HD_limit</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="c1"># exclude (stripped) He stars</span>
                <span class="n">s1_X_surf</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;surface_h1&#39;</span><span class="p">]</span>
                <span class="n">lbv_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lbv_1</span><span class="p">,</span> <span class="n">s1_X_surf</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="c1"># exclude stars going through TPAGB</span>
                <span class="n">s1_Teff</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;log_Teff&#39;</span><span class="p">]</span>
                <span class="n">s1_Yc</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;center_he4&#39;</span><span class="p">]</span>
                <span class="n">s1_he_shell_mass</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;he_core_mass&#39;</span><span class="p">]</span> <span class="o">-</span>\
                                   <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history1</span><span class="p">[</span><span class="s1">&#39;co_core_mass&#39;</span><span class="p">]</span>
                <span class="n">tpagb_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s1_Teff</span> <span class="o">&lt;=</span> <span class="n">hot_wind_full_on_T</span><span class="p">,</span>\
                                         <span class="n">s1_Yc</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">)</span>
                <span class="n">tpagb_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">tpagb_1</span><span class="p">,</span> <span class="n">s1_he_shell_mass</span> <span class="o">&lt;=</span> <span class="mf">1e-1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lbv_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span>
                <span class="n">tpagb_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s2_L</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;log_L&#39;</span><span class="p">]</span>
                <span class="n">s2_R</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;log_R&#39;</span><span class="p">]</span>
                <span class="n">s2_HD_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0e-5</span> <span class="o">*</span> <span class="n">s2_R</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2_L</span><span class="p">))</span>
                <span class="n">lbv_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s2_L</span> <span class="o">&gt;</span> <span class="mf">6.0e5</span><span class="p">,</span> <span class="n">s2_HD_limit</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="c1"># exclude (stripped) He stars</span>
                <span class="n">s2_X_surf</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;surface_h1&#39;</span><span class="p">]</span>
                <span class="n">lbv_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lbv_2</span><span class="p">,</span> <span class="n">s2_X_surf</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="c1"># exclude stars going through TPAGB</span>
                <span class="n">s2_Teff</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;log_Teff&#39;</span><span class="p">]</span>
                <span class="n">s2_Yc</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;center_he4&#39;</span><span class="p">]</span>
                <span class="n">s2_he_shell_mass</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;he_core_mass&#39;</span><span class="p">]</span> <span class="o">-</span>\
                                   <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">history2</span><span class="p">[</span><span class="s1">&#39;co_core_mass&#39;</span><span class="p">]</span>
                <span class="n">tpagb_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s2_Teff</span> <span class="o">&lt;=</span> <span class="n">hot_wind_full_on_T</span><span class="p">,</span>\
                                         <span class="n">s2_Yc</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">)</span>
                <span class="n">tpagb_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">tpagb_2</span><span class="p">,</span> <span class="n">s2_he_shell_mass</span> <span class="o">&lt;=</span> <span class="mf">1e-1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lbv_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span>
                <span class="n">tpagb_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">lbv_1</span><span class="p">,</span> <span class="n">lbv_2</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">tpagb_1</span><span class="p">,</span> <span class="n">tpagb_2</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">runs_to_rerun</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">runs_to_rerun</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;no_age_limit&#39;</span><span class="p">:</span>
        <span class="n">termination_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;max_age&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rerun_type</span> <span class="o">==</span> <span class="s1">&#39;envelope_mass_limit&#39;</span><span class="p">:</span> <span class="c1"># maybe &#39;fe_core_infall_limit&#39; as well?</span>
        <span class="n">runs_to_rerun</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># implement logic</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported rerun type </span><span class="si">{</span><span class="n">rerun_type</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">runs_to_rerun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">termination_flags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Undefined rerun!&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">runs_to_rerun</span><span class="p">,</span> <span class="n">termination_flags</span><span class="p">,</span> <span class="n">new_mesa_flag</span></div>



<div class="viewcode-block" id="rerun">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.rerun">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rerun</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">path_to_csv_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate files to start a rerun.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index in csv file.</span>
<span class="sd">    path_to_csv_file : str</span>
<span class="sd">        Path to csv file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Enable/Disable additional output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># read csv file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> not available in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># get values from csv file</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_grid&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_grid in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;rerun_path&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">rerun_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;rerun_path&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No rerun_path in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;grid_type&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No grid_type in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;rerun_metallicity&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">rerun_metallicity</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;rerun_metallicity&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No rerun_metallicity in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;rerun_type&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">rerun_type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;rerun_type&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No rerun_type in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;cluster&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Cluster not specified, use quest as cluster&#39;</span><span class="p">,</span>
              <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="s1">&#39;quest&#39;</span>
    
    <span class="c1"># load grid</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">grid_path</span><span class="p">)</span>
    
    <span class="c1"># export point to rerun</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rerun </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">rerun_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># get reruns</span>
    <span class="n">runs_to_rerun</span><span class="p">,</span> <span class="n">termination_flags</span><span class="p">,</span> <span class="n">new_mesa_flag</span> <span class="o">=</span> <span class="n">logic_rerun</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span>
                                                                  <span class="n">rerun_type</span><span class="p">)</span>
    <span class="c1"># get csv file for reruns</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">rerun</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="n">rerun_path</span><span class="p">,</span> <span class="n">runs_to_rerun</span><span class="o">=</span><span class="n">runs_to_rerun</span><span class="p">,</span>
               <span class="n">termination_flags</span><span class="o">=</span><span class="n">termination_flags</span><span class="p">,</span>
               <span class="n">new_mesa_flag</span><span class="o">=</span><span class="n">new_mesa_flag</span><span class="p">)</span>
    
    <span class="c1"># copy ini file and set the new inlist commit</span>
    <span class="n">copy_ini_file</span><span class="p">(</span><span class="n">grid_type</span><span class="p">,</span> <span class="n">rerun_metallicity</span><span class="p">,</span> <span class="n">rerun_type</span><span class="p">,</span>
                  <span class="n">destination</span><span class="o">=</span><span class="n">rerun_path</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_grid">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.plot_grid">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_grid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">path_to_csv_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates plots of a grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index in csv file.</span>
<span class="sd">    path_to_csv_file : str</span>
<span class="sd">        Path to csv file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Enable/Disable additional output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># grid mass ranges:</span>
    <span class="c1"># min and max values might get updated, than the step is used to update the</span>
    <span class="c1"># nbin (in case of log==True the step is in log space)</span>
    <span class="n">grid_sample</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;HMS-HMS&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;log&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;nbin&#39;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;qmin&#39;</span> <span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;qmax&#39;</span> <span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
            <span class="s1">&#39;step&#39;</span> <span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;CO-HeMS&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;log&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;nbin&#39;</span> <span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
            <span class="s1">&#39;mmin&#39;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;mmax&#39;</span> <span class="p">:</span> <span class="mf">51.32759630397827</span><span class="p">,</span>
            <span class="s1">&#39;step&#39;</span> <span class="p">:</span> <span class="mf">0.0777432239326138</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;CO-HMS&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;log&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;nbin&#39;</span> <span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
            <span class="s1">&#39;mmin&#39;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;mmax&#39;</span> <span class="p">:</span> <span class="mf">51.32759630397827</span><span class="p">,</span>
            <span class="s1">&#39;step&#39;</span> <span class="p">:</span> <span class="mf">0.0777432239326138</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_nbin</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">nbin</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x_max</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x_min</span><span class="p">))</span><span class="o">/</span><span class="n">step</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbin</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max</span><span class="o">-</span><span class="n">x_min</span><span class="p">)</span><span class="o">/</span><span class="n">step</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbin</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_range</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_n</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x_min</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x_max</span><span class="p">),</span> <span class="n">x_n</span><span class="p">)</span>
            <span class="n">vars_edges</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">vars</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">vars</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span><span class="n">x_max</span><span class="p">,</span><span class="n">x_n</span><span class="p">)</span>
            <span class="n">vars_edges</span> <span class="o">=</span> <span class="p">(</span><span class="nb">vars</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="nb">vars</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mf">0.5</span>
        <span class="n">vars_edges</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">+</span><span class="n">vars_edges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="nb">vars</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">vars_edges</span>
    
    <span class="c1"># read csv file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> not available in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    
    <span class="n">check_dirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># get values from csv file</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_grid&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_grid in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;grid_type&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No grid_type in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_plot&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">plot_dir</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_plot&#39;</span><span class="p">]</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">plot_dir</span><span class="p">))</span>
        <span class="n">check_dirs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">plot_dir</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_plot in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;quantities_to_plot&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">quantities_to_plot</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;quantities_to_plot&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quantities_to_plot</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;quantities_to_plot is not a list in line </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No quantities_to_plot in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">multipage</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;plot_extension&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">plot_extension</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;plot_extension&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">plot_extension</span><span class="o">==</span><span class="s1">&#39;multipage-pdf&#39;</span><span class="p">:</span>
            <span class="n">multipage</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">plot_extension</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;No plot extension, use pdf&#39;</span><span class="p">,</span> <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
        <span class="n">plot_extension</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_interpolator&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">path_to_interpolator</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_interpolator&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path_to_interpolator</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="c1"># check that plots/ directories exist</span>
    <span class="k">for</span> <span class="n">dir_</span> <span class="ow">in</span> <span class="n">check_dirs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_</span><span class="p">)</span>
        
    <span class="c1"># load grid</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">grid_path</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">quantity_to_plot</span> <span class="ow">in</span> <span class="n">quantities_to_plot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;plotting: </span><span class="si">{</span><span class="n">quantity_to_plot</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> to &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plot_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># load interpolator and evaluate interp errors</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;INTERP_ERROR&#39;</span> <span class="ow">in</span> <span class="n">quantity_to_plot</span> 
            <span class="ow">and</span> <span class="n">path_to_interpolator</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">IFInterpolator</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path_to_interpolator</span><span class="p">)</span>
            <span class="n">evalIFerr</span> <span class="o">=</span> <span class="n">EvaluateIFInterpolator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
            <span class="n">interp_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interp_error</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># get attributes for plotting</span>
        <span class="n">plot_attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;plot_dir_name&#39;</span> <span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
            <span class="s1">&#39;zvar&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;term_flag&#39;</span> <span class="p">:</span> <span class="s1">&#39;termination_flag_1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;zlog&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;zmin&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;zmax&#39;</span> <span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">quantity_to_plot</span> <span class="ow">in</span> <span class="n">PRE_SET_PLOTS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">PRE_SET_PLOTS</span><span class="p">[</span><span class="n">quantity_to_plot</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">plot_attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRE_SET_PLOTS</span><span class="p">[</span><span class="n">quantity_to_plot</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quantity_to_plot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1">#TODO: check if quantity_to_plot is plotable as Z value</span>
            <span class="k">if</span> <span class="s1">&#39;INTERP_ERROR_&#39;</span> <span class="ow">in</span> <span class="n">quantity_to_plot</span><span class="p">:</span>
                <span class="n">short_quantity</span> <span class="o">=</span> <span class="n">quantity_to_plot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;INTERP_ERROR_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">set_name</span> <span class="o">=</span> <span class="s1">&#39;INTERP_ERROR_DEFAULT&#39;</span>
                <span class="k">if</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="n">PRE_SET_PLOTS</span><span class="p">:</span>
                    <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;plot_dir_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>\
                                                        <span class="s1">&#39;INTERP_ERROR&#39;</span><span class="p">,</span>
                                                        <span class="n">short_quantity</span><span class="p">)</span>
                    <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">short_quantity</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">PRE_SET_PLOTS</span><span class="p">[</span><span class="n">set_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">plot_attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRE_SET_PLOTS</span><span class="p">[</span><span class="n">set_name</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Pwarn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">set_name</span><span class="si">}</span><span class="s1"> not in PRE_SET_PLOTS&#39;</span><span class="p">,</span>
                          <span class="s2">&quot;UnsupportedModelWarning&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;_MODEL&#39;</span> <span class="ow">in</span> <span class="n">quantity_to_plot</span><span class="p">:</span>
                <span class="n">short_quantity</span> <span class="o">=</span> <span class="n">quantity_to_plot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_MODEL&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">short_quantity</span> <span class="o">=</span> <span class="n">short_quantity</span><span class="p">[</span><span class="n">short_quantity</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="n">quantity_to_plot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">short_quantity</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">set_name</span> <span class="o">=</span> <span class="n">quantity_to_plot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_MODEL&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>\
                           <span class="s1">&#39;_MODEL_DEFAULT_&#39;</span> <span class="o">+</span> <span class="n">short_quantity</span>
                <span class="k">if</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="n">PRE_SET_PLOTS</span><span class="p">:</span>
                    <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;plot_dir_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span>
                                                                <span class="n">short_quantity</span><span class="p">)</span>
                    <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity_to_plot</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">PRE_SET_PLOTS</span><span class="p">[</span><span class="n">set_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">plot_attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRE_SET_PLOTS</span><span class="p">[</span><span class="n">set_name</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Pwarn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">set_name</span><span class="si">}</span><span class="s1"> not in PRE_SET_PLOTS&#39;</span><span class="p">,</span>
                          <span class="s2">&quot;UnsupportedModelWarning&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">quantity_to_plot</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LOG10_&#39;</span><span class="p">:</span>
                <span class="n">short_quantity</span> <span class="o">=</span> <span class="n">quantity_to_plot</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
                <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;plot_dir_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">short_quantity</span>
                <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">short_quantity</span>
                <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zlog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;plot_dir_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity_to_plot</span>
                <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity_to_plot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantity_to_plot</span><span class="si">}</span><span class="s1"> should be a string!&#39;</span><span class="p">)</span>
        
        <span class="c1"># check that plots/ directories exist</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;plot_dir_name&#39;</span><span class="p">]</span>
        <span class="n">dir_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multipage</span><span class="p">:</span>
            <span class="c1"># multipage plots don&#39;t need the lowest directory level</span>
            <span class="n">dir_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dir_</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;CO&#39;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">):</span>
            <span class="c1"># skip plotting CO properties</span>
            <span class="k">if</span> <span class="s1">&#39;S2_&#39;</span> <span class="ow">in</span> <span class="n">quantity_to_plot</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># both grids are sampled in the same way with respect to the</span>
            <span class="c1"># compact object mass</span>
            <span class="k">if</span> <span class="s1">&#39;CO-HeMS&#39;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
                <span class="n">smpl</span> <span class="o">=</span> <span class="n">grid_sample</span><span class="p">[</span><span class="s1">&#39;CO-HeMS&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">smpl</span> <span class="o">=</span> <span class="n">grid_sample</span><span class="p">[</span><span class="s1">&#39;CO-HMS&#39;</span><span class="p">]</span>
            <span class="n">slice_3D_var_str</span> <span class="o">=</span> <span class="s1">&#39;star_2_mass&#39;</span>
            <span class="n">min_3D_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">initial_values</span><span class="p">[</span><span class="n">slice_3D_var_str</span><span class="p">])</span>
            <span class="n">max_3D_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">initial_values</span><span class="p">[</span><span class="n">slice_3D_var_str</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmin&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">min_3D_var</span><span class="p">:</span>
                <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_3D_var</span>
                <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;nbin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_nbin</span><span class="p">(</span><span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmin&#39;</span><span class="p">],</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmax&#39;</span><span class="p">],</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">],</span>
                                     <span class="n">log</span><span class="o">=</span><span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmax&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">max_3D_var</span><span class="p">:</span>
                <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_3D_var</span>
                <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;nbin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_nbin</span><span class="p">(</span><span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmin&#39;</span><span class="p">],</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmax&#39;</span><span class="p">],</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">],</span>
                                     <span class="n">log</span><span class="o">=</span><span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">])</span>
            <span class="nb">vars</span><span class="p">,</span> <span class="n">vars_edges</span> <span class="o">=</span> <span class="n">_range</span><span class="p">(</span><span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmin&#39;</span><span class="p">],</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;mmax&#39;</span><span class="p">],</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;nbin&#39;</span><span class="p">],</span>
                                      <span class="n">log</span><span class="o">=</span><span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">])</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;grid_m_</span><span class="si">%1.2f</span><span class="s1">.&#39;</span> <span class="o">+</span> <span class="n">plot_extension</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;$m_\mathrm</span><span class="si">{CO}</span><span class="s1">=</span><span class="si">%1.2f</span><span class="s1">\,M_\odot$&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;HMS-HMS&#39;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>        
            <span class="c1"># mass ratio slices</span>
            <span class="n">smpl</span> <span class="o">=</span> <span class="n">grid_sample</span><span class="p">[</span><span class="s1">&#39;HMS-HMS&#39;</span><span class="p">]</span>
            <span class="n">slice_3D_var_str</span> <span class="o">=</span> <span class="s1">&#39;mass_ratio&#39;</span> 
            <span class="nb">vars</span><span class="p">,</span> <span class="n">vars_edges</span> <span class="o">=</span> <span class="n">_range</span><span class="p">(</span><span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;qmin&#39;</span><span class="p">],</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;qmax&#39;</span><span class="p">],</span> <span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;nbin&#39;</span><span class="p">],</span>
                                      <span class="n">log</span><span class="o">=</span><span class="n">smpl</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">vars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mf">1.0</span><span class="p">:</span>
                <span class="nb">vars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="c1"># we replaced q=1 with q=0.99 in mesa runs</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;grid_q_</span><span class="si">%1.2f</span><span class="s1">.&#39;</span> <span class="o">+</span> <span class="n">plot_extension</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;$q=</span><span class="si">%1.2f</span><span class="s1">$&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Grid type not supported!&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">multipage</span><span class="p">:</span>
            <span class="n">pdf_handler</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">+</span>\
                                   <span class="s1">&#39;_all_slices.&#39;</span> <span class="o">+</span> <span class="n">plot_extension</span><span class="p">,</span>
                                   <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Author&#39;</span><span class="p">:</span> <span class="s1">&#39;POSYDON&#39;</span><span class="p">})</span>
        <span class="c1"># loop over all grid slices</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
            <span class="n">slice_3D_var_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">vars_edges</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">vars_edges</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># TODO: skip plotting slice if there are no data</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># default plot properties</span>
                <span class="n">PLOT_PROPERTIES_DEFAULT</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;figsize&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mf">3.5</span><span class="p">),</span>
                    <span class="s1">&#39;path_to_file&#39;</span> <span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;show_fig&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;fname&#39;</span> <span class="p">:</span> <span class="n">fname</span><span class="o">%</span><span class="n">var</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span> <span class="p">:</span> <span class="n">title</span><span class="o">%</span><span class="n">var</span><span class="p">,</span>
                    <span class="s1">&#39;log10_x&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;log10_y&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;legend2D&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bbox_to_anchor&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mf">1.03</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)}</span>
                <span class="p">}</span>
            
                <span class="n">PLOT_PROPERTIES</span> <span class="o">=</span> <span class="n">PLOT_PROPERTIES_DEFAULT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># default plot properties with colorbar</span>
                    <span class="n">PLOT_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">PLOT_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;colorbar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pad&#39;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">}</span>
                    <span class="n">PLOT_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;log10_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zlog&#39;</span><span class="p">]</span>
                    <span class="n">PLOT_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;zmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zmin&#39;</span><span class="p">]</span>
                    <span class="n">PLOT_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;zmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zmax&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;INTERP_ERROR&#39;</span> <span class="ow">in</span> <span class="n">quantity_to_plot</span><span class="p">:</span>
                        <span class="n">PLOT_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;colorbar&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity_to_plot</span>
                <span class="k">if</span> <span class="n">multipage</span><span class="p">:</span>
                    <span class="n">PLOT_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;PdfPages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf_handler</span>
                
                <span class="k">if</span> <span class="s1">&#39;INTERP_ERROR&#39;</span> <span class="ow">in</span> <span class="n">quantity_to_plot</span><span class="p">:</span>
                    <span class="c1"># initial/final error all points in one plot</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">PLOT_PROPERTIES_ALL</span> <span class="o">=</span> <span class="n">PLOT_PROPERTIES</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">PLOT_PROPERTIES_ALL</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>\
                                                       <span class="s1">&#39;$ all&#39;</span>
                        <span class="n">PLOT_PROPERTIES_ALL</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%1.2f</span><span class="s1">&#39;</span><span class="p">,</span>\
                                                                     <span class="s1">&#39;all&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">multipage</span><span class="p">:</span>
                            <span class="n">PLOT_PROPERTIES_ALL</span><span class="p">[</span><span class="s1">&#39;path_to_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>
                            <span class="n">PLOT_PROPERTIES_ALL</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_all.&#39;</span> <span class="o">+</span>\
                                                           <span class="n">plot_extension</span>
                            <span class="n">PLOT_PROPERTIES_ALL</span><span class="p">[</span><span class="s1">&#39;PdfPages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">evalIFerr</span><span class="o">.</span><span class="n">plot2D</span><span class="p">(</span><span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">],</span> 
                                         <span class="n">slice_3D_var_str</span><span class="p">,</span> 
                                         <span class="p">(</span><span class="n">vars_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vars_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> 
                                         <span class="n">PLOT_PROPERTIES_ALL</span><span class="p">)</span>
                    <span class="c1"># initial/final error slices</span>
                    <span class="n">evalIFerr</span><span class="o">.</span><span class="n">plot2D</span><span class="p">(</span><span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">],</span> <span class="n">slice_3D_var_str</span><span class="p">,</span>
                                     <span class="n">slice_3D_var_range</span><span class="p">,</span> <span class="n">PLOT_PROPERTIES</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;CLASS_ERROR&#39;</span> <span class="ow">in</span> <span class="n">quantity_to_plot</span><span class="p">:</span>
                    <span class="c1"># TODO: add class error plots</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">evalIFerr</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">],</span>
                                                   <span class="n">close_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;VIOLIN&#39;</span> <span class="ow">in</span> <span class="n">quantity_to_plot</span><span class="p">:</span>
                    <span class="c1"># TODO: add violin plots</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">evalIFerr</span><span class="o">.</span><span class="n">violin_plots</span><span class="p">(</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span>
                                               <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">]],</span>
                                               <span class="n">close_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grid</span><span class="o">.</span><span class="n">plot2D</span><span class="p">(</span><span class="s1">&#39;star_1_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;period_days&#39;</span><span class="p">,</span>
                                <span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;zvar&#39;</span><span class="p">],</span>
                                <span class="n">termination_flag</span><span class="o">=</span><span class="n">plot_attributes</span><span class="p">[</span><span class="s1">&#39;term_flag&#39;</span><span class="p">],</span>
                                <span class="n">grid_3D</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">slice_3D_var_str</span><span class="o">=</span><span class="n">slice_3D_var_str</span><span class="p">,</span>
                                <span class="n">slice_3D_var_range</span><span class="o">=</span><span class="n">slice_3D_var_range</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">PLOT_PROPERTIES</span><span class="p">)</span>
            
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FAILED TO PLOT &#39;</span><span class="o">+</span><span class="n">title</span><span class="o">%</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39; to &#39;</span><span class="o">+</span><span class="n">fname</span><span class="o">%</span><span class="n">var</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">multipage</span><span class="p">:</span>
                    <span class="c1"># close and reopen handler</span>
                    <span class="c1"># (WARNING: this will overwrite the pdf file)</span>
                    <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;delete and reopen: &#39;</span><span class="o">+</span>\
                          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_dir</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">+</span>\
                          <span class="sa">f</span><span class="s1">&#39;_all.</span><span class="si">{</span><span class="n">plot_extension</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">pdf_handler</span>
                    <span class="n">pdf_handler</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">+</span>\
                                           <span class="s1">&#39;_all_slices.&#39;</span> <span class="o">+</span><span class="n">plot_extension</span><span class="p">,</span>
                                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Author&#39;</span><span class="p">:</span> <span class="s1">&#39;POSYDON&#39;</span><span class="p">})</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">multipage</span><span class="p">:</span>
            <span class="n">pdf_handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="do_check">
<a class="viewcode-back" href="../api_reference/posydon_run_pipeline.html#posydon_run_pipeline.do_check">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_check</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">path_to_csv_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform a check on a grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index in csv file.</span>
<span class="sd">    path_to_csv_file : str</span>
<span class="sd">        Path to csv file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Enable/Disable additional output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># read csv file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> not available in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    
    <span class="c1"># get values from csv file</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_grid&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">grid_path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No path_to_grid in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;checks_to_do&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">checks_to_do</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;checks_to_do&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checks_to_do</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;checks_to_do is not a list in line </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No checks_to_do in </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;path_to_interpolator&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">path_to_interpolator</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;path_to_interpolator&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path_to_interpolator</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="c1"># load grid</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">grid_path</span><span class="p">)</span>
    
    <span class="c1"># do the checks</span>
    <span class="k">for</span> <span class="n">check_to_do</span> <span class="ow">in</span> <span class="n">checks_to_do</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">check_to_do</span><span class="o">==</span><span class="s1">&#39;failure_rate&#39;</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="s1">&#39;interpolation_class&#39;</span><span class="p">])</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">count</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="n">count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;not_converged&#39;</span> <span class="ow">in</span> <span class="n">count</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">failure_rate_in_percent</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="s1">&#39;not_converged&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">failure_rate_in_percent</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failure rate: </span><span class="si">{</span><span class="n">failure_rate_in_percent</span><span class="si">}</span><span class="s1">% in </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">check_to_do</span><span class="o">==</span><span class="s1">&#39;CO_type&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;S1_MODEL&#39;</span> <span class="ow">in</span> <span class="n">quantity</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;CO_type&#39;</span> <span class="ow">in</span> <span class="n">quantity</span><span class="p">)):</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">quantity</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">check_to_do</span><span class="o">==</span><span class="s1">&#39;SN_type&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;S1_MODEL&#39;</span> <span class="ow">in</span> <span class="n">quantity</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SN_type&#39;</span> <span class="ow">in</span> <span class="n">quantity</span><span class="p">)):</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">final_values</span><span class="p">[</span><span class="n">quantity</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1">#TODO: add more checks</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Do not know how to do </span><span class="si">{</span><span class="n">check_to_do</span><span class="si">}</span><span class="s1"> for&#39;</span><span class="o">+</span>\
                  <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">grid_path</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span> <span class="s2">&quot;UnsupportedModelWarning&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># read commond line arguments</span>
    <span class="n">n_args</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">n_args</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># path to girds</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;--help&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Programm to run a pipeline step&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;syntax: posydon-run-pipeline PATH_TO_GRIDS PATH_TO_CSV_FILE&#39;</span>
                  <span class="s1">&#39; [SLURM_I] [VERBOSE]&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PATH_TO_GRIDS: path to the root directory with the grids&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PATH_TO_CSV_FILE: path to the csv file containing the step&#39;</span>
                  <span class="s1">&#39; data&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SLURM_I (optional): slurm array index, used to grep a&#39;</span>
                  <span class="s1">&#39; certain data set (usually line index) from the csv file;&#39;</span>
                  <span class="s1">&#39; if not given the first non header line is used&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;VERBOSE (optional): flag for additional output&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">PATH_TO_GRIDS</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">):</span> <span class="c1"># check given path</span>
            <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="s1">&#39;Grids were not found! Check your &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;PATH_TO_GRIDS=</span><span class="si">{</span><span class="n">PATH_TO_GRIDS</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No path to the grids given. It should be specified &#39;</span>
                       <span class="s1">&#39;as first commandline argument.&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">n_args</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># path to csv file</span>
        <span class="n">PATH_TO_CSV_FILE</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">PATH_TO_CSV_FILE</span><span class="p">):</span> <span class="c1"># check given path</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Csv file not found! Check your &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;PATH_TO_CSV_FILE=</span><span class="si">{</span><span class="n">PATH_TO_CSV_FILE</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No csv file given. It should be specified as &#39;</span>
                       <span class="s1">&#39;second commandline argument.&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">n_args</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># slurm index</span>
        <span class="n">SLURM_I</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">SLURM_I</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># check value</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The slurm index cannot be negative: </span><span class="si">{</span><span class="n">SLURM_I</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;No slurm index given, use 0&#39;</span><span class="p">,</span> <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
        <span class="n">SLURM_I</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">n_args</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># verbose flag</span>
        <span class="n">VERBOSE</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;No verbose flag given, use True&#39;</span><span class="p">,</span> <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
        <span class="n">VERBOSE</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># chose grid slice given the slurm jobarray index</span>

    <span class="c1"># offset the start of each job</span>
    <span class="c1"># NOTE: this prevents job arrays starting at the same time to read</span>
    <span class="c1"># the same files at the same time (e.g. when creatign LITE/ORIGINAL grid,</span>
    <span class="c1"># or when creating a directory that does not exist yet)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">)</span>

    <span class="n">STEP</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">PATH_TO_CSV_FILE</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">STEP</span><span class="o">==</span><span class="s1">&#39;step_1&#39;</span><span class="p">:</span> <span class="c1"># grid slices creation</span>
        <span class="n">create_grid_slice</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">,</span> <span class="n">PATH_TO_CSV_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">STEP</span><span class="o">==</span><span class="s1">&#39;step_2&#39;</span><span class="p">:</span> <span class="c1"># grid slices concatenation</span>
        <span class="n">combine_grid_slices</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">,</span> <span class="n">PATH_TO_CSV_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">STEP</span><span class="o">==</span><span class="s1">&#39;step_3&#39;</span><span class="p">:</span> <span class="c1"># calculate extra values</span>
        <span class="n">calculate_extra_values</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">,</span> <span class="n">PATH_TO_CSV_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">STEP</span><span class="o">==</span><span class="s1">&#39;step_4&#39;</span><span class="p">:</span> <span class="c1"># train interpolators</span>
        <span class="n">train_interpolators</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">,</span> <span class="n">PATH_TO_CSV_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">STEP</span><span class="o">==</span><span class="s1">&#39;step_5&#39;</span><span class="p">:</span> <span class="c1"># train profile interpolators</span>
        <span class="n">train_profile_interpolators</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">,</span> <span class="n">PATH_TO_CSV_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">STEP</span><span class="o">==</span><span class="s1">&#39;step_9&#39;</span><span class="p">:</span> <span class="c1"># export dataset</span>
        <span class="n">export_dataset</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">,</span> <span class="n">PATH_TO_CSV_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">STEP</span><span class="o">==</span><span class="s1">&#39;rerun&#39;</span><span class="p">:</span> <span class="c1"># export rerun</span>
        <span class="n">rerun</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">,</span> <span class="n">PATH_TO_CSV_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">STEP</span><span class="p">:</span> <span class="c1"># plot grid slices</span>
        <span class="n">plot_grid</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">,</span> <span class="n">PATH_TO_CSV_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;check&#39;</span> <span class="ow">in</span> <span class="n">STEP</span><span class="p">:</span> <span class="c1"># do checks, e.g. failure rate</span>
        <span class="n">do_check</span><span class="p">(</span><span class="n">SLURM_I</span><span class="p">,</span> <span class="n">PATH_TO_CSV_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>

    <span class="n">print_stats</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tassos Fragos.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      Version: v2.0.0-dev
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        
        <dl>
            <dt> v2</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v2.0.6/index.html">2.0</a></dd>
            
            <dd><a href="https://posydon.org/POSYDON/v2.1.2/index.html">2.1</a></dd>
            
        </dl>
        
        <dl>
            <dt> v1</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v1.0.5/index.html">1.0</a></dd>
            
        </dl>
        
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>