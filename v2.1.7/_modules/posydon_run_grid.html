

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>posydon_run_grid &mdash; posydon 2.1.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=d66fa8e6" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=ebebaa27"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/posydon_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction-acknowledgements/intro.html">Introduction, Objectives, and Scope</a></li>
<li class="toctree-l1"><a class="reference external" href="https://posydon.org/team.html">Collaborative Team</a></li>
<li class="toctree-l1"><a class="reference external" href="https://ui.adsabs.harvard.edu/public-libraries/ZZsD9bzLTzWnLV3hwyJxbA">Publications</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-grids.html">Quick Start: Examining the MESA Grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-population.html">Quick Start: Your First Population</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials and Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/population-synthesis/binary-pop-syn.html">Binary-Star Population Synthesis with POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/generating-datasets/generating-datasets.html">Crafting the Core Datasets for POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/MESA-grids/running-grids.html">Architecting MESA Simulation Grids with POSYDON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">In-Depth Components Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/mesa-grids.html">MESA Grids API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/processing-pipeline.html">Processing Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/machine-learning-components.html">Machine Learning Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/stellar-binary-simulation.html">Stellar &amp; Binary-star Simulation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/posydon.html">posydon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/bin.html">executables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases and Datasets</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON/releases">Releases</a></li>
<li class="toctree-l1"><a class="reference external" href="https://zenodo.org/communities/posydon/">Datasets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support and Contact</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contact-support/contact-information.html">Contact Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting-faqs/installation-issues.html">Common Installation Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting-faqs/code-questions.html">Code Usage Questions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON/issues/new/choose">Report an Issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/how-to-contribute.html">How To Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">posydon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">posydon_run_grid</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for posydon_run_grid</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">##############################################################################</span>
<span class="c1">#  IMPORT ALL NECESSARY PYTHON PACKAGES</span>
<span class="c1">##############################################################################</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">stat</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">gridutils</span> <span class="k">as</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.posydonwarning</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pwarn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.grids.psygrid</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSyGrid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.active_learning.psy_cris.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_inifile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChainMap</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">mpi4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPI</span>
    <span class="n">MPI_IMPORTED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">MPI_IMPORTED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">###############################################################################</span>
<span class="c1"># DEFINE COMMANDLINE ARGUMENTS</span>
<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="parse_commandline">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.parse_commandline">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_commandline</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse the arguments given on the command-line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>
    <span class="n">grid_arguments</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Arguments related to the running of the grid, including &#39;</span>
                                               <span class="s1">&#39;specifying the grid values and type of grid to be run, &#39;</span>
                                               <span class="s1">&#39;where the MESA simulation will be run, &#39;</span>
                                               <span class="s1">&#39;and where the output of the simulation should go&#39;</span><span class="p">)</span>
    <span class="n">grid_arguments</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-grid&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Grid of mesa points with values already known,&quot;</span>
                        <span class="s2">&quot;or new grid values to run MESA on&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">grid_arguments</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--grid-type&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Either you are supplying a grid &quot;</span>
                        <span class="s2">&quot;of points to run MESA on (fixed) or you are supplying a pre computed MESA &quot;</span>
                        <span class="s2">&quot;grid and want to sampling new points to run MESA on (dynamic).&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">grid_arguments</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output-directory&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This is where the result of the MESA simulatio  will go&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">grid_arguments</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--temporary-directory&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This is where your MESA simulations will run&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

    <span class="n">fixed_grid_arguments</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Arguments specific to running a fixed grid&#39;</span><span class="p">)</span>
    <span class="n">fixed_grid_arguments</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--grid-point-index&quot;</span><span class="p">,</span>
                                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Override grid point slection by &quot;</span>
                                      <span class="s2">&quot;explictly saying which grid point you want.&quot;</span>
                                      <span class="s2">&quot;This must be run with mpirun -np 1!!&quot;</span><span class="p">,</span>
                                      <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">dynamic_grid_arguments</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Arguments specific to running a dynamic grid&#39;</span><span class="p">)</span>
    <span class="n">dynamic_grid_arguments</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--psycris-inifile&quot;</span><span class="p">,</span>
                                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the psycris inifile. &quot;</span><span class="p">)</span>
    <span class="n">dynamic_grid_arguments</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--Niter&quot;</span><span class="p">,</span>
                                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of iterations of binaries &quot;</span>
                                        <span class="s2">&quot;to try, will check ever Nstep for convergence&quot;</span><span class="p">,</span>
                                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="n">mesa_executables</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;absolute path to MESA executables to be used in grid&#39;</span><span class="p">)</span>
    <span class="n">mesa_executables</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-binary-executable&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;MESA binary executable to be used for this grid&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mesa_executables</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-star1-executable&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;optionally use star executable to form star1&quot;</span><span class="p">,</span>
                       <span class="p">)</span>
    <span class="n">mesa_executables</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-star2-executable&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;optionally use star executable to form star2&quot;</span><span class="p">,</span>
                       <span class="p">)</span>

    <span class="n">inlists_for_running_binary</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;absolute paths to static inlists related to the call of the binary executable&#39;</span><span class="p">)</span>
    <span class="n">inlists_for_running_binary</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-binary-inlist-project&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This is the shared inlist_project that will be used by &quot;</span>
                        <span class="s2">&quot;every MESA run for this grid. inlist_project has both binary_job and binary_controls in it&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">inlists_for_running_binary</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-binary-inlist1&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This is the shared inlist1 that will be used by &quot;</span>
                        <span class="s2">&quot;every MESA run for this grid. inlist1 has both star_job and controls in it that determine &quot;</span>
                        <span class="s2">&quot;the properties of the first object&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">inlists_for_running_binary</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-binary-inlist2&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This is the shared inlist2 that will be used by &quot;</span>
                        <span class="s2">&quot;every MESA run for this grid. inlist2 has both star_job and controls in it that determine &quot;</span>
                        <span class="s2">&quot;the properties of the second object&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">inlists_for_running_star1</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;absolute paths to static inlists related to the formation of star1&#39;</span><span class="p">)</span>
    <span class="n">inlists_for_running_star1</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-star1-inlist-project&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;optionally use specific inlist(s) to form star1&quot;</span><span class="p">,</span>
                       <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
    <span class="n">inlists_for_running_star2</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;absolute paths to static inlists related to the formation of star2&#39;</span><span class="p">)</span>

    <span class="n">inlists_for_running_star2</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-star2-inlist-project&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;optionally use specific inlist(s) to form star2&quot;</span><span class="p">,</span>
                       <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>

    <span class="n">mesa_columns</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;absolute paths to list of columns desired from each MESA simulation on this grid&#39;</span><span class="p">)</span>
    <span class="n">mesa_columns</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-star-history-columns&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This is the path to the star_history_columns.list file you want to use for this grid&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mesa_columns</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-binary-history-columns&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This is the path to the binary_history_columns.list file you want to use for this grid&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mesa_columns</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mesa-profile-columns&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This is the path to the profile_columns.list file you want to use for this grid&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run in Verbose Mode&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--keep_profiles&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not delete profiles at run completion&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--keep_photos&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not delete photos at run completion&quot;</span><span class="p">)</span>

    <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--job_end&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="o">+</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;End time of the job (in seconds)&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--job_before_end&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time span till end of job (in seconds)&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;--run-type must be either fixed or dynamic&quot;</span><span class="p">)</span>

    <span class="c1"># if we are running a dynamic grid then these arguments are required otherwise</span>
    <span class="c1"># they are not</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">psycris_inifile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must supply a psycris inifile when running a dynamic grid&quot;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">args</span></div>


<div class="viewcode-block" id="id_generator">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.id_generator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">id_generator</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">chars</span><span class="o">=</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span>
                        <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span>
                        <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obtain omicron triggers run gravityspy on</span>

<span class="sd">    Parameters:</span>

<span class="sd">        x (str): the item you would like a random id to be generated for</span>
<span class="sd">    Returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">SystemRandom</span><span class="p">()</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">))</span></div>


<div class="viewcode-block" id="extract_mesa_results">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.extract_mesa_results">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_mesa_results</span><span class="p">(</span><span class="n">final_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Based on the structure of the results folder extract the final state of the simulation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">PSyGrid</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">final_dir</span><span class="p">,</span> <span class="s2">&quot;./tmp.hdf5&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;posydon_single&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">psg</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">()</span>
        <span class="n">psg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;tmp.hdf5&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">psg</span><span class="o">.</span><span class="n">get_pandas_initial_final</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="create_working_directory">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.create_working_directory">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_working_directory</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to build the directory name and make inlists for a given grid point</span>

<span class="sd">    Params:</span>
<span class="sd">        grid_param_dict:</span>
<span class="sd">            Dictionary with keys being the parameter names of the grid</span>
<span class="sd">            and values the actual values for those parameters for this grid point</span>
<span class="sd">        args:</span>
<span class="sd">            The arguments passed to posydon-run-grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">############# set directories</span>
    <span class="n">variable_names_to_log</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;initial_z&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_period_in_days&#39;</span><span class="p">]</span>
    <span class="c1"># first name directories which we do not need to log</span>
    <span class="n">directory_name_from_dict_no_log</span> <span class="o">=</span>  <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">grid_param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variable_names_to_log</span><span class="p">])</span>
    <span class="n">directory_name_from_dict_log</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:.4e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">grid_param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">variable_names_to_log</span><span class="p">])</span>
    <span class="c1"># drop parenthesis</span>
    <span class="n">directory_name_from_dict_no_log</span> <span class="o">=</span> <span class="n">directory_name_from_dict_no_log</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">directory_name_from_dict_no_log</span> <span class="o">=</span> <span class="n">directory_name_from_dict_no_log</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># combine and add on what grid number we are running if exists</span>
    <span class="n">directory_name_from_dict</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory_name_from_dict_no_log</span><span class="p">,</span> <span class="n">directory_name_from_dict_log</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">directory_name_from_dict</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">_</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory_name_from_dict</span><span class="p">,</span> <span class="s1">&#39;grid_index&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">:</span>
        <span class="n">directory_name_from_dict</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory_name_from_dict</span><span class="p">,</span> <span class="n">id_generator</span><span class="p">())</span>

    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">temporary_directory</span> <span class="c1">#all sims will be created inside this directory (e.g. /scratch/pablo_nu/sim1/)</span>

    <span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">directory_name_from_dict</span><span class="p">)</span>

    <span class="n">final_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">directory_name_from_dict</span><span class="p">)</span>

    <span class="c1">############# check for existance of precomputed model</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">work_dir</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Directory </span><span class="si">{}</span><span class="s2"> exists, removing and rerunning&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">work_dir</span><span class="p">),</span>
              <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>

    <span class="c1">############# create work directory and change into it</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star_history_columns</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_binary_history_columns</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_profile_columns</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span></div>


<div class="viewcode-block" id="create_binary_inlists">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.create_binary_inlists">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_binary_inlists</span><span class="p">(</span><span class="n">binary_controls</span><span class="p">,</span> <span class="n">binary_job</span><span class="p">,</span>
                          <span class="n">star1_binary_controls</span><span class="p">,</span> <span class="n">star1_binary_job</span><span class="p">,</span>
                          <span class="n">star2_binary_controls</span><span class="p">,</span> <span class="n">star2_binary_job</span><span class="p">,</span>
                          <span class="n">work_dir</span><span class="p">,</span> <span class="n">binary_inlist_project</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the inlist and inlist grid points needed to run this part of grid</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">binary_controls_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&amp;binary_controls</span>

<span class="s2">      read_extra_binary_controls_inlist1 = .true.</span>
<span class="s2">      extra_binary_controls_inlist1_name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span>
<span class="s2">      read_extra_binary_controls_inlist2 = .true.</span>
<span class="s2">      extra_binary_controls_inlist2_name = &#39;inlist_grid_points&#39;</span>

<span class="s2">/ ! end of controls namelist</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">binary_inlist_project</span><span class="p">)</span>

    <span class="n">binary_job_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&amp;binary_job</span>

<span class="s2">      read_extra_binary_job_inlist1 = .true.</span>
<span class="s2">      extra_binary_job_inlist1_name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span>

<span class="s2">/ ! end of job namelist</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">binary_inlist_project</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;inlist&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">binary_controls_str</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">binary_job_str</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;inlist_grid_points&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inlist_grid_points</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">binary_controls</span><span class="p">:</span>
            <span class="c1"># Write the binary controls for this grid point</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;binary_controls</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">binary_controls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .true.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .false.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;/ ! end of binary_controls namelist</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">binary_job</span><span class="p">:</span>
            <span class="c1"># Write the binary job for this grid point</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;binary_job</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">binary_job</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .true.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .false.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;/ ! end of binary_job namelist</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">star1_binary_controls</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;inlist_grid_star1_binary_controls&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inlist_grid_points</span><span class="p">:</span>
            <span class="c1"># Write the star1 controls for this grid point</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;controls</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">star1_binary_controls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .true.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .false.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;/ ! end of controls namelist</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">star2_binary_controls</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;inlist_grid_star2_binary_controls&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inlist_grid_points</span><span class="p">:</span>
            <span class="c1"># Write the star2 controls for this grid point</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;controls</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">star2_binary_controls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .true.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .false.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;/ ! end of controls namelist</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">star1_binary_job</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;inlist_grid_star1_binary_job&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inlist_grid_points</span><span class="p">:</span>
            <span class="c1"># Write the star1 job for this grid point</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;star_job</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">star1_binary_job</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .true.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .false.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;/ ! end of star_job namelist</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">star2_binary_job</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;inlist_grid_star2_binary_job&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inlist_grid_points</span><span class="p">:</span>
            <span class="c1"># Write the star2 job for this grid point</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;star_job</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">star2_binary_job</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()):</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .true.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> = .false.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;/ ! end of star_job namelist</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="create_star_formation">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.create_star_formation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_star_formation</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">star_inlist_project</span><span class="p">,</span> <span class="n">initial_z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_Z</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the inlist and inlist grid points needed to run this part of grid</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">binary_controls_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&amp;controls</span>

<span class="s2">      read_extra_controls_inlist1 = .true.</span>
<span class="s2">      extra_controls_inlist1_name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span>
<span class="s2">      read_extra_controls_inlist2 = .true.</span>
<span class="s2">      extra_controls_inlist2_name = &#39;inlist_grid_points&#39;</span>

<span class="s2">/ ! end of controls namelist</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star_inlist_project</span><span class="p">)</span>

    <span class="n">binary_job_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&amp;star_job</span>

<span class="s2">      read_extra_star_job_inlist1 = .true.</span>
<span class="s2">      extra_star_job_inlist1_name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span>
<span class="s2">      read_extra_star_job_inlist2 = .true.</span>
<span class="s2">      extra_star_job_inlist2_name = &#39;inlist_grid_points&#39;</span>

<span class="s2">/ ! end of job namelist</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star_inlist_project</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;inlist&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">binary_controls_str</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">binary_job_str</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;inlist_grid_points&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inlist_grid_points</span><span class="p">:</span>
        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;controls</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;initial_mass = &quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">initial_z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;initial_z = &quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">initial_z</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Zbase = &quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">initial_z</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;/ ! end of star_controls namelist</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;star_job</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_Z</span><span class="p">:</span>
            <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;new_Z = &quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:.10e}</span><span class="se">\n</span><span class="s2">&quot;</span>\
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">initial_z</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;/ ! end of star_job namelist</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">inlist_grid_points</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="move_mesa_output">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.move_mesa_output">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">move_mesa_output</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">,</span> <span class="n">copyinstead</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Moves the data from the working directory to the final directory.</span>
<span class="sd">    Parameters:</span>
<span class="sd">        work_dir:</span>
<span class="sd">            Working directory (i.e. where the mesa exectuable should run)</span>
<span class="sd">        final_dir:</span>
<span class="sd">            When completed where would you like the output to go</span>
<span class="sd">        copyinstead:</span>
<span class="sd">            Indicates that the files should be copied instead of moved</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">work_dir</span> <span class="o">==</span> <span class="n">final_dir</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">final_dir</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Directory </span><span class="si">{}</span><span class="s2"> exists,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span> <span class="o">+</span>\
                  <span class="s2">&quot; replacing with new data&quot;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">final_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">copyinstead</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;copy data from &quot;</span> <span class="o">+</span> <span class="n">work_dir</span><span class="o">+</span> <span class="s2">&quot; to &quot;</span><span class="o">+</span> <span class="n">final_dir</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;move data from &quot;</span> <span class="o">+</span> <span class="n">work_dir</span><span class="o">+</span> <span class="s2">&quot; to &quot;</span><span class="o">+</span> <span class="n">final_dir</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="run_mesa">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.run_mesa">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_mesa</span><span class="p">(</span><span class="n">mesa_executable</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides minor utility for actually spawning the mesa job for each grid</span>

<span class="sd">        mesa_executable:</span>
<span class="sd">            Path to the executable you are running</span>
<span class="sd">        work_dir:</span>
<span class="sd">            Working directory (i.e. where the mesa exectuable should run)</span>
<span class="sd">        final_dir:</span>
<span class="sd">            When completed where would you like the output to go</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;outfile_name&#39;</span><span class="p">,</span> <span class="s1">&#39;out.txt&#39;</span><span class="p">)</span>
    <span class="n">keep_profiles</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;keep_profiles&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">keep_photos</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;keep_photos&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">keep_work_dir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;keep_work_dir&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">work_dir</span> <span class="o">==</span> <span class="n">final_dir</span><span class="p">:</span>
        <span class="n">child_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">child_ID</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">if</span> <span class="n">child_ID</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1">#parent process: run MESA and do the clean up in the working directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> &amp;&gt; </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mesa_executable</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">outfile_name</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_profiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;LOGS&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;LOGS&#39;</span><span class="p">),</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span>  <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span> <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm LOGS/profile*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;LOGS1&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;LOGS1&#39;</span><span class="p">),</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span>  <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span> <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm LOGS1/profile*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;LOGS2&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;LOGS2&#39;</span><span class="p">),</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span>  <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span> <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm LOGS2/profile*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;.mesa_temp_cache&#39;</span><span class="p">)):</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf .mesa_temp_cache&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_photos</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf photos*&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">child_ID</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#kill child process, because it is no longer needed</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">child_ID</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">move_mesa_output</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">,</span> <span class="n">keep_work_dir</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">child_ID</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">child_end</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;job_end&#39;</span><span class="p">,</span> <span class="n">now</span><span class="o">+</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="o">-</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;job_before_end&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="c1">#child process: waits till short before the job will get killed by slurm to copy the data beforehand and exit this process after the copy finished</span>
        <span class="k">if</span> <span class="n">child_end</span><span class="o">&gt;</span><span class="n">now</span><span class="p">:</span>
            <span class="c1">#if the child job still needs to wait, get time to wait</span>
            <span class="n">wait_time</span> <span class="o">=</span> <span class="n">child_end</span> <span class="o">-</span> <span class="n">now</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#otherwise wait 1 minute</span>
            <span class="n">wait_time</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
        <span class="n">move_mesa_output</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">,</span> <span class="n">copyinstead</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">final_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="get_next_grid_point">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.get_next_grid_point">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_next_grid_point</span><span class="p">(</span><span class="n">psycris_inifile_path</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">n_new_points</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample a new grid point</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    psycris_inifile_path : str</span>
<span class="sd">        Path to psycris inifile</span>
<span class="sd">    grid : pandas DataFrame</span>
<span class="sd">        DataFrame of initial and final values of training data</span>
<span class="sd">    n_new_points : int</span>
<span class="sd">        Number of new points requested from the algorithm</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    query_points : array</span>
<span class="sd">        Initial conditions of new MESA run to label.</span>
<span class="sd">    pred_classess : array</span>
<span class="sd">        Predicted class of query point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">posydon.grids.psygrid</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSyGrid</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">posydon.active_learning.psy_cris.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_new_query_points</span><span class="p">,</span> <span class="n">parse_inifile</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">posydon.interpolation.data_scaling</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataScaler</span>

    <span class="n">normed_grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">mesa_kwargs</span> <span class="o">=</span> <span class="n">parse_inifile</span><span class="p">(</span><span class="n">psycris_inifile_path</span><span class="p">)</span>

    <span class="n">input_cols</span> <span class="o">=</span> <span class="n">mesa_kwargs</span><span class="p">[</span><span class="s2">&quot;TableData_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">]</span>
    <span class="n">output_cols</span> <span class="o">=</span> <span class="n">mesa_kwargs</span><span class="p">[</span><span class="s2">&quot;TableData_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;output_cols&quot;</span><span class="p">]</span>
    <span class="n">in_scaling</span> <span class="o">=</span> <span class="n">mesa_kwargs</span><span class="p">[</span><span class="s2">&quot;posydon_dynamic_sampling_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;in_scaling&quot;</span><span class="p">]</span>
    <span class="n">out_scaling</span> <span class="o">=</span> <span class="n">mesa_kwargs</span><span class="p">[</span><span class="s2">&quot;posydon_dynamic_sampling_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;out_scaling&quot;</span><span class="p">]</span>
    <span class="c1"># Check if sampling input and output columns match data from psygrid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">name</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_cols</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad input columns given: </span><span class="si">{0}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">Must be in: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_cols</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">name</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">output_cols</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad output columns given: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">Must be in: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_cols</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="p">)</span>
    <span class="c1"># default scaling is from [-1,1]</span>
    <span class="c1"># scale input data</span>
    <span class="n">input_scalers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">input_col_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_cols</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">DataScaler</span><span class="p">()</span>
        <span class="n">col_data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">fit_and_transform</span><span class="p">(</span> <span class="n">grid</span><span class="p">[</span><span class="n">input_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">in_scaling</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">normed_grid</span><span class="p">[</span><span class="n">input_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_data</span>
        <span class="n">input_scalers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="c1"># scale output data</span>
    <span class="n">output_scalers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output_col_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_cols</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">output_col_name</span><span class="o">==</span><span class="n">mesa_kwargs</span><span class="p">[</span><span class="s2">&quot;TableData_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;class_col_name&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">DataScaler</span><span class="p">()</span>
        <span class="n">col_data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">fit_and_transform</span><span class="p">(</span> <span class="n">grid</span><span class="p">[</span><span class="n">output_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">out_scaling</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">normed_grid</span><span class="p">[</span><span class="n">output_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_data</span>
        <span class="n">output_scalers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="c1"># protect overwriting nested dicts</span>
    <span class="n">holder</span> <span class="o">=</span> <span class="n">mesa_kwargs</span><span class="p">[</span><span class="s1">&#39;TableData_kwargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">holder</span><span class="p">[</span><span class="s2">&quot;my_DataFrame&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normed_grid</span>
    <span class="n">mesa_kwargs</span><span class="p">[</span><span class="s1">&#39;TableData_kwargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">holder</span>

    <span class="n">normed_query_points</span><span class="p">,</span> <span class="n">pred_classess</span> <span class="o">=</span> <span class="n">get_new_query_points</span><span class="p">(</span><span class="n">N_new_points</span><span class="o">=</span><span class="n">n_new_points</span><span class="p">,</span> <span class="o">**</span><span class="n">mesa_kwargs</span><span class="p">)</span>

    <span class="c1"># inv transform the query points from sapling space for MESA variables</span>
    <span class="n">query_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">normed_query_points</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_scalers</span><span class="p">)</span> <span class="p">):</span>
       <span class="n">query_points</span><span class="p">[:,</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_scalers</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">inv_transform</span><span class="p">(</span><span class="n">normed_query_points</span><span class="p">[:,</span><span class="n">n</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">query_points</span><span class="p">,</span> <span class="n">pred_classess</span></div>



<div class="viewcode-block" id="convert_input_cols_to_mesa_cols">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.convert_input_cols_to_mesa_cols">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_input_cols_to_mesa_cols</span><span class="p">(</span><span class="n">grid_df</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;initial_period_days&#39;</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;initial_period_in_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;initial_period_days&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;log_p&#39;</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;initial_period_in_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;log_p&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;initial_star_1_mass&#39;</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;initial_star_1_mass&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;initial_star_2_mass&#39;</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;m2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;initial_star_2_mass&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;initial_star_1_mass&#39;</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;m2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;initial_star_1_mass&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">grid_df</span></div>


<div class="viewcode-block" id="do_root_process_logic">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.do_root_process_logic">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_root_process_logic</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">grid_params_binary_controls</span><span class="p">,</span> <span class="n">grid_params_binary_job</span><span class="p">,</span>
                          <span class="n">grid_params_star1_binary_controls</span><span class="p">,</span> <span class="n">grid_params_star1_binary_job</span><span class="p">,</span>
                          <span class="n">grid_params_star2_binary_controls</span><span class="p">,</span> <span class="n">grid_params_star2_binary_job</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the logic that the root process does for the dynamic grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">posydon.active_learning.psy_cris.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_inifile</span>
    <span class="n">nstep</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Beginning dynamic grid...&#39;</span><span class="p">)</span>
    <span class="c1"># As first step find the new grid points for all the child process to run on and send that data to them</span>
    <span class="n">proposed_points</span><span class="p">,</span> <span class="n">predicted_classes_of_points</span> <span class="o">=</span> <span class="n">get_next_grid_point</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">psycris_inifile</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">n_new_points</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sampling first grid point for process </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># make a dataframe from the proposed points with the names of the columns</span>
        <span class="n">dynamic_grid_params</span> <span class="o">=</span> <span class="n">parse_inifile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">psycris_inifile</span><span class="p">)</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">proposed_points</span><span class="p">[</span><span class="n">child</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]),</span><span class="n">columns</span><span class="o">=</span><span class="n">dynamic_grid_params</span><span class="p">[</span><span class="s2">&quot;TableData_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">],)</span>

        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">convert_input_cols_to_mesa_cols</span><span class="p">(</span><span class="n">grid_df</span><span class="p">)</span>

        <span class="c1"># make a dict so we can send the information around</span>
        <span class="n">grid_dict</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sending process number </span><span class="si">{0}</span><span class="s1"> a new grid point...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">isend</span><span class="p">(</span><span class="n">grid_dict</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">child</span><span class="p">,)</span>
        <span class="n">req</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Process number </span><span class="si">{0}</span><span class="s1"> received their new grid point...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">nstep</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">Niter</span><span class="p">:</span>
        <span class="c1"># Now we wait for one of the child processes to finish their grid point and send the result back to the root process so we can</span>
        <span class="c1"># sample a new point using that extra info</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">Status</span><span class="p">()</span>
        <span class="n">mesa_result</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">ANY_SOURCE</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">ANY_TAG</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">Get_source</span><span class="p">()</span>
        <span class="c1"># calculate some columns for convenience</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;initial_star_2_mass&#39;</span> <span class="ow">in</span> <span class="n">mesa_result</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;initial_star_1_mass&#39;</span> <span class="ow">in</span> <span class="n">mesa_result</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">mesa_result</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesa_result</span><span class="p">[</span><span class="s1">&#39;initial_star_2_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">mesa_result</span><span class="p">[</span><span class="s1">&#39;initial_star_1_mass&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;initial_period_days&#39;</span> <span class="ow">in</span> <span class="n">mesa_result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mesa_result</span><span class="p">[</span><span class="s1">&#39;log_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mesa_result</span><span class="p">[</span><span class="s1">&#39;initial_period_days&#39;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesa_result</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The version of POSYDON used to make the fixed grid psygrid object is likely different then the version psygrid object&quot;</span>
                             <span class="s2">&quot; being used for this dynamic grid run&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Process number </span><span class="si">{0}</span><span class="s1"> finished their run&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving grid data and sampling a new grid point...&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;grid_results.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sampling next grid point for process </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">proposed_points</span><span class="p">,</span> <span class="n">predicted_classes_of_points</span> <span class="o">=</span> <span class="n">get_next_grid_point</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">psycris_inifile</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">n_new_points</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># make a dataframe from the proposed points with the names of the columns</span>
        <span class="n">dynamic_grid_params</span> <span class="o">=</span> <span class="n">parse_inifile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">psycris_inifile</span><span class="p">)</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">proposed_points</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">dynamic_grid_params</span><span class="p">[</span><span class="s2">&quot;TableData_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">],)</span>

        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">convert_input_cols_to_mesa_cols</span><span class="p">(</span><span class="n">grid_df</span><span class="p">)</span>

        <span class="c1"># make a dict so we can send the information around</span>
        <span class="n">grid_dict</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sending process number </span><span class="si">{0}</span><span class="s1"> a new grid point...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">isend</span><span class="p">(</span><span class="n">grid_dict</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">child</span><span class="p">,)</span>
        <span class="n">req</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Process number </span><span class="si">{0}</span><span class="s1"> received their new grid point...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">nstep</span> <span class="o">+=</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="do_child_process_logic">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.do_child_process_logic">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_child_process_logic</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">star1_formation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">star2_formation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the logic that the child process does for the dynamic grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">irecv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="mi">0</span><span class="p">,)</span>
    <span class="n">grid_dict</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="c1"># per each type of grid value (i.e. binary control or job or star1 control or job etc)</span>
    <span class="c1"># create a dictionary of the column name and value for this grid point</span>
    <span class="n">binary_controls</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">grid_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grid_params_binary_controls</span><span class="p">}</span>
    <span class="n">binary_job</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">grid_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grid_params_binary_job</span><span class="p">}</span>

    <span class="n">star1_binary_controls</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">grid_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grid_params_star1_binary_controls</span><span class="p">}</span>
    <span class="n">star1_binary_job</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">grid_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grid_params_star1_binary_job</span><span class="p">}</span>

    <span class="n">star2_binary_controls</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">grid_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grid_params_star2_binary_controls</span><span class="p">}</span>
    <span class="n">star2_binary_job</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">grid_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grid_params_star2_binary_job</span><span class="p">}</span>

    <span class="n">grid_param_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">({},</span> <span class="n">binary_controls</span><span class="p">,</span> <span class="n">binary_job</span><span class="p">,</span> <span class="n">star1_binary_controls</span><span class="p">,</span> <span class="n">star1_binary_job</span><span class="p">,</span> <span class="n">star2_binary_controls</span><span class="p">,</span><span class="n">star2_binary_job</span><span class="p">))</span>

    <span class="n">grid_params_string</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">grid_param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Process </span><span class="si">{0}</span><span class="s2"> is running with </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">grid_params_string</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">mesa_result</span> <span class="o">=</span> <span class="n">run_grid_point</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">star1_formation</span><span class="p">,</span> <span class="n">star2_formation</span><span class="p">,</span>
                                 <span class="n">grid_param_dict</span><span class="p">,</span> <span class="n">binary_controls</span><span class="p">,</span> <span class="n">binary_job</span><span class="p">,</span>
                                 <span class="n">star1_binary_controls</span><span class="p">,</span> <span class="n">star1_binary_job</span><span class="p">,</span>
                                 <span class="n">star2_binary_controls</span><span class="p">,</span> <span class="n">star2_binary_job</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

   <span class="c1"># we now send the result data to the root node</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">mesa_result</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Job completed: From process </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>



<div class="viewcode-block" id="run_grid_point">
<a class="viewcode-back" href="../api_reference/posydon_run_grid.html#posydon_run_grid.run_grid_point">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_grid_point</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">star1_formation</span><span class="p">,</span> <span class="n">star2_formation</span><span class="p">,</span>
                   <span class="n">grid_param_dict</span><span class="p">,</span> <span class="n">binary_controls</span><span class="p">,</span> <span class="n">binary_job</span><span class="p">,</span>
                   <span class="n">star1_binary_controls</span><span class="p">,</span> <span class="n">star1_binary_job</span><span class="p">,</span>
                   <span class="n">star2_binary_controls</span><span class="p">,</span> <span class="n">star2_binary_job</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the logic to run this MESA grid point</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># based on the values create directory</span>
    <span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span> <span class="o">=</span> <span class="n">create_working_directory</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="c1"># are we first generating a model before running binary for the first star?</span>
    <span class="k">if</span> <span class="n">star1_formation</span><span class="p">:</span>
        <span class="c1"># if yes then create inlists specific to this grid points</span>
        <span class="c1"># moreover we should loop over all the star1 formation steps</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">inlist_step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_inlist_project</span><span class="p">):</span>
            <span class="c1"># this is only called to create single HeMS stars, only second step1</span>
            <span class="c1"># requires metallicity</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">create_star_formation</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">],</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">inlist_step</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">create_star_formation</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">],</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">inlist_step</span><span class="p">,</span> <span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;initial_z&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">run_mesa</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_executable</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">,</span> <span class="n">keep_work_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">outfile_name</span><span class="o">=</span><span class="s1">&#39;out_star1_formation_step</span><span class="si">{0}</span><span class="s1">.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

    <span class="c1"># are we first generating a model before running binary for the second star?</span>
    <span class="k">if</span> <span class="n">star2_formation</span><span class="p">:</span>
        <span class="c1"># if yes then create inlists specific to this grid points</span>
        <span class="c1"># moreover we should loop over all the star1 formation steps</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">inlist_step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star2_inlist_project</span><span class="p">):</span>
            <span class="c1"># this is only called to create single HeMS stars, only second step1</span>
            <span class="c1"># requires metallicity</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">create_star_formation</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;m2&#39;</span><span class="p">],</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">inlist_step</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">create_star_formation</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;m2&#39;</span><span class="p">],</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">inlist_step</span><span class="p">,</span> <span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;initial_z&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">run_mesa</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star2_executable</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">,</span> <span class="n">keep_work_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">outfile_name</span><span class="o">=</span><span class="s1">&#39;out_star2_formation_step</span><span class="si">{0}</span><span class="s1">.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

    <span class="c1"># now we can create the grid specific binary inlists and run the binary executable</span>
    <span class="n">create_binary_inlists</span><span class="p">(</span><span class="n">binary_controls</span><span class="p">,</span> <span class="n">binary_job</span><span class="p">,</span>
                          <span class="n">star1_binary_controls</span><span class="p">,</span> <span class="n">star1_binary_job</span><span class="p">,</span>
                          <span class="n">star2_binary_controls</span><span class="p">,</span> <span class="n">star2_binary_job</span><span class="p">,</span>
                          <span class="n">work_dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">mesa_binary_inlist_project</span><span class="p">)</span>

    <span class="c1"># run the binary exectuable</span>
    <span class="n">run_mesa</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_binary_executable</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">,</span>
             <span class="n">keep_profiles</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">keep_profiles</span><span class="p">,</span> <span class="n">keep_photos</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">keep_photos</span><span class="p">,</span>
             <span class="n">job_end</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">job_end</span><span class="p">,</span> <span class="n">job_before_end</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">job_before_end</span><span class="p">)</span>

    <span class="c1"># find out what happened</span>
    <span class="n">mesa_result</span> <span class="o">=</span> <span class="n">extract_mesa_results</span><span class="p">(</span><span class="n">final_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mesa_result</span></div>


<span class="c1">###############################################################################</span>
<span class="c1"># BEGIN MAIN FUNCTION</span>
<span class="c1">###############################################################################</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># check MPI was imported</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">MPI_IMPORTED</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;MPI module mpi4py not installed! Plese check your POSYDON installation!&#39;</span><span class="p">)</span>

    <span class="c1"># READ COMMANDLINE ARGUMENTS</span>
    <span class="c1">###########################################################################</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_commandline</span><span class="p">()</span>
    <span class="c1"># do to the fact that the arguments args.mesa_star2_inlist_project and args.mesa_star1_inlist_project</span>
    <span class="c1"># are interpreted as lists when you supply None it stringifies it and makes it a list</span>
    <span class="k">if</span> <span class="s1">&#39;None&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_inlist_project</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_inlist_project</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;None&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">mesa_star2_inlist_project</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mesa_star2_inlist_project</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_executable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_inlist_project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Then we must first make star1 model before running binary executable</span>
        <span class="n">star1_formation</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">star1_formation</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star2_executable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star2_inlist_project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Then we must first make star2 model before running binary executable</span>
        <span class="n">star2_formation</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">star2_formation</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># read in grid</span>
    <span class="k">if</span> <span class="s1">&#39;.csv&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">mesa_grid</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_grid</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;.h5&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">mesa_grid</span><span class="p">:</span>
        <span class="n">psy_grid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">()</span>
        <span class="n">psy_grid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_grid</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">psy_grid</span><span class="o">.</span><span class="n">get_pandas_initial_final</span><span class="p">()</span>
        <span class="n">psy_grid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Grid format not recognized, please feed in an acceptable format: csv&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">:</span>
        <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">Get_processor_name</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You can not have multiple MPI tasks and &quot;</span>
                             <span class="s2">&quot;request to run a specific grid point.&quot;</span>
                             <span class="s2">&quot;Please make sure you cal with mpirun -np 1.&quot;</span><span class="p">)</span>

    <span class="c1"># identify all columns in the CSV file which effect MESA controls, i.e. what all the parameter</span>
    <span class="c1"># values that change simulation to simulation are</span>
    <span class="n">binary_inlist_params</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_binary_inlist_project</span><span class="p">)</span>
    <span class="n">star1_binary_params</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_binary_inlist1</span><span class="p">)</span>
    <span class="n">star2_binary_params</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_binary_inlist2</span><span class="p">)</span>

    <span class="n">final_binary_controls</span> <span class="o">=</span> <span class="n">binary_inlist_params</span><span class="p">[</span><span class="s1">&#39;&amp;binary_controls&#39;</span><span class="p">]</span>
    <span class="n">final_binary_job</span> <span class="o">=</span> <span class="n">binary_inlist_params</span><span class="p">[</span><span class="s1">&#39;&amp;binary_job&#39;</span><span class="p">]</span>
    <span class="n">final_star1_binary_controls</span> <span class="o">=</span> <span class="n">star1_binary_params</span><span class="p">[</span><span class="s1">&#39;&amp;controls&#39;</span><span class="p">]</span>
    <span class="n">final_star1_binary_job</span> <span class="o">=</span> <span class="n">star1_binary_params</span><span class="p">[</span><span class="s1">&#39;&amp;star_job&#39;</span><span class="p">]</span>
    <span class="n">final_star2_binary_controls</span> <span class="o">=</span> <span class="n">star2_binary_params</span><span class="p">[</span><span class="s1">&#39;&amp;controls&#39;</span><span class="p">]</span>
    <span class="n">final_star2_binary_job</span> <span class="o">=</span> <span class="n">star2_binary_params</span><span class="p">[</span><span class="s1">&#39;&amp;star_job&#39;</span><span class="p">]</span>

    <span class="c1"># detemine which is any of the parameters are binary_controls or binary_job params</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">:</span>
        <span class="n">dynamic_grid_params</span> <span class="o">=</span> <span class="n">parse_inifile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">psycris_inifile</span><span class="p">)</span>
        <span class="n">mesa_params_to_run_grid_over</span> <span class="o">=</span> <span class="n">dynamic_grid_params</span><span class="p">[</span><span class="s2">&quot;posydon_dynamic_sampling_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;mesa_column_names&quot;</span><span class="p">]</span>
        <span class="n">grid_params_binary_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">mesa_params_to_run_grid_over</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_binary_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">grid_params_binary_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">mesa_params_to_run_grid_over</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_binary_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="n">grid_params_star1_binary_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">mesa_params_to_run_grid_over</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star1_binary_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">grid_params_star1_binary_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">mesa_params_to_run_grid_over</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star1_binary_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="n">grid_params_star2_binary_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">mesa_params_to_run_grid_over</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star2_binary_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">grid_params_star2_binary_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">mesa_params_to_run_grid_over</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star2_binary_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">grid_params_binary_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_binary_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">grid_params_binary_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_binary_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="n">grid_params_star1_binary_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star1_binary_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">grid_params_star1_binary_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star1_binary_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="n">grid_params_star2_binary_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star2_binary_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">grid_params_star2_binary_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star2_binary_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="c1"># check if we are running a single star grid!</span>
    <span class="k">if</span> <span class="n">star1_formation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">grid_params_binary_controls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">grid_params_binary_job</span><span class="p">)):</span>
        <span class="c1"># we need to check for something other than m1, we want to be looking for initial_mass</span>
        <span class="c1"># identify all columns in the CSV file which effect MESA controls, i.e. what all the parameter</span>
        <span class="c1"># values that change simulation to simulation are</span>
        <span class="n">star1_formation_params</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_inlist_project</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">final_star1_formation_controls</span> <span class="o">=</span> <span class="n">star1_formation_params</span><span class="p">[</span><span class="s1">&#39;&amp;controls&#39;</span><span class="p">]</span>
        <span class="n">final_star1_formation_job</span> <span class="o">=</span> <span class="n">star1_formation_params</span><span class="p">[</span><span class="s1">&#39;&amp;star_job&#39;</span><span class="p">]</span>

        <span class="c1"># detemine which is any of the parameters are formation_controls or formation_job params</span>
        <span class="n">grid_params_star1_formation_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star1_formation_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">grid_params_star1_formation_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star1_formation_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="n">star1_formation_controls</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span><span class="p">][</span><span class="n">grid_params_star1_formation_controls</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">star1_formation_job</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span><span class="p">][</span><span class="n">grid_params_star1_formation_job</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">grid_param_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">({},</span> <span class="n">star1_formation_controls</span><span class="p">,</span> <span class="n">star1_formation_job</span><span class="p">,))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You are running a single star grid, we are checking for what parameters you are varying in your grid&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star1_formation_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star1_formation_controls</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star1_formation_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star1_formation_job</span><span class="p">)))</span>

        <span class="c1"># based on the values create directory</span>
        <span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span> <span class="o">=</span> <span class="n">create_working_directory</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="c1"># run the single star grid</span>
        <span class="n">last_step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_inlist_project</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">inlist_step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_inlist_project</span><span class="p">):</span>
            <span class="c1"># single_HMS star has only step0, metallicity is required but not new_Z</span>
            <span class="c1"># single_HeMS star has step0, step1, step2, last two steps require metallicity</span>
            <span class="c1"># but only step1 requires new_Z</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">last_step</span><span class="p">:</span>
                <span class="n">create_star_formation</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">],</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">inlist_step</span><span class="p">,</span> <span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;initial_z&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">create_star_formation</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">],</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">inlist_step</span><span class="p">,</span> <span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;initial_z&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">create_star_formation</span><span class="p">(</span><span class="n">grid_param_dict</span><span class="p">[</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">],</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">inlist_step</span><span class="p">)</span>
            <span class="n">run_mesa</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mesa_star1_executable</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">final_dir</span><span class="p">,</span>
                     <span class="n">outfile_name</span><span class="o">=</span><span class="s1">&#39;out_star1_formation_step</span><span class="si">{0}</span><span class="s1">.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
                     <span class="n">keep_profiles</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">keep_profiles</span><span class="p">,</span> <span class="n">keep_photos</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">keep_photos</span><span class="p">,</span>
                     <span class="n">job_end</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">job_end</span><span class="p">,</span> <span class="n">job_before_end</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">job_before_end</span><span class="p">,</span>
                     <span class="n">keep_work_dir</span><span class="o">=</span><span class="n">index</span><span class="o">&lt;</span><span class="n">last_step</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># only print this information is this is the root process</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect binary_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_binary_controls</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect binary_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_binary_job</span><span class="p">)))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star1_binary_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star1_binary_controls</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star1_binary_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star1_binary_job</span><span class="p">)))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star2_binary_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star2_binary_controls</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star2_binary_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star2_binary_job</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect binary_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_binary_controls</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect binary_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_binary_job</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star1_binary_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star1_binary_controls</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star1_binary_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star1_binary_job</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star2_binary_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star2_binary_controls</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star2_binary_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star2_binary_job</span><span class="p">)))</span>

    <span class="c1"># calculate some columns for convenience</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;m2&#39;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;m1&#39;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;m2&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;initial_period_in_days&#39;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;log_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;initial_period_in_days&#39;</span><span class="p">])</span>

    <span class="c1"># calculate some columns for convenience</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;initial_star_2_mass&#39;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;initial_star_1_mass&#39;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;initial_star_2_mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;initial_star_1_mass&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;initial_period_days&#39;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;log_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;initial_period_days&#39;</span><span class="p">])</span>

    <span class="c1"># if we are using a job array or just running a single point of grid</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># per each type of grid value (i.e. binary control or job or star1 control or job etc)</span>
        <span class="c1"># create a dictionary of the column name and value for this grid point</span>
        <span class="n">binary_controls</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span><span class="p">][</span><span class="n">grid_params_binary_controls</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">binary_job</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span><span class="p">][</span><span class="n">grid_params_binary_job</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">star1_binary_controls</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span><span class="p">][</span><span class="n">grid_params_star1_binary_controls</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">star1_binary_job</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span><span class="p">][</span><span class="n">grid_params_star1_binary_job</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">star2_binary_controls</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span><span class="p">][</span><span class="n">grid_params_star2_binary_controls</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">star2_binary_job</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">grid_point_index</span><span class="p">][</span><span class="n">grid_params_star2_binary_job</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">grid_param_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">({},</span> <span class="n">binary_controls</span><span class="p">,</span> <span class="n">binary_job</span><span class="p">,</span> <span class="n">star1_binary_controls</span><span class="p">,</span> <span class="n">star1_binary_job</span><span class="p">,</span> <span class="n">star2_binary_controls</span><span class="p">,</span><span class="n">star2_binary_job</span><span class="p">))</span>

        <span class="n">mesa_result</span> <span class="o">=</span> <span class="n">run_grid_point</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">star1_formation</span><span class="p">,</span> <span class="n">star2_formation</span><span class="p">,</span>
                                     <span class="n">grid_param_dict</span><span class="p">,</span> <span class="n">binary_controls</span><span class="p">,</span> <span class="n">binary_job</span><span class="p">,</span>
                                     <span class="n">star1_binary_controls</span><span class="p">,</span> <span class="n">star1_binary_job</span><span class="p">,</span>
                                     <span class="n">star2_binary_controls</span><span class="p">,</span> <span class="n">star2_binary_job</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mesa_result</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">mesa_results_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;grid_results.csv&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mesa_results_file</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mesa_results_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">mesa_result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mesa_results_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">mesa_result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># If we are running a dynamic grid and/or using a single MPI task to manage all grid points</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">do_root_process_logic</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">grid_params_binary_controls</span><span class="p">,</span> <span class="n">grid_params_binary_job</span><span class="p">,</span>
                                      <span class="n">grid_params_star1_binary_controls</span><span class="p">,</span> <span class="n">grid_params_star1_binary_job</span><span class="p">,</span>
                                      <span class="n">grid_params_star2_binary_controls</span><span class="p">,</span> <span class="n">grid_params_star2_binary_job</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">do_child_process_logic</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">star1_formation</span><span class="o">=</span><span class="n">star1_formation</span><span class="p">,</span> <span class="n">star2_formation</span><span class="o">=</span><span class="n">star2_formation</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Tassos Fragos.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      Version: 2.1.7
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        
        <dl>
            <dt> v2</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v2.0.6/index.html">2.0</a></dd>
            
            <dd><a href="https://posydon.org/POSYDON/v2.1.7/index.html">2.1</a></dd>
            
        </dl>
        
        <dl>
            <dt> v1</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v1.0.5/index.html">1.0</a></dd>
            
        </dl>
        
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>