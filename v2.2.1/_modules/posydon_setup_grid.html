

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>posydon_setup_grid &mdash; posydon 2.2.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=9430f4b5" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=16656018"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/posydon_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction-acknowledgements/intro.html">Introduction, Objectives, and Scope</a></li>
<li class="toctree-l1"><a class="reference external" href="https://posydon.org/team.html">Collaborative Team</a></li>
<li class="toctree-l1"><a class="reference external" href="https://ui.adsabs.harvard.edu/public-libraries/ZZsD9bzLTzWnLV3hwyJxbA">Publications</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-grids.html">Quick Start: Examining the MESA Grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-population.html">Quick Start: Your First Population</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials and Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/population-synthesis/binary-pop-syn.html">Binary-Star Population Synthesis with POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/generating-datasets/generating-datasets.html">Crafting the Core Datasets for POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/MESA-grids/running-grids.html">Architecting MESA Simulation Grids with POSYDON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">POSYDON school material</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON-class-materials-2025">POSYDON School 2025</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">In-Depth Components Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/mesa-grids.html">MESA Grids API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/processing-pipeline.html">Processing Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/machine-learning-components.html">Machine Learning Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/stellar-binary-simulation.html">Stellar &amp; Binary-star Simulation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/posydon.html">posydon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/bin.html">executables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases and Datasets</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON/releases">Releases</a></li>
<li class="toctree-l1"><a class="reference external" href="https://zenodo.org/communities/posydon/">Datasets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support and Contact</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contact-support/contact-information.html">Contact Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting-faqs/installation-issues.html">Common Installation Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting-faqs/code-questions.html">Code Usage Questions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON/issues/new/choose">Report an Issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/how-to-contribute.html">How To Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">posydon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">posydon_setup_grid</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for posydon_setup_grid</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">##############################################################################</span>
<span class="c1">#  IMPORT ALL NECESSARY PYTHON PACKAGES</span>
<span class="c1">##############################################################################</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.active_learning.psy_cris.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_inifile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.grids.psygrid</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSyGrid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">configfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">gridutils</span> <span class="k">as</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.posydonwarning</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pwarn</span>


<span class="c1">###############################################################################</span>
<span class="c1"># DEFINE COMMANDLINE ARGUMENTS</span>
<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="parse_commandline">
<a class="viewcode-back" href="../api_reference/posydon_setup_grid.html#posydon_setup_grid.parse_commandline">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_commandline</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse the arguments given on the command-line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--inifile&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of ini file of params&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--grid-type&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Either you are supplying a grid &quot;</span>
                        <span class="s2">&quot;of points to run MESA on (fixed) or you are supplying a pre computed MESA &quot;</span>
                        <span class="s2">&quot;grid and want to sample new points to run MESA on (dynamic).&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--run-directory&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path where executable will be made and MESA &quot;</span>
                             <span class="s2">&quot;simulation output will be placed&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--submission-type&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Options include creating a shell script or a slurm script&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;shell&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--nproc&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of processors&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run in Verbose Mode&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;--grid-type must be either fixed or dynamic&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">submission_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">,</span> <span class="s1">&#39;shell&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;--submission-type must be either slurm of shell&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">args</span></div>


<div class="viewcode-block" id="find_inlist_from_scenario">
<a class="viewcode-back" href="../api_reference/posydon_setup_grid.html#posydon_setup_grid.find_inlist_from_scenario">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_inlist_from_scenario</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">gitcommit</span><span class="p">,</span> <span class="n">system_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dynamically find the inlists the user wants to from the supplied info</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">        source:</span>

<span class="sd">        gitcommit:</span>

<span class="sd">        system_type:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># note the directory we are in now</span>
    <span class="n">where_am_i_now</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are going to dynamically fetch the posydon inlists based on your scenario&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;posydon&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You have selected posydon as your source&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;checking if we have already cloned POSYDON-MESA-INLISTS for you&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/.posydon_mesa_inlists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">])):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are clonining the repo for you&quot;</span><span class="p">)</span>
            <span class="c1"># Determine location of executables</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;clone&#39;</span><span class="p">,</span> <span class="s1">&#39;https://github.com/POSYDON-code/POSYDON-MESA-INLISTS.git&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/.posydon_mesa_inlists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">])],</span>
                                         <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                         <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                         <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                                     <span class="p">)</span>
            <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;git repository is already there, using that&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>

        <span class="n">inlists_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/.posydon_mesa_inlists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">])</span>
        <span class="n">branch</span> <span class="o">=</span> <span class="n">gitcommit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">githash</span> <span class="o">=</span> <span class="n">gitcommit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You have selected user as your source &quot;</span>
              <span class="s2">&quot;checking if we have already cloned USER-MESA-INLISTS for you &quot;</span>
              <span class="s2">&quot;Validating the name of the git hash you want to use...&quot;</span>
              <span class="s2">&quot;must be of format &#39;branch-githash&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gitcommit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You have supplied an invalid user gitcommit format, must be of format &#39;branch-githash&#39;&quot;</span><span class="p">)</span>

        <span class="n">branch</span> <span class="o">=</span> <span class="n">gitcommit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">githash</span> <span class="o">=</span> <span class="n">gitcommit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/.user_mesa_inlists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">])):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are clonining the repo for you&quot;</span><span class="p">)</span>
            <span class="c1"># Determine location of executables</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;clone&#39;</span><span class="p">,</span> <span class="s1">&#39;https://github.com/POSYDON-code/USER-MESA-INLISTS.git&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/.user_mesa_inlists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">])],</span>
                                         <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                         <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                         <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                                     <span class="p">)</span>
            <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;git repository is already there, using that&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>

        <span class="n">inlists_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/.user_mesa_inlists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">])</span>
        <span class="n">branch</span> <span class="o">=</span> <span class="n">gitcommit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">githash</span> <span class="o">=</span> <span class="n">gitcommit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;supplied source is not valid/understood. Valid sources are user and posydon&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">inlists_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;checking out branch: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">branch</span><span class="p">))</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;checkout&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">branch</span><span class="p">)],</span>
                                 <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                             <span class="p">)</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For posterity we are pulling (specifically needed if you already have the repo clone)&quot;</span><span class="p">)</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;pull&#39;</span><span class="p">],</span>
                                 <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                             <span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;checking out commit/tag: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">githash</span><span class="p">))</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;checkout&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">githash</span><span class="p">)],</span>
                                 <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                             <span class="p">)</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="c1"># if this is looking at posydon defaults, all posydon defaults build from default common inlists</span>
    <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;posydon&#39;</span><span class="p">:</span>
        <span class="n">inlists_location_common</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">/</span><span class="si">{2}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_dir</span><span class="p">,</span> <span class="s1">&#39;r11701&#39;</span><span class="p">,</span> <span class="s2">&quot;default_common_inlists&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Based on system_type </span><span class="si">{0}</span><span class="s2"> &quot;</span>
              <span class="s2">&quot;We are populating the posydon inlists in the following directory: &quot;</span>
              <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">system_type</span><span class="p">,</span> <span class="n">inlists_location_common</span><span class="p">))</span>

        <span class="n">inlist1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inlist1</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inlist1</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># check if we also need to find the location of the zams.data file</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;zams_filename&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ZAMS_FILENAME detected, setting mesa_inlists[&#39;zams_filename&#39;] for star 1&quot;</span><span class="p">)</span>
                        <span class="n">zams_filename_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">zams_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_dir</span><span class="p">,</span> <span class="s1">&#39;r11701&#39;</span><span class="p">,</span> <span class="s2">&quot;ZAMS_models&quot;</span><span class="p">,</span> <span class="n">zams_filename_1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">zams_file_path</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Verified locations of ZAMS data file, </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zams_file_path</span><span class="p">))</span>
                            <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zams_file_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running Single Grid: Setting mesa_star1_extras to </span><span class="si">{0}</span><span class="s2">/binary/src/run_star_extras.f&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">))</span>

        <span class="n">inlist2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist2&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inlist2</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inlist2</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># check if we also need to find the location of the zams.data file</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;zams_filename&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ZAMS_FILENAME detected, setting mesa_inlists[&#39;zams_filename&#39;] for star 2&quot;</span><span class="p">)</span>
                        <span class="n">zams_filename_2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">zams_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_dir</span><span class="p">,</span> <span class="s1">&#39;r11701&#39;</span><span class="p">,</span> <span class="s2">&quot;ZAMS_models&quot;</span><span class="p">,</span> <span class="n">zams_filename_2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">zams_file_path</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Verified locations of ZAMS data file, </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zams_file_path</span><span class="p">))</span>
                            <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zams_file_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running Single Grid: Setting mesa_star2_extras to </span><span class="si">{0}</span><span class="s2">/binary/src/run_star_extras.f&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">))</span>


        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating inifile values&quot;</span><span class="p">)</span>
        <span class="c1"># binary inlists</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_controls_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_job_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_controls_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_job_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;binary_controls_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist_project&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;binary_job_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist_project&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>

        <span class="c1"># columns</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star_history_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/history_columns.list&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;binary_history_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary_history_columns.list&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;profile_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/profile_columns.list&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>

        <span class="c1"># executables</span>
        <span class="n">mesa_extras</span><span class="p">[</span><span class="s1">&#39;posydon_binary_extras&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/src/run_binary_extras.f&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>
        <span class="n">mesa_extras</span><span class="p">[</span><span class="s1">&#39;posydon_star_binary_extras&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/src/run_star_extras.f&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>

        <span class="n">mesa_extras</span><span class="p">[</span><span class="s2">&quot;mesa_star1_extras&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/src/run_star_extras.f&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)</span>

        <span class="c1"># so this is sufficient for system type HMS-HMS but not for others, for others we stack the above inlists on further inlists</span>
        <span class="c1"># we also need to see if we are looking at a folder for binaries or singles</span>
        <span class="k">if</span> <span class="n">system_type</span> <span class="o">==</span> <span class="s1">&#39;HeMS-HMS&#39;</span><span class="p">:</span>
            <span class="n">inlists_location</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">/</span><span class="si">{2}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_dir</span><span class="p">,</span> <span class="s1">&#39;r11701&#39;</span><span class="p">,</span> <span class="n">system_type</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Based on system_type </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                  <span class="s2">&quot;We are populating the user inlists in the following directory: &quot;</span>
                  <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">system_type</span><span class="p">,</span> <span class="n">inlists_location</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist1&quot;</span><span class="p">)):</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_controls_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist1&quot;</span><span class="p">))</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_job_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist1&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist2&quot;</span><span class="p">)):</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_controls_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist2&quot;</span><span class="p">))</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_job_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist2&quot;</span><span class="p">))</span>

            <span class="c1"># check for star formation parameters</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;star1_formation&quot;</span><span class="p">)):</span>
                <span class="c1"># We are making star1 so we can unset the zams file we were going to use for star1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are making star1 so we can unset the zams file we were going to use for star1&quot;</span><span class="p">)</span>
                <span class="c1"># print()</span>
                <span class="c1"># print(&quot;HERE&quot;)</span>
                <span class="c1"># print()</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Figure out how many user star1 formation steps there are and layer the posydon default inlists on all of them</span>
                <span class="n">star1_formation_scenario</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;star1_formation&quot;</span><span class="p">,</span> <span class="s2">&quot;*step*&quot;</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These are the user we are using to make star1: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_formation_scenario</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are going to add a layer of posydon default common inlists to these user steps: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)))</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_controls_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_job_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star1_formation_scenario</span><span class="p">)):</span>
                    <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_controls_posydon_defaults&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">))</span>
                    <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_job_posydon_defaults&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">))</span>

                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_controls_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star1_formation_scenario</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_job_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star1_formation_scenario</span>

        <span class="k">elif</span> <span class="n">system_type</span> <span class="o">!=</span> <span class="s2">&quot;HMS-HMS&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;single_star_grid&#39;</span><span class="p">]:</span>
            <span class="n">inlists_location</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">/</span><span class="si">{2}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_dir</span><span class="p">,</span> <span class="s1">&#39;r11701&#39;</span><span class="p">,</span> <span class="n">system_type</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Based on system_type </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                  <span class="s2">&quot;We are populating the user inlists in the following directory: &quot;</span>
                  <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">system_type</span><span class="p">,</span> <span class="n">inlists_location</span><span class="p">))</span>

            <span class="c1"># determine where the binary inlist(s) are</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist_project&quot;</span><span class="p">)):</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;binary_controls_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist_project&quot;</span><span class="p">))</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;binary_job_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist_project&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist1&quot;</span><span class="p">)):</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_controls_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist1&quot;</span><span class="p">))</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_job_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist1&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist2&quot;</span><span class="p">)):</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_controls_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist2&quot;</span><span class="p">))</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_job_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;inlist2&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;history_columns.list&quot;</span><span class="p">)):</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star_history_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;history_columns.list&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary_history_columns.list&quot;</span><span class="p">)):</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;binary_history_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;binary_history_columns.list&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;profile_columns.list&quot;</span><span class="p">)):</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;profile_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;profile_columns.list&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;run_binary_extras.f&quot;</span><span class="p">)):</span>
                <span class="n">mesa_extras</span><span class="p">[</span><span class="s1">&#39;user_binary_extras&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;run_binary_extras.f&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;run_star_extras.f&quot;</span><span class="p">)):</span>
                <span class="n">mesa_extras</span><span class="p">[</span><span class="s1">&#39;user_star_binary_extras&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;run_star_extras.f&quot;</span><span class="p">))</span>

            <span class="c1"># check for star formation parameters</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;star1_formation&quot;</span><span class="p">)):</span>
                <span class="c1"># We are making star1 so we can unset the zams file we were going to use for star1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are making star1 so we can unset the zams file we were going to use for star1&quot;</span><span class="p">)</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Figure out how many user star1 formation steps there are and layer the posydon default inlists on all of them</span>
                <span class="n">star1_formation_scenario</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;star1_formation&quot;</span><span class="p">,</span> <span class="s2">&quot;*step*&quot;</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These are the user we are using to make star1: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_formation_scenario</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are going to add a layer of posydon default common inlists to these user steps: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)))</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_controls_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_job_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star1_formation_scenario</span><span class="p">)):</span>
                    <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_controls_posydon_defaults&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">))</span>
                    <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_job_posydon_defaults&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">))</span>

                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_controls_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star1_formation_scenario</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_formation_job_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star1_formation_scenario</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;star2_formation&quot;</span><span class="p">)):</span>
                <span class="c1"># We are making star2 so we can unset the zams file we were going to use for star2</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are making star2 so we can unset the zams file we were going to use for star2&quot;</span><span class="p">)</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Figure out how many user star2 formation steps there are and layer the posydon default inlists on all of them</span>
                <span class="n">star2_formation_scenario</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;star2_formation&quot;</span><span class="p">,</span> <span class="s2">&quot;*step*&quot;</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These are the user we are using to make star2: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_formation_scenario</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are going to add a layer of posydon default common inlists to these user steps: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">)))</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_formation_controls_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_formation_job_posydon_defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star2_formation_scenario</span><span class="p">)):</span>
                    <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_formation_controls_posydon_defaults&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">))</span>
                    <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_formation_job_posydon_defaults&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/binary/inlist1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_location_common</span><span class="p">))</span>

                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_formation_controls_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star2_formation_scenario</span>
                <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star2_formation_job_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star2_formation_scenario</span>

        <span class="k">if</span> <span class="n">system_type</span> <span class="o">==</span> <span class="s2">&quot;HMS-HMS&quot;</span> <span class="ow">and</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;single_star_grid&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You want a single star HMS grid, this means that we need to make a user inlist on the fly with a single line &quot;</span>
                  <span class="s2">&quot;x_logical_ctrl(1)=.true.&quot;</span><span class="p">)</span>
            <span class="c1"># write star1 formation step to file</span>
            <span class="n">special_single_star_user_inlist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;special_single_star_user_inlist&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">special_single_star_user_inlist</span><span class="p">):</span>
                <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">special_single_star_user_inlist</span><span class="p">,</span>
                      <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">special_single_star_user_inlist</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;controls</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;x_logical_ctrl(1)&quot;</span><span class="p">,</span> <span class="s2">&quot;.true.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        / ! end of star1_controls namelist</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_controls_special&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">special_single_star_user_inlist</span>
        <span class="k">elif</span> <span class="n">system_type</span> <span class="o">==</span> <span class="s2">&quot;CO-He_star&quot;</span> <span class="ow">and</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;single_star_grid&#39;</span><span class="p">]:</span>
            <span class="n">inlists_location</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">/</span><span class="si">{2}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlists_dir</span><span class="p">,</span> <span class="s1">&#39;r11701&#39;</span><span class="p">,</span> <span class="n">system_type</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Based on system_type </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                  <span class="s2">&quot;We are populating the user inlists in the following directory: &quot;</span>
                  <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">system_type</span><span class="p">,</span> <span class="n">inlists_location</span><span class="p">))</span>

            <span class="c1"># We are making star2 so we can unset the zams file we were going to use for star2</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are making star2 so we can unset the zams file we were going to use for star2&quot;</span><span class="p">)</span>
            <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Find the user single star controls</span>
            <span class="n">single_star_scenario</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inlists_location</span><span class="p">,</span> <span class="s2">&quot;star1_formation&quot;</span><span class="p">,</span> <span class="s2">&quot;*step*&quot;</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These are the user inlists used in the single star grid: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">single_star_scenario</span><span class="p">))</span>
            <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_controls_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_star_scenario</span>
            <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_job_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_star_scenario</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You want a single star He grid, &quot;</span>
                  <span class="s2">&quot;this means that we need to make the inlist that will be used to evolve the system &quot;</span>
                  <span class="s2">&quot;and make sure we layer on the line &quot;</span>
                  <span class="s2">&quot;x_logical_ctrl(1)=.true.&quot;</span><span class="p">)</span>
            <span class="c1"># write star1 formation step to file</span>
            <span class="n">special_single_star_user_inlist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;special_single_star_user_inlist&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">special_single_star_user_inlist</span><span class="p">):</span>
                <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">special_single_star_user_inlist</span><span class="p">,</span>
                      <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">special_single_star_user_inlist</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;controls</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;x_logical_ctrl(1)&quot;</span><span class="p">,</span> <span class="s2">&quot;.true.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        / ! end of star1_controls namelist</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;star_job</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        / / ! end of star_job namelist</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star1_controls_special&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">special_single_star_user_inlist</span><span class="p">)</span>

    <span class="c1"># change back to where I was</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">where_am_i_now</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="construct_static_inlist">
<a class="viewcode-back" href="../api_reference/posydon_setup_grid.html#posydon_setup_grid.construct_static_inlist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">construct_static_inlist</span><span class="p">(</span><span class="n">mesa_inlists</span><span class="p">,</span> <span class="n">grid_parameters</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Based on all the inlists that were passed construc the MESA project dir</span>

<span class="sd">    Parameters</span>
<span class="sd">        mesa_inlists:</span>
<span class="sd">            All of the values from the mesa_inlists section of the inifile (`dict`)</span>

<span class="sd">        grid_parameters:</span>
<span class="sd">            A list of the parameters from the csv file so we can determine all of</span>
<span class="sd">            the inlist parameters for binary, star1 and star2 that will be changing</span>
<span class="sd">            with this grid</span>

<span class="sd">    Returns:</span>
<span class="sd">        inlists</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># To make it backwards compatible</span>
    <span class="k">if</span> <span class="s1">&#39;zams_filename&#39;</span> <span class="ow">in</span> <span class="n">mesa_inlists</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename&#39;</span><span class="p">]</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;zams_filename_1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesa_inlists</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s1">&#39;zams_filename_2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesa_inlists</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s1">&#39;single_star_grid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesa_inlists</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;single_star_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">########################################</span>
    <span class="c1">### CONSTRUCT BINARY INLIST PARAMS   ###</span>
    <span class="c1">########################################</span>

    <span class="c1"># inlist project controls binary_job and binary_controls</span>
    <span class="n">inlist_binary_project</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist_project&#39;</span><span class="p">)</span>
    <span class="c1"># inlist1 (controls star_job1 and star_controls1</span>
    <span class="n">inlist_star1_binary</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist1&#39;</span><span class="p">)</span>
    <span class="c1"># inlist1 (controls star_job2 and star_controls2</span>
    <span class="n">inlist_star2_binary</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist2&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize some stuff</span>
    <span class="n">final_binary_controls</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">final_binary_job</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">final_star1_binary_job</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">final_star2_binary_job</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">final_star1_binary_controls</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">final_star2_binary_controls</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;single_star_grid&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesa_inlists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;binary_controls&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;binary_controls&#39;</span>
                    <span class="n">controls_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">controls_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="n">final_binary_controls</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

                <span class="k">elif</span> <span class="s1">&#39;binary_job&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;binary_job&#39;</span>
                    <span class="n">job_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">job_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="n">final_binary_job</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

                <span class="k">elif</span> <span class="s1">&#39;star1_job&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;star_job&#39;</span>
                    <span class="n">star_job1_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">star_job1_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

                <span class="k">elif</span> <span class="s1">&#39;star2_job&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;star_job&#39;</span>
                    <span class="n">star_job2_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">star_job2_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

                <span class="k">elif</span> <span class="s1">&#39;star1_controls&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;controls&#39;</span>
                    <span class="n">star_control1_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">star_control1_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="k">if</span> <span class="s1">&#39;num_x_ctrls&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">:</span>
                            <span class="c1"># This is a special default that the default value in the .defaults</span>
                            <span class="c1"># file in MESA does not work because it is a placeholder</span>
                            <span class="n">final_star1_binary_controls</span><span class="p">[</span><span class="n">k1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;num_x_ctrls&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">final_star1_binary_controls</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

                <span class="k">elif</span> <span class="s1">&#39;star2_controls&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;controls&#39;</span>
                    <span class="n">star_control2_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">star_control2_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="k">if</span> <span class="s1">&#39;num_x_ctrls&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">:</span>
                            <span class="c1"># This is a special default that the default value in the .defaults</span>
                            <span class="c1"># file in MESA does not work because it is a placeholder</span>
                            <span class="n">final_star2_binary_controls</span><span class="p">[</span><span class="n">k1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;num_x_ctrls&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">final_star2_binary_controls</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

        <span class="c1"># detemine which is any of the parameters are binary_controls or binary_job params</span>
        <span class="n">grid_params_binary_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid_parameters</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_binary_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect binary_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_binary_controls</span><span class="p">)))</span>
        <span class="n">grid_params_binary_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid_parameters</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_binary_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect binary_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_binary_job</span><span class="p">)))</span>

        <span class="n">grid_params_star1_binary_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid_parameters</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star1_binary_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star1_binary_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star1_binary_controls</span><span class="p">)))</span>
        <span class="n">grid_params_star1_binary_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid_parameters</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star1_binary_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star1_binary_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star1_binary_job</span><span class="p">)))</span>

        <span class="n">grid_params_star2_binary_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid_parameters</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star2_binary_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star2_binary_controls: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star2_binary_controls</span><span class="p">)))</span>
        <span class="n">grid_params_star2_binary_job</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grid_parameters</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">final_star2_binary_job</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid parameters that effect star2_binary_job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grid_params_star2_binary_job</span><span class="p">)))</span>

        <span class="c1"># depending on if there are any grid parameters that effect star1 or star2 we need to actually</span>
        <span class="c1"># do a read star extras step</span>
        <span class="k">if</span> <span class="n">grid_params_star1_binary_controls</span><span class="p">:</span>
            <span class="n">final_star1_binary_controls</span><span class="p">[</span><span class="s1">&#39;read_extra_controls_inlist1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.true.&#39;</span>
            <span class="n">final_star1_binary_controls</span><span class="p">[</span><span class="s1">&#39;extra_controls_inlist1_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;inlist_grid_star1_binary_controls&#39;&quot;</span>

        <span class="k">if</span> <span class="n">grid_params_star2_binary_controls</span><span class="p">:</span>
            <span class="n">final_star2_binary_controls</span><span class="p">[</span><span class="s1">&#39;read_extra_controls_inlist1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.true.&#39;</span>
            <span class="n">final_star2_binary_controls</span><span class="p">[</span><span class="s1">&#39;extra_controls_inlist1_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;inlist_grid_star2_binary_controls&#39;&quot;</span>

        <span class="k">if</span> <span class="n">grid_params_star1_binary_job</span><span class="p">:</span>
            <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;read_extra_star_job_inlist1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.true.&#39;</span>
            <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;extra_star_job_inlist1_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;inlist_grid_star1_binary_job&#39;&quot;</span>

        <span class="k">if</span> <span class="n">grid_params_star2_binary_job</span><span class="p">:</span>
            <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;read_extra_star_job_inlist1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.true.&#39;</span>
            <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;extra_star_job_inlist1_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;inlist_grid_star2_binary_job&#39;&quot;</span>

        <span class="c1"># We want to point the binary_job section to the star1 and star2 inlist we just made</span>
        <span class="n">final_binary_job</span><span class="p">[</span><span class="s1">&#39;inlist_names(1)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlist_star1_binary</span><span class="p">)</span>
        <span class="n">final_binary_job</span><span class="p">[</span><span class="s1">&#39;inlist_names(2)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inlist_star2_binary</span><span class="p">)</span>

    <span class="c1">########################</span>
    <span class="c1">### STAR 1 FORMATION ###</span>
    <span class="c1">########################</span>
    <span class="c1"># Check the number of inlists provided to the star1 formation sections</span>
    <span class="c1"># of the inifile</span>
    <span class="n">star1_formation</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># if we have provided a pre-computed zams model, it does not matter if we wanted to form star1 and star2 for</span>
    <span class="c1"># the binary step, we have supceded this with the zams_filename</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;single_star_grid&#39;</span><span class="p">]):</span>
        <span class="n">star1_formation_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;single_star_grid&#39;</span><span class="p">]:</span>
        <span class="n">star1_formation_dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="p">((</span><span class="s1">&#39;star1_job&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;star1_controls&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">and</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mesa_inlists</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># create dictionary of only these sections</span>
        <span class="n">star1_formation_dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="s1">&#39;star1_formation&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mesa_inlists</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

    <span class="c1"># See if the user even supplied inlists for doing star1_formation</span>
    <span class="k">if</span> <span class="n">star1_formation_dictionary</span><span class="p">:</span>
        <span class="c1"># initialize the string argument for star1 formation that will be passed to posydon-run-grid</span>
        <span class="n">inlist_star1_formation</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># check the number of inlists in each star1 formation parameter. We will take calculate the max number and treat that as</span>
        <span class="c1"># the number of star1 formation steps desired before making the final star1 model that will be fed into the binary exectuable</span>
        <span class="n">number_of_star1_formation_steps</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">star1_formation_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">number_of_star1_formation_steps</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">number_of_star1_formation_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_star1_formation_steps</span><span class="p">):</span>
            <span class="n">star1_formation</span><span class="p">[</span><span class="s1">&#39;step</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">star1_formation</span><span class="p">[</span><span class="s1">&#39;step</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)][</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;star1&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist_step</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">star1_formation_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">star1_formation</span><span class="p">[</span><span class="s1">&#39;step</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">v</span>

        <span class="c1"># Now we loop over each star1 formation step and construct the final star1 formation inlist for each step</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">step_inlists</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">star1_formation</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="c1"># there is a new one of these final star1 formation inlists per step</span>
            <span class="n">final_star1_formation_controls</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">final_star1_formation_job</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">step_inlists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;star1_formation_controls&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;star1_controls&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">):</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;controls&#39;</span>
                    <span class="n">controls_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">controls_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="k">if</span> <span class="s1">&#39;num_x_ctrls&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">:</span>
                            <span class="c1"># This is a special default that the default value in the .defaults</span>
                            <span class="c1"># file in MESA does not work because it is a placeholder</span>
                            <span class="n">final_star1_formation_controls</span><span class="p">[</span><span class="n">k1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;num_x_ctrls&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">final_star1_formation_controls</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;star1_formation_job&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;star1_job&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">):</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;star_job&#39;</span>
                    <span class="n">controls_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">controls_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="n">final_star1_formation_job</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

            <span class="c1"># The user supplied a way to form star1 and we need to update dictionary of parameters and their values correctly</span>
            <span class="c1"># We want to make sure that the binary inlists load up the properly saved models from star1 formation</span>
            <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;create_pre_main_sequence_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>
            <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;load_saved_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
            <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;saved_model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;initial_star1_step</span><span class="si">{0}</span><span class="s2">.mod&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="c1"># if this is step0 then we simply overwrite the save_model_when_terminate and</span>
            <span class="c1"># save_model_filename parts of the inlists. However, for all steps higher than</span>
            <span class="c1"># step 0 we need to have that step load in the model from the step</span>
            <span class="c1"># below the current step</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">final_star1_formation_job</span><span class="p">[</span><span class="s1">&#39;save_model_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.true.&#39;</span>
                <span class="n">final_star1_formation_job</span><span class="p">[</span><span class="s1">&#39;save_model_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;initial_star1_step</span><span class="si">{0}</span><span class="s2">.mod&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_star1_formation_job</span><span class="p">[</span><span class="s1">&#39;create_pre_main_sequence_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>
                <span class="n">final_star1_formation_job</span><span class="p">[</span><span class="s1">&#39;load_saved_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
                <span class="n">final_star1_formation_job</span><span class="p">[</span><span class="s1">&#39;saved_model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;initial_star1_step</span><span class="si">{0}</span><span class="s2">.mod&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">final_star1_formation_job</span><span class="p">[</span><span class="s1">&#39;save_model_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.true.&#39;</span>
                <span class="n">final_star1_formation_job</span><span class="p">[</span><span class="s1">&#39;save_model_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;initial_star1_step</span><span class="si">{0}</span><span class="s2">.mod&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;single_star_grid&#39;</span><span class="p">]):</span>
                <span class="n">final_star1_formation_controls</span><span class="p">[</span><span class="s1">&#39;zams_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;single_star_grid&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;zams_filename_1&#39;</span> <span class="ow">in</span> <span class="n">final_star1_formation_controls</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">final_star1_formation_controls</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;zams_filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># write star1 formation step to file</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">step_inlists</span><span class="p">[</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">]):</span>
                <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">step_inlists</span><span class="p">[</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">],</span>
                      <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">step_inlists</span><span class="p">[</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">],</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;controls</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_star1_formation_controls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        / ! end of star1_controls namelist</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;star_job</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_star1_formation_job</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        / ! end of star1_job namelist</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># Construct star1 formation argument string to be passed to posydon-run-grid</span>
            <span class="n">inlist_star1_formation</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step_inlists</span><span class="p">[</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inlist_star1_formation</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">########################</span>
    <span class="c1">### STAR 2 FORMATION ###</span>
    <span class="c1">########################</span>
    <span class="c1"># Check the number of inlists provided to the star2 formation sections</span>
    <span class="c1"># of the inifile</span>
    <span class="n">star2_formation</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># if we have provided a pre-computed zams model, it does not matter if we wanted to form star1 and star2 for</span>
    <span class="c1"># the binary step, we have supceded this with the zams_filename_2</span>
    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_2&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">star2_formation_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># create dictionary of only these sections</span>
        <span class="n">star2_formation_dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="s1">&#39;star2_formation&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mesa_inlists</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

    <span class="c1"># See if the user even supplied inlists for doing star2_formation</span>
    <span class="k">if</span> <span class="n">star2_formation_dictionary</span><span class="p">:</span>
        <span class="c1"># initialize the string argument for star2 formation that will be passed to posydon-run-grid</span>
        <span class="n">inlist_star2_formation</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># check the number of inlists in each star2 formation parameter. We will take calculate the max number and treat that as</span>
        <span class="c1"># the number of star2 formation steps desired before making the final star2 model that will be fed into the binary exectuable</span>
        <span class="n">number_of_star2_formation_steps</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">star2_formation_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">number_of_star2_formation_steps</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">number_of_star2_formation_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_star2_formation_steps</span><span class="p">):</span>
            <span class="n">star2_formation</span><span class="p">[</span><span class="s1">&#39;step</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">star2_formation</span><span class="p">[</span><span class="s1">&#39;step</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)][</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;star2&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist_step</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">star2_formation_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">star2_formation</span><span class="p">[</span><span class="s1">&#39;step</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">v</span>

        <span class="c1"># Now we loop over each star2 formation step and construct the final star2 formation inlist for each step</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">step_inlists</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">star2_formation</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">final_star2_formation_controls</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">final_star2_formation_job</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">step_inlists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;star2_formation_controls&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;controls&#39;</span>
                    <span class="n">controls_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">controls_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="k">if</span> <span class="s1">&#39;num_x_ctrls&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">:</span>
                            <span class="c1"># This is a special default that the default value in the .defaults</span>
                            <span class="c1"># file in MESA does not work because it is a placeholder</span>
                            <span class="n">final_star2_formation_controls</span><span class="p">[</span><span class="n">k1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;num_x_ctrls&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">final_star2_formation_controls</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

                <span class="k">if</span> <span class="s1">&#39;star2_formation_job&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;&amp;star_job&#39;</span>
                    <span class="n">controls_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">clean_inlist_file</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span><span class="n">v1</span> <span class="ow">in</span> <span class="n">controls_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># remove any hidden inlists extras since that is not how we want to do things</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;read_extra&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;inlist&#39;</span> <span class="ow">in</span> <span class="n">k1</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="n">final_star2_formation_job</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

            <span class="c1"># then the user supplied a star2 formation and we need to update dictionary of parameters and their values correctly</span>
            <span class="c1"># We want to make sure that the binary inlists load up the properly saved models from star2 formation</span>
            <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;create_pre_main_sequence_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>
            <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;load_saved_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
            <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;saved_model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;initial_star2_step</span><span class="si">{0}</span><span class="s2">.mod&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="c1"># if this is step0 then we simply overwrite the save_model_when_terminate and</span>
            <span class="c1"># save_model_filename parts of the inlists. However, for all steps higher than</span>
            <span class="c1"># step 0 we need to have that step load in the model from the step</span>
            <span class="c1"># below the current step</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">final_star2_formation_job</span><span class="p">[</span><span class="s1">&#39;save_model_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.true.&#39;</span>
                <span class="n">final_star2_formation_job</span><span class="p">[</span><span class="s1">&#39;save_model_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;initial_star2_step</span><span class="si">{0}</span><span class="s2">.mod&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_star2_formation_job</span><span class="p">[</span><span class="s1">&#39;create_pre_main_sequence_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>
                <span class="n">final_star2_formation_job</span><span class="p">[</span><span class="s1">&#39;load_saved_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
                <span class="n">final_star2_formation_job</span><span class="p">[</span><span class="s1">&#39;saved_model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;initial_star2_step</span><span class="si">{0}</span><span class="s2">.mod&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">final_star2_formation_job</span><span class="p">[</span><span class="s1">&#39;save_model_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.true.&#39;</span>
                <span class="n">final_star2_formation_job</span><span class="p">[</span><span class="s1">&#39;save_model_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;initial_star2_step</span><span class="si">{0}</span><span class="s2">.mod&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">step_inlists</span><span class="p">[</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">]):</span>
                <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">step_inlists</span><span class="p">[</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">],</span>
                      <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">step_inlists</span><span class="p">[</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">],</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;controls</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_star2_formation_controls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        / ! end of star2_controls namelist</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;star_job</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_star2_formation_job</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        / ! end of star2_job namelist</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># Construct star2 formation argument string to be passed to posydon-run-grid</span>
            <span class="n">inlist_star2_formation</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step_inlists</span><span class="p">[</span><span class="s1">&#39;inlist_file&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inlist_star2_formation</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">##########################################</span>
    <span class="c1">###### MESA BINARY OUTPUT CONTROLS #######</span>
    <span class="c1">##########################################</span>
    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;final_profile_star1&#39;</span><span class="p">]:</span>
        <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;write_profile_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
        <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;filename_for_profile_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;final_profile_star1.data&#39;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;write_profile_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>

    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;final_profile_star2&#39;</span><span class="p">]:</span>
        <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;write_profile_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
        <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;filename_for_profile_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;final_profile_star2.data&#39;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;write_profile_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>

    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;final_model_star1&#39;</span><span class="p">]:</span>
        <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;save_model_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
        <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;save_model_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;final_star1.mod&#39;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_star1_binary_job</span><span class="p">[</span><span class="s1">&#39;save_model_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>

    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;final_model_star2&#39;</span><span class="p">]:</span>
        <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;save_model_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
        <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;save_model_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;final_star2.mod&#39;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_star2_binary_job</span><span class="p">[</span><span class="s1">&#39;save_model_when_terminate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>

    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;history_star1&#39;</span><span class="p">]:</span>
        <span class="n">final_star1_binary_controls</span><span class="p">[</span><span class="s1">&#39;do_history_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_star1_binary_controls</span><span class="p">[</span><span class="s1">&#39;do_history_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>

    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;history_star2&#39;</span><span class="p">]:</span>
        <span class="n">final_star2_binary_controls</span><span class="p">[</span><span class="s1">&#39;do_history_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.true.&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_star2_binary_controls</span><span class="p">[</span><span class="s1">&#39;do_history_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.false.&quot;</span>

    <span class="n">final_binary_controls</span><span class="p">[</span><span class="s1">&#39;history_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;history_interval&#39;</span><span class="p">]</span>
    <span class="n">final_star1_binary_controls</span><span class="p">[</span><span class="s1">&#39;history_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;history_interval&#39;</span><span class="p">]</span>
    <span class="n">final_star2_binary_controls</span><span class="p">[</span><span class="s1">&#39;history_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;history_interval&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;binary_history&#39;</span><span class="p">]:</span>
        <span class="n">final_binary_controls</span><span class="p">[</span><span class="s1">&#39;history_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-1&quot;</span>

    <span class="c1"># update the controls for star1 star2 for the binary with the precomputed zams model</span>
    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">final_star1_binary_controls</span><span class="p">[</span><span class="s1">&#39;zams_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_1&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_2&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">final_star2_binary_controls</span><span class="p">[</span><span class="s1">&#39;zams_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;zams_filename_2&#39;</span><span class="p">])</span>

    <span class="c1">##########################################</span>
    <span class="c1">###### WRITE MESA BINARY INLISTS   #######</span>
    <span class="c1">##########################################</span>
    <span class="c1"># now that we have all the parameters and their correct values</span>
    <span class="c1"># we now write our own inlist_project, inlist1 and inlist2 for the binary</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">inlist_binary_project</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">inlist_binary_project</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inlist_binary_project</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;binary_controls</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_binary_controls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">/ ! end of binary_controls namelist&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;binary_job</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_binary_job</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">/ ! end of binary_job namelist</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">inlist_star1_binary</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">inlist_star1_binary</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inlist_star1_binary</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;controls</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_star1_binary_controls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">/ ! end of star1_controls namelist</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;star_job</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_star1_binary_job</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">/ ! end of star1_job namelist</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">inlist_star2_binary</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">inlist_star2_binary</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inlist_star2_binary</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;controls</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_star2_binary_controls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">/ ! end of star2_controls namelist</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&amp;star_job</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">final_star2_binary_job</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">/ ! end of star2_job namelist</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inlist_star1_formation</span><span class="p">,</span> <span class="n">inlist_star2_formation</span><span class="p">,</span> <span class="n">inlist_binary_project</span><span class="p">,</span> <span class="n">inlist_star1_binary</span><span class="p">,</span> <span class="n">inlist_star2_binary</span></div>


<div class="viewcode-block" id="make_executables">
<a class="viewcode-back" href="../api_reference/posydon_setup_grid.html#posydon_setup_grid.make_executables">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_executables</span><span class="p">(</span><span class="n">mesa_extras</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pass mesa extra function and compile binary executable on the fly</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># First, make individual star executables</span>
    <span class="n">star1_src_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;star1&#39;</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">star1_src_folder</span><span class="p">):</span>  <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">star1_src_folder</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">star1_src_folder</span><span class="p">)</span>

    <span class="n">star1_make_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;star1&#39;</span><span class="p">,</span> <span class="s1">&#39;make&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">star1_make_folder</span><span class="p">):</span>  <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">star1_make_folder</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">star1_make_folder</span><span class="p">)</span>

    <span class="n">star2_src_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;star2&#39;</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">star2_src_folder</span><span class="p">):</span>  <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">star2_src_folder</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">star2_src_folder</span><span class="p">)</span>

    <span class="n">star2_make_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;star2&#39;</span><span class="p">,</span> <span class="s1">&#39;make&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">star2_make_folder</span><span class="p">):</span>  <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">star2_make_folder</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">star2_make_folder</span><span class="p">)</span>

    <span class="c1"># Now make the binary folder</span>
    <span class="n">binary_src_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">binary_src_folder</span><span class="p">):</span>  <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">binary_src_folder</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">binary_src_folder</span><span class="p">)</span>

    <span class="n">binary_make_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;make&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">binary_make_folder</span><span class="p">):</span>  <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">binary_make_folder</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">binary_make_folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;mk&#39;</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace mk&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;mk&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># first we need to cd into the make folder</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesa_extras</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;binary_extras&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;binary_run&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">binary_src_folder</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;star_run&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">star1_src_folder</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">star2_src_folder</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;star1_extras&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">star1_src_folder</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;star2_extras&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">star2_src_folder</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;makefile_binary&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">binary_make_folder</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cd </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">binary_make_folder</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;make -f </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s1">&#39;makefile_star&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">star1_make_folder</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cd </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_make_folder</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;make -f </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">star2_make_folder</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cd </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_make_folder</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;make -f </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s1">&#39;mesa_dir&#39;</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;chmod 755 mk&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;./mk&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span><span class="s1">&#39;binary&#39;</span><span class="p">),</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span><span class="s1">&#39;star1&#39;</span><span class="p">,</span><span class="s1">&#39;star&#39;</span><span class="p">),</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span><span class="s1">&#39;star2&#39;</span><span class="p">,</span><span class="s1">&#39;star&#39;</span><span class="p">),</span> \</div>


<div class="viewcode-block" id="construct_command_line">
<a class="viewcode-back" href="../api_reference/posydon_setup_grid.html#posydon_setup_grid.construct_command_line">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">construct_command_line</span><span class="p">(</span><span class="n">number_of_mpi_processes</span><span class="p">,</span> <span class="n">path_to_grid</span><span class="p">,</span>
                           <span class="n">binary_exe</span><span class="p">,</span> <span class="n">star1_exe</span><span class="p">,</span> <span class="n">star2_exe</span><span class="p">,</span>
                           <span class="n">inlist_binary_project</span><span class="p">,</span> <span class="n">inlist_star1_binary</span><span class="p">,</span> <span class="n">inlist_star2_binary</span><span class="p">,</span>
                           <span class="n">inlist_star1_formation</span><span class="p">,</span> <span class="n">inlist_star2_formation</span><span class="p">,</span>
                           <span class="n">star_history_columns</span><span class="p">,</span> <span class="n">binary_history_columns</span><span class="p">,</span> <span class="n">profile_columns</span><span class="p">,</span>
                           <span class="n">run_directory</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span> <span class="n">path_to_run_grid_exec</span><span class="p">,</span>
                           <span class="n">psycris_inifile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_profiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">keep_photos</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Based on the inifile construct the command line call to posydon-run-grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;fixed&quot;</span><span class="p">:</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="s1">&#39;python </span><span class="si">{15}</span><span class="s1"> --mesa-grid </span><span class="si">{1}</span><span class="s1"> --mesa-binary-executable </span><span class="si">{2}</span><span class="s1"> &#39;</span>
    <span class="k">elif</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;dynamic&quot;</span><span class="p">:</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="s1">&#39;mpirun --bind-to none -np </span><span class="si">{0}</span><span class="s1"> python -m mpi4py </span><span class="si">{15}</span><span class="s1"> --mesa-grid </span><span class="si">{1}</span><span class="s1"> --mesa-binary-executable </span><span class="si">{2}</span><span class="s1"> &#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;grid_type can either be fixed or dynamic not anything else&quot;</span><span class="p">)</span>
    <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39;--mesa-star1-executable </span><span class="si">{3}</span><span class="s1"> --mesa-star2-executable </span><span class="si">{4}</span><span class="s1"> --mesa-binary-inlist-project </span><span class="si">{5}</span><span class="s1"> &#39;</span>
    <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39;--mesa-binary-inlist1 </span><span class="si">{6}</span><span class="s1"> --mesa-binary-inlist2 </span><span class="si">{7}</span><span class="s1"> --mesa-star1-inlist-project </span><span class="si">{8}</span><span class="s1"> &#39;</span>
    <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39;--mesa-star2-inlist-project </span><span class="si">{9}</span><span class="s1"> --mesa-star-history-columns </span><span class="si">{10}</span><span class="s1"> &#39;</span>
    <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39;--mesa-binary-history-columns </span><span class="si">{11}</span><span class="s1"> --mesa-profile-columns </span><span class="si">{12}</span><span class="s1"> &#39;</span>
    <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39;--output-directory </span><span class="si">{13}</span><span class="s1"> --grid-type </span><span class="si">{14}</span><span class="s1"> &#39;</span>
    <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39;--psycris-inifile </span><span class="si">{16}</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">keep_profiles</span><span class="p">:</span>
        <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39; --keep_profiles&#39;</span>
    <span class="k">if</span> <span class="n">keep_photos</span><span class="p">:</span>
        <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39; --keep_photos&#39;</span>
    <span class="n">command_line</span> <span class="o">=</span> <span class="n">command_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_of_mpi_processes</span><span class="p">,</span>
                                       <span class="n">path_to_grid</span><span class="p">,</span>
                                       <span class="n">binary_exe</span><span class="p">,</span>
                                       <span class="n">star1_exe</span><span class="p">,</span>
                                       <span class="n">star2_exe</span><span class="p">,</span>
                                       <span class="n">inlist_binary_project</span><span class="p">,</span>
                                       <span class="n">inlist_star1_binary</span><span class="p">,</span>
                                       <span class="n">inlist_star2_binary</span><span class="p">,</span>
                                       <span class="n">inlist_star1_formation</span><span class="p">,</span>
                                       <span class="n">inlist_star2_formation</span><span class="p">,</span>
                                       <span class="n">star_history_columns</span><span class="p">,</span>
                                       <span class="n">binary_history_columns</span><span class="p">,</span>
                                       <span class="n">profile_columns</span><span class="p">,</span>
                                       <span class="n">run_directory</span><span class="p">,</span>
                                       <span class="n">grid_type</span><span class="p">,</span>
                                       <span class="n">path_to_run_grid_exec</span><span class="p">,</span>
                                       <span class="n">psycris_inifile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">command_line</span></div>


<span class="c1">###############################################################################</span>
<span class="c1"># BEGIN MAIN FUNCTION</span>
<span class="c1">###############################################################################</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># READ COMMANDLINE ARGUMENTS</span>
    <span class="c1">###########################################################################</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_commandline</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MESA_DIR&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MESA_DIR must be defined in your environment &quot;</span>
                          <span class="s2">&quot;before you can run a grid os MESA runs&quot;</span><span class="p">)</span>

    <span class="c1"># Determine location of executables</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;which&#39;</span><span class="p">,</span> <span class="s1">&#39;posydon-run-grid&#39;</span><span class="p">],</span>
                                 <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                             <span class="p">)</span>
    <span class="p">(</span><span class="n">path_to_run_grid_exec</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path_to_run_grid_exec</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot locate posydon-run-grid executable in your path&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path_to_run_grid_exec</span> <span class="o">=</span> <span class="n">path_to_run_grid_exec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">run_parameters</span><span class="p">,</span> <span class="n">slurm</span><span class="p">,</span> <span class="n">mesa_inlists</span><span class="p">,</span> <span class="n">mesa_extras</span> <span class="o">=</span> <span class="n">configfile</span><span class="o">.</span><span class="n">parse_inifile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">inifile</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;scenario&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesa_inlists</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s1">&#39;keep_profiles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">run_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;keep_profiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;keep_photos&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">run_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;keep_photos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]))):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Supplied grid does not exist, please check your path and try again&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;psycris_inifile&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">run_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please add psycris inifile to the [run_parameters] section of the inifile.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">find_inlist_from_scenario</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="n">gitcommit</span><span class="o">=</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                  <span class="n">system_type</span><span class="o">=</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1"># read grid</span>
    <span class="k">if</span> <span class="s1">&#39;.csv&#39;</span> <span class="ow">in</span> <span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]:</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">])</span>
        <span class="n">fixgrid_file_name</span> <span class="o">=</span> <span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;.h5&#39;</span> <span class="ow">in</span> <span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]:</span>
        <span class="n">psy_grid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">()</span>
        <span class="n">psy_grid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">])</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">psy_grid</span><span class="o">.</span><span class="n">get_pandas_initial_final</span><span class="p">()</span>
        <span class="n">psy_grid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">fixgrid_file_name</span> <span class="o">=</span> <span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]):</span>
        <span class="n">mygrid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span> <span class="s2">&quot;./fixed_grid_results.h5&quot;</span><span class="p">,</span> <span class="n">slim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">psy_grid</span> <span class="o">=</span> <span class="n">PSyGrid</span><span class="p">()</span>
        <span class="n">psy_grid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;./fixed_grid_results.h5&quot;</span><span class="p">)</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">psy_grid</span><span class="o">.</span><span class="n">get_pandas_initial_final</span><span class="p">()</span>
        <span class="n">psy_grid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">fixgrid_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;fixed_grid_results.h5&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Grid format not recognized, please feed in an acceptable format: csv&#39;</span><span class="p">)</span>

    <span class="c1"># validate mesa_extras dictionary</span>
    <span class="c1"># check if user has supplied multiple run_star run_binary extras files and enforce mesa, then posydon, then user order</span>
    <span class="n">extras_files_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mesa_extras</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;binary_extras&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">)]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WE ARE USING THE EXTRA FILE FROM TYPE </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extras_files_types</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mesa_extras</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;binary_extras&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">extras_files_types</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Section mesa_extras value </span><span class="si">{0}</span><span class="s2"> is being set to&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span>\
                  <span class="s2">&quot; None&quot;</span><span class="p">,</span> <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
            <span class="n">mesa_extras</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">binary_exe</span><span class="p">,</span> <span class="n">star1_exe</span><span class="p">,</span> <span class="n">star2_exe</span> <span class="o">=</span> <span class="n">make_executables</span><span class="p">(</span><span class="n">mesa_extras</span><span class="o">=</span><span class="n">mesa_extras</span><span class="p">,</span>
                                                        <span class="n">working_directory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">run_directory</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;dynamic&quot;</span><span class="p">:</span>
        <span class="n">dynamic_grid_params</span> <span class="o">=</span> <span class="n">parse_inifile</span><span class="p">(</span><span class="n">run_parameters</span><span class="p">[</span><span class="s2">&quot;psycris_inifile&quot;</span><span class="p">])</span>
        <span class="n">mesa_params_to_run_grid_over</span> <span class="o">=</span> <span class="n">dynamic_grid_params</span><span class="p">[</span><span class="s2">&quot;posydon_dynamic_sampling_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;mesa_column_names&quot;</span><span class="p">]</span>
        <span class="n">inlist_star1_formation</span><span class="p">,</span> <span class="n">inlist_star2_formation</span><span class="p">,</span> <span class="n">inlist_binary_project</span><span class="p">,</span> <span class="n">inlist_star1_binary</span><span class="p">,</span> \
            <span class="n">inlist_star2_binary</span> <span class="o">=</span> <span class="n">construct_static_inlist</span><span class="p">(</span><span class="n">mesa_inlists</span><span class="p">,</span>
                                                          <span class="n">grid_parameters</span><span class="o">=</span><span class="n">mesa_params_to_run_grid_over</span><span class="p">,</span>
                                                          <span class="n">working_directory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">run_directory</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inlist_star1_formation</span><span class="p">,</span> <span class="n">inlist_star2_formation</span><span class="p">,</span> <span class="n">inlist_binary_project</span><span class="p">,</span> <span class="n">inlist_star1_binary</span><span class="p">,</span> \
            <span class="n">inlist_star2_binary</span> <span class="o">=</span> <span class="n">construct_static_inlist</span><span class="p">(</span><span class="n">mesa_inlists</span><span class="p">,</span>
                                                          <span class="n">grid_parameters</span><span class="o">=</span><span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                                          <span class="n">working_directory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">run_directory</span><span class="p">)</span>

    <span class="c1"># handle column lists</span>
    <span class="c1"># first, creating a directory</span>
    <span class="n">column_lists_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">run_directory</span><span class="p">,</span> <span class="s1">&#39;column_lists&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">column_lists_folder</span><span class="p">):</span>  <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">column_lists_folder</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">column_lists_folder</span><span class="p">)</span>
    <span class="c1"># second, getting new location</span>
    <span class="n">star_history_columns</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_lists_folder</span><span class="p">,</span> <span class="s1">&#39;history_columns.list&#39;</span><span class="p">)</span>
    <span class="n">binary_history_columns</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_lists_folder</span><span class="p">,</span> <span class="s1">&#39;binary_history_columns.list&#39;</span><span class="p">)</span>
    <span class="n">profile_columns</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_lists_folder</span><span class="p">,</span> <span class="s1">&#39;profile_columns.list&#39;</span><span class="p">)</span>
    <span class="c1"># third, copy lists</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;star_history_columns&#39;</span><span class="p">],</span> <span class="n">star_history_columns</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;binary_history_columns&#39;</span><span class="p">],</span> <span class="n">binary_history_columns</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mesa_inlists</span><span class="p">[</span><span class="s1">&#39;profile_columns&#39;</span><span class="p">],</span> <span class="n">profile_columns</span><span class="p">)</span>

    <span class="c1"># now we can write the mpi command line</span>
    <span class="k">if</span> <span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;job_array&#39;</span><span class="p">]:</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="n">construct_command_line</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                                              <span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span>
                                              <span class="n">binary_exe</span><span class="p">,</span>
                                              <span class="n">star1_exe</span><span class="p">,</span>
                                              <span class="n">star2_exe</span><span class="p">,</span>
                                              <span class="n">inlist_binary_project</span><span class="p">,</span>
                                              <span class="n">inlist_star1_binary</span><span class="p">,</span>
                                              <span class="n">inlist_star2_binary</span><span class="p">,</span>
                                              <span class="n">inlist_star1_formation</span><span class="p">,</span>
                                              <span class="n">inlist_star2_formation</span><span class="p">,</span>
                                              <span class="n">star_history_columns</span><span class="p">,</span>
                                              <span class="n">binary_history_columns</span><span class="p">,</span>
                                              <span class="n">profile_columns</span><span class="p">,</span>
                                              <span class="n">args</span><span class="o">.</span><span class="n">run_directory</span><span class="p">,</span>
                                              <span class="s1">&#39;fixed&#39;</span><span class="p">,</span>
                                              <span class="n">path_to_run_grid_exec</span><span class="p">,</span>
                                              <span class="n">keep_profiles</span><span class="o">=</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;keep_profiles&#39;</span><span class="p">],</span>
                                              <span class="n">keep_photos</span><span class="o">=</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;keep_photos&#39;</span><span class="p">])</span>
        <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39; --grid-point-index $SLURM_ARRAY_TASK_ID&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="n">construct_command_line</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;number_of_mpi_tasks&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;number_of_nodes&#39;</span><span class="p">],</span>
                                              <span class="n">fixgrid_file_name</span><span class="p">,</span>
                                              <span class="n">binary_exe</span><span class="p">,</span>
                                              <span class="n">star1_exe</span><span class="p">,</span>
                                              <span class="n">star2_exe</span><span class="p">,</span>
                                              <span class="n">inlist_binary_project</span><span class="p">,</span>
                                              <span class="n">inlist_star1_binary</span><span class="p">,</span>
                                              <span class="n">inlist_star2_binary</span><span class="p">,</span>
                                              <span class="n">inlist_star1_formation</span><span class="p">,</span>
                                              <span class="n">inlist_star2_formation</span><span class="p">,</span>
                                              <span class="n">star_history_columns</span><span class="p">,</span>
                                              <span class="n">binary_history_columns</span><span class="p">,</span>
                                              <span class="n">profile_columns</span><span class="p">,</span>
                                              <span class="n">args</span><span class="o">.</span><span class="n">run_directory</span><span class="p">,</span>
                                              <span class="n">args</span><span class="o">.</span><span class="n">grid_type</span><span class="p">,</span>
                                              <span class="n">path_to_run_grid_exec</span><span class="p">,</span>
                                              <span class="n">psycris_inifile</span> <span class="o">=</span> <span class="n">run_parameters</span><span class="p">[</span><span class="s2">&quot;psycris_inifile&quot;</span><span class="p">],</span>
                                              <span class="n">keep_profiles</span><span class="o">=</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;keep_profiles&#39;</span><span class="p">],</span>
                                              <span class="n">keep_photos</span><span class="o">=</span><span class="n">run_parameters</span><span class="p">[</span><span class="s1">&#39;keep_photos&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">submission_type</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
        <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39; --job_end $SLURM_JOB_END_TIME&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;work_dir&#39;</span> <span class="ow">in</span> <span class="n">slurm</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;work_dir&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">command_line</span> <span class="o">+=</span> <span class="s1">&#39; --temporary-directory &#39;</span><span class="o">+</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;work_dir&#39;</span><span class="p">]</span>

    <span class="c1"># now we need to know how this person plans to run the above created</span>
    <span class="c1"># command. As a shell script? As a SLURM submission? In some other way?</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">submission_type</span> <span class="o">==</span> <span class="s1">&#39;shell&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;grid_command.sh&#39;</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace grid_command.sh&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;grid_command.sh&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#!/bin/bash</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export OMP_NUM_THREADS=</span><span class="si">{0}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;number_of_cpus_per_task&#39;</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export MESASDK_ROOT=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MESASDK_ROOT&#39;</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;source $MESASDK_ROOT/bin/mesasdk_init.sh</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export MESA_DIR=</span><span class="si">{0}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MESA_DIR&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;job_array&#39;</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;for SLURM_ARRAY_TASK_ID in &#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_df</span><span class="p">)):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; do &#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;job_array&#39;</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; ; done</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># do cleanup</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;compress-mesa .</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;newgroup&#39;</span> <span class="ow">in</span> <span class="n">slurm</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;echo </span><span class="se">\&quot;</span><span class="s1">Change group to </span><span class="si">{0}</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;newgroup&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;chgrp -fR </span><span class="si">{0}</span><span class="s1"> .</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;newgroup&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;echo </span><span class="se">\&quot;</span><span class="s1">Change group permission to rwX at least</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;chmod -fR g+rwX .</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">echo </span><span class="se">\&quot;</span><span class="s1">Done.</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># make the script executable</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;chmod 755 grid_command.sh&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">submission_type</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
        <span class="c1"># if slurm will we submit as job array or MPI</span>
        <span class="k">if</span> <span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;job_array&#39;</span><span class="p">]:</span>
            <span class="n">grid_script</span> <span class="o">=</span> <span class="s1">&#39;job_array_grid_submit.slurm&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">grid_script</span><span class="p">):</span>
                <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">grid_script</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">grid_script</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#!/bin/bash</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --account=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;account&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --partition=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;partition&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH -N 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --array=0-</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_df</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --cpus-per-task </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;number_of_cpus_per_task&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --ntasks-per-node 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --time=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --job-name=</span><span class="se">\&quot;</span><span class="s1">mesa_grid_\$</span><span class="si">{SLURM_ARRAY_TASK_ID}</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --output=mesa_grid.%A_</span><span class="si">%a</span><span class="s1">.out</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --mail-type=ALL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --mail-user=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --mem-per-cpu=4G</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export OMP_NUM_THREADS=</span><span class="si">{0}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;number_of_cpus_per_task&#39;</span><span class="p">]))</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export MESASDK_ROOT=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MESASDK_ROOT&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;source $MESASDK_ROOT/bin/mesasdk_init.sh</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export MESA_DIR=</span><span class="si">{0}</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MESA_DIR&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid_script</span> <span class="o">=</span> <span class="s1">&#39;mpi_grid_submit.slurm&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">grid_script</span><span class="p">):</span>
                <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace &#39;</span><span class="o">+</span><span class="n">grid_script</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">grid_script</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#!/bin/bash</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --account=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;account&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --partition=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;partition&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH -N </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;number_of_nodes&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --cpus-per-task </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;number_of_cpus_per_task&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --ntasks-per-node </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;number_of_mpi_tasks&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --time=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --output=</span><span class="se">\&quot;</span><span class="s1">mesa_grid.out</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --mail-type=ALL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --mail-user=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --mem-per-cpu=4G</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export OMP_NUM_THREADS=</span><span class="si">{0}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;number_of_cpus_per_task&#39;</span><span class="p">]))</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export MESASDK_ROOT=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MESASDK_ROOT&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;source $MESASDK_ROOT/bin/mesasdk_init.sh</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;export MESA_DIR=</span><span class="si">{0}</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MESA_DIR&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span>
        <span class="c1"># create a cleanup script</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;cleanup.slurm&#39;</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace cleanup.slurm&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;cleanup.slurm&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#!/bin/bash</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --account=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;account&#39;</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --partition=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;partition&#39;</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH -N 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --cpus-per-task 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --ntasks-per-node 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --time=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --job-name=</span><span class="se">\&quot;</span><span class="s1">mesa_grid_cleanup</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --output=mesa_cleanup.out</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --mail-type=ALL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --mail-user=</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#SBATCH --mem-per-cpu=4G</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;compress-mesa .</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;newgroup&#39;</span> <span class="ow">in</span> <span class="n">slurm</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;echo </span><span class="se">\&quot;</span><span class="s1">Change group to </span><span class="si">{0}</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;newgroup&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;chgrp -fR </span><span class="si">{0}</span><span class="s1"> .</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm</span><span class="p">[</span><span class="s1">&#39;newgroup&#39;</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;echo </span><span class="se">\&quot;</span><span class="s1">Change group permission to rwX at least</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;chmod -fR g+rwX .</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">echo </span><span class="se">\&quot;</span><span class="s1">Done.</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># create a runfile script</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;run_grid.sh&#39;</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace run_grid.sh&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;run_grid.sh&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#!/bin/bash</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ID_GRID=$(sbatch --parsable </span><span class="si">{0}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid_script</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;echo </span><span class="se">\&quot;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid_script</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; submitted as </span><span class="se">\&quot;</span><span class="s1">$</span><span class="si">{ID_GRID}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ID_cleanup=$(sbatch --parsable --dependency=afterany:$</span><span class="si">{ID_GRID}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;--kill-on-invalid-dep=yes cleanup.slurm)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;echo </span><span class="se">\&quot;</span><span class="s1">cleanup.slurm submitted as </span><span class="se">\&quot;</span><span class="s1">$</span><span class="si">{ID_cleanup}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># make the runfile script executable</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;chmod 755 run_grid.sh&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Tassos Fragos.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      Version: 2.2.1
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        
        <dl>
            <dt> v2</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v2.0.6/index.html">2.0</a></dd>
            
            <dd><a href="https://posydon.org/POSYDON/v2.1.7/index.html">2.1</a></dd>
            
            <dd><a href="https://posydon.org/POSYDON/v2.2.4/index.html">2.2</a></dd>
            
        </dl>
        
        <dl>
            <dt> v1</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v1.0.5/index.html">1.0</a></dd>
            
        </dl>
        
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>