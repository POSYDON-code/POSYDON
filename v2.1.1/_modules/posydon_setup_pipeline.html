

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>posydon_setup_pipeline &mdash; posydon 2.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=d66fa8e6" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=841abef3"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/posydon_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction-acknowledgements/intro.html">Introduction, Objectives, and Scope</a></li>
<li class="toctree-l1"><a class="reference external" href="https://posydon.org/team.html">Collaborative Team</a></li>
<li class="toctree-l1"><a class="reference external" href="https://ui.adsabs.harvard.edu/public-libraries/ZZsD9bzLTzWnLV3hwyJxbA">Publications</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-grids.html">Quick Start: Examining the MESA Grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-population.html">Quick Start: Your First Population</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials and Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/population-synthesis/binary-pop-syn.html">Binary-Star Population Synthesis with POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/generating-datasets/generating-datasets.html">Crafting the Core Datasets for POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-examples/MESA-grids/running-grids.html">Architecting MESA Simulation Grids with POSYDON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">In-Depth Components Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/mesa-grids.html">MESA Grids API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/processing-pipeline.html">Processing Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/machine-learning-components.html">Machine Learning Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components-overview/stellar-binary-simulation.html">Stellar &amp; Binary-star Simulation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/posydon.html">posydon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/bin.html">executables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases and Datasets</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON/releases">Releases</a></li>
<li class="toctree-l1"><a class="reference external" href="https://zenodo.org/communities/posydon/">Datasets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support and Contact</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contact-support/contact-information.html">Contact Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting-faqs/installation-issues.html">Common Installation Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting-faqs/code-questions.html">Code Usage Questions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON/issues/new/choose">Report an Issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/how-to-contribute.html">How To Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">posydon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">posydon_setup_pipeline</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for posydon_setup_pipeline</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="n">__authors__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Simone Bavera &lt;Simone.Bavera@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Kyle Akira Rocha &lt;kylerocha2024@u.northwestern.edu&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Matthias Kruckow &lt;Matthias.Kruckow@unige.ch&gt;&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1">##############################################################################</span>
<span class="c1">#  IMPORT ALL NECESSARY PYTHON PACKAGES</span>
<span class="c1">##############################################################################</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.popsyn.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_inifile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">PATH_TO_POSYDON</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.gridutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_new_grid_name</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.posydonwarning</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pwarn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.grids.SN_MODELS</span><span class="w"> </span><span class="kn">import</span> <span class="n">SN_MODELS</span>

<span class="c1"># this data processing pipeline was designed assuming POSYDON v2 data structure</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Data tree structure</span>

<span class="sd">PATH_TO_GRIDS/</span>
<span class="sd">    /HMS-HMS/</span>
<span class="sd">    /CO-HMS_RLO/</span>
<span class="sd">    /CO-HeMS/</span>
<span class="sd">    /single_HMS/</span>
<span class="sd">    /single_HeMS/</span>
<span class="sd">        /v1/</span>
<span class="sd">        /v2/</span>
<span class="sd">            /1e+00_Zsun/</span>
<span class="sd">            /1e-01_Zsun/</span>
<span class="sd">            /1e-02_Zsun/</span>
<span class="sd">            ...</span>
<span class="sd">                /grid_low_res_0/</span>
<span class="sd">                /grid_low_res_1/</span>
<span class="sd">                /grid_rerun_1/</span>
<span class="sd">                ...</span>
<span class="sd">                /LITE/</span>
<span class="sd">                /ORIGINAL/</span>
<span class="sd">                /plots/</span>
<span class="sd">                    /grid_low_res_combined/</span>
<span class="sd">                        /TF1/</span>
<span class="sd">                        /TF2/</span>
<span class="sd">                        ...</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># pipeline steps</span>
<span class="n">ACTION_TO_STEP_NUM</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;CREATE_GRID_SLICES&#39;</span>         <span class="p">:</span> <span class="s1">&#39;step_1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;COMBINE_GRID_SLICES&#39;</span>        <span class="p">:</span> <span class="s1">&#39;step_2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CALCULATE_EXTRA_VALUES&#39;</span>     <span class="p">:</span> <span class="s1">&#39;step_3&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TRAIN_INTERPOLATORS&#39;</span>        <span class="p">:</span> <span class="s1">&#39;step_4&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TRAIN_PROFILE_INTERPOLATORS&#39;</span><span class="p">:</span> <span class="s1">&#39;step_5&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EXPORT_DATASET&#39;</span>             <span class="p">:</span> <span class="s1">&#39;step_F&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RERUN&#39;</span>                      <span class="p">:</span> <span class="s1">&#39;rerun&#39;</span>
<span class="p">}</span>
<span class="c1"># pipeline substeps</span>
<span class="n">SUB_STEPS_TO_EXTENSION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;CREATE_PLOTS&#39;</span> <span class="p">:</span> <span class="s1">&#39;_plots&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DO_CHECKS&#39;</span>    <span class="p">:</span> <span class="s1">&#39;_checks&#39;</span>
<span class="p">}</span>
<span class="c1"># predefined plotting sets</span>
<span class="n">PLOTTING_SETS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;PLOT_AFTER_CREATE&#39;</span>   <span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;PLOT_AFTER_COMBINE&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;combined_TF12&#39;</span><span class="p">,</span> <span class="s1">&#39;termination_flag_1&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;termination_flag_2&#39;</span><span class="p">,</span> <span class="s1">&#39;termination_flag_3&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;termination_flag_4&#39;</span><span class="p">,</span> <span class="s1">&#39;rl_relative_overflow_1&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;rl_relative_overflow_2&#39;</span><span class="p">,</span> <span class="s1">&#39;lg_mtransfer_rate&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PLOT_AFTER_EXTRA&#39;</span>    <span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;PLOT_AFTER_TRAINING&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;INTERP_ERROR_age&#39;</span><span class="p">,</span> <span class="s1">&#39;INTERP_ERROR_star_1_mass&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_star_2_mass&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_period_days&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_co_core_mass&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_co_core_radius&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_he_core_mass&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_he_core_radius&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_center_h1&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_center_he4&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_surface_h1&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_surface_he4&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_surf_avg_omega_div_omega_crit&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_log_Teff&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_log_L&#39;</span><span class="p">,</span> <span class="s1">&#39;INTERP_ERROR_S1_log_R&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_spin_parameter&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S1_lambda_CE_10cent&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_co_core_mass&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_co_core_radius&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_he_core_mass&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_he_core_radius&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_center_h1&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_center_he4&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_surface_h1&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_surface_he4&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_surf_avg_omega_div_omega_crit&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_log_Teff&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_log_L&#39;</span><span class="p">,</span> <span class="s1">&#39;INTERP_ERROR_S2_log_R&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_spin_parameter&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;INTERP_ERROR_S2_lambda_CE_10cent&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PLOT_AFTER_PROFILE_TRAINING&#39;</span> <span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">SN_MODEL_NAME</span> <span class="ow">in</span> <span class="n">SN_MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CO_type&#39;</span><span class="p">,</span> <span class="s1">&#39;SN_type&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;spin&#39;</span><span class="p">,</span> <span class="s1">&#39;m_disk_radiated&#39;</span><span class="p">]:</span>
        <span class="n">PLOTTING_SETS</span><span class="p">[</span><span class="s1">&#39;PLOT_AFTER_EXTRA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
         <span class="sa">f</span><span class="s1">&#39;S1_</span><span class="si">{</span><span class="n">SN_MODEL_NAME</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quantity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CO_type&#39;</span><span class="p">,</span> <span class="s1">&#39;SN_type&#39;</span><span class="p">]:</span>
            <span class="n">PLOTTING_SETS</span><span class="p">[</span><span class="s1">&#39;PLOT_AFTER_TRAINING&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
             <span class="sa">f</span><span class="s1">&#39;INTERP_ERROR_S1_</span><span class="si">{</span><span class="n">SN_MODEL_NAME</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># predefined checking sets</span>
<span class="n">CHECKING_SETS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;CHECK_AFTER_CREATE&#39;</span>           <span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;CHECK_AFTER_COMBINE&#39;</span>          <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;failure_rate&#39;</span><span class="p">],</span>
    <span class="s1">&#39;CHECK_AFTER_EXTRA&#39;</span>            <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CO_type&#39;</span><span class="p">,</span> <span class="s1">&#39;SN_type&#39;</span><span class="p">],</span>
    <span class="s1">&#39;CHECK_AFTER_TRAINING&#39;</span>         <span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;CHECK_AFTER_PROFILE_TRAINING&#39;</span> <span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>
<span class="c1"># common attributes for all steps</span>
<span class="n">ATTRIBUTES_TO_CHECK</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GRID_TYPES&#39;</span><span class="p">,</span> <span class="s1">&#39;METALLICITIES&#39;</span><span class="p">,</span> <span class="s1">&#39;GRID_SLICES&#39;</span><span class="p">,</span>\
                       <span class="s1">&#39;COMPRESSIONS&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="PostProcessingPipeline">
<a class="viewcode-back" href="../api_reference/posydon_setup_pipeline.html#posydon_setup_pipeline.PostProcessingPipeline">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PostProcessingPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to handle the post-processing pipeline.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_inifile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a pipeline</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_to_inifile : path</span>
<span class="sd">            The location of an ini file to read the parameters for the pipeline</span>
<span class="sd">            (default: None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set base variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PATH_TO_POSYDON</span> <span class="o">=</span> <span class="n">PATH_TO_POSYDON</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PATH_TO_INIFILE</span> <span class="o">=</span> <span class="n">path_to_inifile</span>

        <span class="c1"># if there is an ini file extract the parameters from it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATH_TO_INIFILE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PATH_TO_INIFILE</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_setup_params</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">PATH_TO_INIFILE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find ini-file: &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PATH_TO_INIFILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="PostProcessingPipeline.parse_setup_params">
<a class="viewcode-back" href="../api_reference/posydon_setup_pipeline.html#posydon_setup_pipeline.PostProcessingPipeline.parse_setup_params">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_setup_params</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse inifile for running post-processing pipelines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : path</span>
<span class="sd">            The location of an ini file to read the parameters for the pipeline</span>
<span class="sd">            (default: None)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary with all the parameters in the ini file. It accounts</span>
<span class="sd">            for one sectioning level.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">parse_inifile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">pipeline_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="c1"># create a subdirectory for each section</span>
            <span class="n">section_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">parser</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># interprete all input in python types</span>
                <span class="c1"># MK:this is probably not a save way to do this</span>
                <span class="n">section_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">section_dict</span>
        <span class="k">return</span> <span class="n">pipeline_kwargs</span></div>



<div class="viewcode-block" id="PostProcessingPipeline.create_csv_and_slurm_job_files">
<a class="viewcode-back" href="../api_reference/posydon_setup_pipeline.html#posydon_setup_pipeline.PostProcessingPipeline.create_csv_and_slurm_job_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_csv_and_slurm_job_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates all files the pipeline needs.&quot;&quot;&quot;</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">expand_runfile</span><span class="p">(</span><span class="n">runfile</span><span class="p">,</span> <span class="n">step_number</span><span class="o">=</span><span class="s1">&#39;step_X&#39;</span><span class="p">,</span> <span class="n">last_step</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Add next entry to the script in runfile.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            runfile : file object (text file)</span>
<span class="sd">                IO object of an opened file to write to</span>
<span class="sd">            step_number : str</span>
<span class="sd">                String representation of the current step</span>
<span class="sd">            last_step : str</span>
<span class="sd">                String representation of the last step</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            str</span>
<span class="sd">                On success it returns step_number</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">runfile</span><span class="o">.</span><span class="n">writable</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t write to </span><span class="si">{</span><span class="n">runfile</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">.slurm&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t find file </span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">.slurm&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_step</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="c1"># if there was no previous step the current step has no</span>
                <span class="c1"># dependency</span>
                <span class="n">runfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ID</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">=$(sbatch --parsable &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">.slurm)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># steps waiting for the previous step</span>
                <span class="n">runfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ID</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">=$(sbatch --parsable &quot;</span>
                              <span class="s2">&quot;--dependency=afterok:$&quot;&quot;{&quot;</span><span class="sa">f</span><span class="s2">&quot;ID</span><span class="si">{</span><span class="n">last_step</span><span class="si">}</span><span class="s2">&quot;&quot;} &quot;</span>
                              <span class="s2">&quot;--kill-on-invalid-dep=yes &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">.slurm)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">runfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo &#39;</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">.slurm submitted as &#39;$&quot;</span>
                          <span class="s2">&quot;{&quot;</span><span class="sa">f</span><span class="s2">&quot;ID</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">&quot;&quot;}&quot;</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">step_number</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">get_step_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_number</span><span class="o">=</span><span class="s1">&#39;step_X&#39;</span><span class="p">,</span> <span class="n">last_step</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Provides the attributes of a step. Additionally, it replaces</span>
<span class="sd">            defined sets and it checks for missing attributes and may copies</span>
<span class="sd">            them from a previous step.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            step_number : str</span>
<span class="sd">                String representation of the current step</span>
<span class="sd">            last_step : str</span>
<span class="sd">                String representation of the last step</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            dict</span>
<span class="sd">                A dictionary containing all the parameters for the current step</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">step_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s1"> not in pipeline_kwargs.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">((</span><span class="s1">&#39;step&#39;</span> <span class="ow">in</span> <span class="n">step_number</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">step_number</span><span class="o">==</span><span class="s1">&#39;rerun&#39;</span><span class="p">)):</span>
                <span class="c1"># check for attributes</span>
                <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">ATTRIBUTES_TO_CHECK</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">]</span><span class="o">.</span>\
                        <span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span>\
                        <span class="p">[</span><span class="n">step_number</span><span class="p">][</span><span class="n">attribute</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">last_step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>\
                            <span class="ow">and</span> <span class="n">attribute</span> <span class="ow">in</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">last_step</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="c1"># infer missing attribute from last step</span>
                            <span class="n">Pwarn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copy </span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">last_step</span><span class="si">}</span><span class="s2"> to &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">][</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">last_step</span><span class="p">][</span><span class="n">attribute</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s1"> has no </span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># replace pre defined sets</span>
                <span class="k">if</span> <span class="s1">&#39;CREATE_PLOTS&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">set_name</span><span class="p">,</span> <span class="n">set_content</span> <span class="ow">in</span> <span class="n">PLOTTING_SETS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">]</span>\
                                       <span class="p">[</span><span class="s1">&#39;CREATE_PLOTS&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">][</span><span class="s1">&#39;CREATE_PLOTS&#39;</span><span class="p">]</span><span class="o">.</span>\
                                <span class="n">remove</span><span class="p">(</span><span class="n">set_name</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">][</span><span class="s1">&#39;CREATE_PLOTS&#39;</span><span class="p">]</span><span class="o">.</span>\
                                <span class="n">extend</span><span class="p">(</span><span class="n">set_content</span><span class="p">)</span>
                    <span class="c1"># remove all plot entries in case the global plotting flag</span>
                    <span class="c1"># is off</span>
                    <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;pipeline setup&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span>\
                        <span class="p">(</span><span class="s1">&#39;MAKE_PLOTS&#39;</span> <span class="ow">in</span>\
                         <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="s1">&#39;pipeline setup&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="s1">&#39;pipeline setup&#39;</span><span class="p">]</span>\
                                 <span class="p">[</span><span class="s1">&#39;MAKE_PLOTS&#39;</span><span class="p">])):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">][</span><span class="s1">&#39;CREATE_PLOTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="s1">&#39;DO_CHECKS&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">set_name</span><span class="p">,</span> <span class="n">set_content</span> <span class="ow">in</span> <span class="n">CHECKING_SETS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">]</span>\
                                       <span class="p">[</span><span class="s1">&#39;DO_CHECKS&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">][</span><span class="s1">&#39;DO_CHECKS&#39;</span><span class="p">]</span><span class="o">.</span>\
                                <span class="n">remove</span><span class="p">(</span><span class="n">set_name</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">][</span><span class="s1">&#39;DO_CHECKS&#39;</span><span class="p">]</span><span class="o">.</span>\
                                <span class="n">extend</span><span class="p">(</span><span class="n">set_content</span><span class="p">)</span>
                    <span class="c1"># remove all check entries in case the global checking flag</span>
                    <span class="c1"># is off</span>
                    <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;pipeline setup&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span>\
                        <span class="p">(</span><span class="s1">&#39;MAKE_CHECKS&#39;</span> <span class="ow">in</span>\
                         <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="s1">&#39;pipeline setup&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="s1">&#39;pipeline setup&#39;</span><span class="p">]</span>\
                                 <span class="p">[</span><span class="s1">&#39;MAKE_CHECKS&#39;</span><span class="p">])):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">][</span><span class="s1">&#39;DO_CHECKS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># return attributes</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">]</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">has_substep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_number</span><span class="o">=</span><span class="s1">&#39;step_X&#39;</span><span class="p">,</span> <span class="n">substep</span><span class="o">=</span><span class="s1">&#39;ALL&#39;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Checks whether a step has substeps.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            step_number : str</span>
<span class="sd">                String representation of the current step</span>
<span class="sd">            substep : str</span>
<span class="sd">                String representation of the substep</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            bool</span>
<span class="sd">                Only True if a valid substep is found</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">step_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s1"> not in pipeline_kwargs!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">substep</span><span class="o">==</span><span class="s1">&#39;ALL&#39;</span><span class="p">:</span> <span class="c1"># check all possible substeps</span>
                <span class="n">substeps</span> <span class="o">=</span> <span class="n">SUB_STEPS_TO_EXTENSION</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># check the specified substep</span>
                <span class="n">substeps</span> <span class="o">=</span> <span class="p">[</span><span class="n">substep</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">sub_step</span> <span class="ow">in</span> <span class="n">substeps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sub_step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">SUB_STEP_LIST</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">][</span><span class="n">sub_step</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">SUB_STEP_LIST</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">SUB_STEP_LIST</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># at least one entry is found in the substep</span>
                        <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># no entry for the substep(s)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="c1"># check for sections &#39;account&#39; and &#39;pipeline setup&#39; and store their</span>
        <span class="c1"># attributes</span>
        <span class="k">if</span> <span class="s1">&#39;account&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;account not in pipeline_kwargs!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;pipeline setup&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;pipeline setup not in pipeline_kwargs!&#39;</span><span class="p">)</span>
        <span class="n">account_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="s1">&#39;account&#39;</span><span class="p">]</span>
        <span class="n">setup_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="s1">&#39;pipeline setup&#39;</span><span class="p">]</span>
        
        <span class="c1"># take verbose value from setup arguments</span>
        <span class="k">if</span> <span class="s1">&#39;VERBOSE&#39;</span> <span class="ow">in</span> <span class="n">setup_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">setup_kwargs</span><span class="p">[</span><span class="s1">&#39;VERBOSE&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;VERBOSE not given, use False&quot;</span><span class="p">,</span> <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
            <span class="n">VERBOSE</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{:+^45s}</span><span class="s2"> </span><span class="se">\n</span><span class="si">{}</span><span class="se">\n\n</span><span class="si">{:+^45s}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;ACCOUNT&#39;</span><span class="p">,</span> <span class="n">pformat</span><span class="p">(</span><span class="n">account_kwargs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                    <span class="s1">&#39;SETUP&#39;</span><span class="p">,</span> <span class="n">pformat</span><span class="p">(</span><span class="n">setup_kwargs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
                 <span class="p">)</span>
        
        <span class="n">previously_created_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plot_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pipeline_steps</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;run_pipeline.sh&#39;</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s1">&#39;Replace run_pipeline.sh&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="c1"># create a runfile script</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;run_pipeline.sh&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">runfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">runfile</span><span class="o">.</span><span class="n">writable</span><span class="p">():</span>
                <span class="n">runfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t write to </span><span class="si">{</span><span class="n">runfile</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># loop through all steps</span>
            <span class="n">last_step</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">step_number</span> <span class="ow">in</span> <span class="n">ACTION_TO_STEP_NUM</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">setup_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">do_step_bool</span> <span class="o">=</span> <span class="n">setup_kwargs</span><span class="p">[</span><span class="n">action</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">do_step_bool</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{:-^45s}</span><span class="s2"> </span><span class="si">{:^8s}</span><span class="s2">:</span><span class="si">{:^6s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">action</span><span class="p">,</span> <span class="n">step_number</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">do_step_bool</span><span class="p">))</span> <span class="p">)</span>

                <span class="k">if</span> <span class="n">do_step_bool</span> <span class="ow">or</span> <span class="n">has_substep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_number</span><span class="o">=</span><span class="n">step_number</span><span class="p">):</span>
                    <span class="n">step_kwargs</span> <span class="o">=</span> <span class="n">get_step_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                  <span class="n">step_number</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>
                                                  <span class="n">last_step</span><span class="o">=</span><span class="n">last_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span> <span class="n">pformat</span><span class="p">(</span><span class="n">step_kwargs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>

                <span class="k">if</span> <span class="n">do_step_bool</span><span class="p">:</span>
                    <span class="c1"># create csv file and remember therein created files</span>
                    <span class="n">previously_created_files</span> <span class="o">+=</span> <span class="n">create_csv</span><span class="p">(</span>
                        <span class="n">step_name</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>
                        <span class="n">previously_created_files</span><span class="o">=</span><span class="n">previously_created_files</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">step_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">setup_kwargs</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="c1"># create slurm file</span>
                    <span class="n">slurm_job</span><span class="p">(</span>
                        <span class="n">job_name</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>
                        <span class="n">step_name</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>
                        <span class="n">PATH_TO_POSYDON</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PATH_TO_POSYDON</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">step_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">setup_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">account_kwargs</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">pipeline_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_number</span><span class="p">)</span>
                    <span class="c1"># add job to the list in the runfile script</span>
                    <span class="n">expand_runfile</span><span class="p">(</span><span class="n">runfile</span><span class="p">,</span> <span class="n">step_number</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>
                                   <span class="n">last_step</span><span class="o">=</span><span class="n">last_step</span><span class="p">)</span>
                    <span class="c1"># remember that this step was done last</span>
                    <span class="n">last_step</span> <span class="o">=</span> <span class="n">step_number</span>
                    <span class="c1"># add cleanup</span>
                    <span class="k">if</span> <span class="n">create_cleanup_slurm_job</span><span class="p">(</span><span class="n">job_name</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>\
                        <span class="n">step_name</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>\
                        <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">step_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">setup_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">account_kwargs</span><span class="p">}):</span>
                        <span class="n">pipeline_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_number</span><span class="o">+</span><span class="s2">&quot;_cleanup&quot;</span><span class="p">)</span>
                        <span class="n">expand_runfile</span><span class="p">(</span><span class="n">runfile</span><span class="p">,</span>
                                       <span class="n">step_number</span><span class="o">=</span><span class="n">step_number</span><span class="o">+</span><span class="s2">&quot;_cleanup&quot;</span><span class="p">,</span>
                                       <span class="n">last_step</span><span class="o">=</span><span class="n">last_step</span><span class="p">)</span>
                    <span class="c1"># try to load the profile interpolation module, because it</span>
                    <span class="c1"># will be needed when running step 5</span>
                    <span class="k">if</span> <span class="n">step_number</span> <span class="o">==</span> <span class="s2">&quot;step_5&quot;</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">posydon.interpolation.profile_interpolation</span>\
                            <span class="kn">import</span><span class="w"> </span><span class="nn">CompileData</span><span class="o">,</span><span class="w"> </span><span class="nn">ProfileInterpolator</span>
                
                <span class="k">for</span> <span class="n">sub_step</span><span class="p">,</span> <span class="n">step_extension</span> <span class="ow">in</span> <span class="n">SUB_STEPS_TO_EXTENSION</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sub_step</span> <span class="ow">not</span> <span class="ow">in</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="n">step_number</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">has_substep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_number</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>
                                   <span class="n">substep</span><span class="o">=</span><span class="n">sub_step</span><span class="p">):</span>
                        <span class="c1"># get sub-step number to be a concatenation of the main</span>
                        <span class="c1"># step and the sub-step extension.</span>
                        <span class="n">sub_step_number</span> <span class="o">=</span> <span class="n">step_number</span><span class="o">+</span><span class="n">step_extension</span>
                        <span class="c1"># create csv file for sub step</span>
                        <span class="n">plot_dirs</span> <span class="o">+=</span> <span class="n">create_csv</span><span class="p">(</span>
                            <span class="n">step_name</span><span class="o">=</span><span class="n">sub_step_number</span><span class="p">,</span>
                            <span class="n">previously_created_files</span><span class="o">=</span><span class="n">previously_created_files</span><span class="p">,</span>
                            <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">step_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">setup_kwargs</span><span class="p">}</span>
                        <span class="p">)</span>
                        <span class="c1"># create slurm file for sub step</span>
                        <span class="n">slurm_job</span><span class="p">(</span>
                            <span class="n">job_name</span><span class="o">=</span><span class="n">sub_step_number</span><span class="p">,</span>
                            <span class="n">step_name</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>
                            <span class="n">PATH_TO_POSYDON</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PATH_TO_POSYDON</span><span class="p">,</span>
                            <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">step_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">setup_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">account_kwargs</span><span class="p">}</span>
                        <span class="p">)</span>
                        <span class="n">pipeline_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_step_number</span><span class="p">)</span>
                        <span class="c1"># add job to the list in the runfile script</span>
                        <span class="n">expand_runfile</span><span class="p">(</span><span class="n">runfile</span><span class="p">,</span> <span class="n">step_number</span><span class="o">=</span><span class="n">sub_step_number</span><span class="p">,</span>
                                       <span class="n">last_step</span><span class="o">=</span><span class="n">last_step</span><span class="p">)</span>
                        <span class="c1"># add cleanup</span>
                        <span class="k">if</span> <span class="n">create_cleanup_slurm_job</span><span class="p">(</span><span class="n">job_name</span><span class="o">=</span><span class="n">sub_step_number</span><span class="p">,</span>\
                            <span class="n">step_name</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">step_kwargs</span><span class="p">,</span>\
                                 <span class="o">**</span><span class="n">setup_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">account_kwargs</span><span class="p">}):</span>
                            <span class="n">pipeline_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_step_number</span><span class="o">+</span><span class="s2">&quot;_cleanup&quot;</span><span class="p">)</span>
                            <span class="n">expand_runfile</span><span class="p">(</span><span class="n">runfile</span><span class="p">,</span>
                                <span class="n">step_number</span><span class="o">=</span><span class="n">sub_step_number</span><span class="o">+</span><span class="s2">&quot;_cleanup&quot;</span><span class="p">,</span>
                                <span class="n">last_step</span><span class="o">=</span><span class="n">sub_step_number</span><span class="p">)</span>
                        <span class="c1"># there are no dependencies supported on sub steps</span>
                        <span class="c1"># beside the cleanup</span>
            <span class="c1"># add cleanup for pipeline</span>
            <span class="k">if</span> <span class="n">create_cleanup_slurm_job</span><span class="p">(</span><span class="n">job_name</span><span class="o">=</span><span class="s1">&#39;pipeline&#39;</span><span class="p">,</span>\
                <span class="n">step_name</span><span class="o">=</span><span class="s1">&#39;pipeline&#39;</span><span class="p">,</span>\
                <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">step_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">setup_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">account_kwargs</span><span class="p">}):</span>
                <span class="c1"># create csv with all created files</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;PATH&#39;</span> <span class="ow">in</span> <span class="n">setup_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">PATH</span> <span class="o">=</span> <span class="n">setup_kwargs</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;PATH not given, use current directory&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
                    <span class="n">PATH</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pipeline_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previously_created_files</span> <span class="o">+</span>\
                                       <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">plot_dirs</span><span class="p">))</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;pipeline_files.csv&#39;</span><span class="p">),</span>
                          <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="c1"># add cleanup to run script</span>
                <span class="n">submission_line</span> <span class="o">=</span> <span class="s2">&quot;IDpipeline_cleanup=$(sbatch --parsable &quot;</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pipeline_steps</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">submission_line</span> <span class="o">+=</span> <span class="s2">&quot;--dependency=&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">submission_line</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
                    <span class="n">submission_line</span> <span class="o">+=</span> <span class="s2">&quot;afterany:$&quot;&quot;{&quot;</span><span class="sa">f</span><span class="s2">&quot;ID</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;&quot;}&quot;</span>
                <span class="n">submission_line</span> <span class="o">+=</span> <span class="s2">&quot; --kill-on-invalid-dep=yes &quot;</span>
                <span class="n">submission_line</span> <span class="o">+=</span> <span class="s2">&quot;pipeline_cleanup.slurm)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">runfile</span><span class="o">.</span><span class="n">writable</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;pipeline_cleanup.slurm&quot;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find file &quot;</span>
                                                <span class="s2">&quot;pipeline_cleanup.slurm&quot;</span><span class="p">)</span>
                    <span class="n">runfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">submission_line</span><span class="p">)</span>
                    <span class="n">runfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;echo &#39;pipeline_cleanup.slurm submitted as &#39;&quot;</span>
                                  <span class="s2">&quot;$</span><span class="si">{IDpipeline_cleanup}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t write to </span><span class="si">{</span><span class="n">runfile</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># make the runfile script executable</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;chmod a+x run_pipeline.sh&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="PostProcessingPipeline.create_log_dirs">
<a class="viewcode-back" href="../api_reference/posydon_setup_pipeline.html#posydon_setup_pipeline.PostProcessingPipeline.create_log_dirs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_log_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create directories to store the log files.&quot;&quot;&quot;</span>

        <span class="c1"># use work directory given by PATH in the setup attributes</span>
        <span class="k">if</span> <span class="s1">&#39;pipeline setup&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;pipeline setup not in pipeline_kwargs!&#39;</span><span class="p">)</span>
        <span class="n">setup_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_kwargs</span><span class="p">[</span><span class="s1">&#39;pipeline setup&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;PATH&#39;</span> <span class="ow">in</span> <span class="n">setup_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">setup_kwargs</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">],</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;PATH not given, use current directory&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
            <span class="n">logs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>
        <span class="c1"># create logs in working dir to store all slurm outputs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">logs_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">logs_path</span><span class="p">)</span>
        <span class="c1"># create sub directories for each step</span>
        <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">step_number</span> <span class="ow">in</span> <span class="n">ACTION_TO_STEP_NUM</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">action</span> <span class="ow">in</span> <span class="n">setup_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">setup_kwargs</span><span class="p">[</span><span class="n">action</span><span class="p">]):</span>
                <span class="n">step_log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logs_path</span><span class="p">,</span> <span class="n">step_number</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">step_log_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">step_log_path</span><span class="p">)</span>
        <span class="c1"># create sub directory for cleanup</span>
        <span class="n">step_log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logs_path</span><span class="p">,</span> <span class="s1">&#39;cleanup&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">step_log_path</span><span class="p">):</span>
             <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">step_log_path</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="slurm_job">
<a class="viewcode-back" href="../api_reference/posydon_setup_pipeline.html#posydon_setup_pipeline.slurm_job">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">slurm_job</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span>
              <span class="n">step_name</span><span class="p">,</span>
              <span class="n">PATH_TO_GRIDS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">PATH_TO_POSYDON</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">PATH</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
              <span class="n">ACCOUNT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">PARTITION</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">WALLTIME</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">MAILTYPE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">EMAIL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">VERBOSE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create slurm file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    job_name : str</span>
<span class="sd">        String representation of the job. It will be used in the file name.</span>
<span class="sd">    step_name : str</span>
<span class="sd">        String representation of the parent step. It will be used for the logs.</span>
<span class="sd">    PATH_TO_GRIDS : str</span>
<span class="sd">        Path where to find the root directory of the grids.</span>
<span class="sd">    PATH_TO_POSYDON : str</span>
<span class="sd">        Path where to find the root directory of POSYDON.</span>
<span class="sd">    PATH : str</span>
<span class="sd">        Path of the working directory.</span>
<span class="sd">    ACCOUNT : str</span>
<span class="sd">        The slurm account name. Passed to slurm&#39;s option &#39;--account&#39;.</span>
<span class="sd">    PARTITION : str</span>
<span class="sd">        The slurm partition name. Passed to slurm&#39;s option &#39;--partition&#39;.</span>
<span class="sd">    WALLTIME : str</span>
<span class="sd">        Maximum time for the slurm job. Passed to slurm&#39;s option &#39;--time&#39;.</span>
<span class="sd">    MAILTYPE : str</span>
<span class="sd">        Specifier, which emails to send by slurm. Passed to slurm&#39;s option</span>
<span class="sd">        &#39;--mail-type&#39;. It requires EMAIL to be set, too.</span>
<span class="sd">    EMAIL : str</span>
<span class="sd">        Email address to send mails to. Passed to slurm&#39;s option &#39;--mail-user&#39;.</span>
<span class="sd">        It requires MAILTYPE to be set, too.</span>
<span class="sd">    VERBOSE : bool</span>
<span class="sd">        Enables/Disables additional output.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Other parameters (all being ignored).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PATH_TO_GRIDS=</span><span class="si">{</span><span class="n">PATH_TO_GRIDS</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
    <span class="c1"># get path to csv file</span>
    <span class="n">path_to_csv_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing csv file: </span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">.slurm&#39;</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Replace </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">.slurm&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
    <span class="c1"># create slurm file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">.slurm&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># get STEPID</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;step&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">STEPID</span> <span class="o">=</span> <span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">STEPID</span> <span class="o">+=</span> <span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;rerun&#39;</span><span class="p">:</span>
            <span class="n">STEPID</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;No step ID detected, leave it empty&quot;</span><span class="p">,</span> <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
            <span class="n">STEPID</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># write slurm file content</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ACCOUNT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --account=</span><span class="si">{</span><span class="n">ACCOUNT</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PARTITION</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --partition=</span><span class="si">{</span><span class="n">PARTITION</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -N 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --cpus-per-task 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --ntasks-per-node 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">WALLTIME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --time=</span><span class="si">{</span><span class="n">WALLTIME</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --job-name=psygrid</span><span class="si">{</span><span class="n">STEPID</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --mem-per-cpu=4G</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">EMAIL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">MAILTYPE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --mail-type=</span><span class="si">{</span><span class="n">MAILTYPE</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --mail-user=</span><span class="si">{</span><span class="n">EMAIL</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># extract array size</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">job_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;step_1&#39;</span><span class="p">,</span> <span class="s1">&#39;step_3&#39;</span><span class="p">,</span> <span class="s1">&#39;step_4&#39;</span><span class="p">,</span> <span class="s1">&#39;step_5&#39;</span><span class="p">,</span> <span class="s1">&#39;step_F&#39;</span><span class="p">,</span>\
            <span class="s1">&#39;rerun&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;check&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">)):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;step_2&#39;</span><span class="p">]:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv_file</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;This should never happen! job_name=</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> has no jobs to run, please check &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --array=0-</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">slurm_array</span> <span class="o">=</span> <span class="s1">&#39;$SLURM_ARRAY_TASK_ID&#39;</span>
        <span class="c1"># get logs path and set the output of the slurm job</span>
        <span class="k">if</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
            <span class="n">path_to_logs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">step_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_to_logs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">job_name</span><span class="p">)</span>
        <span class="n">log_file_name</span> <span class="o">=</span> <span class="n">get_log_file_name</span><span class="p">(</span><span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>\
                                          <span class="n">step_name</span><span class="o">=</span><span class="n">step_name</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --open-mode=truncate</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --output=</span><span class="si">{</span><span class="n">path_to_logs</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">log_file_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># set PATH_TO_POSYDON where needed</span>
        <span class="k">if</span> <span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_3&#39;</span><span class="p">:</span> <span class="c1"># CALCULATE_EXTRA_VALUES</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;export PATH_TO_POSYDON=</span><span class="si">{</span><span class="n">PATH_TO_POSYDON</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># reset display settings</span>
        <span class="k">if</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span> <span class="c1"># PLOTS</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;unset DISPLAY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># get path to run the pipeline</span>
        <span class="n">path_to_run_pipeline</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_POSYDON</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;posydon-run-pipeline&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_to_run_pipeline</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Pipeline&#39;s runfile not found at &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path_to_run_pipeline</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="c1"># encode the verbose information for running the pipeline as a command</span>
        <span class="c1"># line argument</span>
        <span class="k">if</span> <span class="n">VERBOSE</span> <span class="ow">and</span> <span class="s1">&#39;check&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">srun python </span><span class="si">{</span><span class="n">path_to_run_pipeline</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">PATH_TO_GRIDS</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">slurm_array</span><span class="si">}</span><span class="s2"> 1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">srun python </span><span class="si">{</span><span class="n">path_to_run_pipeline</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">PATH_TO_GRIDS</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path_to_csv_file</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">slurm_array</span><span class="si">}</span><span class="s2"> 0&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_csv">
<a class="viewcode-back" href="../api_reference/posydon_setup_pipeline.html#posydon_setup_pipeline.create_csv">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_csv</span><span class="p">(</span><span class="n">GRID_TYPES</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">METALLICITIES</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">GRID_SLICES</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">COMPRESSIONS</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">step_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
               <span class="n">VERSION</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
               <span class="n">PLOT_EXTENSION</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span>
               <span class="n">GRIDS_COMBINED</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">ORIGINAL_COMPRESSIONS</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">INTERPOLATION_METHODS</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">PROFILE_NAMES</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">CONTROL_GRIDS</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">STOP_BEFORE_CARBON_DEPLETION</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
               <span class="n">RERUN_TYPE</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
               <span class="n">CLUSTER</span><span class="o">=</span><span class="s1">&#39;quest&#39;</span><span class="p">,</span>
               <span class="n">DROP_MISSING_FILES</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">CREATE_PLOTS</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">DO_CHECKS</span><span class="o">=</span><span class="p">[],</span>
               <span class="n">PATH_TO_GRIDS</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
               <span class="n">PATH</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
               <span class="n">previously_created_files</span><span class="o">=</span><span class="p">[],</span>
               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create csv file with a list containing all data to process a step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    GRID_TYPES : list</span>
<span class="sd">        Grid types in the directory tree in PATH_TO_GRIDS.</span>
<span class="sd">    METALLICITIES : list</span>
<span class="sd">        Metallicities in the directory tree below grid types (or version).</span>
<span class="sd">    GRID_SLICES : list</span>
<span class="sd">        Grid slices in the directory tree below the metallicities.</span>
<span class="sd">    COMPRESSIONS: list</span>
<span class="sd">        Compression types (e.g. LITE or ORIGINAL).</span>
<span class="sd">    step_name : str</span>
<span class="sd">        String representation of the step. It will be used in the file name.</span>
<span class="sd">    VERSION : str</span>
<span class="sd">        Version in the directory tree level below the grid type. (outdated)</span>
<span class="sd">    PLOT_EXTENSION : str</span>
<span class="sd">        The file extension for plots recognized by mathplotlib or</span>
<span class="sd">        &#39;multipage-pdf&#39;.</span>
<span class="sd">    GRIDS_COMBINED : list</span>
<span class="sd">        The names of the new grids combined from several slices.</span>
<span class="sd">    ORIGINAL_COMPRESSIONS : list</span>
<span class="sd">        Grids with the orgininal compression to get detailed data from them.</span>
<span class="sd">    INTERPOLATION_METHODS : list</span>
<span class="sd">        The interpolation methodes (e.g. linear or 1NN).</span>
<span class="sd">    PROFILE_NAMES : list</span>
<span class="sd">        The profiles which should get interpolated (e.g. radius, logRho, ...)</span>
<span class="sd">    CONTROL_GRIDS : list</span>
<span class="sd">        Grids used to check the interpolators.</span>
<span class="sd">    STOP_BEFORE_CARBON_DEPLETION : int</span>
<span class="sd">        Flag to stop high mass stars before carbon depletion because of chaotic</span>
<span class="sd">        behavior.</span>
<span class="sd">    RERUN_TYPE : str</span>
<span class="sd">        Rerun types (e.g. PISN, reverse_MT, ...).</span>
<span class="sd">    CLUSTER : str</span>
<span class="sd">        Name of the cluster (e.g. yggdrasil or quest).</span>
<span class="sd">    DROP_MISSING_FILES : bool</span>
<span class="sd">        Enable/Disable to ignore files which neither exists nor are created</span>
<span class="sd">        beforehand.</span>
<span class="sd">    CREATE_PLOTS : list</span>
<span class="sd">        Requested plots to be created (e.g. combined_TF12, termination_flag_1,</span>
<span class="sd">        ...).</span>
<span class="sd">    DO_CHECKS : list</span>
<span class="sd">        Requested checks (e.g. failure_rate, CO_type).</span>
<span class="sd">    PATH_TO_GRIDS : str</span>
<span class="sd">        Path where to find the root directory of the grids.</span>
<span class="sd">    PATH : str</span>
<span class="sd">        Path of the working directory.</span>
<span class="sd">    previously_created_files : list</span>
<span class="sd">        List of filenames created by previous steps.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Other parameters (all being ignored).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List of names of files which will be created by this step.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PATH_TO_GRIDS=</span><span class="si">{</span><span class="n">PATH_TO_GRIDS</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">PATH</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PATH=</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
    <span class="c1"># number of grid types</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">GRID_TYPES</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">N</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">METALLICITIES</span><span class="p">)</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">GRID_SLICES</span><span class="p">)</span> <span class="ow">or</span>
         <span class="n">N</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">COMPRESSIONS</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Missmatch between the len of GRID_TYPES, &#39;</span>
                         <span class="s1">&#39;METALLICITIES, GRID_SLICES, COMPRESSIONS.&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;Lengths: </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">METALLICITIES</span><span class="p">)</span><span class="si">}</span><span class="s1">, &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">GRID_SLICES</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">COMPRESSIONS</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_2&#39;</span><span class="p">:</span>
        <span class="c1"># there need to be as many combined files specified as recipes are</span>
        <span class="c1"># given to create them.</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">GRIDS_COMBINED</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;len(GRID_TYPES) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">GRID_TYPES</span><span class="p">)</span><span class="si">}</span><span class="s1"> != &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">GRIDS_COMBINED</span><span class="p">)</span><span class="si">}</span><span class="s1"> = len(GRIDS_COMBINED)!&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_3&#39;</span><span class="p">:</span>
        <span class="c1"># here we need a reference grid with ORIGINAL compression to</span>
        <span class="c1"># calculated the extra quantities from.</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ORIGINAL_COMPRESSIONS</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;len(GRID_TYPES) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">GRID_TYPES</span><span class="p">)</span><span class="si">}</span><span class="s1"> != &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ORIGINAL_COMPRESSIONS</span><span class="p">)</span><span class="si">}</span><span class="s1"> = &#39;</span>
                             <span class="s1">&#39;len(ORIGINAL_COMPRESSIONS)!&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">((</span><span class="s1">&#39;step_4_&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;step_5&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)):</span>
        <span class="c1"># sub steps of the interpolator training need a control grid</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">GRID_SLICES</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">CONTROL_GRIDS</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;len(GRID_SLICES) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">GRID_SLICES</span><span class="p">)</span><span class="si">}</span><span class="s1"> != &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">CONTROL_GRIDS</span><span class="p">)</span><span class="si">}</span><span class="s1"> = len(CONTROL_GRIDS)!&#39;</span><span class="p">)</span>

    <span class="n">grids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grids_compression</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grids_type</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stop_before_carbon_depletion</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grids_ORIGINAL</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">processed_grids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">interpolation_methods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">interpolators</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">profile_quantities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">profile_interpolators</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">export_path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rerun_metallicities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rerun_path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rerun_type</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plot_dirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plot_quantities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plot_extensions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">newly_created_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="c1"># loop over all grid types</span>
    <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">grid_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">GRID_TYPES</span><span class="p">):</span>
        <span class="n">METALLICITIES_</span> <span class="o">=</span> <span class="n">METALLICITIES</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">GRID_SLICES_</span> <span class="o">=</span> <span class="n">GRID_SLICES</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">COMPRESSIONS_</span> <span class="o">=</span> <span class="n">COMPRESSIONS</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ORIGINAL_COMPRESSIONS</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>\
            <span class="nb">len</span><span class="p">(</span><span class="n">ORIGINAL_COMPRESSIONS</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">ORIGINAL_COMPRESSIONS_</span> <span class="o">=</span> <span class="n">ORIGINAL_COMPRESSIONS</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="c1"># loop over all metallicities, grid slices and compressions</span>
        <span class="k">for</span> <span class="n">metallicity</span> <span class="ow">in</span> <span class="n">METALLICITIES_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">grid_slice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">GRID_SLICES_</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">compression</span> <span class="ow">in</span> <span class="n">COMPRESSIONS_</span><span class="p">:</span>
                    <span class="c1"># get RLO extension text depending on compression</span>
                    <span class="k">if</span> <span class="s1">&#39;RLO&#39;</span> <span class="ow">in</span> <span class="n">compression</span><span class="p">:</span>
                        <span class="n">RLO</span> <span class="o">=</span> <span class="s1">&#39;_RLO&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">RLO</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="c1"># check for combined gird in step 2 and its supsteps</span>
                    <span class="k">if</span> <span class="s1">&#39;step_2&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">GRID_SLICES</span><span class="p">[</span><span class="n">l</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">GRIDS_COMBINED</span><span class="p">[</span><span class="n">l</span><span class="p">]):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;len(GRID_SLICES[</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">]) = &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">GRID_SLICES</span><span class="p">[</span><span class="n">l</span><span class="p">])</span><span class="si">}</span><span class="s1"> != &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">GRIDS_COMBINED</span><span class="p">[</span><span class="n">l</span><span class="p">])</span><span class="si">}</span><span class="s1"> =&#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;len(GRIDS_COMBINED[</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">])!&#39;</span><span class="p">)</span>
                    <span class="c1"># check for combined gird in steps 4 and 5 (incl. supsteps)</span>
                    <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;step_4_&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;step_5&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">GRID_SLICES</span><span class="p">[</span><span class="n">l</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">CONTROL_GRIDS</span><span class="p">[</span><span class="n">l</span><span class="p">]):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;len(GRID_SLICES[</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">]) = &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">GRID_SLICES</span><span class="p">[</span><span class="n">l</span><span class="p">])</span><span class="si">}</span><span class="s1"> != &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">CONTROL_GRIDS</span><span class="p">[</span><span class="n">l</span><span class="p">])</span><span class="si">}</span><span class="s1"> =&#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;len(CONTROL_GRIDS[</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">])!&#39;</span><span class="p">)</span>
                    <span class="c1"># create data lists depending on the (sub)step</span>
                    <span class="k">if</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_1&#39;</span><span class="p">:</span> <span class="c1"># CREATE_GRID_SLICES</span>
                        <span class="c1"># This step needs the location of the grid slice, the</span>
                        <span class="c1"># compression applied to it, the type of the gird, and</span>
                        <span class="c1"># the information, whether it is OK to stop cut of some</span>
                        <span class="c1"># evolution short before carbon depletion for massive</span>
                        <span class="c1"># stars.</span>
                        <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span>
                                                  <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                                  <span class="n">grid_slice</span><span class="p">))</span>
                        <span class="n">grids_compression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compression</span><span class="p">)</span>
                        <span class="n">grids_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid_type</span><span class="p">)</span>
                        <span class="n">stop_before_carbon_depletion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">STOP_BEFORE_CARBON_DEPLETION</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">compression_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                           <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                           <span class="n">metallicity</span><span class="p">,</span>
                                                           <span class="n">compression</span><span class="p">)</span>
                            <span class="c1"># the compression directory will be created if not</span>
                            <span class="c1"># existing already</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">compression_dir</span><span class="p">):</span>
                                <span class="n">newly_created_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compression_dir</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_2&#39;</span><span class="p">:</span> <span class="c1"># COMBINE_GRID_SLICES</span>
                        <span class="c1"># This step needs the name of the combined gird and the</span>
                        <span class="c1"># information which slices get combined for each</span>
                        <span class="c1"># combined gird. It will be stored in a data frame,</span>
                        <span class="c1"># with the name of the combined grid as column key and</span>
                        <span class="c1"># the column containing the slices to be combined.</span>
                        <span class="n">combine_grid_slices</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="c1"># grid_slice is a batch</span>
                        <span class="k">for</span> <span class="n">grid_slice_</span> <span class="ow">in</span> <span class="n">grid_slice</span><span class="p">:</span>
                                <span class="n">path_to_grid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                <span class="n">metallicity</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span>
                                                <span class="n">grid_slice_</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">)</span>
                                <span class="n">combine_grid_slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_to_grid</span><span class="p">)</span>
                        <span class="n">path_to_grid_combined</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                 <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                 <span class="n">metallicity</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span>
                                                 <span class="n">GRIDS_COMBINED</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">)</span>
                        <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                        <span class="n">df_tmp</span><span class="p">[</span><span class="n">path_to_grid_combined</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_grid_slices</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span><span class="n">df_tmp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_3&#39;</span><span class="p">:</span> <span class="c1"># CALCULATE_EXTRA_VALUES</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ORIGINAL_COMPRESSIONS_</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>\
                            <span class="nb">len</span><span class="p">(</span><span class="n">ORIGINAL_COMPRESSIONS_</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                            <span class="c1"># use one orginal for all compressions, hence use</span>
                            <span class="c1"># first one and ignore others</span>
                            <span class="n">original_compression</span> <span class="o">=</span> <span class="n">ORIGINAL_COMPRESSIONS_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># if not defined assume &#39;ORIGINAL&#39;</span>
                            <span class="n">original_compression</span> <span class="o">=</span> <span class="s1">&#39;ORIGINAL&#39;</span>
                        <span class="c1"># This step needs the grid to process, the grid type,</span>
                        <span class="c1"># the grid containing the ORIGINAL data, and the name</span>
                        <span class="c1"># of the new grid containing the processed data.</span>
                        <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                      <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                      <span class="n">compression</span><span class="p">,</span> <span class="n">grid_slice</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
                        <span class="n">grids_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid_type</span><span class="p">)</span>
                        <span class="n">grids_ORIGINAL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                               <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                               <span class="n">metallicity</span><span class="p">,</span>
                                               <span class="n">original_compression</span><span class="o">+</span><span class="n">RLO</span><span class="p">,</span>
                                               <span class="n">grid_slice</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
                        <span class="n">processed_grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                <span class="n">metallicity</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span>
                                                <span class="n">grid_slice</span><span class="o">+</span><span class="s1">&#39;_processed.h5&#39;</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_4&#39;</span><span class="p">:</span> <span class="c1"># TRAIN_INTERPOLATORS</span>
                        <span class="c1"># This step needs the grids to use for the training,</span>
                        <span class="c1"># the grid type, the interpolation methods, and the</span>
                        <span class="c1"># names of the files where the interpolator data gets</span>
                        <span class="c1"># written to.</span>
                        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">INTERPOLATION_METHODS</span><span class="p">:</span>
                            <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                          <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                          <span class="n">compression</span><span class="p">,</span> <span class="n">grid_slice</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
                            <span class="n">grids_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid_type</span><span class="p">)</span>
                            <span class="n">interpolation_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="o">+</span><span class="n">RLO</span><span class="p">)</span>
                            <span class="n">interpolators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                  <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                  <span class="n">metallicity</span><span class="p">,</span>
                                                  <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;IF_&#39;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span><span class="n">RLO</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">interpolator_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                <span class="n">metallicity</span><span class="p">,</span>
                                                <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">)</span>
                            <span class="c1"># the interpolator directory will be created if not</span>
                            <span class="c1"># existing already</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">interpolator_dir</span><span class="p">):</span>
                                <span class="n">newly_created_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolator_dir</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_5&#39;</span><span class="p">:</span> <span class="c1"># TRAIN_PROFILE_INTERPOLATORS</span>
                        <span class="c1"># This step needs the grids to use for the training,</span>
                        <span class="c1"># the grid type, the names of the files of the IF</span>
                        <span class="c1"># interpolators, the quantities to get profiles</span>
                        <span class="c1"># interpolated for, and the names of the files where</span>
                        <span class="c1"># the interpolator data gets written to. </span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">PROFILE_NAMES</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>\
                            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PROFILE_NAMES</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)):</span>
                            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">INTERPOLATION_METHODS</span><span class="p">:</span>
                                <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                              <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                              <span class="n">compression</span><span class="p">,</span> <span class="n">grid_slice</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
                                <span class="n">grids_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid_type</span><span class="p">)</span>
                                <span class="n">interpolators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                    <span class="n">PATH_TO_GRIDS</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                    <span class="n">metallicity</span><span class="p">,</span> <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;IF_&#39;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span><span class="n">RLO</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
                                <span class="n">profile_quantities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PROFILE_NAMES</span><span class="p">)</span>
                                <span class="n">profile_interpolators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                    <span class="n">PATH_TO_GRIDS</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                    <span class="n">metallicity</span><span class="p">,</span> <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;profile_&#39;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span><span class="n">RLO</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">interpolator_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                    <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                    <span class="n">metallicity</span><span class="p">,</span>
                                                    <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">)</span>
                                <span class="c1"># the interpolator directory will be created if</span>
                                <span class="c1"># not existing already</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">interpolator_dir</span><span class="p">):</span>
                                    <span class="n">newly_created_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="n">interpolator_dir</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_F&#39;</span><span class="p">:</span> <span class="c1"># EXPORT_DATASET</span>
                        <span class="k">if</span> <span class="s2">&quot;RLO&quot;</span> <span class="ow">in</span> <span class="n">grid_type</span><span class="p">:</span>
                            <span class="n">export_dir</span> <span class="o">=</span> <span class="n">grid_type</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">export_dir</span> <span class="o">=</span> <span class="n">grid_type</span><span class="o">+</span><span class="n">RLO</span>
                        <span class="c1"># This step needs the grids/interpolators to export and</span>
                        <span class="c1"># the path where to export them to. </span>
                        <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                      <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                      <span class="n">compression</span><span class="p">,</span> <span class="n">grid_slice</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
                        <span class="n">full_export_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;POSYDON_data&#39;</span><span class="p">,</span>
                                                       <span class="n">export_dir</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full_export_dir</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">full_export_dir</span><span class="p">)</span>
                        <span class="n">export_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_export_dir</span><span class="p">,</span>
                                                        <span class="n">metallicity</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="s1">&#39;linear3c_kNN&#39;</span><span class="p">],</span>
                                        <span class="p">[</span><span class="s1">&#39;1NN&#39;</span><span class="p">,</span><span class="s1">&#39;1NN_1NN&#39;</span><span class="p">]]:</span>
                            <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span>
                                          <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                          <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;IF_&#39;</span><span class="o">+</span><span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">RLO</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
                            <span class="n">full_export_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span>
                                               <span class="s1">&#39;POSYDON_data&#39;</span><span class="p">,</span> <span class="n">export_dir</span><span class="p">,</span>
                                               <span class="s1">&#39;interpolators&#39;</span><span class="p">,</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full_export_dir</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">full_export_dir</span><span class="p">)</span>
                            <span class="n">export_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_export_dir</span><span class="p">,</span>
                                                <span class="n">metallicity</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;rerun&#39;</span><span class="p">:</span> <span class="c1"># RERUN</span>
                        <span class="c1"># This step needs the grid to get the runs from, the</span>
                        <span class="c1"># path for the new runs, the grid type, the</span>
                        <span class="c1"># metallicity, the rerun type and the cluster name.</span>
                        <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span>
                                      <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span>
                                      <span class="n">grid_slice</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
                        <span class="n">rerun_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                           <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                           <span class="s1">&#39;rerun_&#39;</span><span class="o">+</span><span class="n">RERUN_TYPE</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">grid_slice</span><span class="p">))</span>
                        <span class="n">grids_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid_type</span><span class="p">)</span>
                        <span class="n">rerun_metallicities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metallicity</span><span class="p">)</span>
                        <span class="n">rerun_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RERUN_TYPE</span><span class="p">)</span>
                        <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CLUSTER</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;check&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)):</span>
                        <span class="c1"># get output grid names for sub steps</span>
                        <span class="k">if</span> <span class="s1">&#39;step_2&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
                            <span class="n">grid_s</span> <span class="o">=</span> <span class="n">GRIDS_COMBINED</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="s1">&#39;step_3&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
                            <span class="n">grid_s</span> <span class="o">=</span> <span class="n">grid_slice</span><span class="o">+</span><span class="s1">&#39;_processed&#39;</span>
                        <span class="k">elif</span> <span class="p">((</span><span class="s1">&#39;step_4&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)</span> <span class="ow">or</span>
                              <span class="p">(</span><span class="s1">&#39;step_5&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)):</span>
                            <span class="n">grid_s</span> <span class="o">=</span> <span class="n">CONTROL_GRIDS</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">grid_s</span> <span class="o">=</span> <span class="n">grid_slice</span>
                        
                        <span class="k">if</span> <span class="n">grid_s</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="c1"># skip that slice for sub steps</span>
                            <span class="k">continue</span>
                        
                        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;step_4&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)</span> <span class="ow">and</span> 
                            <span class="p">(</span><span class="s1">&#39;step_5&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)):</span>
                            <span class="c1"># all steps without interpolation method get an</span>
                            <span class="c1"># empty method</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">INTERPOLATION_METHODS</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">INTERPOLATION_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
                        
                        <span class="k">if</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span> <span class="c1"># PLOTS</span>
                            <span class="c1"># only plot first compression type, but allow for</span>
                            <span class="c1"># with and without RLO flag</span>
                            <span class="k">if</span> <span class="p">((</span><span class="n">compression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COMPRESSIONS_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span>
                                <span class="p">(</span><span class="n">COMPRESSIONS_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compression</span><span class="p">)):</span>
                                <span class="k">continue</span>
                            <span class="c1"># loop over interpolation methods and plots</span>
                            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">INTERPOLATION_METHODS</span><span class="p">:</span>
<span class="c1">#                                for to_plot in CREATE_PLOTS:</span>
<span class="c1">#                                    plot_quantities.append(to_plot)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">CREATE_PLOTS</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                    <span class="c1"># Plots need the to know what to plot, the</span>
                                    <span class="c1"># grid to get the data from, its grid type,</span>
                                    <span class="c1"># the directory to put the plots to, the</span>
                                    <span class="c1"># extension for the plot files, and the</span>
                                    <span class="c1"># name of an interpolator, when using it.</span>
                                    <span class="n">plot_quantities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CREATE_PLOTS</span><span class="p">)</span>
                                    <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                  <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                  <span class="n">metallicity</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span>
                                                  <span class="n">grid_s</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
                                    <span class="n">grids_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid_type</span><span class="p">)</span>
                                    <span class="n">plot_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                      <span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                      <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                      <span class="n">metallicity</span><span class="p">,</span> <span class="s1">&#39;plots&#39;</span><span class="p">,</span>
                                                      <span class="n">RLO</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">RLO</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">grid_s</span><span class="p">))</span>
                                    <span class="n">plot_extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PLOT_EXTENSION</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="c1"># if there is a method</span>
                                        <span class="k">if</span> <span class="s1">&#39;step_4&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
                                            <span class="n">interpolators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                <span class="n">PATH_TO_GRIDS</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span>
                                                <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                                <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;IF_&#39;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span><span class="n">RLO</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
                                        <span class="k">elif</span> <span class="s1">&#39;step_5&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
                                            <span class="n">interpolators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                <span class="n">PATH_TO_GRIDS</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span>
                                                <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                                <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;profile_&#39;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span><span class="n">RLO</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                         <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                         <span class="n">metallicity</span><span class="p">,</span> <span class="s1">&#39;plots&#39;</span><span class="p">)</span>
                                <span class="c1"># the plots directory will be created if not</span>
                                <span class="c1"># existing already</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">):</span>
                                    <span class="n">newly_created_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;check&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span> <span class="c1"># CHECKS</span>
                            <span class="c1"># loop over interpolation methods and checks</span>
                            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">INTERPOLATION_METHODS</span><span class="p">:</span>
<span class="c1">#                                for to_check in DO_CHECKS:</span>
<span class="c1">#                                    checks.append(to_check)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DO_CHECKS</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                    <span class="c1"># Checks need the to know what kind of</span>
                                    <span class="c1"># check to do, the grid to get the data</span>
                                    <span class="c1"># from, and the name of an interpolator,</span>
                                    <span class="c1"># when using it.</span>
                                    <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DO_CHECKS</span><span class="p">)</span>
                                    <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_GRIDS</span><span class="p">,</span>
                                                  <span class="n">grid_type</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                                                  <span class="n">metallicity</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span>
                                                  <span class="n">grid_s</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="c1"># if there is a method</span>
                                        <span class="k">if</span> <span class="s1">&#39;step_4&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
                                            <span class="n">interpolators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                <span class="n">PATH_TO_GRIDS</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span>
                                                <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                                <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;IF_&#39;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span><span class="n">RLO</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
                                        <span class="k">elif</span> <span class="s1">&#39;step_5&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
                                            <span class="n">interpolators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                <span class="n">PATH_TO_GRIDS</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span>
                                                <span class="n">VERSION</span><span class="p">,</span> <span class="n">metallicity</span><span class="p">,</span>
                                                <span class="s1">&#39;interpolation_objects&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;profile_&#39;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span><span class="n">RLO</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
    
    <span class="c1"># saving dataset to csv file (step 2 is special here, because the data</span>
    <span class="c1"># frame was already created.)</span>
    <span class="k">if</span> <span class="n">step_name</span> <span class="o">!=</span> <span class="s1">&#39;step_2&#39;</span><span class="p">:</span>
        <span class="c1"># create a data frame to export it to a csv file (each step requires</span>
        <span class="c1"># other data columns)</span>
        <span class="n">grids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grids</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids</span>
        <span class="k">if</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_1&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids_compression</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids_type</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stop_before_carbon_depletion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop_before_carbon_depletion</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_3&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids_type</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_grid_ORIGINAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids_ORIGINAL</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_processed_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_grids</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_4&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids_type</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;interpolation_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolation_methods</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_interpolator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolators</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_5&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids_type</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;profile_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile_quantities</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_IF_interpolator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolators</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_profile_interpolator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile_interpolators</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_F&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;export_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">export_path</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;rerun&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rerun_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rerun_path</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids_type</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rerun_metallicity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rerun_metallicities</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rerun_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rerun_type</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clusters</span>
        <span class="k">elif</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grid_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grids_type</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;quantities_to_plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_quantities</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_dirs</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plot_extension&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_extensions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interpolators</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_interpolator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolators</span>
        <span class="k">elif</span> <span class="s1">&#39;check&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;checks_to_do&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">checks</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interpolators</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_interpolator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolators</span>
        <span class="c1"># drop lines when grid directories/files are not found</span>
        <span class="k">if</span> <span class="n">DROP_MISSING_FILES</span><span class="p">:</span>
            <span class="n">drop_rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="c1"># grid file is always needed</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previously_created_files</span><span class="p">):</span>
                    <span class="n">drop_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_3&#39;</span><span class="p">:</span>
                    <span class="c1"># grid file with ORIGINAL compression needed</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;path_to_grid_ORIGINAL&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previously_created_files</span><span class="p">):</span>
                        <span class="n">drop_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">((</span><span class="s1">&#39;step_4_&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;step_5_&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)):</span>
                    <span class="c1"># interpolator files needed</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;path_to_interpolator&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previously_created_files</span><span class="p">):</span>
                        <span class="n">drop_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;step_5&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
                    <span class="c1"># interpolator files needed</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;path_to_IF_interpolator&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previously_created_files</span><span class="p">):</span>
                        <span class="n">drop_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="c1"># report about missing files and remove tasks, which need them</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_rows</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{:-^54s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step_name</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The following grids will not be processed because the &#39;</span>
                      <span class="s1">&#39;files/directories are missing! If this warning message &#39;</span>
                      <span class="s1">&#39;is unexpected to you, please check the file paths!&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">drop_rows</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_3&#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;path_to_grid_ORIGINAL&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">((</span><span class="s1">&#39;step_4_&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)</span> <span class="ow">or</span>
                          <span class="p">(</span><span class="s1">&#39;step_5_&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;path_to_interpolator&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="s1">&#39;step_5&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;path_to_IF_interpolator&#39;</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">drop_rows</span><span class="p">)</span>
        <span class="c1"># keep track of files created by a step</span>
        <span class="k">if</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_1&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;path_to_grid&#39;</span><span class="p">]</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;compression&#39;</span><span class="p">]</span>
                <span class="n">newly_created_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_new_grid_name</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">compression</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_3&#39;</span><span class="p">:</span>
            <span class="n">newly_created_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_processed_grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_4&#39;</span><span class="p">:</span>
            <span class="n">newly_created_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_interpolator&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_5&#39;</span><span class="p">:</span>
            <span class="n">newly_created_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path_to_profile_interpolator&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;step_F&#39;</span><span class="p">:</span>
            <span class="n">newly_created_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;export_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">step_name</span> <span class="o">==</span> <span class="s1">&#39;rerun&#39;</span><span class="p">:</span>
            <span class="n">newly_created_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rerun_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">step_name</span><span class="p">:</span>
            <span class="n">newly_created_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">plot_dirs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># step 2</span>
        <span class="c1"># drop columns when psygrid files are not found</span>
        <span class="k">if</span> <span class="n">DROP_MISSING_FILES</span><span class="p">:</span>
            <span class="n">first_time</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">drop_rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">column</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previously_created_files</span><span class="p">):</span>
                            <span class="n">drop_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="c1"># report about missing files and adjust column</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_rows</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{:-^54s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step_name</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;If this warning message is unexpected to you, &#39;</span>
                              <span class="s1">&#39;please check that step 1 occoured &#39;</span>
                              <span class="s1">&#39;succesffully!&#39;</span><span class="p">)</span>
                        <span class="n">first_time</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;In </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> the following grids are skipped!&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">drop_rows</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">column</span><span class="p">])</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">newcol</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newcol</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">drop_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                    <span class="n">newcol</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">newcol</span><span class="p">))</span><span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcol</span>
            <span class="c1"># report about empty tasks and remove them</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{:-^54s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step_name</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;If this warning message is unexpected to you, &#39;</span>
                          <span class="s1">&#39;please check that step 1 occoured &#39;</span>
                          <span class="s1">&#39;succesffully!&#39;</span><span class="p">)</span>
                    <span class="n">first_time</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The following grids will not be combined as all grid &#39;</span>
                      <span class="s1">&#39;slices are missing!&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">drop_columns</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">newly_created_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    <span class="c1"># finally save data frame</span>
    <span class="n">output_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s1">.csv&#39;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="n">output_fname</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># return list of new files created by that step</span>
    <span class="k">return</span> <span class="n">newly_created_files</span></div>



<div class="viewcode-block" id="create_cleanup_slurm_job">
<a class="viewcode-back" href="../api_reference/posydon_setup_pipeline.html#posydon_setup_pipeline.create_cleanup_slurm_job">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_cleanup_slurm_job</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span>
                             <span class="n">step_name</span><span class="p">,</span>
                             <span class="n">PATH</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                             <span class="n">ACCOUNT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">PARTITION</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">WALLTIME</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">MAILTYPE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">EMAIL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">GROUP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">VERBOSE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create slurm file for cleanup job.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    job_name : str</span>
<span class="sd">        String representation of the job. It will be used in the file name.</span>
<span class="sd">    step_name : str</span>
<span class="sd">        String representation of the parent step. It will be used for the logs.</span>
<span class="sd">    PATH : str</span>
<span class="sd">        Path of the working directory.</span>
<span class="sd">    ACCOUNT : str</span>
<span class="sd">        The slurm account name. Passed to slurm&#39;s option &#39;--account&#39;.</span>
<span class="sd">    PARTITION : str</span>
<span class="sd">        The slurm partition name. Passed to slurm&#39;s option &#39;--partition&#39;.</span>
<span class="sd">    WALLTIME : str</span>
<span class="sd">        Maximum time for the slurm job. Passed to slurm&#39;s option &#39;--time&#39;.</span>
<span class="sd">    MAILTYPE : str</span>
<span class="sd">        Specifier, which emails to send by slurm. Passed to slurm&#39;s option</span>
<span class="sd">        &#39;--mail-type&#39;. It requires EMAIL to be set, too.</span>
<span class="sd">    EMAIL : str</span>
<span class="sd">        Email address to send mails to. Passed to slurm&#39;s option &#39;--mail-user&#39;.</span>
<span class="sd">        It requires MAILTYPE to be set, too.</span>
<span class="sd">    GROUP : str</span>
<span class="sd">        Group name to get ownership and permissions on files created by the</span>
<span class="sd">        pipeline.</span>
<span class="sd">    VERBOSE : bool</span>
<span class="sd">        Enables/Disables additional output.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Other parameters (all being ignored).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_2&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_F&#39;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;rerun&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="s1">&#39;check&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">((</span><span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;pipeline&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">GROUP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">PATH</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PATH=</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">_cleanup.slurm&#39;</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Replace </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">_cleanup.slurm&#39;</span><span class="p">,</span> <span class="s2">&quot;OverwriteWarning&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">_cleanup.slurm&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># write slurm file content</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ACCOUNT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --account=</span><span class="si">{</span><span class="n">ACCOUNT</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">PARTITION</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --partition=</span><span class="si">{</span><span class="n">PARTITION</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -N 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --cpus-per-task 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --ntasks-per-node 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">WALLTIME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --time=</span><span class="si">{</span><span class="n">WALLTIME</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --job-name=cleanup</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --mem-per-cpu=4G</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">EMAIL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --mail-type=FAIL</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --mail-user=</span><span class="si">{</span><span class="n">EMAIL</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">path_to_logs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="s1">&#39;cleanup&#39;</span><span class="p">)</span>
            <span class="n">log_file_name</span> <span class="o">=</span> <span class="n">get_log_file_name</span><span class="p">(</span><span class="n">job_name</span><span class="o">=</span><span class="s2">&quot;cleanup&quot;</span><span class="p">,</span>\
                                              <span class="n">step_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --open-mode=truncate</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --output=</span><span class="si">{</span><span class="n">path_to_logs</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">log_file_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># get logs path and set the output of the slurm job</span>
            <span class="k">if</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                <span class="n">path_to_log_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">step_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path_to_log_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">job_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_2&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_F&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;rerun&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="s1">&#39;check&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">)):</span>
                <span class="c1"># combine logs</span>
                <span class="n">old_log_file_names</span> <span class="o">=</span> <span class="n">get_log_file_name</span><span class="p">(</span><span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>\
                                                       <span class="n">step_name</span><span class="o">=</span><span class="n">step_name</span><span class="p">)</span>
                <span class="n">new_log_file_name</span> <span class="o">=</span> <span class="n">old_log_file_names</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_</span><span class="si">%4a</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
                <span class="n">old_log_file_names</span> <span class="o">=</span> <span class="n">old_log_file_names</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_</span><span class="si">%4a</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_*&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">cat </span><span class="si">{</span><span class="n">path_to_log_files</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">old_log_file_names</span><span class="si">}</span><span class="s2"> &gt;&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">path_to_log_files</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_log_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">rm </span><span class="si">{</span><span class="n">path_to_log_files</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">old_log_file_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># the overall cleanup of the pipeline</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;pipeline&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">GROUP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">echo </span><span class="se">\&quot;</span><span class="s2">Change group to </span><span class="si">{</span><span class="n">GROUP</span><span class="si">}</span><span class="s2"> and group &quot;</span>
                            <span class="s2">&quot;permission to rwX at least for all files stated &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">/pipeline_files.csv</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">for FILE in $(cat </span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">/pipeline_files.csv); do&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  chgrp -fR </span><span class="si">{</span><span class="n">GROUP</span><span class="si">}</span><span class="s2"> $&quot;&quot;</span><span class="si">{FILE}</span><span class="s2">;&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  chmod -fR g+rwX $</span><span class="si">{FILE}</span><span class="s2">;&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">done&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">echo </span><span class="se">\&quot;</span><span class="s2">Acting on </span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2"> and all subdirectories&quot;</span>
                            <span class="s2">&quot;/files in there</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">echo </span><span class="se">\&quot;</span><span class="s2">Change group to </span><span class="si">{</span><span class="n">GROUP</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">chgrp -fR </span><span class="si">{</span><span class="n">GROUP</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">echo </span><span class="se">\&quot;</span><span class="s2">Change group permission to rwX at least</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">chmod -fR g+rwX </span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">echo </span><span class="se">\&quot;</span><span class="s2">Done, check </span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ls -al </span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="get_log_file_name">
<a class="viewcode-back" href="../api_reference/posydon_setup_pipeline.html#posydon_setup_pipeline.get_log_file_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_log_file_name</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">step_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get name of log file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    job_name : str</span>
<span class="sd">        Name of the job.</span>
<span class="sd">    step_name : str</span>
<span class="sd">        Name of the step/parent job the job belongs to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Name of the log file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_1&#39;</span><span class="p">:</span> <span class="c1"># CREATE_GRID_SLICES</span>
        <span class="k">return</span> <span class="s2">&quot;grid_slice_</span><span class="si">%4a</span><span class="s2">.out&quot;</span>
    <span class="k">if</span> <span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_2&#39;</span><span class="p">:</span> <span class="c1"># COMBINE_GRID_SLICES</span>
        <span class="k">return</span> <span class="s2">&quot;combine_grid_slice_</span><span class="si">%4a</span><span class="s2">.out&quot;</span>
    <span class="k">if</span> <span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_3&#39;</span><span class="p">:</span> <span class="c1"># CALCULATE_EXTRA_VALUES</span>
        <span class="k">return</span> <span class="s2">&quot;post_processing_</span><span class="si">%4a</span><span class="s2">.out&quot;</span>
    <span class="k">if</span> <span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_4&#39;</span><span class="p">:</span> <span class="c1"># TRAIN_INTERPOLATORS</span>
        <span class="k">return</span> <span class="s2">&quot;train_interpolator_</span><span class="si">%4a</span><span class="s2">.out&quot;</span>
    <span class="k">if</span> <span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_5&#39;</span><span class="p">:</span> <span class="c1"># TRAIN_PROFILE_INTERPOLATORS</span>
        <span class="k">return</span> <span class="s2">&quot;train_profile_interpolator_</span><span class="si">%4a</span><span class="s2">.out&quot;</span>
    <span class="k">if</span> <span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;step_F&#39;</span><span class="p">:</span> <span class="c1"># EXPORT_DATASET</span>
        <span class="k">return</span> <span class="s2">&quot;export_dataset_</span><span class="si">%4a</span><span class="s2">.out&quot;</span>
    <span class="k">if</span> <span class="n">job_name</span> <span class="o">==</span> <span class="s1">&#39;rerun&#39;</span><span class="p">:</span> <span class="c1"># RERUN</span>
        <span class="k">return</span> <span class="s2">&quot;rerun_</span><span class="si">%4a</span><span class="s2">.out&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span> <span class="c1"># PLOTS</span>
        <span class="k">return</span> <span class="s2">&quot;plots_&quot;</span><span class="o">+</span><span class="n">step_name</span><span class="o">+</span><span class="s2">&quot;_slice_</span><span class="si">%4a</span><span class="s2">.out&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;check&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span> <span class="c1"># CHECKS</span>
        <span class="k">return</span> <span class="s2">&quot;checks_&quot;</span><span class="o">+</span><span class="n">step_name</span><span class="o">+</span><span class="s2">&quot;_slice_</span><span class="si">%4a</span><span class="s2">.out&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;cleanup&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span> <span class="c1"># CLEANUPS</span>
        <span class="k">return</span> <span class="s2">&quot;cleanup_&quot;</span><span class="o">+</span><span class="n">step_name</span><span class="o">+</span><span class="s2">&quot;.out&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;log.out&quot;</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;--help&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Programm to setup the posydon pipeline&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;syntax: posydon-setup-pipeline INI_FILE_PATH&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INI_FILE_PATH: path to the ini file containing the data&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ini_file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ini_file_path</span><span class="p">:</span>
            <span class="n">ini_file_path</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="n">ini_file_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No ini file specified.&#39;</span><span class="p">)</span>
    
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">PostProcessingPipeline</span><span class="p">(</span><span class="n">ini_file_path</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">create_csv_and_slurm_job_files</span><span class="p">()</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">create_log_dirs</span><span class="p">()</span>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Tassos Fragos.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      Version: 2.1.1
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        
        <dl>
            <dt> v2</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v2.0.6/index.html">2.0</a></dd>
            
            <dd><a href="https://posydon.org/POSYDON/v2.1.2/index.html">2.1</a></dd>
            
        </dl>
        
        <dl>
            <dt> v1</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v1.0.5/index.html">1.0</a></dd>
            
        </dl>
        
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>