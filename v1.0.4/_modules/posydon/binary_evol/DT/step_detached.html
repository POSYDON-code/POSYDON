<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>posydon.binary_evol.DT.step_detached &mdash; posydon 1.0.4 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            posydon
          </a>
              <div class="version">
                1.0.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data/data.html">Data Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">Application Programming Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Binary Star Grids</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../run_mesa_grids/inifile.html">.ini file documentation for POSYDON GRIDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../run_mesa_grids/fixed/fixed.html">Run a fixed MESA grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../PSyGrid/PSyGrid.html">The PSyGrid Object</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Generating Populations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pop_synth/POSYDON_populations.html">Running populations using POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pop_synth/pop_synth.html">Running a POSYDON population synthesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pop_synth/custom_flow.html">Custom population synthesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../SingleStar/SingleStar.html">The SingleStar object</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../BinaryStar/BinaryStar.html">The BinaryStar object</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../advanced_pop_options/custom_hooks.html">Evolutionary Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../advanced_pop_options/debugging_binaries.html">Debugging Failed Binaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../interpolation/IF-Interpolator/IFInterpolator.html">Initial-Final Interpolation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plotting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../visualization/plot1D/plot1D.html">1D plotting functionalities for POSYDON GRIDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../visualization/plot2D/plot2D.html">2D plotting functionalities for POSYDON GRIDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../visualization/VHD/VHD.html">Van den Heuvel diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../interpolation/violinplot.html">Making the Violin Plot</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../about/licence.html">Licence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about/attribution.html">Attribution</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">posydon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">posydon.binary_evol.DT.step_detached</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for posydon.binary_evol.DT.step_detached</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Detached evolution step.&quot;&quot;&quot;</span>


<span class="n">__authors__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Devina Misra &lt;devina.misra@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Zepei Xing &lt;Zepei.Xing@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Emmanouil Zapartas &lt;ezapartas@gmail.com&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Nam Tran &lt;tranhn03@gmail.com&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Simone Bavera &lt;Simone.Bavera@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Konstantinos Kovlakas &lt;Konstantinos.Kovlakas@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Kyle Akira Rocha &lt;kylerocha2024@u.northwestern.edu&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Jeffrey Andrews &lt;jeffrey.andrews@northwestern.edu&gt;&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">solve_ivp</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">PchipInterpolator</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root</span>

<span class="kn">from</span> <span class="nn">posydon.utils.data_download</span> <span class="kn">import</span> <span class="n">PATH_TO_POSYDON_DATA</span>
<span class="kn">from</span> <span class="nn">posydon.binary_evol.binarystar</span> <span class="kn">import</span> <span class="n">BINARYPROPERTIES</span>
<span class="kn">from</span> <span class="nn">posydon.binary_evol.singlestar</span> <span class="kn">import</span> <span class="n">STARPROPERTIES</span>
<span class="kn">from</span> <span class="nn">posydon.interpolation</span> <span class="kn">import</span> <span class="n">GRIDInterpolator</span>
<span class="kn">from</span> <span class="nn">posydon.interpolation.data_scaling</span> <span class="kn">import</span> <span class="n">DataScaler</span>
<span class="kn">from</span> <span class="nn">posydon.utils.common_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">bondi_hoyle</span><span class="p">,</span>
    <span class="n">orbital_period_from_separation</span><span class="p">,</span>
    <span class="n">roche_lobe_radius</span><span class="p">,</span>
    <span class="n">check_state_of_star</span><span class="p">,</span>
    <span class="n">PchipInterpolator2</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">posydon.binary_evol.flow_chart</span> <span class="kn">import</span> <span class="p">(</span><span class="n">STAR_STATES_CC</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">posydon.utils.constants</span> <span class="k">as</span> <span class="nn">const</span>


<span class="n">LIST_ACCEPTABLE_STATES_FOR_HMS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;H-rich_Core_H_burning&quot;</span><span class="p">]</span>

<span class="n">LIST_ACCEPTABLE_STATES_FOR_postMS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;H-rich_Shell_H_burning&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H-rich_Core_He_burning&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H-rich_Central_He_depleted&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H-rich_Core_C_burning&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H-rich_Central_C_depletion&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H-rich_non_burning&quot;</span><span class="p">]</span>

<span class="n">LIST_ACCEPTABLE_STATES_FOR_HeStar</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;stripped_He_Core_He_burning&#39;</span><span class="p">,</span>
    <span class="s1">&#39;stripped_He_Shell_He_burning&#39;</span><span class="p">,</span>     <span class="c1"># includes stars burning C in core</span>
    <span class="s1">&#39;stripped_He_Central_He_depleted&#39;</span><span class="p">,</span>  <span class="c1"># includes stars burning C in core</span>
    <span class="s1">&#39;stripped_He_Central_C_depletion&#39;</span><span class="p">,</span>
    <span class="s1">&#39;stripped_He_non_burning&#39;</span>           <span class="c1"># includes stars burning C in core</span>
    <span class="p">]</span>

<span class="n">STAR_STATES_H_RICH</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;H-rich_Core_H_burning&#39;</span><span class="p">,</span>
    <span class="s1">&#39;H-rich_Core_He_burning&#39;</span><span class="p">,</span>
    <span class="s1">&#39;H-rich_Shell_H_burning&#39;</span><span class="p">,</span>
    <span class="s1">&#39;H-rich_Central_He_depleted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;H-rich_Shell_He_burning&#39;</span><span class="p">,</span>
    <span class="s1">&#39;H-rich_Core_C_burning&#39;</span><span class="p">,</span>
    <span class="s1">&#39;H-rich_Central_C_depletion&#39;</span><span class="p">,</span>
    <span class="s1">&#39;H-rich_non_burning&#39;</span>
<span class="p">]</span>


<div class="viewcode-block" id="detached_step"><a class="viewcode-back" href="../../../../api/posydon.binary_evol.DT.step_detached.html#posydon.binary_evol.DT.step_detached.detached_step">[docs]</a><span class="k">class</span> <span class="nc">detached_step</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evolve a detached binary.</span>

<span class="sd">    The binary will be evolved until Roche-lobe overflow, core-collapse or</span>
<span class="sd">    maximum simulation time, using the standard equations that govern the</span>
<span class="sd">    orbital evolution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to the directory that contains a HDF5 grid.</span>
<span class="sd">    dt : float</span>
<span class="sd">        The timestep size, in years, to be appended to the history of the</span>
<span class="sd">        binary. None means only the final step.</span>
<span class="sd">        Note: do not select very small timesteps cause it may mess with the</span>
<span class="sd">        solving of the ODE.</span>
<span class="sd">    n_o_steps_history: int</span>
<span class="sd">        Alternatively, we can define the number of timesteps to be appended to</span>
<span class="sd">        the history of the binary. None means only the final step. If both `dt`</span>
<span class="sd">        and `n_o_steps_history` are different than None, `dt` has priority.</span>
<span class="sd">    matching_method: str</span>
<span class="sd">        Method to find the best match between a star from a previous step and a</span>
<span class="sd">        point in a single MIST-like stellar track. Options &quot;root&quot; (which tries</span>
<span class="sd">        to find a root of two matching quantities, and it is possible to not</span>
<span class="sd">        achieve it) or &quot;minimize&quot; (minimizes the sum of squares of differences</span>
<span class="sd">        of various quantities between the previous step and the track).</span>
<span class="sd">    verbose : Boolean</span>
<span class="sd">        True if we want to print stuff.</span>
<span class="sd">    do_wind_loss: Boolean</span>
<span class="sd">        If True, take into account change of separation due to mass loss from</span>
<span class="sd">        the star.</span>
<span class="sd">    do_tides: Booleans</span>
<span class="sd">        If True, take into account change of separation, eccentricity and star</span>
<span class="sd">        spin due to tidal forces.</span>
<span class="sd">    do_gravitational_radiation: Boolean</span>
<span class="sd">        If True, take into account change of separation and eccentricity due to</span>
<span class="sd">        gravitational wave radiation.</span>
<span class="sd">    do_magnetic_braking: Boolean</span>
<span class="sd">        If True, take into account change of star spin due to magnetic braking.</span>
<span class="sd">    do_stellar_evolution_and_spin_from_winds: Boolean</span>
<span class="sd">        If True, take into account change of star spin due to change of its</span>
<span class="sd">        moment of inertia during its evolution and due to spin angular momentum</span>
<span class="sd">        loss due to winds.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    KEYS : list of str</span>
<span class="sd">           Contains valid keywords which is used</span>
<span class="sd">           to extract quantities from the grid.</span>
<span class="sd">    grid : GRIDInterpolator</span>
<span class="sd">           Object to interpolate between the time-series in</span>
<span class="sd">           the h5 grid.</span>
<span class="sd">    initial_mass : list of float</span>
<span class="sd">            Contains the initial masses of the stars in the grid.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    A matching between the properties of the star, and the h5 tracks are</span>
<span class="sd">    required. In the &quot;root&quot; solver matching_method, if the root solver fails</span>
<span class="sd">    then the evolution will immediately end, and the binary state will be</span>
<span class="sd">    tagged with &quot;Root solver failed&quot;. In the &quot;minimize&quot; matching_method, we</span>
<span class="sd">    minimize the sum of squares of differences of various quantities between</span>
<span class="sd">    the previous step and the h5 track.</span>

<span class="sd">    Warns</span>
<span class="sd">    -----</span>
<span class="sd">    UserWarning</span>
<span class="sd">        If the call cannot determine the primary or secondary in the binary.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        If the ode-solver fails to solve the differential equation</span>
<span class="sd">        that governs the orbital evolution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">PATH_TO_POSYDON_DATA</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">n_o_steps_history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">matching_method</span><span class="o">=</span><span class="s2">&quot;minimize&quot;</span><span class="p">,</span>
            <span class="n">initial_mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">rootm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">do_wind_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">do_tides</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">do_gravitational_radiation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">do_magnetic_braking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">do_stellar_evolution_and_spin_from_winds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">RLO_orbit_at_orbit_with_same_am</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the step. See class documentation for details.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_o_steps_history</span> <span class="o">=</span> <span class="n">n_o_steps_history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matching_method</span> <span class="o">=</span> <span class="n">matching_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_wind_loss</span> <span class="o">=</span> <span class="n">do_wind_loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_tides</span> <span class="o">=</span> <span class="n">do_tides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_gravitational_radiation</span> <span class="o">=</span> <span class="n">do_gravitational_radiation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_magnetic_braking</span> <span class="o">=</span> <span class="n">do_magnetic_braking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_stellar_evolution_and_spin_from_winds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">do_stellar_evolution_and_spin_from_winds</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RLO_orbit_at_orbit_with_same_am</span> <span class="o">=</span> <span class="n">RLO_orbit_at_orbit_with_same_am</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_mass</span> <span class="o">=</span> <span class="n">initial_mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rootm</span> <span class="o">=</span> <span class="n">rootm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">dt</span><span class="p">,</span>
                <span class="n">n_o_steps_history</span><span class="p">,</span>
                <span class="n">matching_method</span><span class="p">,</span>
                <span class="n">do_wind_loss</span><span class="p">,</span>
                <span class="n">do_tides</span><span class="p">,</span>
                <span class="n">do_gravitational_radiation</span><span class="p">,</span>
                <span class="n">do_magnetic_braking</span><span class="p">,</span>
                <span class="n">do_stellar_evolution_and_spin_from_winds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orbital_period&quot;</span><span class="p">:</span> <span class="s2">&quot;porb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eccentricity&quot;</span><span class="p">:</span> <span class="s2">&quot;ecc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;separation&quot;</span><span class="p">:</span> <span class="s2">&quot;sep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;rl_relative_overflow_1&quot;</span><span class="p">:</span> <span class="s2">&quot;rl_relative_overflow_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rl_relative_overflow_2&quot;</span><span class="p">:</span> <span class="s2">&quot;rl_relative_overflow_2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lg_mtransfer_rate&quot;</span><span class="p">:</span> <span class="s2">&quot;lg_mtransfer_rate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;V_sys&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log_R&quot;</span><span class="p">:</span> <span class="s2">&quot;log_R&quot;</span><span class="p">,</span>
            <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lg_mdot&quot;</span><span class="p">:</span> <span class="s2">&quot;mdot&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log_L&quot;</span><span class="p">:</span> <span class="s2">&quot;log_L&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lg_wind_mdot&quot;</span><span class="p">:</span> <span class="s2">&quot;mdot&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lg_system_mdot&quot;</span><span class="p">:</span> <span class="s2">&quot;lg_mdot&quot;</span><span class="p">,</span>
            <span class="s2">&quot;he_core_mass&quot;</span><span class="p">:</span> <span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;he_core_radius&quot;</span><span class="p">:</span> <span class="s2">&quot;he_core_radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;c_core_mass&quot;</span><span class="p">:</span> <span class="s2">&quot;c_core_mass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;c_core_radius&quot;</span><span class="p">:</span> <span class="s2">&quot;c_core_radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;o_core_mass&quot;</span><span class="p">:</span> <span class="s2">&quot;o_core_mass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;o_core_radius&quot;</span><span class="p">:</span> <span class="s2">&quot;o_core_radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;center_h1&quot;</span><span class="p">:</span> <span class="s2">&quot;center_h1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;center_he4&quot;</span><span class="p">:</span> <span class="s2">&quot;center_he4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;center_c12&quot;</span><span class="p">:</span> <span class="s2">&quot;center_c12&quot;</span><span class="p">,</span>
            <span class="s2">&quot;center_o16&quot;</span><span class="p">:</span> <span class="s2">&quot;center_o16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;center_n14&quot;</span><span class="p">:</span> <span class="s2">&quot;center_n14&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surface_h1&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_h1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surface_he4&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_he4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surface_c12&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_c12&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surface_n14&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_n14&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surface_o16&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_o16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;center_gamma&quot;</span><span class="p">:</span> <span class="s2">&quot;center_gamma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log_LH&quot;</span><span class="p">:</span> <span class="s2">&quot;log_LH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log_LHe&quot;</span><span class="p">:</span> <span class="s2">&quot;log_LHe&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log_LZ&quot;</span><span class="p">:</span> <span class="s2">&quot;log_LZ&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log_Lnuc&quot;</span><span class="p">:</span> <span class="s2">&quot;log_Lnuc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;c12_c12&quot;</span><span class="p">:</span> <span class="s2">&quot;c12_c12&quot;</span><span class="p">,</span>
            <span class="s2">&quot;avg_c_in_c_core&quot;</span><span class="p">:</span> <span class="s2">&quot;avg_c_in_c_core&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surf_avg_omega_div_omega_crit&quot;</span><span class="p">:</span> <span class="s2">&quot;surf_avg_omega_div_omega_crit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surf_avg_omega&quot;</span><span class="p">:</span> <span class="s2">&quot;omega&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">:</span> <span class="s2">&quot;inertia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log_total_angular_momentum&quot;</span><span class="p">:</span> <span class="s2">&quot;log_total_angular_momentum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;profile&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;metallicity&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;spin&quot;</span><span class="p">:</span> <span class="s2">&quot;spin_parameter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log_total_angular_momentum&quot;</span><span class="p">:</span> <span class="s2">&quot;log_total_angular_momentum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conv_env_top_mass&quot;</span><span class="p">:</span> <span class="s2">&quot;conv_env_top_mass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conv_env_bot_mass&quot;</span><span class="p">:</span> <span class="s2">&quot;conv_env_bot_mass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conv_env_top_radius&quot;</span><span class="p">:</span> <span class="s2">&quot;conv_env_top_radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conv_env_bot_radius&quot;</span><span class="p">:</span> <span class="s2">&quot;conv_env_bot_radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conv_env_turnover_time_g&quot;</span><span class="p">:</span> <span class="s2">&quot;conv_env_turnover_time_g&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conv_env_turnover_time_l_b&quot;</span><span class="p">:</span> <span class="s2">&quot;conv_env_turnover_time_l_b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conv_env_turnover_time_l_t&quot;</span><span class="p">:</span> <span class="s2">&quot;conv_env_turnover_time_l_t&quot;</span><span class="p">,</span>
            <span class="s2">&quot;envelope_binding_energy&quot;</span><span class="p">:</span> <span class="s2">&quot;envelope_binding_energy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mass_conv_reg_fortides&quot;</span><span class="p">:</span> <span class="s2">&quot;mass_conv_reg_fortides&quot;</span><span class="p">,</span>
            <span class="s2">&quot;thickness_conv_reg_fortides&quot;</span><span class="p">:</span> <span class="s2">&quot;thickness_conv_reg_fortides&quot;</span><span class="p">,</span>
            <span class="s2">&quot;radius_conv_reg_fortides&quot;</span><span class="p">:</span> <span class="s2">&quot;radius_conv_reg_fortides&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lambda_CE_1cent&quot;</span><span class="p">:</span> <span class="s2">&quot;lambda_CE_1cent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lambda_CE_10cent&quot;</span><span class="p">:</span> <span class="s2">&quot;lambda_CE_10cent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lambda_CE_30cent&quot;</span><span class="p">:</span> <span class="s2">&quot;lambda_CE_30cent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;co_core_mass&quot;</span><span class="p">:</span> <span class="s2">&quot;co_core_mass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;co_core_radius&quot;</span><span class="p">:</span> <span class="s2">&quot;co_core_radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lambda_CE_pure_He_star_10cent&quot;</span><span class="p">:</span> <span class="s2">&quot;lambda_CE_pure_He_star_10cent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trap_radius&quot;</span><span class="p">:</span> <span class="s2">&quot;trap_radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;acc_radius&quot;</span><span class="p">:</span> <span class="s2">&quot;acc_radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_sync_rad_1&quot;</span><span class="p">:</span> <span class="s2">&quot;t_sync_rad_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_sync_conv_1&quot;</span><span class="p">:</span> <span class="s2">&quot;t_sync_conv_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_sync_rad_2&quot;</span><span class="p">:</span> <span class="s2">&quot;t_sync_rad_2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_sync_conv_2&quot;</span><span class="p">:</span> <span class="s2">&quot;t_sync_conv_2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mass_transfer_case&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;nearest_neighbour_distance&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># these are the KEYS read from POSYDON h5 grid files (after translating</span>
        <span class="c1"># them to the appropriate columns)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">KEYS</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;age&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mdot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;inertia&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conv_mx1_top_r&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conv_mx1_bot_r&#39;</span><span class="p">,</span>
            <span class="s1">&#39;surface_h1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;center_h1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mass_conv_reg_fortides&#39;</span><span class="p">,</span>
            <span class="s1">&#39;thickness_conv_reg_fortides&#39;</span><span class="p">,</span>
            <span class="s1">&#39;radius_conv_reg_fortides&#39;</span><span class="p">,</span>
            <span class="s1">&#39;log_Teff&#39;</span><span class="p">,</span>
            <span class="s1">&#39;surface_he3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;surface_he4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;center_he4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;avg_c_in_c_core&#39;</span><span class="p">,</span>
            <span class="s1">&#39;log_LH&#39;</span><span class="p">,</span>
            <span class="s1">&#39;log_LHe&#39;</span><span class="p">,</span>
            <span class="s1">&#39;log_LZ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;log_Lnuc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;c12_c12&#39;</span><span class="p">,</span>
            <span class="s1">&#39;center_c12&#39;</span><span class="p">,</span>
            <span class="s1">&#39;he_core_mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;log_L&#39;</span><span class="p">,</span>
            <span class="s1">&#39;log_R&#39;</span><span class="p">,</span>
            <span class="s1">&#39;c_core_mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;o_core_mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;co_core_mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;c_core_radius&#39;</span><span class="p">,</span>
            <span class="s1">&#39;o_core_radius&#39;</span><span class="p">,</span>
            <span class="s1">&#39;co_core_radius&#39;</span><span class="p">,</span>
            <span class="s1">&#39;spin_parameter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;log_total_angular_momentum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;center_n14&#39;</span><span class="p">,</span>
            <span class="s1">&#39;center_o16&#39;</span><span class="p">,</span>
            <span class="s1">&#39;surface_n14&#39;</span><span class="p">,</span>
            <span class="s1">&#39;surface_o16&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conv_env_top_mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conv_env_bot_mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conv_env_top_radius&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conv_env_bot_radius&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conv_env_turnover_time_g&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conv_env_turnover_time_l_b&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conv_env_turnover_time_l_t&#39;</span><span class="p">,</span>
            <span class="s1">&#39;envelope_binding_energy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lambda_CE_1cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lambda_CE_10cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lambda_CE_30cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lambda_CE_pure_He_star_10cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;center_gamma&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">KEYS_POSITIVE</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;mass_conv_reg_fortides&#39;</span><span class="p">,</span>
            <span class="s1">&#39;thickness_conv_reg_fortides&#39;</span><span class="p">,</span>
            <span class="s1">&#39;radius_conv_reg_fortides&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root_keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>  <span class="c1"># for the matching</span>
            <span class="p">[</span>
                <span class="s2">&quot;age&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">,</span>
                <span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span>
                <span class="s2">&quot;center_h1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;center_he4&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surface_he4&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surface_h1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_R&quot;</span><span class="p">,</span>
                <span class="s2">&quot;center_c12&quot;</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># keys for the final value interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_keys</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;avg_c_in_c_core_at_He_depletion&#39;</span><span class="p">,</span>
            <span class="s1">&#39;co_core_mass_at_He_depletion&#39;</span><span class="p">,</span>
            <span class="s1">&#39;m_core_CE_1cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;m_core_CE_10cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;m_core_CE_30cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;m_core_CE_pure_He_star_10cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;r_core_CE_1cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;r_core_CE_10cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;r_core_CE_30cent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;r_core_CE_pure_He_star_10cent&#39;</span>
        <span class="p">)</span>

        <span class="c1"># keys for the star profile interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_keys</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;radius&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;logRho&#39;</span><span class="p">,</span>
            <span class="s1">&#39;energy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;x_mass_fraction_H&#39;</span><span class="p">,</span>
            <span class="s1">&#39;y_mass_fraction_He&#39;</span><span class="p">,</span>
            <span class="s1">&#39;z_mass_fraction_metals&#39;</span><span class="p">,</span>
            <span class="s1">&#39;neutral_fraction_H&#39;</span><span class="p">,</span>
            <span class="s1">&#39;neutral_fraction_He&#39;</span><span class="p">,</span>
            <span class="s1">&#39;avg_charge_He&#39;</span>
        <span class="p">)</span>

        <span class="n">grid_name1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;single_HMS&#39;</span><span class="p">,</span> <span class="s1">&#39;grid_0.0142.h5&#39;</span><span class="p">)</span>
        <span class="n">grid_name2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;single_HeMS&#39;</span><span class="p">,</span> <span class="s1">&#39;grid_0.0142.h5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid1</span> <span class="o">=</span> <span class="n">GRIDInterpolator</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">grid_name1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid2</span> <span class="o">=</span> <span class="n">GRIDInterpolator</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">grid_name2</span><span class="p">))</span>

<div class="viewcode-block" id="detached_step.get_track_val"><a class="viewcode-back" href="../../../../api/posydon.binary_evol.DT.step_detached.html#posydon.binary_evol.DT.step_detached.detached_step.get_track_val">[docs]</a>    <span class="k">def</span> <span class="nf">get_track_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a single value from the interpolated time-series.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            Keyword of the required quantity.</span>
<span class="sd">        m0 : float</span>
<span class="sd">            The associated initial mass of the required quantity.</span>
<span class="sd">        t  : float</span>
<span class="sd">            The required time in the time-series.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The value of the quantity `key` from a MIST-like track of</span>
<span class="sd">            initial mass `m0` at the time `t0`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># htrack as a boolean determines whether H or He grid is used</span>
        <span class="k">if</span> <span class="n">htrack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid2</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">m0</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">m0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">1e99</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">1e99</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">i_bad</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_bad</span><span class="p">):</span>
                <span class="n">i_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i_bad</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i_bad</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="detached_step.scale"><a class="viewcode-back" href="../../../../api/posydon.binary_evol.DT.step_detached.html#posydon.binary_evol.DT.step_detached.detached_step.scale">[docs]</a>    <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Nomarlize quantities in the single star grids to (0,1).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            Keyword of the required quantity.</span>
<span class="sd">        method : str</span>
<span class="sd">            Scalling method in the data normalization class</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        class</span>
<span class="sd">            Data normalization class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">htrack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_mass</span>

        <span class="n">all_attribute</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_mass</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mass</span><span class="p">):</span>
                <span class="n">all_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">all_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_attribute</span><span class="p">)</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">DataScaler</span><span class="p">()</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fit_and_transform</span><span class="p">(</span>
            <span class="n">all_value</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="c1"># xtnew = sc.transform(x)</span>
        <span class="k">return</span> <span class="n">sc</span></div>

<div class="viewcode-block" id="detached_step.transform"><a class="viewcode-back" href="../../../../api/posydon.binary_evol.DT.step_detached.html#posydon.binary_evol.DT.step_detached.detached_step.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply needed quantities to the normalization class.&quot;&quot;&quot;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">sc_mass_H</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;log_min_max&quot;</span><span class="p">)</span>
        <span class="n">sc_mass_He</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;log_min_max&quot;</span><span class="p">)</span>
        <span class="n">sc_log_R_H</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;log_R&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;min_max&quot;</span><span class="p">)</span>
        <span class="n">sc_log_R_He</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;log_R&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;min_max&quot;</span><span class="p">)</span>
        <span class="n">sc_he_core_mass_H</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;min_max&quot;</span><span class="p">)</span>
        <span class="n">sc_he_core_mass_He</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;min_max&quot;</span><span class="p">)</span>
        <span class="n">sc_center_h1</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;center_h1&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;min_max&quot;</span><span class="p">)</span>
        <span class="n">sc_center_he4_H</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;center_he4&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;min_max&quot;</span><span class="p">)</span>
        <span class="n">sc_center_he4_He</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;center_he4&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;min_max&quot;</span><span class="p">)</span>
        <span class="n">sc_center_c12</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="s2">&quot;center_c12&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;min_max&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">sc_mass_H</span><span class="p">,</span> <span class="n">sc_mass_He</span><span class="p">,</span> <span class="n">sc_log_R_H</span><span class="p">,</span> <span class="n">sc_log_R_He</span><span class="p">,</span>
                <span class="n">sc_he_core_mass_H</span><span class="p">,</span> <span class="n">sc_he_core_mass_He</span><span class="p">,</span> <span class="n">sc_center_h1</span><span class="p">,</span>
                <span class="n">sc_center_he4_H</span><span class="p">,</span> <span class="n">sc_center_he4_He</span><span class="p">,</span> <span class="n">sc_center_c12</span><span class="p">)</span></div>

<div class="viewcode-block" id="detached_step.get_root0"><a class="viewcode-back" href="../../../../api/posydon.binary_evol.DT.step_detached.html#posydon.binary_evol.DT.step_detached.detached_step.get_root0">[docs]</a>    <span class="k">def</span> <span class="nf">get_root0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="n">rs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the closest associated initial mass and time in the grid</span>
<span class="sd">        which has a specific value as tentative solutions for matching.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keys : list of str</span>
<span class="sd">            Contains the keys of the required specific quantities that will be</span>
<span class="sd">            matched in the MIST-like track.</span>
<span class="sd">        x : list of floats, of same length as &quot;keys&quot;</span>
<span class="sd">            Contains the latest values (from a previous POSYDON step) of the</span>
<span class="sd">            quantities of &quot;keys&quot; in the POSYDON SingleStar object.</span>
<span class="sd">        rs : list of floats, same length as &quot;keys&quot;</span>
<span class="sd">            Contains normalization factors to be divided for rescaling</span>
<span class="sd">            x values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of 2 float values</span>
<span class="sd">            Contains the associated initial mass (in solar units) and the time</span>
<span class="sd">            (in years) such that the time-series of the `keys` at that time has</span>
<span class="sd">            the closest values to `x`. These will become m0, t0 for the later</span>
<span class="sd">            integration during the detached binary evolution.</span>
<span class="sd">            If there is no match then NaNs will be returned instead.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">htrack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_mass</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">mass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_mass</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">mass</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rootm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_mass</span><span class="p">),</span>
                                       <span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_keys</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mass</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_mass</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_keys</span><span class="p">):</span>
                <span class="n">track</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mass</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rootm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="p">),</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">track</span>

        <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">keys</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_keys</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootm</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">rs</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootm</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="s2">&quot;age&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_keys</span><span class="p">)]</span>
        <span class="n">m0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_mass</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">m0</span><span class="p">,</span> <span class="n">t</span></div>

<div class="viewcode-block" id="detached_step.get_mist0"><a class="viewcode-back" href="../../../../api/posydon.binary_evol.DT.step_detached.html#posydon.binary_evol.DT.step_detached.detached_step.get_mist0">[docs]</a>    <span class="k">def</span> <span class="nf">get_mist0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">htrack</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the associated initial mass and time in the grid that</span>
<span class="sd">        matches the properties of the binary.</span>

<span class="sd">        For &quot;root&quot; matching_method, the properties that are matched is always</span>
<span class="sd">        the mass of the secondary star.</span>
<span class="sd">        If the secondary has the state `MS` then</span>
<span class="sd">        the center hydrogen abundance will also be matched</span>
<span class="sd">        otherwise the mass of helium-core will be matched.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        star : SingleStar</span>
<span class="sd">            The star which properties are required</span>
<span class="sd">            to be matched with the single MIST-like grid.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of 2 float values</span>
<span class="sd">            Contains the associated (in solar units) and the time (in years)</span>
<span class="sd">            such that the time-series in the grid matches</span>
<span class="sd">            the properties of the secondary.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">htrack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid2</span>
        <span class="n">m_min_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid1</span><span class="o">.</span><span class="n">grid_mass</span><span class="p">)</span>
        <span class="n">m_max_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid1</span><span class="o">.</span><span class="n">grid_mass</span><span class="p">)</span>
        <span class="n">m_min_He</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid2</span><span class="o">.</span><span class="n">grid_mass</span><span class="p">)</span>
        <span class="n">m_max_He</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid2</span><span class="o">.</span><span class="n">grid_mass</span><span class="p">)</span>
        <span class="n">get_root0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_root0</span>
        <span class="n">get_track_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span>
        <span class="n">matching_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matching_method</span>
        <span class="n">tran</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span>
        <span class="n">sc_mass_H</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sc_mass_He</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sc_log_R_H</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">sc_log_R_He</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">sc_he_core_mass_H</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">sc_he_core_mass_He</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">sc_center_h1</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">sc_center_he4_H</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">sc_center_he4_He</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">sc_center_c12</span> <span class="o">=</span> <span class="n">tran</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">initials</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># tolerance 1e-8</span>
        <span class="n">tolerance_mist_integration</span> <span class="o">=</span> <span class="mf">1e-2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">matching_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matching_method</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">star</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_HMS</span><span class="p">:</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">get_root0</span><span class="p">([</span><span class="s2">&quot;center_h1&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">star</span><span class="o">.</span><span class="n">center_h1</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span><span class="p">],</span>
                               <span class="n">htrack</span><span class="p">,</span> <span class="n">rs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mi">300</span><span class="p">])</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;center_h1&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
                        <span class="o">-</span> <span class="n">star</span><span class="o">.</span><span class="n">center_h1</span><span class="p">,</span>
                        <span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">x0</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;hybr&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">get_root0</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">star</span><span class="o">.</span><span class="n">he_core_mass</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span><span class="p">],</span>
                    <span class="n">htrack</span><span class="p">,</span>
                    <span class="n">rs</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
                        <span class="o">-</span> <span class="n">star</span><span class="o">.</span><span class="n">he_core_mass</span><span class="p">,</span>
                        <span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">x0</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;hybr&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sol</span><span class="o">.</span><span class="n">success</span> <span class="ow">or</span> <span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">initials</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">initials</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">x</span>
        <span class="k">elif</span> <span class="n">matching_method</span> <span class="o">==</span> <span class="s2">&quot;minimize&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">star</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_HMS</span><span class="p">:</span>
                <span class="c1"># Initialezed ZAMS systems have no information of radius</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">log_R</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">log_R</span><span class="p">):</span>
                    <span class="n">initials</span> <span class="o">=</span> <span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">MESA_label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;center_h1&quot;</span><span class="p">,</span> <span class="s2">&quot;log_R&quot;</span><span class="p">,</span> <span class="s2">&quot;he_core_mass&quot;</span><span class="p">]</span>
                    <span class="n">posydon_attribute</span> <span class="o">=</span> <span class="p">[</span><span class="n">star</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">center_h1</span><span class="p">,</span>
                                         <span class="n">star</span><span class="o">.</span><span class="n">log_R</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">he_core_mass</span><span class="p">]</span>
                    <span class="n">rs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matching attributes and their normalizations :&quot;</span><span class="p">,</span>
                              <span class="n">MESA_label</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">MESA_label</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_keys</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Expected matching parameter not &quot;</span>
                                            <span class="s2">&quot;added in the MIST model options.&quot;</span><span class="p">)</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">get_root0</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">,</span> <span class="n">posydon_attribute</span><span class="p">,</span>
                                   <span class="n">htrack</span><span class="p">,</span> <span class="n">rs</span><span class="o">=</span><span class="n">rs</span><span class="p">)</span>
                    <span class="n">bnds</span> <span class="o">=</span> <span class="p">([</span><span class="n">m_min_H</span><span class="p">,</span> <span class="n">m_max_H</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
                    <span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                            <span class="n">sc_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                            <span class="o">-</span> <span class="n">sc_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">sc_center_h1</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                            <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                            <span class="o">-</span> <span class="n">sc_center_h1</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">sc_log_R_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                            <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                            <span class="o">-</span> <span class="n">sc_log_R_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">sc_he_core_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                            <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                            <span class="o">-</span> <span class="n">sc_he_core_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                               <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">x0</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;TNC&quot;</span><span class="p">,</span>
                        <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span>
                    <span class="p">)</span>
                    <span class="c1"># stars after mass transfer could swell up so that log_R</span>
                    <span class="c1"># is not appropriate for matching</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance_mist_integration</span><span class="p">:</span>
                        <span class="n">MESA_label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;center_h1&quot;</span><span class="p">,</span> <span class="s2">&quot;he_core_mass&quot;</span><span class="p">]</span>
                        <span class="n">posydon_attribute</span> <span class="o">=</span> <span class="p">[</span><span class="n">star</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">center_h1</span><span class="p">,</span>
                                             <span class="n">star</span><span class="o">.</span><span class="n">he_core_mass</span><span class="p">]</span>
                        <span class="n">rs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>
                        <span class="n">x0</span> <span class="o">=</span> <span class="n">get_root0</span><span class="p">(</span>
                            <span class="n">MESA_label</span><span class="p">,</span> <span class="n">posydon_attribute</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="n">rs</span><span class="o">=</span><span class="n">rs</span><span class="p">)</span>
                        <span class="n">bnds</span> <span class="o">=</span> <span class="p">([</span><span class="n">m_min_H</span><span class="p">,</span> <span class="n">m_max_H</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
                        <span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                                <span class="n">sc_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                 <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                                <span class="o">-</span> <span class="n">sc_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                    <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="p">(</span><span class="n">sc_center_h1</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                                <span class="o">-</span> <span class="n">sc_center_h1</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                    <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="p">(</span><span class="n">sc_he_core_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                                <span class="o">-</span> <span class="n">sc_he_core_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                   <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;TNC&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span>
                        <span class="p">)</span>
            <span class="k">elif</span> <span class="n">star</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_postMS</span><span class="p">:</span>
                <span class="n">MESA_label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;center_he4&quot;</span><span class="p">,</span> <span class="s2">&quot;log_R&quot;</span><span class="p">]</span>
                <span class="n">posydon_attribute</span> <span class="o">=</span> <span class="p">[</span><span class="n">star</span><span class="o">.</span><span class="n">he_core_mass</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
                                     <span class="n">star</span><span class="o">.</span><span class="n">center_he4</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">log_R</span><span class="p">]</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matching attributes and their normalizations : &quot;</span><span class="p">,</span>
                          <span class="n">MESA_label</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">MESA_label</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_keys</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Expected matching parameter not added&quot;</span>
                                        <span class="s2">&quot; in the MIST model options.&quot;</span><span class="p">)</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">get_root0</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">,</span> <span class="n">posydon_attribute</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="n">rs</span><span class="o">=</span><span class="n">rs</span><span class="p">)</span>
                <span class="n">bnds</span> <span class="o">=</span> <span class="p">([</span><span class="n">m_min_H</span><span class="p">,</span> <span class="n">m_max_H</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">sc_he_core_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                          <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                         <span class="o">-</span> <span class="n">sc_he_core_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="o">/</span> <span class="n">sc_he_core_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="n">sc_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                        <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                             <span class="o">-</span> <span class="n">sc_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="o">/</span> <span class="n">sc_mass_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">sc_center_he4_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                        <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                       <span class="o">-</span> <span class="n">sc_center_he4_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">sc_log_R_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                        <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                        <span class="o">-</span> <span class="n">sc_log_R_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>

                    <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;TNC&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">star</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_HeStar</span><span class="p">:</span>
                <span class="n">MESA_label</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span>
                    <span class="c1"># &quot;surface_he4&quot;,</span>
                    <span class="s2">&quot;center_he4&quot;</span><span class="p">,</span>
                    <span class="c1"># &quot;mass&quot;,</span>
                    <span class="c1"># &quot;center_c12&quot;,</span>
                    <span class="s2">&quot;log_R&quot;</span>
                <span class="p">]</span>
                <span class="n">posydon_attribute</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">star</span><span class="o">.</span><span class="n">he_core_mass</span><span class="p">,</span>
                    <span class="c1"># star.surface_he4,</span>
                    <span class="n">star</span><span class="o">.</span><span class="n">center_he4</span><span class="p">,</span>
                    <span class="c1"># star.mass,</span>
                    <span class="c1"># star.center_c12,</span>
                    <span class="n">star</span><span class="o">.</span><span class="n">log_R</span>
                <span class="p">]</span>
                <span class="c1"># rs = [10, 2.0, 2.0, 20, 2.0]</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matching attributes and their normalizations : &quot;</span><span class="p">,</span>
                          <span class="n">MESA_label</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">MESA_label</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_keys</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Expected matching parameter not added&quot;</span>
                                        <span class="s2">&quot; in the MIST model options.&quot;</span><span class="p">)</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">get_root0</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">,</span> <span class="n">posydon_attribute</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rs</span><span class="o">=</span><span class="n">rs</span><span class="p">)</span>
                <span class="n">bnds</span> <span class="o">=</span> <span class="p">([</span><span class="n">m_min_He</span><span class="p">,</span> <span class="n">m_max_He</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
                <span class="c1"># match he4 abundance using definite value</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">sc_he_core_mass_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                         <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                         <span class="o">-</span> <span class="n">sc_he_core_mass_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="o">/</span> <span class="n">sc_he_core_mass_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_center_he4_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                        <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                            <span class="o">-</span> <span class="n">sc_center_he4_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_log_R_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                        <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                            <span class="o">-</span> <span class="n">sc_log_R_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;TNC&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance_mist_integration</span>
                        <span class="ow">or</span> <span class="ow">not</span> <span class="n">sol</span><span class="o">.</span><span class="n">success</span><span class="p">):</span>
                    <span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">sc_he_core_mass_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                             <span class="o">-</span> <span class="n">sc_he_core_mass_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                 <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="o">/</span> <span class="n">sc_he_core_mass_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">sc_center_he4_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                            <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                           <span class="o">-</span> <span class="n">sc_center_he4_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_log_R_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                            <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                                <span class="o">-</span> <span class="n">sc_log_R_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                        <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Powell&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance_mist_integration</span>
                            <span class="ow">or</span> <span class="ow">not</span> <span class="n">sol</span><span class="o">.</span><span class="n">success</span><span class="p">):</span>
                        <span class="n">star</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">x0</span> <span class="o">=</span> <span class="n">get_root0</span><span class="p">(</span>
                            <span class="n">MESA_label</span><span class="p">,</span> <span class="n">posydon_attribute</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="n">rs</span><span class="o">=</span><span class="n">rs</span><span class="p">)</span>
                        <span class="n">bnds</span> <span class="o">=</span> <span class="p">([</span><span class="n">m_min_H</span><span class="p">,</span> <span class="n">m_max_H</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
                        <span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                                <span class="p">(</span><span class="n">sc_he_core_mass_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                    <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                                 <span class="o">-</span> <span class="n">sc_he_core_mass_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                     <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                <span class="o">/</span> <span class="n">sc_he_core_mass_He</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                     <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="p">(</span><span class="n">sc_center_he4_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                               <span class="o">-</span> <span class="n">sc_center_he4_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                     <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_log_R_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                <span class="n">get_track_val</span><span class="p">(</span><span class="n">MESA_label</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">))</span>
                                <span class="o">-</span> <span class="n">sc_log_R_H</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                                     <span class="n">posydon_attribute</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;TNC&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span>
                                    <span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
                                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span>
                                    <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">):</span>
                            <span class="n">initials</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">initials</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sol.fun = &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">fun</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance_mist_integration</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;minimization in matching considered acceptable,&quot;</span>
                              <span class="s2">&quot; with&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">fun</span><span class="p">),</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
                              <span class="n">tolerance_mist_integration</span><span class="p">,</span> <span class="s2">&quot;tolerance&quot;</span><span class="p">)</span>
                    <span class="n">initials</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">star</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">fun</span>
                    <span class="n">star</span><span class="o">.</span><span class="n">stiching_rel_mass_difference</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span>
                    <span class="k">if</span> <span class="n">star</span><span class="o">.</span><span class="n">log_R</span> <span class="ow">in</span> <span class="n">MESA_label</span><span class="p">:</span>
                        <span class="n">star</span><span class="o">.</span><span class="n">stiching_rel_logRadius_difference</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;log_R&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                            <span class="o">-</span> <span class="n">star</span><span class="o">.</span><span class="n">log_R</span><span class="p">)</span> <span class="o">/</span> <span class="n">star</span><span class="o">.</span><span class="n">log_R</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">star</span><span class="o">.</span><span class="n">stiching_rel_logRadius_difference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">total_moment_of_inertia</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">total_moment_of_inertia</span><span class="p">)):</span>
                        <span class="n">star</span><span class="o">.</span><span class="n">stiching_rel_inertia_difference</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;inertia&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                            <span class="o">-</span> <span class="n">star</span><span class="o">.</span><span class="n">total_moment_of_inertia</span>
                        <span class="p">)</span> <span class="o">/</span> <span class="n">star</span><span class="o">.</span><span class="n">total_moment_of_inertia</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;minimization in matching not successful, with&quot;</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">fun</span><span class="p">),</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">tolerance_mist_integration</span><span class="p">,</span>
                              <span class="s2">&quot;tolerance&quot;</span><span class="p">)</span>
                    <span class="n">initials</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">star</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">star</span><span class="o">.</span><span class="n">stiching_rel_mass_difference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">star</span><span class="o">.</span><span class="n">stiching_rel_radius_difference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">star</span><span class="o">.</span><span class="n">stiching_rel_inertia_difference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;matching with track of intial mass m0, at time t0 &quot;</span><span class="p">,</span>
                <span class="n">initials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">initials</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;with m(t0), log10(R(t0), center_he(t0), surface_he4, &quot;</span>
                <span class="s2">&quot;surface_h1, he_core_mass, center_c12) = &quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;log_R&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;center_he4&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;surface_he4&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;surface_h1&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;he_core_mass&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_track_val</span><span class="p">(</span><span class="s2">&quot;center_c12&quot;</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                <span class="s2">&quot;Mass / Radius of the secondary at the end of the previous &quot;</span>
                <span class="s2">&quot;step was = &quot;</span><span class="p">,</span>
                <span class="n">star</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
                <span class="n">star</span><span class="o">.</span><span class="n">log_R</span><span class="p">,</span>
                <span class="n">star</span><span class="o">.</span><span class="n">center_he4</span><span class="p">,</span>
                <span class="n">star</span><span class="o">.</span><span class="n">surface_he4</span><span class="p">,</span>
                <span class="n">star</span><span class="o">.</span><span class="n">surface_h1</span><span class="p">,</span>
                <span class="n">star</span><span class="o">.</span><span class="n">he_core_mass</span><span class="p">,</span>
                <span class="n">star</span><span class="o">.</span><span class="n">center_c12</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">initials</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the type of evolution type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Detached Step.&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evolve the binary until RLO or compact object formation.&quot;&quot;&quot;</span>
        <span class="n">get_mist0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mist0</span>
        <span class="n">KEYS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEYS</span>
        <span class="n">KEYS_POSITIVE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEYS_POSITIVE</span>
        <span class="c1"># the primary is the more evolved star</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BH&quot;</span><span class="p">,</span> <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;WD&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">STAR_STATES_H_RICH</span><span class="p">):</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
            <span class="n">secondary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
            <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BH&quot;</span><span class="p">,</span> <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;WD&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_HeStar</span><span class="p">):</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
            <span class="n">secondary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
            <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BH&quot;</span><span class="p">,</span> <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;WD&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">STAR_STATES_H_RICH</span><span class="p">):</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
            <span class="n">secondary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
            <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BH&quot;</span><span class="p">,</span> <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;WD&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_HeStar</span><span class="p">):</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
            <span class="n">secondary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
            <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">STAR_STATES_H_RICH</span>
                <span class="ow">and</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">STAR_STATES_H_RICH</span><span class="p">):</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
            <span class="n">secondary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
            <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_HeStar</span>
                <span class="ow">and</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">STAR_STATES_H_RICH</span><span class="p">):</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
            <span class="n">secondary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
            <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_HeStar</span>
                <span class="ow">and</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">STAR_STATES_H_RICH</span><span class="p">):</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
            <span class="n">secondary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
            <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_HeStar</span>
                <span class="ow">and</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">LIST_ACCEPTABLE_STATES_FOR_HeStar</span><span class="p">):</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
            <span class="n">secondary</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
            <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">primary</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;States not recognized!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">get_mist0</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span><span class="p">)</span>
        <span class="n">m2</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">get_mist0</span><span class="p">(</span><span class="n">secondary</span><span class="p">,</span> <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_star_data</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">star1</span><span class="p">,</span> <span class="n">star2</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="n">co</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get and interpolate the properties of stars.</span>

<span class="sd">            The data of a compact object can be stored as a copy of its</span>
<span class="sd">            companion for convenience except its mass, radius, mdot, Idot,</span>
<span class="sd">            and radius, mdot, Idot are set to be zero.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            htrack : bool</span>
<span class="sd">                htrack of star1</span>
<span class="sd">            co: bool</span>
<span class="sd">                co of star2</span>
<span class="sd">            Return</span>
<span class="sd">            -------</span>
<span class="sd">            interp1d</span>
<span class="sd">                Contains the properties of star1 if co is false,</span>
<span class="sd">                if co is true, star2 is a compact object,</span>
<span class="sd">                return the properties of star2</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">htrack</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid1</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">htrack</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid2</span>

            <span class="n">get_track</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
                <span class="c1"># get the initial m0, t0 track</span>
                <span class="n">m0</span><span class="p">,</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">get_mist0</span><span class="p">(</span><span class="n">star1</span><span class="p">,</span> <span class="n">htrack</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">([</span><span class="n">m0</span><span class="p">,</span> <span class="n">t0</span><span class="p">])):</span>
                <span class="c1">#    binary.event = &quot;END&quot;</span>
                <span class="c1">#    binary.state += &quot; (GridMatchingFailed)&quot;</span>
                <span class="c1">#    if self.verbose:</span>
                <span class="c1">#        print(&quot;Failed matching&quot;)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">max_time</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">max_simulation_time</span>
            <span class="k">assert</span> <span class="n">max_time</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;max_time is non-positive&quot;</span>

            <span class="n">age</span> <span class="o">=</span> <span class="n">get_track</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">m0</span><span class="p">)</span>
            <span class="n">t_max</span> <span class="o">=</span> <span class="n">age</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c1"># max timelength of the track</span>
            <span class="n">interp1d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">kvalue</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">kvalue</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_track</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">m0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS_POSITIVE</span><span class="p">:</span>
                        <span class="n">positive</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">interp1d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator2</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                                           <span class="n">positive</span><span class="o">=</span><span class="n">positive</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">interp1d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator2</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">i_bad</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_bad</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">age</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">age</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">i_bad</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">kvalue</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">kvalue</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">i_bad</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS_POSITIVE</span><span class="p">:</span>
                        <span class="n">positive</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">interp1d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator2</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                                           <span class="n">positive</span><span class="o">=</span><span class="n">positive</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">interp1d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator2</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;inertia&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span>
                <span class="n">age</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;inertia&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;Idot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;inertia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">derivative</span><span class="p">()</span>

            <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;log_L&quot;</span><span class="p">])</span>
            <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;log_R&quot;</span><span class="p">])</span>
            <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;t_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_max</span>
            <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;max_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_time</span>
            <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span>
            <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;m0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m0</span>
            <span class="k">if</span> <span class="n">co</span><span class="p">:</span>
                <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">star2</span><span class="o">.</span><span class="n">mass</span>
                <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;log_R&quot;</span><span class="p">])</span>
                <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;mdot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;mdot&quot;</span><span class="p">])</span>
                <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">])</span>
                <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">])</span>
                <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;mdot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;mdot&quot;</span><span class="p">])</span>
                <span class="n">interp1d</span><span class="p">[</span><span class="s2">&quot;Idot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">[</span><span class="s2">&quot;mdot&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">interp1d</span>

        <span class="c1"># get the matched data of two stars, respectively</span>
        <span class="n">interp1d_sec</span> <span class="o">=</span> <span class="n">get_star_data</span><span class="p">(</span>
            <span class="n">binary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
            <span class="n">interp1d_pri</span> <span class="o">=</span> <span class="n">get_star_data</span><span class="p">(</span>
                <span class="n">binary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
            <span class="n">interp1d_pri</span> <span class="o">=</span> <span class="n">get_star_data</span><span class="p">(</span>
                <span class="n">binary</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interp1d_sec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">interp1d_pri</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># binary.event = &quot;END&quot;</span>
            <span class="n">binary</span><span class="o">.</span><span class="n">state</span> <span class="o">+=</span> <span class="s2">&quot; (GridMatchingFailed)&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed matching&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">t0_sec</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span>
        <span class="n">t0_pri</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span>
        <span class="n">m01</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;m0&quot;</span><span class="p">]</span>
        <span class="n">m02</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;m0&quot;</span><span class="p">]</span>
        <span class="n">t_max_sec</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;t_max&quot;</span><span class="p">]</span>
        <span class="n">t_max_pri</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;t_max&quot;</span><span class="p">]</span>
        <span class="n">t_offset_sec</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">t0_sec</span>
        <span class="n">t_offset_pri</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">t0_pri</span>
        <span class="n">max_time</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;max_time&quot;</span><span class="p">]</span>

        <span class="nd">@event</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">ev_rlo1</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Difference between radius and Roche lobe at a given time.</span>

<span class="sd">            Used to check if there is RLOF mass transfer during the detached</span>
<span class="sd">            binary evolution interpolation.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            t : float</span>
<span class="sd">                Time of the evolution, in years.</span>
<span class="sd">            y : tuple of floats</span>
<span class="sd">                [separation, eccentricity] at that time. Separation should be</span>
<span class="sd">                in solar radii.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            float</span>
<span class="sd">                Difference between stellar radius and Roche lobe radius in</span>
<span class="sd">                solar radii.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ecc</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">RL</span> <span class="o">=</span> <span class="n">roche_lobe_radius</span><span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span>
                                   <span class="o">/</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">),</span>
                                   <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ecc</span><span class="p">)</span> <span class="o">*</span> <span class="n">sep</span><span class="p">)</span>
            <span class="c1"># 95% filling of the RL is enough to assume beginning of RLO,</span>
            <span class="c1"># as we do in CO-HMS_RLO grid</span>
            <span class="k">return</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">RL</span>

        <span class="nd">@event</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">ev_rlo2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Difference between radius and Roche lobe at a given time.</span>

<span class="sd">            Used to check if there is RLOF mass transfer during the detached</span>
<span class="sd">            binary evolution interpolation.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            t : float</span>
<span class="sd">                Time of the evolution, in years</span>
<span class="sd">            y : tuple of floats</span>
<span class="sd">                [separation, eccentricity] at that time. Separation should be</span>
<span class="sd">                in solar radii.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            float</span>
<span class="sd">                Difference between stellar radius and Roche lobe radius in</span>
<span class="sd">                solar radii.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ecc</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">RL</span> <span class="o">=</span> <span class="n">roche_lobe_radius</span><span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span>
                                   <span class="o">/</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">),</span>
                                   <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ecc</span><span class="p">)</span> <span class="o">*</span> <span class="n">sep</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">RL</span>

        <span class="nd">@event</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">ev_rel_rlo1</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Relative difference between radius and Roche lobe.</span>

<span class="sd">            Used to check if there is RLOF mass transfer during the detached</span>
<span class="sd">            binary evolution interpolation.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            t : float</span>
<span class="sd">                Time of the evolution, in years.</span>
<span class="sd">            y : tuple of floats</span>
<span class="sd">                [separation, eccentricity] at that time. Separation should be</span>
<span class="sd">                in solar radii.</span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            float</span>
<span class="sd">                Relative difference between stellar radius and Roche lobe</span>
<span class="sd">                radius.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ecc</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">RL</span> <span class="o">=</span> <span class="n">roche_lobe_radius</span><span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span>
                                   <span class="o">/</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">),</span>
                                   <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ecc</span><span class="p">)</span> <span class="o">*</span> <span class="n">sep</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">-</span> <span class="n">RL</span><span class="p">)</span> <span class="o">/</span> <span class="n">RL</span>

        <span class="nd">@event</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">ev_rel_rlo2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Relative difference between radius and Roche lobe.</span>

<span class="sd">            Used to check if there is RLOF mass transfer during the detached</span>
<span class="sd">            binary evolution interpolation.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            t : float</span>
<span class="sd">                Time of the evolution, in years.</span>
<span class="sd">            y : tuple of floats</span>
<span class="sd">                [separation, eccentricity] at that time. Separation should be</span>
<span class="sd">                in solar radii.</span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            float</span>
<span class="sd">                Relative difference between stellar radius and Roche lobe</span>
<span class="sd">                radius.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ecc</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">RL</span> <span class="o">=</span> <span class="n">roche_lobe_radius</span><span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span>
                                   <span class="o">/</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">),</span>
                                   <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ecc</span><span class="p">)</span> <span class="o">*</span> <span class="n">sep</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span> <span class="o">-</span> <span class="n">RL</span><span class="p">)</span> <span class="o">/</span> <span class="n">RL</span>

        <span class="nd">@event</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">ev_max_time1</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">t_max_sec</span> <span class="o">+</span> <span class="n">t_offset_sec</span> <span class="o">-</span> <span class="n">t</span>

        <span class="nd">@event</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">ev_max_time2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">t_max_pri</span> <span class="o">+</span> <span class="n">t_offset_pri</span> <span class="o">-</span> <span class="n">t</span>

        <span class="c1"># make a function to get the spin of two stars</span>
        <span class="k">def</span> <span class="nf">get_omega</span><span class="p">(</span><span class="n">star</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">log_total_angular_momentum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">star</span><span class="o">.</span><span class="n">total_moment_of_inertia</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">log_total_angular_momentum</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">total_moment_of_inertia</span><span class="p">)):</span>
                <span class="n">omega_in_rad_per_year</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mf">10.0</span> <span class="o">**</span> <span class="n">star</span><span class="o">.</span><span class="n">log_total_angular_momentum</span>
                        <span class="o">/</span> <span class="n">star</span><span class="o">.</span><span class="n">total_moment_of_inertia</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>
                <span class="p">)</span>  <span class="c1"># the last factor transforms it from rad/s to rad/yr</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calculating initial omega from angular momentum and&quot;</span>
                          <span class="s2">&quot; moment of inertia&quot;</span><span class="p">,</span> <span class="n">omega_in_rad_per_year</span><span class="p">)</span>
            <span class="c1"># except TypeError:</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we equate secondary&#39;s initial omega to surf_avg_omega</span>
                <span class="c1"># (although the critical rotation should be improved to</span>
                <span class="c1"># take into accoun radiation pressure)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">surf_avg_omega</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">surf_avg_omega</span><span class="p">)):</span>
                    <span class="n">omega_in_rad_per_year</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">surf_avg_omega</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>
                    <span class="c1"># the last factor transforms it from rad/s to rad/yr.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calculating initial omega from surf_avg_omega&quot;</span><span class="p">,</span>
                              <span class="n">omega_in_rad_per_year</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">surf_avg_omega_div_omega_crit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">surf_avg_omega_div_omega_crit</span><span class="p">)):</span>
                    <span class="n">omega_in_rad_per_year</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">star</span><span class="o">.</span><span class="n">surf_avg_omega_div_omega_crit</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                            <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span>
                            <span class="o">/</span> <span class="p">((</span><span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">log_R</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">))</span>
                        <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
                    <span class="c1"># the last factor transforms it from rad/s to rad/yr</span>
                    <span class="c1"># EDIT: We assume POSYDON surf_avg_omega is provided in</span>
                    <span class="c1"># rad/yr already.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calculating initial omega from &quot;</span>
                              <span class="s2">&quot;surf_avg_omega_div_omega_crit&quot;</span><span class="p">,</span>
                              <span class="n">omega_in_rad_per_year</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">omega_in_rad_per_year</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;could calculate initial omega&quot;</span><span class="p">,</span>
                              <span class="n">omega_in_rad_per_year</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;initial omega_in_rad_per_year&quot;</span><span class="p">,</span> <span class="n">omega_in_rad_per_year</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">omega_in_rad_per_year</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ev_rlo1</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="o">.</span><span class="n">separation</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">eccentricity</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="n">ev_rlo2</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">binary</span><span class="o">.</span><span class="n">separation</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">eccentricity</span><span class="p">])</span>
                <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">binary</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;initial_RLOF&quot;</span>
            <span class="k">return</span>
            <span class="c1"># binary.event = &quot;END&quot;</span>
            <span class="c1"># TODO: put it out of its misery here!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">max_time</span> <span class="o">-</span> <span class="n">binary</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;max_time is lower than the current time. &quot;</span>
                                <span class="s2">&quot;Evolution of the detached binary will go to &quot;</span>
                                <span class="s2">&quot;lower times.&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
                <span class="n">omega_in_rad_per_year_sec</span> <span class="o">=</span> <span class="n">get_omega</span><span class="p">(</span><span class="n">secondary</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                    <span class="c1"># omega of compact objects won&#39;t be used for intergration</span>
                    <span class="n">omega_in_rad_per_year_pri</span> <span class="o">=</span> <span class="n">omega_in_rad_per_year_sec</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                    <span class="n">omega_in_rad_per_year_pri</span> <span class="o">=</span> <span class="n">get_omega</span><span class="p">(</span><span class="n">primary</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">diffeq</span><span class="p">(</span>
                            <span class="n">t</span><span class="p">,</span>
                            <span class="n">y</span><span class="p">,</span>
                            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">),</span>
                            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">),</span>
                            <span class="o">*</span><span class="p">[</span>
                                <span class="n">interp1d_sec</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
                            <span class="p">],</span>
                            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;Idot&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">),</span>
                            <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">),</span>
                            <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">),</span>
                            <span class="o">*</span><span class="p">[</span>
                                <span class="n">interp1d_pri</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
                            <span class="p">],</span>
                            <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;Idot&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_wind_loss</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_tides</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_gravitational_radiation</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_magnetic_braking</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_stellar_evolution_and_spin_from_winds</span>
                            <span class="c1"># ,self.verbose</span>
                        <span class="p">),</span>
                        <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="n">ev_rlo1</span><span class="p">,</span> <span class="n">ev_rlo2</span><span class="p">,</span> <span class="n">ev_max_time1</span><span class="p">,</span> <span class="n">ev_max_time2</span><span class="p">],</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Radau&quot;</span><span class="p">,</span>
                        <span class="n">t_span</span><span class="o">=</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">max_time</span><span class="p">),</span>
                        <span class="n">y0</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">binary</span><span class="o">.</span><span class="n">separation</span><span class="p">,</span>
                            <span class="n">binary</span><span class="o">.</span><span class="n">eccentricity</span><span class="p">,</span>
                            <span class="n">omega_in_rad_per_year_sec</span><span class="p">,</span>
                            <span class="n">omega_in_rad_per_year_pri</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="c1"># vectorized=True</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">diffeq</span><span class="p">(</span>
                            <span class="n">t</span><span class="p">,</span>
                            <span class="n">y</span><span class="p">,</span>
                            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">),</span>
                            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">),</span>
                            <span class="o">*</span><span class="p">[</span>
                                <span class="n">interp1d_sec</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
                            <span class="p">],</span>
                            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;Idot&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">),</span>
                            <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">),</span>
                            <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">),</span>
                            <span class="o">*</span><span class="p">[</span>
                                <span class="n">interp1d_pri</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
                            <span class="p">],</span>
                            <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;Idot&quot;</span><span class="p">](</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_wind_loss</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_tides</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_gravitational_radiation</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_magnetic_braking</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_stellar_evolution_and_spin_from_winds</span>
                            <span class="c1"># ,self.verbose</span>
                        <span class="p">),</span>
                        <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="n">ev_rlo1</span><span class="p">,</span> <span class="n">ev_rlo2</span><span class="p">,</span> <span class="n">ev_max_time1</span><span class="p">,</span> <span class="n">ev_max_time2</span><span class="p">],</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RK45&quot;</span><span class="p">,</span>
                        <span class="n">t_span</span><span class="o">=</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">max_time</span><span class="p">),</span>
                        <span class="n">y0</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">binary</span><span class="o">.</span><span class="n">separation</span><span class="p">,</span>
                            <span class="n">binary</span><span class="o">.</span><span class="n">eccentricity</span><span class="p">,</span>
                            <span class="n">omega_in_rad_per_year_sec</span><span class="p">,</span>
                            <span class="n">omega_in_rad_per_year_pri</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="c1"># vectorized=True</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solution of ODE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Integration failed&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
                <span class="n">binary</span><span class="o">.</span><span class="n">state</span> <span class="o">+=</span> <span class="s1">&#39; (Integration failure)&#39;</span>
                <span class="c1"># binary.event = &quot;END&quot;</span>
                <span class="k">return</span>
                <span class="c1"># raise RuntimeError(&quot;Integration failed&quot;, s.message)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_o_steps_history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_o_steps_history</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">t_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">binary</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_o_steps_history</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">t_step</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">t_step</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># self.dt is None and self.n_o_steps_history is None</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">orb_params</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="n">sep_interp</span><span class="p">,</span> <span class="n">ecc_interp</span><span class="p">,</span> <span class="n">omega_interp_sec</span><span class="p">,</span> <span class="n">omega_interp_pri</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span>
                <span class="n">t</span><span class="p">)</span>
            <span class="n">mass_interp_sec</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]]</span>
            <span class="n">mass_interp_pri</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]]</span>

            <span class="c1"># s.sol(t)[0]</span>
            <span class="c1"># interp1d = dict()</span>
            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;sep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># lambda x: orb_params[0][np.argmax(x == t[:, None], 0)]</span>
            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># lambda x: orb_params[1][np.argmax(x == t[:, None], 0)]</span>
            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1"># lambda x: orb_params[2][np.argmax(x == t[:, None], 0)]</span>
            <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;porb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbital_period_from_separation</span><span class="p">(</span>
                <span class="n">sep_interp</span><span class="p">,</span> <span class="n">mass_interp_sec</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">),</span>
                <span class="n">mass_interp_pri</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">))</span>
            <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;porb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbital_period_from_separation</span><span class="p">(</span>
                <span class="n">sep_interp</span><span class="p">,</span> <span class="n">mass_interp_pri</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">),</span>
                <span class="n">mass_interp_sec</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">))</span>

            <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>  <span class="c1"># binary.time + x - t0</span>
            <span class="c1"># time_interp = binary.time + t - t0</span>

            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">secondary</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">binary</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">STARPROPERTIES</span><span class="p">,</span> <span class="n">STARPROPERTIES</span><span class="p">,</span> <span class="n">BINARYPROPERTIES</span><span class="p">],</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;event&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;mass_transfer_case&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;nearest_neighbour_distance&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;metallicity&quot;</span><span class="p">,</span> <span class="s2">&quot;V_sys&quot;</span><span class="p">]:</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="c1"># For star objects, the state is calculated</span>
                        <span class="c1"># further below</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># elif key in (&quot;state&quot;) and obj == secondary:</span>
                    <span class="c1">#    current = check_state_of_star(obj, star_CO=False)</span>
                    <span class="c1">#    history = [current] * len(t[:-1])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;surf_avg_omega_div_omega_crit&quot;</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">secondary</span><span class="p">):</span>
                        <span class="c1"># In fact I replace the actual surf_avg_w with the ef-</span>
                        <span class="c1"># fective omega which takes into account the whole star</span>
                        <span class="c1"># key  = &#39;effective_omega&#39; # in rad/sec</span>
                        <span class="c1"># current = s.y[2][-1] / 3.1558149984e7</span>
                        <span class="c1"># history_of_attribute = s.y[2][:-1] / 3.1558149984e7</span>
                        <span class="n">omega_crit_current_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                            <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span>
                            <span class="o">*</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]](</span>
                                <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span>
                            <span class="o">/</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]](</span>
                                <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
                        <span class="p">)</span>
                        <span class="n">omega_crit_hist_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                            <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span>
                            <span class="o">*</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]](</span>
                                <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span>
                            <span class="o">/</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]](</span>
                                <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
                        <span class="p">)</span>

                        <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>
                                   <span class="o">/</span> <span class="n">omega_crit_current_sec</span><span class="p">)</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>
                                   <span class="o">/</span> <span class="n">omega_crit_hist_sec</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;surf_avg_omega_div_omega_crit&quot;</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">primary</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                            <span class="c1"># TODO: change `item()` to 0</span>
                            <span class="n">omega_crit_current_pri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                                <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span>
                                <span class="o">*</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span>
                                <span class="o">/</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="p">)</span>
                                <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

                            <span class="n">omega_crit_hist_pri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                                <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span>
                                <span class="o">*</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span>
                                <span class="o">/</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

                            <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                       <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span> <span class="o">/</span> <span class="n">omega_crit_current_pri</span><span class="p">)</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                       <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span> <span class="o">/</span> <span class="n">omega_crit_hist_pri</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;surf_avg_omega&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">secondary</span><span class="p">:</span>
                        <span class="c1"># current = interp1d[&quot;omega&quot;](t[-1]) / const.secyer</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;surf_avg_omega&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">primary</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rl_relative_overflow_1&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">binary</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BH&quot;</span><span class="p">,</span> <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;WD&quot;</span><span class="p">):</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">ev_rel_rlo1</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;sep&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="n">ev_rel_rlo1</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;sep&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="k">elif</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">ev_rel_rlo2</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;sep&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="n">ev_rel_rlo2</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;sep&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rl_relative_overflow_2&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">binary</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BH&quot;</span><span class="p">,</span> <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;WD&quot;</span><span class="p">):</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">ev_rel_rlo1</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;sep&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="n">ev_rel_rlo1</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;sep&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="k">elif</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">ev_rel_rlo2</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;sep&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="n">ev_rel_rlo2</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;sep&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;separation&quot;</span><span class="p">,</span> <span class="s2">&quot;orbital_period&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">]:</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">secondary</span><span class="p">):</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                            <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                            <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">primary</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span>
                                    <span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                    <span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;log_total_angular_momentum&quot;</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">secondary</span><span class="p">):</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
                            <span class="o">*</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span>
                                        <span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
                            <span class="o">*</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                        <span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;log_total_angular_momentum&quot;</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">primary</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
                                <span class="o">*</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]](</span>
                                        <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span>
                                            <span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
                                <span class="o">*</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]](</span>
                                        <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                            <span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;spin&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">secondary</span><span class="p">:</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">const</span><span class="o">.</span><span class="n">clight</span>
                            <span class="o">*</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">interp1d_sec</span><span class="p">[</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                            <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                                <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">const</span><span class="o">.</span><span class="n">clight</span>
                            <span class="o">*</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">interp1d_sec</span><span class="p">[</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span>
                            <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                            <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;spin&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">primary</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">const</span><span class="o">.</span><span class="n">clight</span>
                                <span class="o">*</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">interp1d_pri</span><span class="p">[</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]](</span>
                                        <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                                <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                                <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span>
                                    <span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]](</span>
                                        <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                                    <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">const</span><span class="o">.</span><span class="n">clight</span> <span class="o">*</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">interp1d_pri</span><span class="p">[</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;total_moment_of_inertia&quot;</span><span class="p">]](</span>
                                        <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span>
                                <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                                <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span><span class="n">interp1d_pri</span><span class="p">[</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]](</span>
                                        <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span>
                                    <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;lg_mdot&quot;</span><span class="p">,</span> <span class="s2">&quot;lg_wind_mdot&quot;</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">secondary</span><span class="p">):</span>
                        <span class="c1"># in detached step, lg_mdot = lg_wind_mdot</span>
                        <span class="k">if</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="o">-</span><span class="mf">98.99</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">98.99</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                        <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)))</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;lg_mdot&quot;</span><span class="p">,</span> <span class="s2">&quot;lg_wind_mdot&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">primary</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                    <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">current</span> <span class="o">=</span> <span class="o">-</span><span class="mf">98.99</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                                    <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                        <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                        <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">98.99</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                                        <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">in</span> <span class="n">interp1d_sec</span>
                            <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">secondary</span><span class="p">):</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                            <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="n">interp1d_sec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                            <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_sec</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">in</span> <span class="n">interp1d_pri</span>
                            <span class="ow">and</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">primary</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="n">history</span> <span class="o">=</span> <span class="n">interp1d_pri</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">key</span><span class="p">]](</span>
                                <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_offset_pri</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">]:</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">current</span>

                    <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_history&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

            <span class="n">secondary</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">check_state_of_star</span><span class="p">(</span><span class="n">secondary</span><span class="p">,</span> <span class="n">star_CO</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">timestep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">secondary</span><span class="o">.</span><span class="n">state_history</span><span class="p">[</span><span class="n">timestep</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_state_of_star</span><span class="p">(</span>
                    <span class="n">secondary</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">timestep</span><span class="p">,</span> <span class="n">star_CO</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                <span class="n">mdot_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">bondi_hoyle</span><span class="p">(</span>
                    <span class="n">binary</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">wind_disk_criteria</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;Kudritzki+2000&#39;</span><span class="p">))</span>
                <span class="n">primary</span><span class="o">.</span><span class="n">lg_mdot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mdot_acc</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">primary</span><span class="o">.</span><span class="n">lg_mdot_history</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">primary</span><span class="o">.</span><span class="n">lg_mdot_history</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                                        <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mdot_acc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span><span class="p">:</span>
                <span class="n">primary</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">check_state_of_star</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">star_CO</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">timestep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">):</span>

                    <span class="n">primary</span><span class="o">.</span><span class="n">state_history</span><span class="p">[</span><span class="n">timestep</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_state_of_star</span><span class="p">(</span>
                        <span class="n">primary</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">timestep</span><span class="p">,</span> <span class="n">star_CO</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">get_star_final_values</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="n">m0</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">htrack</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid1</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">htrack</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid2</span>

                <span class="n">get_final_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_final_values</span>
                <span class="n">get_final_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_final_state</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_keys</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">get_final_values</span><span class="p">(</span><span class="s1">&#39;S1_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">m0</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">get_star_profile</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">htrack</span><span class="p">,</span> <span class="n">m0</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">htrack</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid1</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">htrack</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid2</span>

                <span class="n">get_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_profile</span>

                <span class="n">profile_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_profile</span><span class="p">(</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="n">m0</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_keys</span><span class="p">:</span>
                    <span class="n">profile_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">m0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">profile_new</span><span class="p">[</span><span class="s1">&#39;omega&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">surf_avg_omega</span>

                <span class="n">star</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile_new</span>

            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># reached RLOF</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RLO_orbit_at_orbit_with_same_am</span><span class="p">:</span>
                    <span class="c1"># final circular orbit conserves angular momentum</span>
                    <span class="c1"># compared to the eccentric orbit</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">separation</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">orbital_period</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">1.5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># final circular orbit is at periastron of the ecc. orbit</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">separation</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">orbital_period</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mf">1.5</span>

                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">orbital_period</span>
                    <span class="o">-</span> <span class="n">orbital_period_from_separation</span><span class="p">(</span>
                        <span class="n">binary</span><span class="o">.</span><span class="n">separation</span><span class="p">,</span> <span class="n">secondary</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">primary</span><span class="o">.</span><span class="n">mass</span>
                    <span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="n">binary</span><span class="o">.</span><span class="n">orbital_period</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">binary</span><span class="o">.</span><span class="n">eccentricity</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="p">:</span>
                        <span class="n">binary</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;RLO1&quot;</span>
                        <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;oRLO1&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">binary</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;RLO2&quot;</span>
                        <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;oRLO2&quot;</span>
                <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="p">:</span>
                        <span class="n">binary</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;RLO2&quot;</span>
                        <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;oRLO2&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">binary</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;RLO1&quot;</span>
                        <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;oRLO1&quot;</span>

            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="c1"># reached t_max of track. End of life (possible collapse) of</span>
                <span class="c1"># secondary</span>
                <span class="k">if</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="p">:</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;CC1&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;CC2&quot;</span>
                <span class="n">get_star_final_values</span><span class="p">(</span><span class="n">secondary</span><span class="p">,</span> <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="n">m01</span><span class="p">)</span>
                <span class="n">get_star_profile</span><span class="p">(</span><span class="n">secondary</span><span class="p">,</span> <span class="n">secondary</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="n">m01</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">primary</span><span class="o">.</span><span class="n">co</span> <span class="ow">and</span> <span class="n">primary</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">STAR_STATES_CC</span><span class="p">:</span>
                    <span class="c1"># simultaneous core-collapse of the other star as well</span>
                    <span class="n">primary_time</span> <span class="o">=</span> <span class="n">t_max_pri</span> <span class="o">+</span> <span class="n">t_offset_pri</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">secondary_time</span> <span class="o">=</span> <span class="n">t_max_sec</span> <span class="o">+</span> <span class="n">t_offset_sec</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">primary_time</span> <span class="o">==</span> <span class="n">secondary_time</span><span class="p">:</span>
                        <span class="c1"># we manually check if s.t_events[3] should also</span>
                        <span class="c1"># be happening simultaneously</span>
                        <span class="n">get_star_final_values</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="n">m02</span><span class="p">)</span>
                        <span class="n">get_star_profile</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="n">m02</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">primary</span><span class="o">.</span><span class="n">mass</span> <span class="o">!=</span> <span class="n">secondary</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Both stars are found to be ready for collapse &quot;</span>
                            <span class="s2">&quot;(i.e. end of their life) during the detached &quot;</span>
                            <span class="s2">&quot;step, but do not have the same mass&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">t_events</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="c1"># reached t_max of track. End of life (possible collapse) of</span>
                <span class="c1"># primary</span>
                <span class="k">if</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="p">:</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;CC2&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;CC1&quot;</span>
                <span class="n">get_star_final_values</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="n">m02</span><span class="p">)</span>
                <span class="n">get_star_profile</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">primary</span><span class="o">.</span><span class="n">htrack</span><span class="p">,</span> <span class="n">m02</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Reached max_time asked.</span>
                <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">max_simulation_time</span> <span class="o">-</span> <span class="n">binary</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;MaxTime_exceeded&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;maxtime&quot;</span></div>
                <span class="c1"># binary.event = &quot;MaxTime_exceeded&quot;</span>


<div class="viewcode-block" id="event"><a class="viewcode-back" href="../../../../api/posydon.binary_evol.DT.step_detached.html#posydon.binary_evol.DT.step_detached.event">[docs]</a><span class="k">def</span> <span class="nf">event</span><span class="p">(</span><span class="n">terminal</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a helper function to set attributes for solve_ivp events.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">return</span> <span class="n">dec</span></div>


<div class="viewcode-block" id="diffeq"><a class="viewcode-back" href="../../../../api/posydon.binary_evol.DT.step_detached.html#posydon.binary_evol.DT.step_detached.diffeq">[docs]</a><span class="k">def</span> <span class="nf">diffeq</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">y</span><span class="p">,</span>
        <span class="n">R_sec</span><span class="p">,</span>
        <span class="n">L_sec</span><span class="p">,</span>
        <span class="n">M_sec</span><span class="p">,</span>
        <span class="n">Mdot_sec</span><span class="p">,</span>
        <span class="n">I_sec</span><span class="p">,</span>
        <span class="c1"># he_core_mass,</span>
        <span class="c1"># mass_conv_core,</span>
        <span class="c1"># conv_mx1_top,</span>
        <span class="c1"># conv_mx1_bot,</span>
        <span class="n">conv_mx1_top_r_sec</span><span class="p">,</span>
        <span class="n">conv_mx1_bot_r_sec</span><span class="p">,</span>
        <span class="n">surface_h1_sec</span><span class="p">,</span>
        <span class="n">center_h1_sec</span><span class="p">,</span>
        <span class="n">M_env_sec</span><span class="p">,</span>
        <span class="n">DR_env_sec</span><span class="p">,</span>
        <span class="n">Renv_middle_sec</span><span class="p">,</span>
        <span class="n">Idot_sec</span><span class="p">,</span>
        <span class="n">R_pri</span><span class="p">,</span>
        <span class="n">L_pri</span><span class="p">,</span>
        <span class="n">M_pri</span><span class="p">,</span>
        <span class="n">Mdot_pri</span><span class="p">,</span>
        <span class="n">I_pri</span><span class="p">,</span>
        <span class="c1"># he_core_mass,</span>
        <span class="c1"># mass_conv_core,</span>
        <span class="c1"># conv_mx1_top,</span>
        <span class="c1"># conv_mx1_bot,</span>
        <span class="n">conv_mx1_top_r_pri</span><span class="p">,</span>
        <span class="n">conv_mx1_bot_r_pri</span><span class="p">,</span>
        <span class="n">surface_h1_pri</span><span class="p">,</span>
        <span class="n">center_h1_pri</span><span class="p">,</span>
        <span class="n">M_env_pri</span><span class="p">,</span>
        <span class="n">DR_env_pri</span><span class="p">,</span>
        <span class="n">Renv_middle_pri</span><span class="p">,</span>
        <span class="n">Idot_pri</span><span class="p">,</span>
        <span class="n">do_wind_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">do_tides</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">do_gravitational_radiation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">do_magnetic_braking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">do_stellar_evolution_and_spin_from_winds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Diff. equation describing the orbital evolution of a detached binary.</span>

<span class="sd">    The equation handles wind mass-loss [1_], tidal [2_], gravational [3_]</span>
<span class="sd">    effects and magnetic braking [4_]. It also handles the change of the</span>
<span class="sd">    secondary&#39;s stellar spin due to its change of moment of intertia and due to</span>
<span class="sd">    mass-loss from its spinning surface. It is assumed that the mass loss is</span>
<span class="sd">    fully non-conservative. Magnetic braking is fully applied to secondary</span>
<span class="sd">    stars with mass less than 1.3 Msun and fully off for stars with mass larger</span>
<span class="sd">    then 1.5 Msun. The effect of magnetic braking falls linearly for stars with</span>
<span class="sd">    mass between 1.3 Msun and 1.5 Msun.</span>

<span class="sd">    TODO: exaplin new features (e.g., double COs)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t : float</span>
<span class="sd">        The age of the system in years</span>
<span class="sd">    y : list of float</span>
<span class="sd">        Contains the separation, eccentricity and angular velocity, in Rsolar,</span>
<span class="sd">        dimensionless and rad/year units, respectively.</span>
<span class="sd">    M_pri : float</span>
<span class="sd">        Mass of the primary in Msolar units.</span>
<span class="sd">    M_sec : float</span>
<span class="sd">        Mass of the secondary in Msolar units.</span>
<span class="sd">    Mdot : float</span>
<span class="sd">        Rate of change of mass of the star in Msolar/year units.</span>
<span class="sd">        (Negative for wind mass loss.)</span>
<span class="sd">    R : float</span>
<span class="sd">        Radius of the star in Rsolar units.</span>
<span class="sd">    I : float</span>
<span class="sd">        Moment of inertia of the star in Msolar*Rsolar^2.</span>
<span class="sd">    L : float</span>
<span class="sd">        Luminosity of the star  in solar units.</span>
<span class="sd">    #mass_conv_core : float</span>
<span class="sd">    #    Convective core mass of the secondary in Msolar units.</span>
<span class="sd">    conv_mx1_top_r : float</span>
<span class="sd">        Coordinate of top convective mixing zone coordinate in Rsolar.</span>
<span class="sd">    conv_mx1_bot_r : float</span>
<span class="sd">        Coordinate of bottom convective mixing zone coordinate in Rsolar.</span>
<span class="sd">    surface_h1 : float</span>
<span class="sd">        surface mass Hydrogen abundance</span>
<span class="sd">    center_h1 : float</span>
<span class="sd">        center mass Hydrogen abundance</span>
<span class="sd">    M_env : float</span>
<span class="sd">        mass of the dominant convective region for tides above the core,</span>
<span class="sd">        in Msolar.</span>
<span class="sd">    DR_env : float</span>
<span class="sd">        thickness of the dominant convective region for tides above the core,</span>
<span class="sd">        in Rsolar.</span>
<span class="sd">    Renv_middle : float</span>
<span class="sd">        position of the dominant convective region for tides above the core,</span>
<span class="sd">        in Rsolar.</span>
<span class="sd">    Idot : float</span>
<span class="sd">        Rate of change of the moment of inertia of the star in</span>
<span class="sd">        Msolar*Rsolar^2 per year.</span>
<span class="sd">    do_wind_loss: Boolean</span>
<span class="sd">        If True, take into account change of separation due to mass loss from</span>
<span class="sd">        the secondary. Default: True.</span>
<span class="sd">    do_tides: Booleans</span>
<span class="sd">       If True, take into account change of separation, eccentricity and</span>
<span class="sd">       secondary spin due to tidal forces. Default: True.</span>
<span class="sd">    do_gravitational_radiation: Boolean</span>
<span class="sd">       If True, take into account change of separation and eccentricity due to</span>
<span class="sd">       gravitational wave radiation. Default: True</span>
<span class="sd">    do_magnetic_braking: Boolean</span>
<span class="sd">        If True, take into account change of star spin due to magnetic braking.</span>
<span class="sd">        Default: True.</span>
<span class="sd">    do_stellar_evolution_and_spin_from_winds: Boolean</span>
<span class="sd">        If True, take into account change of star spin due to change of its</span>
<span class="sd">        moment of inertia during its evolution and due to spin angular momentum</span>
<span class="sd">        loss due to winds. Default: True.</span>
<span class="sd">    verbose : Boolean</span>
<span class="sd">        If we want to print stuff. Default: False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of float</span>
<span class="sd">        Contains the change of</span>
<span class="sd">        the separation, eccentricity and angular velocity, in Rsolar,</span>
<span class="sd">        dimensionless and rad/year units, respectively.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Tauris, T. M., &amp; van den Heuvel, E. 2006,</span>
<span class="sd">           Compact stellar X-ray sources, 1, 623</span>
<span class="sd">    .. [2] Hut, P. 1981, A&amp;A, 99, 126</span>
<span class="sd">    .. [3] Junker, W., &amp; Schafer, G. 1992, MNRAS, 254, 146</span>
<span class="sd">    .. [4] Rappaport, S., Joss, P. C., &amp; Verbunt, F. 1983, ApJ, 275, 713</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># We limit separation to non-negative values</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># We limit eccentricity to non-negative values</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">):</span>
        <span class="c1"># we force a negligible eccentricity to become 0</span>
        <span class="c1"># for computational stability</span>
        <span class="n">e</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;negligible eccentricity became 0 for &quot;</span>
                  <span class="s2">&quot;computational stability&quot;</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># We limit omega spin to non-negative values</span>
    <span class="n">Omega_sec</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># in rad/yr</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">Omega_pri</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">da</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">de</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dOmega_sec</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dOmega_pri</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1">#  Mass Loss</span>
    <span class="k">if</span> <span class="n">do_wind_loss</span><span class="p">:</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">M_sec</span> <span class="o">/</span> <span class="n">M_pri</span>
        <span class="n">k11</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Mdot_sec</span> <span class="o">/</span> <span class="n">M_sec</span><span class="p">)</span>
        <span class="n">k21</span> <span class="o">=</span> <span class="n">Mdot_sec</span> <span class="o">/</span> <span class="n">M_sec</span>
        <span class="n">k31</span> <span class="o">=</span> <span class="n">Mdot_sec</span> <span class="o">/</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">+</span> <span class="n">M_sec</span><span class="p">)</span>
        <span class="c1"># This is simplified to da_mt = -a * Mdot/(M+Macc), for only (negative)</span>
        <span class="c1"># wind Mdot from star M.</span>
        <span class="n">da_mt_sec</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k11</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k21</span> <span class="o">+</span> <span class="n">k31</span><span class="p">)</span>

        <span class="n">q2</span> <span class="o">=</span> <span class="n">M_pri</span> <span class="o">/</span> <span class="n">M_sec</span>
        <span class="n">k12</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Mdot_pri</span> <span class="o">/</span> <span class="n">M_pri</span><span class="p">)</span>
        <span class="n">k22</span> <span class="o">=</span> <span class="n">Mdot_pri</span> <span class="o">/</span> <span class="n">M_pri</span>
        <span class="n">k32</span> <span class="o">=</span> <span class="n">Mdot_pri</span> <span class="o">/</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">+</span> <span class="n">M_sec</span><span class="p">)</span>
        <span class="n">da_mt_pri</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">k12</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k22</span> <span class="o">+</span> <span class="n">k32</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;da_mt = &quot;</span><span class="p">,</span> <span class="n">da_mt_sec</span><span class="p">,</span> <span class="n">da_mt_pri</span><span class="p">)</span>

        <span class="n">da</span> <span class="o">=</span> <span class="n">da</span> <span class="o">+</span> <span class="n">da_mt_sec</span> <span class="o">+</span> <span class="n">da_mt_pri</span>

    <span class="c1">#  Tidal forces</span>
    <span class="k">if</span> <span class="n">do_tides</span><span class="p">:</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">M_pri</span> <span class="o">/</span> <span class="n">M_sec</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">M_sec</span> <span class="o">/</span> <span class="n">M_pri</span>
        <span class="c1"># P_orb in years. From 3rd Kepler&#39;s law, transforming separation from</span>
        <span class="c1"># Rsolar to AU, to avoid using constants</span>
        <span class="c1"># TODO: we aleady have this function!</span>
        <span class="n">P_orb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">a</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">aursun</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">+</span> <span class="n">M_sec</span><span class="p">))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">P_orb</span>  <span class="c1"># mean orbital ang. vel. in rad/year</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">1</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">31</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">255</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">4</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">185</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">6</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">25</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">8</span>
        <span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">15</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">45</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">6</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">15</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">15</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">6</span>
        <span class="n">f4</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">4</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">4</span>

        <span class="c1"># equilibrium timecale</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">M_env_sec</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">M_env_sec</span><span class="p">))</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">DR_env_sec</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">DR_env_sec</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">Renv_middle_sec</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Renv_middle_sec</span><span class="p">))):</span>
            <span class="c1"># eq. (31) of Hurley et al. 2002, generalized for convective layers</span>
            <span class="c1"># not on surface too</span>
            <span class="n">tau_conv_sec</span> <span class="o">=</span> <span class="mf">0.431</span> <span class="o">*</span> <span class="p">((</span><span class="n">M_env_sec</span> <span class="o">*</span> <span class="n">DR_env_sec</span> <span class="o">*</span> <span class="n">Renv_middle_sec</span>
                                     <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">L_sec</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;something wrong with M_env/DR_env/Renv_middle&quot;</span><span class="p">,</span>
                      <span class="n">M_env_sec</span><span class="p">,</span> <span class="n">DR_env_sec</span><span class="p">,</span> <span class="n">Renv_middle_sec</span><span class="p">)</span>
            <span class="n">tau_conv_sec</span> <span class="o">=</span> <span class="mf">1.0e99</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">M_env_pri</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">M_env_pri</span><span class="p">))</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">DR_env_pri</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">DR_env_pri</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">Renv_middle_pri</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Renv_middle_pri</span><span class="p">))):</span>
            <span class="c1"># eq. (31) of Hurley et al. 2002, generalized for convective layers</span>
            <span class="c1"># not on surface too</span>
            <span class="n">tau_conv_pri</span> <span class="o">=</span> <span class="mf">0.431</span> <span class="o">*</span> <span class="p">((</span><span class="n">M_env_pri</span> <span class="o">*</span> <span class="n">DR_env_pri</span> <span class="o">*</span> <span class="n">Renv_middle_pri</span>
                                     <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">L_pri</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;something wrong with M_env/DR_env/Renv_middle&quot;</span><span class="p">,</span>
                      <span class="n">M_env_pri</span><span class="p">,</span> <span class="n">DR_env_pri</span><span class="p">,</span> <span class="n">Renv_middle_pri</span><span class="p">)</span>
            <span class="n">tau_conv_pri</span> <span class="o">=</span> <span class="mf">1.0e99</span>
        <span class="n">P_spin_sec</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">Omega_sec</span>
        <span class="n">P_spin_pri</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">Omega_pri</span>
        <span class="n">P_tid_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">P_orb</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">P_spin_sec</span><span class="p">))</span>
        <span class="n">P_tid_pri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">P_orb</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">P_spin_pri</span><span class="p">))</span>
        <span class="n">f_conv_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">P_tid_sec</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tau_conv_sec</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">f_conv_pri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">P_tid_pri</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tau_conv_pri</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">F_tid</span> <span class="o">=</span> <span class="mf">1.</span>  <span class="c1"># not 50 as before</span>
        <span class="n">kT_conv_sec</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mi">21</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_conv_sec</span> <span class="o">/</span> <span class="n">tau_conv_sec</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_env_sec</span> <span class="o">/</span> <span class="n">M_sec</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># eq. (30) of Hurley et al. 2002</span>
        <span class="n">kT_conv_pri</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mi">21</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_conv_pri</span> <span class="o">/</span> <span class="n">tau_conv_pri</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_env_pri</span> <span class="o">/</span> <span class="n">M_pri</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">kT_conv_sec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">kT_conv_sec</span><span class="p">):</span>
            <span class="n">kT_conv_sec</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">kT_conv_pri</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">kT_conv_pri</span><span class="p">):</span>
            <span class="n">kT_conv_pri</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kT_conv_sec is&quot;</span><span class="p">,</span> <span class="n">kT_conv_sec</span><span class="p">,</span> <span class="s2">&quot;, set to 0.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kT_conv_pri is&quot;</span><span class="p">,</span> <span class="n">kT_conv_pri</span><span class="p">,</span> <span class="s2">&quot;, set to 0.&quot;</span><span class="p">)</span>
        <span class="c1"># this is the 1/timescale of all d/dt calculted below in yr^-1</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Equilibrium tides in deep convective envelope&quot;</span><span class="p">,</span>
                <span class="n">M_env_sec</span><span class="p">,</span>
                <span class="n">DR_env_sec</span><span class="p">,</span>
                <span class="n">Renv_middle_sec</span><span class="p">,</span>
                <span class="n">R_sec</span><span class="p">,</span>
                <span class="n">M_sec</span><span class="p">,</span>
                <span class="n">M_env_pri</span><span class="p">,</span>
                <span class="n">DR_env_pri</span><span class="p">,</span>
                <span class="n">Renv_middle_pri</span><span class="p">,</span>
                <span class="n">R_pri</span><span class="p">,</span>
                <span class="n">M_pri</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;convective tiimescales and efficiencies&quot;</span><span class="p">,</span>
                  <span class="n">tau_conv_sec</span><span class="p">,</span> <span class="n">P_orb</span><span class="p">,</span> <span class="n">P_spin_sec</span><span class="p">,</span> <span class="n">P_tid_sec</span><span class="p">,</span>
                  <span class="n">f_conv_sec</span><span class="p">,</span>
                  <span class="n">F_tid</span><span class="p">,</span>
                  <span class="n">tau_conv_pri</span><span class="p">,</span> <span class="n">P_orb</span><span class="p">,</span> <span class="n">P_spin_pri</span><span class="p">,</span> <span class="n">P_tid_pri</span><span class="p">,</span>
                  <span class="n">f_conv_pri</span><span class="p">,</span>
                  <span class="n">F_tid</span><span class="p">,</span>
                  <span class="p">)</span>

        <span class="c1"># dynamical timecale</span>
        <span class="n">F_tid</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># E2 = 1.592e-9*M**(2.84) # eq. (43) of Hurley et al. 2002. Deprecated</span>
        <span class="n">R_conv_sec</span> <span class="o">=</span> <span class="n">conv_mx1_top_r_sec</span> <span class="o">-</span> <span class="n">conv_mx1_bot_r_sec</span>
        <span class="n">R_conv_pri</span> <span class="o">=</span> <span class="n">conv_mx1_top_r_pri</span> <span class="o">-</span> <span class="n">conv_mx1_bot_r_pri</span>  <span class="c1"># convective core</span>
        <span class="c1"># R_conv = conv_mx1_top_r  # convective core</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">R_conv_sec</span> <span class="o">&gt;</span> <span class="n">R_sec</span> <span class="ow">or</span> <span class="n">R_conv_sec</span> <span class="o">&lt;=</span> <span class="mf">0.0</span>
                <span class="ow">or</span> <span class="n">conv_mx1_bot_r_sec</span> <span class="o">/</span> <span class="n">R_sec</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">):</span>
            <span class="c1"># R_conv = 0.5*R</span>
            <span class="c1"># if verbose:</span>
            <span class="c1">#     print(</span>
            <span class="c1">#         &quot;R_conv of the convective core is not behaving well or &quot;</span>
            <span class="c1">#         &quot;we are not calculating the convective core, we make it &quot;</span>
            <span class="c1">#         &quot;equal to half of Rstar&quot;,</span>
            <span class="c1">#         R_conv,</span>
            <span class="c1">#         R,</span>
            <span class="c1">#         conv_mx1_top_r,</span>
            <span class="c1">#         conv_mx1_bot_r,</span>
            <span class="c1">#     )</span>
            <span class="c1"># we switch to Zahn+1975 calculation of E2</span>
            <span class="n">E21</span> <span class="o">=</span> <span class="mf">1.592e-9</span> <span class="o">*</span> <span class="n">M_sec</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.84</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">R_sec</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">E21</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">surface_h1_sec</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">:</span>
                <span class="n">E21</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.42</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">R_conv_sec</span> <span class="o">/</span> <span class="n">R_sec</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span>
                    <span class="mf">7.5</span>
                <span class="p">)</span>  <span class="c1"># eq. (9) of Qin et al. 2018, 616, A28</span>
            <span class="k">elif</span> <span class="n">surface_h1_sec</span> <span class="o">&lt;=</span> <span class="mf">0.4</span><span class="p">:</span>  <span class="c1"># &quot;HeStar&quot;:</span>
                <span class="n">E21</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.93</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">R_conv_sec</span> <span class="o">/</span> <span class="n">R_sec</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span>
                    <span class="mf">6.7</span>
                <span class="p">)</span>  <span class="c1"># eq. (9) of Qin et al. 2018, 616, A28</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># in principle we should not go here</span>
                <span class="n">E21</span> <span class="o">=</span> <span class="mf">1.592e-9</span> <span class="o">*</span> <span class="n">M_sec</span> <span class="o">**</span> <span class="p">(</span>
                    <span class="mf">2.84</span>
                <span class="p">)</span>  <span class="c1"># eq. (43) of Hurley et al. 2002 from Zahn+1975 Depreciated</span>
        <span class="c1"># kT = 1.9782e4 * np.sqrt(M * R**2 / a**5) * (1 + q)**(5. / 6) * E2</span>
        <span class="c1"># eq. (42) of Hurley et al. 2002. Depreciated</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">R_conv_pri</span> <span class="o">&gt;</span> <span class="n">R_pri</span> <span class="ow">or</span> <span class="n">R_conv_pri</span> <span class="o">&lt;=</span> <span class="mf">0.0</span>
                <span class="ow">or</span> <span class="n">conv_mx1_bot_r_pri</span> <span class="o">/</span> <span class="n">R_pri</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">):</span>
            <span class="n">E22</span> <span class="o">=</span> <span class="mf">1.592e-9</span> <span class="o">*</span> <span class="n">M_pri</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.84</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;R_conv of the convective core is not behaving well or we &quot;</span>
                    <span class="s2">&quot;are not calculating the convective core, we switch to &quot;</span>
                    <span class="s2">&quot;Zahn+1975 calculation of E2&quot;</span><span class="p">,</span>
                    <span class="n">R_conv_sec</span><span class="p">,</span>
                    <span class="n">R_sec</span><span class="p">,</span>
                    <span class="n">conv_mx1_top_r_sec</span><span class="p">,</span>
                    <span class="n">conv_mx1_bot_r_sec</span><span class="p">,</span>
                    <span class="n">E21</span><span class="p">,</span>
                    <span class="n">R_conv_pri</span><span class="p">,</span>
                    <span class="n">R_pri</span><span class="p">,</span>
                    <span class="n">conv_mx1_top_r_pri</span><span class="p">,</span>
                    <span class="n">conv_mx1_bot_r_pri</span><span class="p">,</span>
                    <span class="n">E22</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">R_pri</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">E22</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">surface_h1_pri</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">:</span>
                <span class="n">E22</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.42</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">R_conv_pri</span> <span class="o">/</span> <span class="n">R_pri</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span>
                    <span class="mf">7.5</span>
                <span class="p">)</span>  <span class="c1"># eq. (9) of Qin et al. 2018, 616, A28</span>
            <span class="k">elif</span> <span class="n">surface_h1_pri</span> <span class="o">&lt;=</span> <span class="mf">0.4</span><span class="p">:</span>  <span class="c1"># &quot;HeStar&quot;:</span>
                <span class="n">E22</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.93</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">R_conv_pri</span> <span class="o">/</span> <span class="n">R_pri</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span>
                    <span class="mf">6.7</span>
                <span class="p">)</span>  <span class="c1"># eq. (9) of Qin et al. 2018, 616, A28</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># in principle we should not go here</span>
                <span class="n">E22</span> <span class="o">=</span> <span class="mf">1.592e-9</span> <span class="o">*</span> <span class="n">M_pri</span> <span class="o">**</span> <span class="p">(</span>
                    <span class="mf">2.84</span>
                <span class="p">)</span>
        <span class="n">kT_rad_sec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_sec</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">R_sec</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="p">)</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">E21</span>
            <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
        <span class="n">kT_rad_pri</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">R_pri</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span><span class="p">)</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">E22</span>
            <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">)</span>
        <span class="c1"># this is the 1/timescale of all d/dt calculted below in yr^-1</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Dynamical tides in radiative envelope&quot;</span><span class="p">,</span>
                <span class="n">conv_mx1_top_r_sec</span><span class="p">,</span>
                <span class="n">conv_mx1_bot_r_sec</span><span class="p">,</span>
                <span class="n">R_conv_sec</span><span class="p">,</span>
                <span class="n">E21</span><span class="p">,</span>
                <span class="n">conv_mx1_top_r_pri</span><span class="p">,</span>
                <span class="n">conv_mx1_bot_r_pri</span><span class="p">,</span>
                <span class="n">R_conv_pri</span><span class="p">,</span>
                <span class="n">E22</span><span class="p">,</span>
                <span class="n">F_tid</span>
            <span class="p">)</span>
        <span class="n">kT_sec</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">kT_conv_sec</span><span class="p">,</span> <span class="n">kT_rad_sec</span><span class="p">)</span>
        <span class="n">kT_pri</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">kT_conv_pri</span><span class="p">,</span> <span class="n">kT_rad_pri</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kT_conv/rad of tides is &quot;</span><span class="p">,</span> <span class="n">kT_conv_sec</span><span class="p">,</span> <span class="n">kT_rad_sec</span><span class="p">,</span>
                  <span class="n">kT_conv_pri</span><span class="p">,</span> <span class="n">kT_rad_pri</span><span class="p">,</span> <span class="s2">&quot;in 1/yr, and we picked the &quot;</span><span class="p">,</span>
                  <span class="n">kT_sec</span><span class="p">,</span> <span class="n">kT_pri</span><span class="p">)</span>

        <span class="n">da_tides_sec</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">6</span>
                <span class="o">*</span> <span class="n">F_tid</span>
                <span class="o">*</span> <span class="n">kT_sec</span>
                <span class="o">*</span> <span class="n">q1</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q1</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">R_sec</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">8</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">15</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">f1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">Omega_sec</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># eq. (9) of Hut 1981, 99, 126</span>

        <span class="n">da_tides_pri</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">6</span>
                <span class="o">*</span> <span class="n">F_tid</span>
                <span class="o">*</span> <span class="n">kT_pri</span>
                <span class="o">*</span> <span class="n">q2</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q2</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">R_pri</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">8</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">15</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">f1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">Omega_pri</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">de_tides_sec</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">27</span>
                <span class="o">*</span> <span class="n">F_tid</span>
                <span class="o">*</span> <span class="n">kT_sec</span>
                <span class="o">*</span> <span class="n">q1</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q1</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">R_sec</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">8</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">13</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">f3</span> <span class="o">-</span> <span class="p">(</span><span class="mi">11</span> <span class="o">/</span> <span class="mi">18</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">Omega_sec</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># eq. (10) of Hut 1981, 99, 126</span>

        <span class="n">de_tides_pri</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">27</span>
                <span class="o">*</span> <span class="n">F_tid</span>
                <span class="o">*</span> <span class="n">kT_pri</span>
                <span class="o">*</span> <span class="n">q2</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q2</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">R_pri</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">8</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">13</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">f3</span> <span class="o">-</span> <span class="p">(</span><span class="mi">11</span> <span class="o">/</span> <span class="mi">18</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">Omega_pri</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">dOmega_tides_sec</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">F_tid</span> <span class="o">*</span> <span class="n">kT_sec</span> <span class="o">*</span> <span class="n">q1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M_sec</span> <span class="o">*</span> <span class="n">R_sec</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">I_sec</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">R_sec</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span>
                <span class="o">*</span> <span class="n">n</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">f2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">f5</span> <span class="o">*</span> <span class="n">Omega_sec</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># eq. (11) of Hut 1981, 99, 126</span>
        <span class="n">dOmega_tides_pri</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">F_tid</span> <span class="o">*</span> <span class="n">kT_pri</span> <span class="o">*</span> <span class="n">q2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M_pri</span> <span class="o">*</span> <span class="n">R_pri</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">I_pri</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">R_pri</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span>
                <span class="o">*</span> <span class="n">n</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">f2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">f5</span> <span class="o">*</span> <span class="n">Omega_pri</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;da,de,dOmega_tides = &quot;</span><span class="p">,</span>
                  <span class="n">da_tides_sec</span><span class="p">,</span> <span class="n">de_tides_sec</span><span class="p">,</span> <span class="n">dOmega_tides_sec</span><span class="p">,</span>
                  <span class="n">da_tides_pri</span><span class="p">,</span> <span class="n">de_tides_pri</span><span class="p">,</span> <span class="n">dOmega_tides_pri</span><span class="p">)</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">da</span> <span class="o">+</span> <span class="n">da_tides_sec</span> <span class="o">+</span> <span class="n">da_tides_pri</span>
        <span class="n">de</span> <span class="o">=</span> <span class="n">de</span> <span class="o">+</span> <span class="n">de_tides_sec</span> <span class="o">+</span> <span class="n">de_tides_pri</span>
        <span class="n">dOmega_sec</span> <span class="o">=</span> <span class="n">dOmega_sec</span> <span class="o">+</span> <span class="n">dOmega_tides_sec</span>
        <span class="n">dOmega_pri</span> <span class="o">=</span> <span class="n">dOmega_pri</span> <span class="o">+</span> <span class="n">dOmega_tides_pri</span>

    <span class="c1">#  Gravitional radiation</span>
    <span class="k">if</span> <span class="n">do_gravitational_radiation</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">*</span> <span class="n">M_sec</span> <span class="o">/</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">+</span> <span class="n">M_sec</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">da_gr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">clight</span> <span class="o">/</span> <span class="mi">15</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">9</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">+</span> <span class="n">M_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span>
               <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">clight</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="mi">3</span>
            <span class="o">*</span> <span class="p">((</span><span class="mi">96</span> <span class="o">+</span> <span class="mi">292</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">37</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
               <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">28</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">+</span> <span class="n">M_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span>
               <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">clight</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
               <span class="o">*</span> <span class="p">((</span><span class="mi">14008</span> <span class="o">+</span> <span class="mi">4707</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">80124</span> <span class="o">+</span> <span class="mi">21560</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span>
               <span class="o">+</span> <span class="p">(</span><span class="mi">17325</span> <span class="o">+</span> <span class="mi">10458</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5501</span> <span class="o">-</span> <span class="mi">1036</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">6</span><span class="p">))</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span>
        <span class="c1"># eq. (35) of Junker et al. 1992, 254, 146</span>
        <span class="n">de_gr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">15</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">v</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">clight</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">+</span> <span class="n">M_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span><span class="p">))</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">+</span> <span class="n">M_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">a</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">clight</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="mi">4</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">7</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="o">*</span> <span class="p">((</span><span class="mi">304</span> <span class="o">+</span> <span class="mi">121</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
               <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">56</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_pri</span> <span class="o">+</span> <span class="n">M_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span>
               <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">rsol</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">clight</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
               <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16705</span> <span class="o">+</span> <span class="mi">4676</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9082</span> <span class="o">+</span> <span class="mi">2807</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">2</span>
               <span class="o">-</span> <span class="p">(</span><span class="mi">25211</span> <span class="o">-</span> <span class="mi">3388</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">**</span> <span class="mi">4</span><span class="p">))</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>
        <span class="c1"># eq. (36) of Junker et al. 1992, 254, 146</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;da,de_gr = &quot;</span><span class="p">,</span> <span class="n">da_gr</span><span class="p">,</span> <span class="n">de_gr</span><span class="p">)</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">da</span> <span class="o">+</span> <span class="n">da_gr</span>
        <span class="n">de</span> <span class="o">=</span> <span class="n">de</span> <span class="o">+</span> <span class="n">de_gr</span>

    <span class="c1">#  Magnetic braking</span>
    <span class="k">if</span> <span class="n">do_magnetic_braking</span><span class="p">:</span>
        <span class="c1"># domega_mb / dt = torque_mb / I,</span>
        <span class="c1"># where torque_mb is in eq.36 of Rapport+1983, with γ = 4</span>
        <span class="n">dOmega_mb_sec</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mf">6.82e34</span>
                <span class="o">*</span> <span class="n">M_sec</span>
                <span class="o">*</span> <span class="n">R_sec</span> <span class="o">**</span> <span class="mi">4</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">Omega_sec</span> <span class="o">*</span> <span class="mf">365.25</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">3</span>
                <span class="o">*</span> <span class="mf">1.48763e-49</span>
                <span class="o">/</span> <span class="n">I_sec</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="mf">1.5</span> <span class="o">-</span> <span class="n">M_sec</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">-</span> <span class="mf">1.3</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">dOmega_mb_pri</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mf">6.82e34</span>
                <span class="o">*</span> <span class="n">M_pri</span>
                <span class="o">*</span> <span class="n">R_pri</span> <span class="o">**</span> <span class="mi">4</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">Omega_pri</span> <span class="o">*</span> <span class="mf">365.25</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">3</span>
                <span class="o">*</span> <span class="mf">1.48763e-49</span>
                <span class="o">/</span> <span class="n">I_pri</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="mf">1.5</span> <span class="o">-</span> <span class="n">M_pri</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">-</span> <span class="mf">1.3</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># -3.8*10e-30</span>
        <span class="c1"># * M</span>
        <span class="c1"># * R ** 4</span>
        <span class="c1"># * Omega ** 3</span>
        <span class="c1"># / I</span>
        <span class="c1"># * (const.rsol)**2 * (const.secyer)**4</span>
        <span class="c1"># (rsol^2 because I ~ MR^2 in the denominator and secyer^4</span>
        <span class="c1"># from omega^3 and to make domega_mb in rad/yr)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dOmega_mb = &quot;</span><span class="p">,</span> <span class="n">dOmega_mb_sec</span><span class="p">,</span> <span class="n">dOmega_mb_pri</span><span class="p">)</span>
        <span class="n">dOmega_sec</span> <span class="o">=</span> <span class="n">dOmega_sec</span> <span class="o">+</span> <span class="n">dOmega_mb_sec</span>
        <span class="n">dOmega_pri</span> <span class="o">=</span> <span class="n">dOmega_pri</span> <span class="o">+</span> <span class="n">dOmega_mb_pri</span>

    <span class="k">if</span> <span class="n">do_stellar_evolution_and_spin_from_winds</span><span class="p">:</span>
        <span class="c1"># Due to the secondary&#39;s own evolution, we have:</span>
        <span class="c1"># domega_spin/dt = d(Jspin/I)/dt = dJspin/dt * 1/I + Jspin*d(1/I)/dt.</span>
        <span class="c1"># These are the two terms calculated below.</span>
        <span class="n">dOmega_spin_wind_sec</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">R_sec</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Omega_sec</span> <span class="o">*</span> <span class="n">Mdot_sec</span> <span class="o">/</span> <span class="n">I_sec</span>
        <span class="p">)</span>
        <span class="c1"># jshell*Mdot/I : specific angular momentum of a thin sperical shell</span>
        <span class="c1"># * mdot  / moment of inertia</span>
        <span class="c1"># Omega is in rad/yr here, and R, M in solar (Mdot solar/yr).</span>
        <span class="n">dOmega_deformation_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
            <span class="p">[</span><span class="o">-</span><span class="n">Omega_sec</span> <span class="o">*</span> <span class="n">Idot_sec</span> <span class="o">/</span> <span class="n">I_sec</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># This is term of Jspin*d(1/I)/dt term of the domega_spin/dt. #</span>
        <span class="c1"># We limit its increase due to contraction to 100 [(rad/yr)/yr]</span>
        <span class="c1"># increase, otherwise the integrator will fail</span>
        <span class="c1"># (usually when we have WD formation).</span>
        <span class="n">dOmega_spin_wind_pri</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">R_pri</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Omega_pri</span> <span class="o">*</span> <span class="n">Mdot_pri</span> <span class="o">/</span> <span class="n">I_pri</span>
        <span class="p">)</span>
        <span class="c1"># jshell*Mdot/I : specific angular momentum of a thin sperical shell</span>
        <span class="c1"># * mdot  / moment of inertia</span>
        <span class="c1"># Omega is in rad/yr here, and R, M in solar (Mdot solar/yr).</span>
        <span class="n">dOmega_deformation_pri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
            <span class="p">[</span><span class="o">-</span><span class="n">Omega_pri</span> <span class="o">*</span> <span class="n">Idot_pri</span> <span class="o">/</span> <span class="n">I_pri</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;dOmega_spin_wind , dOmega_deformation = &quot;</span><span class="p">,</span>
                <span class="n">dOmega_spin_wind_sec</span><span class="p">,</span>
                <span class="n">dOmega_deformation_sec</span><span class="p">,</span>
                <span class="n">dOmega_spin_wind_pri</span><span class="p">,</span>
                <span class="n">dOmega_deformation_pri</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">dOmega_sec</span> <span class="o">=</span> <span class="n">dOmega_sec</span> <span class="o">+</span> <span class="n">dOmega_spin_wind_sec</span>
        <span class="n">dOmega_pri</span> <span class="o">=</span> <span class="n">dOmega_pri</span> <span class="o">+</span> <span class="n">dOmega_spin_wind_pri</span>
        <span class="n">dOmega_sec</span> <span class="o">=</span> <span class="n">dOmega_sec</span> <span class="o">+</span> <span class="n">dOmega_deformation_sec</span>
        <span class="n">dOmega_pri</span> <span class="o">=</span> <span class="n">dOmega_pri</span> <span class="o">+</span> <span class="n">dOmega_deformation_pri</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a[Ro],e,Omega[rad/yr] have been =&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">Omega_sec</span><span class="p">,</span> <span class="n">Omega_pri</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;da,de,dOmega (all) in 1yr is = &quot;</span><span class="p">,</span>
              <span class="n">da</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">dOmega_sec</span><span class="p">,</span> <span class="n">dOmega_pri</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">da</span><span class="p">,</span>
        <span class="n">de</span><span class="p">,</span>
        <span class="n">dOmega_sec</span><span class="p">,</span>
        <span class="n">dOmega_pri</span><span class="p">,</span>
    <span class="p">]</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tassos Fragos.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      Version: 1.0.4
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        
        <dl>
            <dt> v2</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v2.0.6/index.html">2.0</a></dd>
            
            <dd><a href="https://posydon.org/POSYDON/v2.1.6/index.html">2.1</a></dd>
            
        </dl>
        
        <dl>
            <dt> v1</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v1.0.5/index.html">1.0</a></dd>
            
        </dl>
        
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>