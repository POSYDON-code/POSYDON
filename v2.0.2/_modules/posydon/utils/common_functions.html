

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>posydon.utils.common_functions &mdash; posydon 2.0.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=d66fa8e6" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=c2377ec0"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/posydon_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction-acknowledgements/intro.html">Introduction, Objectives, and Scope</a></li>
<li class="toctree-l1"><a class="reference external" href="https://posydon.org/team.html">Collaborative Team</a></li>
<li class="toctree-l1"><a class="reference external" href="https://ui.adsabs.harvard.edu/public-libraries/ZZsD9bzLTzWnLV3hwyJxbA">Publications</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/installation-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/first-grids.html">Quick Start: Examining the MESA Grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/first-population.html">Quick Start: Your First Population</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials and Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials-examples/population-synthesis/binary-pop-syn.html">Binary-Star Population Synthesis with POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials-examples/generating-datasets/generating-datasets.html">Crafting the Core Datasets for POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials-examples/MESA-grids/running-grids.html">Architecting MESA Simulation Grids with POSYDON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">In-Depth Components Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../components-overview/mesa-grids.html">MESA Grids API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components-overview/processing-pipeline.html">Processing Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components-overview/machine-learning-components.html">Machine Learning Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components-overview/stellar-binary-simulation.html">Stellar &amp; Binary-star Simulation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/posydon.html">posydon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/bin.html">executables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases and Datasets</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON/releases">Releases</a></li>
<li class="toctree-l1"><a class="reference external" href="https://zenodo.org/communities/posydon/">Datasets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support and Contact</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contact-support/contact-information.html">Contact Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting-faqs/installation-issues.html">Common Installation Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting-faqs/code-questions.html">Code Usage Questions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/POSYDON-code/POSYDON/issues/new/choose">Report an Issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/how-to-contribute.html">How To Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">posydon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">posydon.utils.common_functions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for posydon.utils.common_functions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Common functions to be used while running populations.&quot;&quot;&quot;</span>


<span class="n">__authors__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Konstantinos Kovlakas &lt;Konstantinos.Kovlakas@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Devina Misra &lt;devina.misra@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Emmanouil Zapartas &lt;ezapartas@gmail.com&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Simone Bavera &lt;Simone.Bavera@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Nam Tran &lt;tranhn03@gmail.com&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ying Qin &lt;&lt;yingqin2013@hotmail.com&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Jeffrey Andrews &lt;jeffrey.andrews@northwestern.edu&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tassos Fragos &lt;Anastasios.Fragkos@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Scott Coughlin &lt;scottcoughlin2014@u.northwestern.edu&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Kyle Akira Rocha &lt;kylerocha2024@u.northwestern.edu&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Matthias Kruckow &lt;Matthias.Kruckow@unige.ch&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Camille Liotine &lt;cliotine@u.northwestern.edu&gt;&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">newton</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">quad</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.posydonwarning</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pwarn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.limits_thresholds</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">THRESHOLD_CENTRAL_ABUNDANCE</span><span class="p">,</span>
    <span class="n">THRESHOLD_HE_NAKED_ABUNDANCE</span><span class="p">,</span> <span class="n">REL_LOG10_BURNING_THRESHOLD</span><span class="p">,</span>
    <span class="n">LOG10_BURNING_THRESHOLD</span><span class="p">,</span> <span class="n">STATE_WD_STARMASS_UPPER_LIMIT</span><span class="p">,</span>
    <span class="n">STATE_NS_STARMASS_LOWER_LIMIT</span><span class="p">,</span> <span class="n">STATE_NS_STARMASS_UPPER_LIMIT</span><span class="p">,</span>
    <span class="n">RL_RELATIVE_OVERFLOW_THRESHOLD</span><span class="p">,</span> <span class="n">LG_MTRANSFER_RATE_THRESHOLD</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">posydon.utils.interpolators</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>


<span class="c1"># Constants related to inferring star states</span>
<span class="n">STATE_UNDETERMINED</span> <span class="o">=</span> <span class="s2">&quot;undetermined_evolutionary_state&quot;</span>

<span class="c1"># ALL POSSIBLE STAR STATES</span>
<span class="n">BURNING_STATES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Core_H_burning&quot;</span><span class="p">,</span> <span class="s2">&quot;Core_He_burning&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Shell_H_burning&quot;</span><span class="p">,</span> <span class="s2">&quot;Central_He_depleted&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Central_C_depletion&quot;</span><span class="p">]</span>
<span class="n">RICHNESS_STATES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;H-rich&quot;</span><span class="p">,</span> <span class="s2">&quot;stripped_He&quot;</span><span class="p">,</span> <span class="s2">&quot;accreted_He&quot;</span><span class="p">]</span>
<span class="n">COMPACT_OBJECTS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WD&quot;</span><span class="p">,</span> <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;BH&quot;</span><span class="p">,</span><span class="s2">&quot;massless_remnant&quot;</span><span class="p">]</span>

<span class="n">ALL_STAR_STATES</span> <span class="o">=</span> <span class="n">COMPACT_OBJECTS</span> <span class="o">+</span> <span class="p">[</span><span class="n">STATE_UNDETERMINED</span><span class="p">]</span>
<span class="n">ALL_STAR_STATES</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rich_in</span><span class="p">,</span> <span class="n">burning</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">rich_in</span> <span class="ow">in</span> <span class="n">RICHNESS_STATES</span>
                        <span class="k">for</span> <span class="n">burning</span> <span class="ow">in</span> <span class="n">BURNING_STATES</span><span class="p">])</span>

<span class="c1"># Mass-transfer cases in form of integer flags</span>
<span class="n">MT_CASE_NO_RLO</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">MT_CASE_A</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">MT_CASE_B</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">MT_CASE_C</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">MT_CASE_BA</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">MT_CASE_BB</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MT_CASE_BC</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">MT_CASE_NONBURNING</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">MT_CASE_UNDETERMINED</span> <span class="o">=</span> <span class="mi">9</span>

<span class="c1"># All cases meaning RLO is happening</span>
<span class="n">ALL_RLO_CASES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">MT_CASE_A</span><span class="p">,</span> <span class="n">MT_CASE_B</span><span class="p">,</span> <span class="n">MT_CASE_C</span><span class="p">,</span>
                     <span class="n">MT_CASE_BA</span><span class="p">,</span> <span class="n">MT_CASE_BB</span><span class="p">,</span> <span class="n">MT_CASE_BC</span><span class="p">,</span>
                     <span class="n">MT_CASE_NONBURNING</span><span class="p">])</span>

<span class="c1"># Conversion of integer mass-transfer flags to strings</span>
<span class="n">MT_CASE_TO_STR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">MT_CASE_NO_RLO</span><span class="p">:</span> <span class="s2">&quot;no_RLO&quot;</span><span class="p">,</span>
    <span class="n">MT_CASE_A</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
    <span class="n">MT_CASE_B</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
    <span class="n">MT_CASE_C</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
    <span class="n">MT_CASE_BA</span><span class="p">:</span> <span class="s2">&quot;BA&quot;</span><span class="p">,</span>
    <span class="n">MT_CASE_BB</span><span class="p">:</span> <span class="s2">&quot;BB&quot;</span><span class="p">,</span>
    <span class="n">MT_CASE_BC</span><span class="p">:</span> <span class="s2">&quot;BC&quot;</span><span class="p">,</span>
    <span class="n">MT_CASE_NONBURNING</span><span class="p">:</span> <span class="s2">&quot;nonburning&quot;</span><span class="p">,</span>
    <span class="n">MT_CASE_UNDETERMINED</span><span class="p">:</span> <span class="s2">&quot;undetermined_MT&quot;</span>
<span class="p">}</span>

<span class="c1"># Conversion of strings to integer mass-transfer flags</span>
<span class="n">MT_STR_TO_CASE</span> <span class="o">=</span> <span class="p">{</span><span class="n">string</span><span class="p">:</span> <span class="n">integer</span> <span class="k">for</span> <span class="n">integer</span><span class="p">,</span> <span class="n">string</span>
                  <span class="ow">in</span> <span class="n">MT_CASE_TO_STR</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">DEFAULT_CE_OPTION_FOR_LAMBDA</span> <span class="o">=</span> \
    <span class="s2">&quot;lambda_from_profile_gravitational_plus_internal_minus_recombination&quot;</span>


<div class="viewcode-block" id="is_number">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.is_number">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_number</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the input can be converted to a float.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="stefan_boltzmann_law">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.stefan_boltzmann_law">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">stefan_boltzmann_law</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the effective temperature give the luminosity and radius.&quot;&quot;&quot;</span>
    <span class="c1">#TODO: check for invalid or negative inputs</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">L</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Lsun</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Rsun</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">boltz_sigma</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span></div>



<div class="viewcode-block" id="rzams">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.rzams">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rzams</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">Zsun</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate the zero age main sequence radius [1]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m : array_like</span>
<span class="sd">        The masses of the stars in Msun.</span>
<span class="sd">    z : float</span>
<span class="sd">        The metallicity of the star.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Array of same size as `m` containing the ZAMS radii of the stars (Rsun)</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Tout C. A., Pols O. R., Eggleton P. P., Han Z., 1996, MNRAS, 281,</span>
<span class="sd">        257</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO: check for invalid or negative inputs</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">xz</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.970417e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2913574e-01</span><span class="p">,</span> <span class="mf">3.4776688e-01</span><span class="p">,</span> <span class="mf">3.7470851e-01</span><span class="p">,</span>
        <span class="mf">9.011915e-02</span><span class="p">,</span> <span class="mf">8.527626e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.441225973e+01</span><span class="p">,</span> <span class="mf">5.643597107e+01</span><span class="p">,</span>
        <span class="mf">3.706152575e+01</span><span class="p">,</span> <span class="mf">5.4562406e+00</span><span class="p">,</span> <span class="mf">2.5546e-04</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.23461e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.3246e-04</span><span class="p">,</span>
        <span class="mf">4.5519e-04</span><span class="p">,</span> <span class="mf">1.6176e-04</span><span class="p">,</span> <span class="mf">5.432889e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.62157806e+00</span><span class="p">,</span> <span class="mf">1.344202049e+01</span><span class="p">,</span>
        <span class="mf">1.451584135e+01</span><span class="p">,</span> <span class="mf">3.39793084e+00</span><span class="p">,</span> <span class="mf">5.563579e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.032345224e+01</span><span class="p">,</span>
        <span class="mf">1.944322980e+01</span><span class="p">,</span> <span class="mf">1.897361347e+01</span><span class="p">,</span> <span class="mf">4.16903097e+00</span><span class="p">,</span> <span class="mf">7.8866060e-01</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">2.90870942e+00</span><span class="p">,</span> <span class="mf">6.54713531e+00</span><span class="p">,</span> <span class="mf">4.05606657e+00</span><span class="p">,</span> <span class="mf">5.3287322e-01</span><span class="p">,</span>
        <span class="mf">5.86685e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.704237e-02</span><span class="p">,</span> <span class="mf">3.872348e-02</span><span class="p">,</span> <span class="mf">2.570041e-02</span><span class="p">,</span> <span class="mf">3.83376e-03</span><span class="p">,</span>
        <span class="mf">1.715359e+00</span><span class="p">,</span> <span class="mf">6.2246212e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.2557761e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.16996966e+00</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">3.0631491e-01</span><span class="p">,</span> <span class="mf">6.597788e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.2450044e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.213339427e+01</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">1.073509484e+01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.51487077e+00</span><span class="p">,</span> <span class="mf">1.008855000e+01</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.11727086e+00</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">3.167119479e+01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.424848322e+01</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.33608972e+00</span><span class="p">,</span> <span class="mf">1.012495e+00</span><span class="p">,</span>
        <span class="mf">3.2699690e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.23418e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.876858e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.12750e-03</span><span class="p">,</span> <span class="mf">7.490166e-02</span><span class="p">,</span>
        <span class="mf">2.410413e-02</span><span class="p">,</span> <span class="mf">7.233664e-02</span><span class="p">,</span> <span class="mf">3.040467e-02</span><span class="p">,</span> <span class="mf">1.97741e-03</span><span class="p">,</span> <span class="mf">1.077422e-02</span><span class="p">,</span>
        <span class="mf">3.082234e+00</span><span class="p">,</span> <span class="mf">9.447205e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.15200882e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.49219496e+00</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">6.3848738e-01</span><span class="p">,</span> <span class="mf">1.784778e+01</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.4534569e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.896066856e+01</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">4.005386135e+01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.09331816e+00</span><span class="p">,</span> <span class="mf">2.2582e-04</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.86899e-03</span><span class="p">,</span>
        <span class="mf">3.88783e-03</span><span class="p">,</span> <span class="mf">1.42402e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.671e-05</span>
    <span class="p">]</span>
    <span class="n">lzs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="n">Zsun</span><span class="p">)</span>

    <span class="n">msp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                           <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                           <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">10</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                             <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">15</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                             <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">20</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                             <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">25</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                             <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">30</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                             <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">35</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                             <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">40</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                             <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">45</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">47</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                              <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">49</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">50</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                              <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">55</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">58</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                              <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">60</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">61</span><span class="p">]</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">62</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">63</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                              <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">65</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">66</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">67</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">68</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">69</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                              <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">70</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">71</span><span class="p">])))</span>
    <span class="n">msp</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span><span class="p">[</span><span class="mi">72</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">73</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">74</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span>
                                              <span class="o">*</span> <span class="p">(</span><span class="n">xz</span><span class="p">[</span><span class="mi">75</span><span class="p">]</span> <span class="o">+</span> <span class="n">lzs</span> <span class="o">*</span> <span class="n">xz</span><span class="p">[</span><span class="mi">76</span><span class="p">])))</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">msp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">msp</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">mx</span> <span class="o">+</span> <span class="n">msp</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">**</span><span class="mi">11</span>
         <span class="o">+</span> <span class="p">(</span><span class="n">msp</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="n">msp</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">*</span> <span class="n">mx</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="o">**</span><span class="mi">19</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
             <span class="n">msp</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">+</span> <span class="n">msp</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">**</span><span class="mi">2</span>
             <span class="o">+</span> <span class="p">(</span><span class="n">msp</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">**</span><span class="mi">8</span> <span class="o">+</span> <span class="n">m</span><span class="o">**</span><span class="mi">18</span> <span class="o">+</span> <span class="n">msp</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">**</span><span class="mi">19</span><span class="p">)</span> <span class="o">*</span> <span class="n">mx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span></div>



<div class="viewcode-block" id="roche_lobe_radius">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.roche_lobe_radius">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">roche_lobe_radius</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">a_orb</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Approximate the Roche lobe radius from [1]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m1 : float, ndarray of floats</span>
<span class="sd">        the mass of the star for which we calculate the Roche lobe</span>
<span class="sd">    m2 : float, ndarray of floats</span>
<span class="sd">        the mass of the companion star</span>
<span class="sd">    a_orb : float, ndarray of floats</span>
<span class="sd">        Orbital separation. The return value will have the same unit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float, ndarray of floats</span>
<span class="sd">        Roche lobe radius in similar units as a_orb</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Eggleton, P. P. 1983, ApJ, 268, 368</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## catching if a_orb is an empty array or is an array with invalid</span>
    <span class="c1">## separation values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_orb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="c1">## if array is empty, fill with NaN values</span>
        <span class="k">if</span> <span class="n">a_orb</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Trying to compute RL radius for binary with invalid&quot;</span>
                  <span class="s2">&quot; separation&quot;</span><span class="p">,</span> <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
            <span class="n">a_orb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">s</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">a_orb</span><span class="o">.</span><span class="n">shape</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c1">## if array contains invalid values, replace with NaN </span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">a_orb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Trying to compute RL radius for binary with invalid&quot;</span>
                  <span class="s2">&quot; separation&quot;</span><span class="p">,</span> <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
            <span class="n">a_orb</span><span class="p">[</span><span class="n">a_orb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1">## catching if a_orb is a float with invalid separation value</span>
    <span class="k">elif</span> <span class="n">a_orb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Trying to compute RL radius for binary with invalid separation&quot;</span><span class="p">,</span>
              <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
        <span class="n">a_orb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">m1</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                  
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Trying to compute RL radius for nonexistent object&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
            <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">s</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m1</span><span class="o">.</span><span class="n">shape</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">m1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Trying to compute RL radius for nonexistent object&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
            <span class="n">m1</span><span class="p">[</span><span class="n">m1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">elif</span> <span class="n">m1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Trying to compute RL radius for nonexistent object&quot;</span><span class="p">,</span>
              <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">m2</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                  
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Trying to compute RL radius for nonexistent companion&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">s</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">shape</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">m2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Trying to compute RL radius for nonexistent companion&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
            <span class="n">m2</span><span class="p">[</span><span class="n">m2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">elif</span> <span class="n">m2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Trying to compute RL radius for nonexistent companion&quot;</span><span class="p">,</span>
              <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
   
    <span class="n">q</span> <span class="o">=</span> <span class="n">m1</span><span class="o">/</span><span class="n">m2</span>
    <span class="n">RL</span> <span class="o">=</span> <span class="n">a_orb</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.49</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
        <span class="mf">0.6</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">RL</span></div>


<div class="viewcode-block" id="check_for_RLO">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.check_for_RLO">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_for_RLO</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">separation</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if either star in a binary is overfilling its Roche lobe.</span>

<span class="sd">    It uses roche_lobe_radius and the binary separation to determine if either</span>
<span class="sd">    star is overfilling their Roche lobe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m1 : float</span>
<span class="sd">        Mass of star 1 (in Msun)</span>
<span class="sd">    r1 : float</span>
<span class="sd">        Radius of star 1 (in Rsun)</span>
<span class="sd">    m2 : float</span>
<span class="sd">        Mass of star 2 (in Msun)</span>
<span class="sd">    r2 : float</span>
<span class="sd">        Radius of star 2 (in Rsun)</span>
<span class="sd">    separation : float</span>
<span class="sd">        Orbital separation (in Rsun)</span>
<span class="sd">    tolerance : float</span>
<span class="sd">        The tolerance to count Roche-lobe filling as Roche-lobe overflow (in Rsun).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    RLO: bool</span>
<span class="sd">        Whether either star in the binary is overfilling its Roche Lobe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First, calculate the Roche radii for each star</span>
    <span class="n">RL1</span> <span class="o">=</span> <span class="n">roche_lobe_radius</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">separation</span><span class="p">)</span>
    <span class="n">RL2</span> <span class="o">=</span> <span class="n">roche_lobe_radius</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">separation</span><span class="p">)</span>

    <span class="c1"># Now check for Roche-lobe overflow</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">r1</span> <span class="o">-</span> <span class="n">RL1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r2</span> <span class="o">-</span> <span class="n">RL2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="orbital_separation_from_period">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.orbital_separation_from_period">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">orbital_separation_from_period</span><span class="p">(</span><span class="n">period_days</span><span class="p">,</span> <span class="n">m1_solar</span><span class="p">,</span> <span class="n">m2_solar</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply the Third Kepler law.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    period_days : float</span>
<span class="sd">        Orbital period in days.</span>
<span class="sd">    m1_solar : float</span>
<span class="sd">        Mass of the one of the stars, in solar units.</span>
<span class="sd">    m2_solar : float</span>
<span class="sd">        Mass of the other star, in solar units.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The separation of the binary in solar radii.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO: check for invalid or negative inputs</span>
    <span class="c1"># cast to float64 to avoid overflow</span>
    <span class="n">m1_solar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">m1_solar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="n">m2_solar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">m2_solar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="n">period_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">period_days</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

    <span class="n">separation_cm</span> <span class="o">=</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span>
                     <span class="o">*</span> <span class="p">(</span><span class="n">m1_solar</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span> <span class="o">+</span> <span class="n">m2_solar</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span><span class="p">)</span>
                     <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
                     <span class="o">*</span> <span class="p">(</span><span class="n">period_days</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">day2sec</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
    <span class="n">separation_solar</span> <span class="o">=</span> <span class="n">separation_cm</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">Rsun</span>
    <span class="k">return</span> <span class="n">separation_solar</span></div>



<div class="viewcode-block" id="orbital_period_from_separation">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.orbital_period_from_separation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">orbital_period_from_separation</span><span class="p">(</span><span class="n">separation</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply the Third Kepler law.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    separation : float</span>
<span class="sd">        Orbital separation (semi-major axis) in Rsun.</span>
<span class="sd">    m1 : float</span>
<span class="sd">        Mass of one of the stars in solar units.</span>
<span class="sd">    m2 : type</span>
<span class="sd">        Mass of the other star in solar units.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The orbital period in days.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO: check for invalid or negative inputs</span>
    <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">dayyer</span> <span class="o">*</span> <span class="p">((</span><span class="n">separation</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">aursun</span><span class="p">)</span><span class="o">**</span><span class="mf">3.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="n">m2</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span></div>





<div class="viewcode-block" id="eddington_limit">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.eddington_limit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">eddington_limit</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">idx</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the Eddington limit &amp; radtiative efficiency of compact object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    binary : BinaryStar</span>
<span class="sd">        The binary object.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        The Eddington accretion limit and radiative efficiency in solar units.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NS&#39;</span><span class="p">,</span> <span class="s1">&#39;BH&#39;</span><span class="p">,</span> <span class="s1">&#39;WD&#39;</span><span class="p">]:</span>
        <span class="n">accretor</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
        <span class="n">donor</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
    <span class="k">elif</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NS&#39;</span><span class="p">,</span> <span class="s1">&#39;BH&#39;</span><span class="p">,</span> <span class="s1">&#39;WD&#39;</span><span class="p">]:</span>
        <span class="n">accretor</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
        <span class="n">donor</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Eddington limit is being calculated for a non-CO&quot;</span><span class="p">)</span>

    <span class="n">state_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">accretor</span><span class="o">.</span><span class="n">state_history</span><span class="p">,</span> <span class="n">accretor</span><span class="o">.</span><span class="n">state</span><span class="p">])[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">m_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">accretor</span><span class="o">.</span><span class="n">mass_history</span><span class="p">,</span> <span class="n">accretor</span><span class="o">.</span><span class="n">mass</span><span class="p">],</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">msol</span>
    <span class="n">surface_h1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">donor</span><span class="o">.</span><span class="n">surface_h1_history</span><span class="p">,</span> <span class="n">donor</span><span class="o">.</span><span class="n">surface_h1</span><span class="p">],</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state_acc</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">state_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="s1">&#39;NS&#39;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">accretor</span><span class="o">.</span><span class="n">state_history</span><span class="p">):</span>
                <span class="n">state_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NS&#39;</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="s1">&#39;BH&#39;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">accretor</span><span class="o">.</span><span class="n">state_history</span><span class="p">):</span>
                <span class="n">state_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BH&#39;</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="s1">&#39;WD&#39;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">accretor</span><span class="o">.</span><span class="n">state_history</span><span class="p">):</span>
                <span class="n">state_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;WD&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;COtype must be &quot;BH&quot;, &quot;NS&quot;, or &quot;WD&quot;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">surface_h1</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">surface_h1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.7155</span>
        <span class="k">if</span> <span class="n">state_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;BH&quot;</span><span class="p">:</span>
            <span class="n">r_isco</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1">#TODO: get r_isco as input/calculate from spin</span>
            <span class="c1"># m_ini is the accretor mass at zero spin</span>
            <span class="n">m_ini</span> <span class="o">=</span> <span class="n">m_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r_isco</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">m_acc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_ini</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">m_ini</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 1.25 * 10**6 cm</span>
            <span class="n">acc_radius</span> <span class="o">=</span> <span class="n">CO_radius</span><span class="p">(</span><span class="n">m_acc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">state_acc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Rsun</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span><span class="o">*</span><span class="n">m_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">acc_radius</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">clight</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># This is the mass accretion rate corresponding to the</span>
        <span class="c1"># Eddington luminosity, L_edd = eta * mdot_edd * clightˆ2 (cgs units)</span>
        <span class="n">mdot_edd</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="n">m_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="o">/</span> <span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">surface_h1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">clight</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mdot_edd</span> <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">msol</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span><span class="p">),</span> <span class="n">eta</span></div>



<div class="viewcode-block" id="beaming">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.beaming">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">beaming</span><span class="p">(</span><span class="n">binary</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the geometrical beaming of a super-Eddington accreting source</span>
<span class="sd">    [1]_, [2]_.</span>

<span class="sd">    Compute the super-Eddington isotropic-equivalent accretion rate and the</span>
<span class="sd">    beaming factor of a star. This does not change the intrinsic accretion onto</span>
<span class="sd">    the accretor and is an observational effect due to the inflated structure</span>
<span class="sd">    of the accretion disc that beams the outgoing X-ray emission. This is</span>
<span class="sd">    important for observing super-Eddington X-ray sources</span>
<span class="sd">    (e.g. ultraluminous X-ray sources). In case of a BH we are assuming that it</span>
<span class="sd">    has zero spin which is not a good approximation for high accretion rates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    binary : BinaryStar</span>
<span class="sd">        The binary object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        The super-Eddington isotropic-equivalent accretion rate and beaming</span>
<span class="sd">        factor respcetively in solar units.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Shakura, N. I. &amp; Sunyaev, R. A. 1973, A&amp;A, 24, 337</span>
<span class="sd">    .. [2] King A. R., 2008, MNRAS, 385, L113</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdot_edd</span> <span class="o">=</span> <span class="n">eddington_limit</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">idx</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">lg_mtransfer_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rlo_mdot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rlo_mdot</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">binary</span><span class="o">.</span><span class="n">lg_mtransfer_rate</span>

    <span class="k">if</span> <span class="n">rlo_mdot</span> <span class="o">&gt;=</span> <span class="n">mdot_edd</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rlo_mdot</span> <span class="o">&gt;</span> <span class="mf">8.5</span> <span class="o">*</span> <span class="n">mdot_edd</span><span class="p">:</span>
            <span class="c1"># eq. 8 in King A. R., 2009, MNRAS, 393, L41-L44</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mi">73</span> <span class="o">/</span> <span class="p">(</span><span class="n">rlo_mdot</span> <span class="o">/</span> <span class="n">mdot_edd</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Shakura, N. I. &amp; Sunyaev, R. A. 1973, A&amp;A, 24, 337</span>
        <span class="n">mdot_beam</span> <span class="o">=</span> <span class="n">mdot_edd</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rlo_mdot</span> <span class="o">/</span> <span class="n">mdot_edd</span><span class="p">))</span> <span class="o">/</span> <span class="n">b</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mdot_beam</span> <span class="o">=</span> <span class="n">rlo_mdot</span>

    <span class="k">return</span> <span class="n">mdot_beam</span><span class="p">,</span> <span class="n">b</span></div>



<div class="viewcode-block" id="bondi_hoyle">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.bondi_hoyle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bondi_hoyle</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">accretor</span><span class="p">,</span> <span class="n">donor</span><span class="p">,</span> <span class="n">idx</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">wind_disk_criteria</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;Hurley+2002&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the Bondi-Hoyle accretion rate of a binary [1]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    binary : BinaryStar</span>
<span class="sd">        The binary which accretion rate is required.</span>
<span class="sd">    accretor : SingleStar</span>
<span class="sd">        The accretor in the binary.</span>
<span class="sd">    donor : SingleStar</span>
<span class="sd">        The donor in the binary.</span>
<span class="sd">    idx : int</span>
<span class="sd">        default: -1</span>
<span class="sd">    wind_disk_criteria : bool</span>
<span class="sd">        default: True, see [5]_</span>
<span class="sd">    scheme : str</span>
<span class="sd">        There are different options:</span>

<span class="sd">        - &#39;Hurley+2002&#39; : following [3]_</span>
<span class="sd">        - &#39;Kudritzki+2000&#39; : following [7]_</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The Bondi-Hoyle accretion rate in solar units.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    An approximation is used for the accretion rate [2]_ and the wind velocity</span>
<span class="sd">    of the donor is moddeled as in [3]_, [6]_. Also see [4]_.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Bondi, H., &amp; Hoyle, F. 1944, MNRAS, 104, 273</span>
<span class="sd">    .. [2] Boffin, H. M. J., &amp; Jorissen, A. 1988, A&amp;A, 205, 155</span>
<span class="sd">    .. [3] Hurley, J. R., Tout, C. A., &amp; Pols, O. R. 2002, MNRAS, 329, 897</span>
<span class="sd">    .. [4] Belczynski, K., Kalogera, V., Rasio, F. A., et al. 2008, ApJS, 174,</span>
<span class="sd">        223</span>
<span class="sd">    .. [5] Sen, K. ,Xu, X. -T., Langer, N., El Mellah, I. , Schurmann, C., &amp;</span>
<span class="sd">        Quast, M., 2021, A&amp;A</span>
<span class="sd">    .. [6] Sander A. A. C., Vink J. S., 2020, MNRAS, 499, 873</span>
<span class="sd">    .. [7] Kudritzki, R.-P., &amp; Puls, J. 2000, ARA&amp;A, 38, 613</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="mf">1e-3</span>     <span class="c1"># 6.67428e-11 m3 kg-1 s-2</span>
    <span class="n">Msun</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span> <span class="o">*</span> <span class="mf">1e-3</span>            <span class="c1"># 1.988547e30  kg</span>
    <span class="n">Rsun</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">Rsun</span> <span class="o">*</span> <span class="mf">1e-2</span>            <span class="c1"># 6.9566e8 m</span>

    <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">binary</span><span class="o">.</span><span class="n">separation_history</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">separation</span><span class="p">],</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">ecc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">binary</span><span class="o">.</span><span class="n">eccentricity_history</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">eccentricity</span><span class="p">],</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>
    <span class="c1">#TODO: use stars in the binary as donor and accretor</span>
    <span class="n">m_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">accretor</span><span class="o">.</span><span class="n">mass_history</span><span class="p">,</span> <span class="n">accretor</span><span class="o">.</span><span class="n">mass</span><span class="p">],</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">donor</span><span class="o">.</span><span class="n">mass_history</span><span class="p">,</span> <span class="n">donor</span><span class="o">.</span><span class="n">mass</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">lg_mdot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">donor</span><span class="o">.</span><span class="n">lg_wind_mdot_history</span><span class="p">,</span> <span class="n">donor</span><span class="o">.</span><span class="n">lg_wind_mdot</span><span class="p">],</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">he_core_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">donor</span><span class="o">.</span><span class="n">he_core_radius_history</span><span class="p">,</span> <span class="n">donor</span><span class="o">.</span><span class="n">he_core_radius</span><span class="p">],</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">log_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">donor</span><span class="o">.</span><span class="n">log_R_history</span><span class="p">,</span> <span class="n">donor</span><span class="o">.</span><span class="n">log_R</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_R</span>  <span class="c1"># Rsun</span>
    <span class="n">surface_h1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">donor</span><span class="o">.</span><span class="n">surface_h1_history</span><span class="p">,</span> <span class="n">donor</span><span class="o">.</span><span class="n">surface_h1</span><span class="p">],</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="o">*</span><span class="n">donor</span><span class="o">.</span><span class="n">log_L_history</span><span class="p">,</span> <span class="n">donor</span><span class="o">.</span><span class="n">log_L</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">Teff</span> <span class="o">=</span> <span class="n">stefan_boltzmann_law</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">L</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>

    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

    <span class="c1"># Hurley, J. R., Tout, C. A., &amp; Pols, O. R. 2002, MNRAS, 329, 897</span>
    <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;Hurley+2002&#39;</span><span class="p">:</span>
        <span class="c1"># For H-rich stars</span>
        <span class="n">beta</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">he_core_mass</span><span class="p">,</span> <span class="n">radius</span> <span class="o">&gt;</span> <span class="mf">900.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.125</span>
        <span class="n">beta</span><span class="p">[</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mf">120.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">7.0</span>
        <span class="n">beta</span><span class="p">[</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mf">1.4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="mf">1.4</span><span class="p">,</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="mf">120.0</span><span class="p">)</span>
        <span class="n">beta</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">120.0</span> <span class="o">-</span> <span class="mf">1.4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">6.5</span><span class="p">)</span>

        <span class="c1"># For He-rich stars</span>
        <span class="n">beta</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">surface_h1</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mf">120.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">7.0</span>
        <span class="n">beta</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">surface_h1</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.125</span>
        <span class="n">mass_cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="mf">120.0</span><span class="p">)</span>
        <span class="n">he_cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mass_cond</span><span class="p">,</span> <span class="n">surface_h1</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">beta</span><span class="p">[</span><span class="n">he_cond</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.125</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">he_cond</span><span class="p">]</span> <span class="o">-</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">120.0</span> <span class="o">-</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">6.875</span><span class="p">)</span>

        <span class="n">f_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>

    <span class="c1"># Kudritzki, R.-P., &amp; Puls, J. 2000, ARA&amp;A, 38, 613</span>
    <span class="k">elif</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;Kudritzki+2000&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">Teff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">21000</span><span class="p">:</span>
                <span class="n">f_m</span> <span class="o">=</span> <span class="mf">2.65</span>
            <span class="k">elif</span> <span class="n">Teff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">10000</span><span class="p">:</span>
                <span class="n">f_m</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_m</span> <span class="o">=</span> <span class="mf">1.4</span>

    <span class="n">v_esc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">Msun</span> <span class="o">/</span> <span class="p">(</span><span class="n">radius</span> <span class="o">*</span> <span class="n">Rsun</span><span class="p">))</span>     <span class="c1"># m/s</span>
    <span class="n">v_wind</span> <span class="o">=</span> <span class="n">v_esc</span> <span class="o">*</span> <span class="n">f_m</span>                                    <span class="c1"># m/s</span>

    <span class="c1"># Sander A. A. C., Vink J. S., 2020, MNRAS, 499, 873</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">surface_h1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.4</span> <span class="ow">and</span> <span class="n">Teff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0e4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lg_mdot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">5.25</span><span class="p">:</span>
                <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.7</span> <span class="o">-</span> <span class="mf">3.25</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">+</span> <span class="mf">5.25</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.25</span> <span class="o">-</span> <span class="mf">3.75</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.25</span> <span class="o">+</span> <span class="mf">7.25</span><span class="p">)</span>
            <span class="n">v_wind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">lg_mdot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">3.25</span> <span class="o">+</span> <span class="mf">5.25</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">m_acc</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">Msun</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">radius</span> <span class="o">*</span> <span class="n">Rsun</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">newton</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="n">ecc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span class="n">t0</span><span class="p">,</span>
               <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
               <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">*</span> <span class="n">Rsun</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ecc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">r_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sep</span> <span class="o">*</span> <span class="n">Rsun</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">-</span> <span class="n">ecc</span><span class="p">),</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">)])</span>
    <span class="n">v_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">sep</span> <span class="o">*</span> <span class="n">Rsun</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">),</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="p">)])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">v_dir_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_dir</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;j&#39;</span><span class="p">,</span> <span class="n">r_vec</span><span class="p">,</span> <span class="n">v_dir</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">v_dir_norm</span><span class="p">)</span>  <span class="c1"># cos(angle)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">m_acc</span><span class="p">)</span> <span class="o">*</span> <span class="n">Msun</span> <span class="o">*</span> <span class="p">((</span><span class="mi">2</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">sep</span> <span class="o">*</span> <span class="n">Rsun</span><span class="p">))))</span>  <span class="c1"># m/s</span>
    <span class="n">v_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v_wind</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">v_wind</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>                <span class="c1"># m/s</span>

    <span class="c1"># Bondi, H., &amp; Hoyle, F. 1944, MNRAS, 104, 273</span>
    <span class="n">mdot_acc</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">((</span><span class="n">G</span> <span class="o">*</span> <span class="n">m_acc</span> <span class="o">*</span> <span class="n">Msun</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                        <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v_rel</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v_wind</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">lg_mdot</span>

    <span class="c1"># eq. 10 in Sen, K. ,Xu, X. -T., Langer, N., El Mellah, I. , Schurmann, C.,</span>
    <span class="c1"># Quast, M., 2021, A&amp;A</span>
    <span class="k">if</span> <span class="n">wind_disk_criteria</span><span class="p">:</span>      <span class="c1"># check if accretion disk will form</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span>           <span class="c1"># wind accretion efficiency between 1 and 1/3</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span>             <span class="c1"># for non-spinning BH</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">m</span> <span class="o">/</span> <span class="n">m_acc</span>
        <span class="n">rdisk_div_risco</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">clight</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">v_wind</span> <span class="o">/</span> <span class="n">v</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rdisk_div_risco</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">rdisk_div_risco</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>         <span class="c1"># No disk formed</span>
                <span class="n">mdot_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mf">99.0</span>

    <span class="c1"># make it Eddington-limited</span>
    <span class="n">mdot_edd</span> <span class="o">=</span> <span class="n">eddington_limit</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mdot_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">mdot_acc</span><span class="p">,</span> <span class="n">mdot_edd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mdot_acc</span><span class="p">)</span></div>



<div class="viewcode-block" id="rejection_sampler">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.rejection_sampler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rejection_sampler</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pdf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a sample from a 1d PDF using the acceptance-rejection method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array_like</span>
<span class="sd">        The x-values of the PDF.</span>
<span class="sd">    y : array_like</span>
<span class="sd">        The y-values of the PDF.</span>
<span class="sd">    size : int</span>
<span class="sd">        The number of random numbers to generate.</span>
<span class="sd">    x_lim : array float</span>
<span class="sd">        The boundary where the pdf function is defined if passed as pdf.</span>
<span class="sd">    pdf : func</span>
<span class="sd">        The pdf function</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        An array with `size` random numbers generated from the PDF.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x and y PDF values must be specified if no PDF&quot;</span>
                             <span class="s2">&quot; function is provided for rejection sampling&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">idxs</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">idxs</span><span class="p">))</span>

        <span class="n">x_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">y_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">x_rand</span><span class="p">[</span><span class="n">y_rand</span> <span class="o">&lt;=</span> <span class="n">pdf</span><span class="p">(</span><span class="n">x_rand</span><span class="p">)]</span>
        <span class="k">while</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">y_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">values</span><span class="p">,</span> <span class="n">x_rand</span><span class="p">[</span><span class="n">y_rand</span> <span class="o">&lt;=</span> <span class="n">pdf</span><span class="p">(</span><span class="n">x_rand</span><span class="p">)]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x_lim must be specified for passed PDF function&quot;</span>
                             <span class="s2">&quot; in rejection sampling&quot;</span><span class="p">)</span>
        <span class="n">x_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">pdf_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50000</span><span class="p">)))</span>
        <span class="n">y_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pdf_max</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">x_rand</span><span class="p">[</span><span class="n">y_rand</span> <span class="o">&lt;=</span> <span class="n">pdf</span><span class="p">(</span><span class="n">x_rand</span><span class="p">)]</span>
        <span class="k">while</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">y_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pdf_max</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">values</span><span class="p">,</span> <span class="n">x_rand</span><span class="p">[</span><span class="n">y_rand</span> <span class="o">&lt;=</span> <span class="n">pdf</span><span class="p">(</span><span class="n">x_rand</span><span class="p">)]])</span>

    <span class="k">return</span> <span class="n">values</span></div>



<div class="viewcode-block" id="inverse_sampler">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.inverse_sampler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">inverse_sampler</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample from a PDF using the inverse-sampling method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array-like</span>
<span class="sd">        The x-axis coordinates of the points where the PDF is defined.</span>
<span class="sd">    y : array-like</span>
<span class="sd">        The probablity density at `x` (or a scaled version of it).</span>
<span class="sd">    size : int</span>
<span class="sd">        Number of samples to generate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array</span>
<span class="sd">        The sample drawn from the PDF.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># x should be sorted</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># y should be above 0</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># compute the area of each trapezoid</span>
    <span class="n">segment_areas</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># their cumulative sum denotes the scaled CDF at each x value</span>
    <span class="n">cumsum_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">segment_areas</span><span class="p">)</span>
    <span class="n">total_area</span> <span class="o">=</span> <span class="n">cumsum_areas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># start the inverse sampling</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="c1"># index of &quot;bin&quot; where each sampled value corresponds too</span>
    <span class="n">u_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cumsum_areas</span><span class="p">,</span> <span class="n">u</span> <span class="o">*</span> <span class="n">total_area</span><span class="p">)</span>
    <span class="c1"># the area that should be covered from the end of the previous bin</span>
    <span class="n">delta_y</span> <span class="o">=</span> <span class="n">total_area</span> <span class="o">*</span> <span class="n">u</span> <span class="o">-</span> <span class="n">cumsum_areas</span><span class="p">[</span><span class="n">u_indices</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">delta_y</span><span class="p">[</span><span class="n">u_indices</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_area</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="n">u_indices</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># the width and height (of the cap) of each sample&#39;s bin</span>
    <span class="n">dx_bins</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">u_indices</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">u_indices</span><span class="p">]</span>
    <span class="n">dy_bins</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">u_indices</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">u_indices</span><span class="p">]</span>

    <span class="n">sample</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">u_indices</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx_bins</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">u_indices</span><span class="p">]</span><span class="o">**</span><span class="mf">2.0</span>
         <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">delta_y</span> <span class="o">*</span> <span class="n">dy_bins</span><span class="o">/</span><span class="n">dx_bins</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">u_indices</span><span class="p">])</span> <span class="o">/</span> <span class="n">dy_bins</span>

    <span class="c1"># if nan values found, then flat CDF for which the inverse is undefined...</span>
    <span class="n">where_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span>
    <span class="n">n_where_nan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">where_nan</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># ... in that case, simply sample randomly from each flat bin!</span>
    <span class="k">if</span> <span class="n">n_where_nan</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dy_bins</span><span class="p">[</span><span class="n">where_nan</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sample</span><span class="p">[</span><span class="n">where_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">u_indices</span><span class="p">][</span><span class="n">where_nan</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">dx_bins</span><span class="p">[</span><span class="n">where_nan</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_where_nan</span><span class="p">))</span>

    <span class="c1"># make sure that everything worked as expected</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sample</span></div>



<div class="viewcode-block" id="histogram_sampler">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.histogram_sampler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">histogram_sampler</span><span class="p">(</span><span class="n">x_edges</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample from an empirical PDF represented by a histogram.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_edges : array-like</span>
<span class="sd">        The edges of the bins of the histrogram.</span>
<span class="sd">    y : array-like</span>
<span class="sd">        The counts (or a scaled version of them) of the histogram.</span>
<span class="sd">    size : int</span>
<span class="sd">        Number of random values to produce.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array</span>
<span class="sd">        The random sample.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># make sure that the lengths of the input arrays are correct</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">n_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_edges</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># first decide which will be the bin of each element in the sample</span>
    <span class="n">bin_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">y</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

    <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># select each bin and based on its uniform distribution, decide the sample</span>
    <span class="n">bins_found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bin_sample</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">bin_index</span> <span class="ow">in</span> <span class="n">bins_found</span><span class="p">:</span>
        <span class="n">in_this_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">bin_sample</span> <span class="o">==</span> <span class="n">bin_index</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">sample</span><span class="p">[</span><span class="n">in_this_bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
            <span class="n">x_edges</span><span class="p">[</span><span class="n">bin_index</span><span class="p">],</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">bin_index</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">in_this_bin</span><span class="p">))</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span></div>



<div class="viewcode-block" id="read_histogram_from_file">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.read_histogram_from_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_histogram_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a histogram from a CSV file.</span>

<span class="sd">    The expected format is:</span>

<span class="sd">    # comment line</span>
<span class="sd">    x[0], x[1], ..., x[n], x[n+1]</span>
<span class="sd">    y[0], y[1], ..., y[n]</span>

<span class="sd">    where # denotes a comment line (also empty lines are ignored), and `n` is</span>
<span class="sd">    the number of bins (notice that the first line contains n+1 elements.)</span>

<span class="sd">    Usage: bin_edges, bin_counts = read_histogram_from_file(&quot;a_histogram.csv&quot;).</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The path of the CSV file containing the histogram information.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of arrays</span>
<span class="sd">        The bin edges and bin counts of the histogram.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;More than two lines found in the histogram&quot;</span>
                                 <span class="s2">&quot; document.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Less than two lines found in the histogram&quot;</span>
                         <span class="s2">&quot; document.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;The number of elements in the second data line is&quot;</span>
                         <span class="s2">&quot; not one less than the number in the first data&quot;</span>
                         <span class="s2">&quot; line.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">arrays</span></div>



<div class="viewcode-block" id="inspiral_timescale_from_separation">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.inspiral_timescale_from_separation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">inspiral_timescale_from_separation</span><span class="p">(</span><span class="n">star1_mass</span><span class="p">,</span> <span class="n">star2_mass</span><span class="p">,</span>
                                       <span class="n">separation</span><span class="p">,</span> <span class="n">eccentricity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the timescale of GW inspiral using the orbital separation.</span>

<span class="sd">    Based on [1]_:</span>
<span class="sd">        https://journals.aps.org/pr/abstract/10.1103/PhysRev.136.B1224</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    star1_mass : float</span>
<span class="sd">        Mass of star 1 in Msun.</span>
<span class="sd">    star2_mass : float</span>
<span class="sd">        Mass of star 2 in Msun.</span>
<span class="sd">    separation : type</span>
<span class="sd">        Binary separation in Rsun.</span>
<span class="sd">    eccentricity : type</span>
<span class="sd">        Eccentricity of the binary orbit. Must be 0 &lt;= ecc &lt;1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The inspiral time scale of the two black holes.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Peters 1964 Phys. Rev. 136, B1224</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE we should check that this matches up with Maggiori equations</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">clight</span>
    <span class="n">Msun</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
    <span class="n">Rsun</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">Rsun</span>
    <span class="n">secyer</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">secyer</span>

    <span class="n">m1</span> <span class="o">=</span> <span class="n">star1_mass</span> <span class="o">*</span> <span class="n">Msun</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">star2_mass</span> <span class="o">*</span> <span class="n">Msun</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">separation</span> <span class="o">*</span> <span class="n">Rsun</span>
    <span class="n">ecc</span> <span class="o">=</span> <span class="n">eccentricity</span>

    <span class="k">if</span> <span class="n">m1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mass of star 1 is &lt;= 0, which is not a physical value.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mass of star 2 is &lt;= 0, which is not a physical value.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Separation is &lt;= 0, which is not a physical value.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ecc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Eccentricity is &lt; 0, which is not a physical value.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ecc</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Eccentricity is &gt;= 1, which is not a physical value.&quot;</span><span class="p">)</span>

    <span class="c1"># Eq. (5.9) in Peters 1964 Phys. Rev. 136, B1224</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">64.0</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">G</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">m1</span> <span class="o">*</span> <span class="n">m2</span> <span class="o">*</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ecc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Eq. (5.10) in Peters 1964 Phys. Rev. 136, B1224</span>
        <span class="n">T_merger</span> <span class="o">=</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Eq. (5.11) at e_0, i.e. a_0 = a(e_0), solved for c_0 in</span>
        <span class="c1"># Peters 1964 Phys. Rev. 136, B1224</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">c_0</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">a0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">e0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">12.0</span> <span class="o">/</span> <span class="mi">19</span><span class="p">))</span>
                    <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">121.0</span> <span class="o">/</span> <span class="mi">304</span><span class="p">)</span> <span class="o">*</span> <span class="n">e0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">870.0</span> <span class="o">/</span> <span class="mi">2299</span><span class="p">))</span>

        <span class="n">c0</span> <span class="o">=</span> <span class="n">c_0</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ecc</span><span class="p">)</span>

        <span class="c1"># Eq. (5.14)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">integrand</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">e</span><span class="o">**</span><span class="p">(</span><span class="mf">29.</span> <span class="o">/</span> <span class="mi">19</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">121.</span> <span class="o">/</span> <span class="mi">304</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1181.0</span> <span class="o">/</span> <span class="mi">2299</span><span class="p">)</span>
                    <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># assume binary circularizes by the time it merges</span>
        <span class="n">T_merger</span> <span class="o">=</span> <span class="p">(</span><span class="mf">12.0</span> <span class="o">/</span> <span class="mi">19</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">c0</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">quad</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">ecc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># return T_merge in Myr</span>
    <span class="k">return</span> <span class="n">T_merger</span> <span class="o">/</span> <span class="p">(</span><span class="n">secyer</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span></div>



<div class="viewcode-block" id="inspiral_timescale_from_orbital_period">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.inspiral_timescale_from_orbital_period">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">inspiral_timescale_from_orbital_period</span><span class="p">(</span><span class="n">star1_mass</span><span class="p">,</span> <span class="n">star2_mass</span><span class="p">,</span>
                                           <span class="n">orbital_period</span><span class="p">,</span> <span class="n">eccentricity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the timescale of GW inspiral using the orbital period.</span>

<span class="sd">    Based on [1]_:</span>
<span class="sd">        https://journals.aps.org/pr/abstract/10.1103/PhysRev.136.B1224</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    star1_mass : float</span>
<span class="sd">        Mass of star 1 in Msun.</span>
<span class="sd">    star2_mass : float</span>
<span class="sd">        Mass of star 2 in Msun.</span>
<span class="sd">    orbital_separation : type</span>
<span class="sd">        Binary separation in Rsun.</span>
<span class="sd">    eccentricity : type</span>
<span class="sd">        Eccentricity of the binary orbit. Must be 0 &lt;= ecc &lt;1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The inspiral time scale of the two black holes in Myr.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Peters 1964 Phys. Rev. 136, B1224</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE we should check that this matches up with Maggiori equations</span>
    <span class="n">separation</span> <span class="o">=</span> <span class="n">orbital_separation_from_period</span><span class="p">(</span><span class="n">orbital_period</span><span class="p">,</span> <span class="n">star1_mass</span><span class="p">,</span>
                                                <span class="n">star2_mass</span><span class="p">)</span>
    <span class="n">T_merge</span> <span class="o">=</span> <span class="n">inspiral_timescale_from_separation</span><span class="p">(</span><span class="n">star1_mass</span><span class="p">,</span> <span class="n">star2_mass</span><span class="p">,</span>
                                                 <span class="n">separation</span><span class="p">,</span> <span class="n">eccentricity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">T_merge</span></div>



<div class="viewcode-block" id="spin_stable_mass_transfer">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.spin_stable_mass_transfer">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spin_stable_mass_transfer</span><span class="p">(</span><span class="n">spin_i</span><span class="p">,</span> <span class="n">star_mass_preMT</span><span class="p">,</span> <span class="n">star_mass_postMT</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the spin of an accreting BH under stable mass transfer.</span>

<span class="sd">    Based on Thorne 1974 eq. 2a.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">star_mass_preMT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">star_mass_preMT</span><span class="o">&lt;=</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">star_mass_postMT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">star_mass_postMT</span><span class="o">&lt;=</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">spin_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">spin_i</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">spin_i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">spin_i</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">spin_i</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">spin_i</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">z1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">r_isco</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">z2</span> <span class="o">-</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">z1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">z1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">z2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">star_mass_postMT</span> <span class="o">/</span> <span class="n">star_mass_preMT</span>
            <span class="ow">and</span> <span class="n">star_mass_postMT</span> <span class="o">/</span> <span class="n">star_mass_preMT</span> <span class="o">&lt;=</span> <span class="n">r_isco</span><span class="o">**</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">spin</span> <span class="o">=</span> <span class="n">r_isco</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">star_mass_preMT</span> <span class="o">/</span> <span class="n">star_mass_postMT</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">r_isco</span> <span class="o">*</span> <span class="n">star_mass_preMT</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">star_mass_postMT</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">star_mass_postMT</span> <span class="o">/</span> <span class="n">star_mass_preMT</span> <span class="o">&gt;</span> <span class="n">r_isco</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">spin</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">spin</span></div>



<div class="viewcode-block" id="check_state_of_star">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.check_state_of_star">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_state_of_star</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">star_CO</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the state of a SingleStar.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    star: SingleStar</span>
<span class="sd">        The star for which the state will be computed.</span>
<span class="sd">    i : integer</span>
<span class="sd">        Index of the model for which we want to calculate the state of the</span>
<span class="sd">        SingleStar object. Default = -1 (the final).</span>
<span class="sd">    star_CO: bool</span>
<span class="sd">        True if we want to assume a compact object (WD/NS/BH).</span>
<span class="sd">        False if the state will be calculated by its attributes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    state : str</span>
<span class="sd">        state at of the star object at index i of the history.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">star_CO</span><span class="p">:</span>
        <span class="n">star_mass</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">mass_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span>
        <span class="k">if</span> <span class="s1">&#39;WD&#39;</span> <span class="o">==</span> <span class="n">star</span><span class="o">.</span><span class="n">state_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">star</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;WD&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;WD&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">infer_star_state</span><span class="p">(</span><span class="n">star_mass</span><span class="o">=</span><span class="n">star_mass</span><span class="p">,</span> <span class="n">star_CO</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">star_mass</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span>
        <span class="n">surface_h1</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">surface_h1</span>
        <span class="n">center_h1</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">center_h1</span>
        <span class="n">center_he4</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">center_he4</span>
        <span class="n">center_c12</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">center_c12</span>
        <span class="n">log_LH</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">log_LH</span>
        <span class="n">log_LHe</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">log_LHe</span>
        <span class="n">log_Lnuc</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">log_Lnuc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">star_mass</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">mass_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">surface_h1</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">surface_h1_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">center_h1</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">center_h1_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">center_he4</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">center_he4_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">center_c12</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">center_c12_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">log_LH</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">log_LH_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">log_LHe</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">log_LHe_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">log_Lnuc</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">log_Lnuc_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">infer_star_state</span><span class="p">(</span><span class="n">star_mass</span><span class="o">=</span><span class="n">star_mass</span><span class="p">,</span>
                            <span class="n">surface_h1</span><span class="o">=</span><span class="n">surface_h1</span><span class="p">,</span>
                            <span class="n">center_h1</span><span class="o">=</span><span class="n">center_h1</span><span class="p">,</span>
                            <span class="n">center_he4</span><span class="o">=</span><span class="n">center_he4</span><span class="p">,</span>
                            <span class="n">center_c12</span><span class="o">=</span><span class="n">center_c12</span><span class="p">,</span>
                            <span class="n">log_LH</span><span class="o">=</span><span class="n">log_LH</span><span class="p">,</span>
                            <span class="n">log_LHe</span><span class="o">=</span><span class="n">log_LHe</span><span class="p">,</span>
                            <span class="n">log_Lnuc</span><span class="o">=</span><span class="n">log_Lnuc</span><span class="p">,</span>
                            <span class="n">star_CO</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_state_of_star_history_array">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.check_state_of_star_history_array">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_state_of_star_history_array</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">star_CO</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the evolutionary states with an array of history data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    star : SingleStar</span>
<span class="sd">        The star for which the state will be computed.</span>
<span class="sd">    N : int</span>
<span class="sd">        Number of history steps (from the end), to calculate the state.</span>
<span class="sd">    star_CO : bool</span>
<span class="sd">        If `True`, assume it&#39;s a compact object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of str</span>
<span class="sd">        The state(s) in a list.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">check_state_of_star</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">star_CO</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span></div>



<div class="viewcode-block" id="get_binary_state_and_event_and_mt_case">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.get_binary_state_and_event_and_mt_case">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_binary_state_and_event_and_mt_case</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">interpolation_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infer the binary state, event and mass transfer case.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    binary : BinaryStar</span>
<span class="sd">        The POSYDON binary star.</span>
<span class="sd">    i : int</span>
<span class="sd">        The index of the history in which we want to calculate the state of the</span>
<span class="sd">        binary object. Default (None) is the current state.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    binary_state : str</span>
<span class="sd">        One of &#39;detached&#39;, &#39;contact&#39;, &#39;RLO1&#39; and &#39;RLO2&#39;.</span>

<span class="sd">    binary_event : str</span>
<span class="sd">        Options are &#39;oRLO1&#39; or &#39;oRLO2&#39; (onset of RLO, the start of RLO),</span>
<span class="sd">        &#39;oCE1&#39;, &#39;oCE2&#39;, &#39;oDoubleCE1&#39;, &#39;oDoubleCE2&#39;, &#39;CC1&#39;, &#39;CC2&#39;.</span>

<span class="sd">    mass transfer case : str</span>
<span class="sd">        &#39;caseA&#39;, &#39;caseB&#39;, etc.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    If &#39;detached&#39; then returns [&#39;detached&#39;, None, None].</span>

<span class="sd">    If &#39;contact&#39; then returns [&#39;contact&#39;, None] or [&#39;oCE1&#39;, &#39;oDoubleCE1&#39;] or</span>
<span class="sd">    [&#39;oDoubleCE2&#39;,  None].</span>

<span class="sd">    If RLO then returns either [&#39;RLO1&#39;,  None, &#39;caseXX&#39;] or</span>
<span class="sd">    [&#39;RLO2&#39;,  None, &#39;caseXX&#39;] or maybe [&#39;RLO2&#39;,  &#39;oRLO2&#39;, &#39;caseXX&#39;].</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initializing: [&#39;binary_state&#39;,&#39;binary_event&#39;,&#39;MT_case&#39;]</span>
    <span class="k">if</span> <span class="n">binary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">interpolation_class</span> <span class="o">==</span> <span class="s1">&#39;not_converged&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">interpolation_class</span> <span class="o">==</span> <span class="s1">&#39;initial_MT&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;initial_RLOF&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lg_mtransfer</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">lg_mtransfer_rate</span>
        <span class="n">rl_overflow1</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">rl_relative_overflow_1</span>
        <span class="n">rl_overflow2</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">rl_relative_overflow_2</span>
        <span class="n">state1</span><span class="p">,</span> <span class="n">state2</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state</span>
        <span class="n">gamma1</span><span class="p">,</span> <span class="n">gamma2</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">center_gamma</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">center_gamma</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lg_mtransfer</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">lg_mtransfer_rate_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rl_overflow1</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">rl_relative_overflow_1_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rl_overflow2</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">rl_relative_overflow_2_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">state1</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">state_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">state2</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">state_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gamma1</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="o">.</span><span class="n">center_gamma_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># this happens if compact object</span>
            <span class="n">gamma1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gamma2</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="o">.</span><span class="n">center_gamma_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># this happens if compact object</span>
            <span class="n">gamma2</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># get numerical MT cases</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">rl_overflow1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rl_overflow2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="n">dominating_star1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rl_overflow1</span> <span class="o">&gt;=</span> <span class="n">rl_overflow2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rl_overflow2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dominating_star1</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dominating_star1</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mt_flag_1</span> <span class="o">=</span> <span class="n">infer_mass_transfer_case</span><span class="p">(</span><span class="n">rl_overflow1</span><span class="p">,</span> <span class="n">lg_mtransfer</span><span class="p">,</span> <span class="n">state1</span><span class="p">,</span>
                                         <span class="n">dominating_star</span><span class="o">=</span><span class="n">dominating_star1</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">mt_flag_2</span> <span class="o">=</span> <span class="n">infer_mass_transfer_case</span><span class="p">(</span><span class="n">rl_overflow2</span><span class="p">,</span> <span class="n">lg_mtransfer</span><span class="p">,</span> <span class="n">state2</span><span class="p">,</span>
                                         <span class="n">dominating_star</span><span class="o">=</span><span class="ow">not</span> <span class="n">dominating_star1</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="c1"># convert to strings</span>
    <span class="n">mt_flag_1_str</span> <span class="o">=</span> <span class="n">cumulative_mass_transfer_string</span><span class="p">([</span><span class="n">mt_flag_1</span><span class="p">])</span>
    <span class="n">mt_flag_2_str</span> <span class="o">=</span> <span class="n">cumulative_mass_transfer_string</span><span class="p">([</span><span class="n">mt_flag_2</span><span class="o">+</span><span class="mi">10</span> <span class="k">if</span> <span class="n">mt_flag_2</span>\
                    <span class="ow">in</span> <span class="n">ALL_RLO_CASES</span> <span class="k">else</span> <span class="n">mt_flag_2</span><span class="p">])</span>

    <span class="n">rlof1</span> <span class="o">=</span> <span class="n">mt_flag_1</span> <span class="ow">in</span> <span class="n">ALL_RLO_CASES</span>
    <span class="n">rlof2</span> <span class="o">=</span> <span class="n">mt_flag_2</span> <span class="ow">in</span> <span class="n">ALL_RLO_CASES</span>
    <span class="n">no_rlof</span> <span class="o">=</span> <span class="p">(</span><span class="n">mt_flag_1</span> <span class="o">==</span> <span class="n">MT_CASE_NO_RLO</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mt_flag_2</span> <span class="o">==</span> <span class="n">MT_CASE_NO_RLO</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rlof1</span> <span class="ow">and</span> <span class="n">rlof2</span><span class="p">:</span>                             <span class="c1"># contact condition</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">interpolation_class</span> <span class="o">==</span> <span class="s1">&#39;unstable_MT&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rl_overflow1</span><span class="o">&gt;=</span><span class="n">rl_overflow2</span><span class="p">:</span>           <span class="c1"># star 1 initiated CE</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="s1">&#39;oCE1&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span>
                <span class="c1"># Check for double CE</span>
                <span class="n">comp_star</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_2</span>
                <span class="k">if</span> <span class="n">comp_star</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;H-rich_Core_H_burning&quot;</span><span class="p">,</span>
                                           <span class="s2">&quot;stripped_He_Core_He_burning&quot;</span><span class="p">,</span> <span class="s2">&quot;WD&quot;</span><span class="p">,</span>
                                           <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;BH&quot;</span><span class="p">]:</span>
                    <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;oDoubleCE1&quot;</span>
            <span class="k">else</span><span class="p">:</span>                                   <span class="c1"># star 2 initiated CE</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="s1">&#39;oCE2&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span>
                <span class="c1"># Check for double CE</span>
                <span class="n">comp_star</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">star_1</span>
                <span class="k">if</span> <span class="n">comp_star</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;H-rich_Core_H_burning&quot;</span><span class="p">,</span>
                                           <span class="s2">&quot;stripped_He_Core_He_burning&quot;</span><span class="p">,</span> <span class="s2">&quot;WD&quot;</span><span class="p">,</span>
                                           <span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="s2">&quot;BH&quot;</span><span class="p">]:</span>
                    <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;oDoubleCE2&quot;</span>
            <span class="k">return</span> <span class="n">result</span>
    <span class="k">elif</span> <span class="n">no_rlof</span><span class="p">:</span>                                   <span class="c1"># no MT in any star</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;detached&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rlof1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rlof2</span><span class="p">:</span>                       <span class="c1"># only in star 1</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RLO1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mt_flag_1_str</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">interpolation_class</span> <span class="o">==</span> <span class="s1">&#39;unstable_MT&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;RLO1&#39;</span><span class="p">,</span> <span class="s1">&#39;oCE1&#39;</span><span class="p">,</span> <span class="n">mt_flag_1_str</span><span class="p">]</span>
        <span class="c1"># if prev_state not in ALL_RLO_CASES:</span>
        <span class="c1">#    return [&#39;RLO1&#39;, &#39;oRLO1&#39;, mt_flag_1_str]</span>
    <span class="k">elif</span> <span class="n">rlof2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rlof1</span><span class="p">:</span>                       <span class="c1"># only in star 2</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RLO2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mt_flag_2_str</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">interpolation_class</span> <span class="o">==</span> <span class="s1">&#39;unstable_MT&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;RLO2&#39;</span><span class="p">,</span> <span class="s1">&#39;oCE2&#39;</span><span class="p">,</span> <span class="n">mt_flag_2_str</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>                                           <span class="c1"># undetermined in any star</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;undefined&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Central_C_depletion&quot;</span> <span class="ow">in</span> <span class="n">state1</span>
            <span class="ow">or</span> <span class="s2">&quot;Central_He_depleted&quot;</span> <span class="ow">in</span> <span class="n">state1</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">gamma1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gamma1</span> <span class="o">&gt;=</span> <span class="mf">10.0</span><span class="p">)):</span>    <span class="c1"># WD formation</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CC1&quot;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;Central_C_depletion&quot;</span> <span class="ow">in</span> <span class="n">state2</span>
          <span class="ow">or</span> <span class="s2">&quot;Central_He_depleted&quot;</span> <span class="ow">in</span> <span class="n">state2</span>
          <span class="ow">or</span> <span class="p">(</span><span class="n">gamma2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gamma2</span> <span class="o">&gt;=</span> <span class="mf">10.0</span><span class="p">)):</span>      <span class="c1"># WD formation</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CC2&quot;</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="get_binary_state_and_event_and_mt_case_array">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.get_binary_state_and_event_and_mt_case_array">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_binary_state_and_event_and_mt_case_array</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the evolutionary states with an array of history data.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    binary: POSYDON BinaryStar object</span>
<span class="sd">    N : array</span>
<span class="sd">        index of the history in which we want to calculate the state of the</span>
<span class="sd">        SingleStar object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    binary_state : str(see in check_state_of_star)</span>
<span class="sd">    binary_event :</span>
<span class="sd">    MT_case :</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>               <span class="c1"># focus on current evolutonary state</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">get_binary_state_and_event_and_mt_case</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">binary_state</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">binary_event</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">MT_case</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">binary_state</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">binary_event</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">MT_case</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">get_binary_state_and_event_and_mt_case</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                                                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">binary_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">binary_event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">MT_case</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">binary_state</span><span class="p">,</span> <span class="n">binary_event</span><span class="p">,</span> <span class="n">MT_case</span></div>



<div class="viewcode-block" id="CO_radius">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.CO_radius">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">CO_radius</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">COtype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the radius of a compact object based on its type and mass.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M : float</span>
<span class="sd">        CO mass in Msun</span>
<span class="sd">    COtype : str</span>
<span class="sd">        Tyep of compact object. Accepted values: &quot;BH&quot;, &quot;NS&quot;, &quot;WD&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Compact object radius in solar radii</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">M</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Compact object mass must be a positive value&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">COtype</span> <span class="o">==</span> <span class="s2">&quot;BH&quot;</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">Schwarzschild_Radius</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">COtype</span> <span class="o">==</span> <span class="s2">&quot;NS&quot;</span><span class="p">:</span>
        <span class="c1"># Some references:</span>
        <span class="c1"># Most, E. R., Weih, L. R., Rezzolla, L., &amp; Schaffner-Bielich, J. 2018,</span>
        <span class="c1">#   PhRvL, 120, 261103</span>
        <span class="c1"># Abbott, B. P., Abbott, R., Abbott, T. D., et al. 2020, ApJL, 892, L3</span>
        <span class="c1"># Landry, P., Essick, R., &amp; Chatziioannou, K. 2020, PhRvD, 101, 123007</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mf">12.5e5</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">Rsun</span>
    <span class="k">elif</span> <span class="n">COtype</span> <span class="o">==</span> <span class="s2">&quot;WD&quot;</span><span class="p">:</span>
        <span class="c1"># Hansen C. J., Kawaler S. D., Trimble V., 2004,</span>
        <span class="c1">#   Stellar Interiors. Springer New York</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mf">2.9e8</span><span class="o">*</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">Rsun</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;COtype not in the list of valid options: &quot;BH&quot;, &quot;NS&quot;, &quot;WD&quot;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">R</span></div>



<div class="viewcode-block" id="He_MS_lifetime">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.He_MS_lifetime">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">He_MS_lifetime</span><span class="p">(</span><span class="n">mass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the lifetime of He burning in a star.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mass : type</span>
<span class="sd">        Mass of star in solar masses</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        He MS time duration in yr.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mass</span> <span class="o">&lt;=</span><span class="mf">0.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too low mass: </span><span class="si">{</span><span class="n">mass</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mass</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>
        <span class="n">he_t_ms</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span>
    <span class="k">elif</span> <span class="n">mass</span> <span class="o">&gt;=</span> <span class="mf">2.0</span> <span class="ow">and</span> <span class="n">mass</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">:</span>
        <span class="n">he_t_ms</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.6094</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span> <span class="o">+</span> <span class="mf">8.7855</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mass</span> <span class="o">&gt;=</span> <span class="mf">10.0</span> <span class="ow">and</span> <span class="n">mass</span> <span class="o">&lt;</span> <span class="mf">100.0</span><span class="p">:</span>
        <span class="n">he_t_ms</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.69897</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span> <span class="o">+</span> <span class="mf">6.875</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># mass &gt;= 100.0</span>
        <span class="n">he_t_ms</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span>
    <span class="k">return</span> <span class="n">he_t_ms</span></div>



<div class="viewcode-block" id="Schwarzschild_Radius">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.Schwarzschild_Radius">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Schwarzschild_Radius</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the Schwarzschild Radius of BH with mass M.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M : float</span>
<span class="sd">        BH mass in Msun</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Schwarzschild Radius in solar radii</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">clight</span>
    <span class="n">Rsun</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">Rsun</span>
    <span class="n">Msun</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span>

    <span class="c1"># Kutner, M. L. 2003, Astronomy: A physical perspective,</span>
    <span class="c1">#   Cambridge University Press</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">M</span> <span class="o">*</span> <span class="n">Msun</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Rsun</span><span class="p">))</span></div>



<div class="viewcode-block" id="flip_stars">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.flip_stars">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flip_stars</span><span class="p">(</span><span class="n">binary</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    binary : type</span>
<span class="sd">        Description of parameter `binary`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        Description of returned object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">star_1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_1</span><span class="p">)</span>
    <span class="n">star_2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">star_2</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;star_1&#39;</span><span class="p">,</span> <span class="n">star_2</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;star_2&#39;</span><span class="p">,</span> <span class="n">star_1</span><span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;RLO1&#39;</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;RLO2&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;RLO2&#39;</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;RLO1&#39;</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;oRLO1&#39;</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;oRLO2&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;oRLO2&#39;</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;oRLO1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;oCE1&#39;</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;oCE2&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;oCE2&#39;</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;oCE1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;CC1&#39;</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;CC2&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;CC2&#39;</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;CC1&#39;</span><span class="p">)</span>

    <span class="n">state_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;state_history&#39;</span><span class="p">))</span>
    <span class="n">cond_RLO2</span> <span class="o">=</span> <span class="n">state_history</span> <span class="o">==</span> <span class="s1">&#39;RLO1&#39;</span>
    <span class="n">cond_RLO1</span> <span class="o">=</span> <span class="n">state_history</span> <span class="o">==</span> <span class="s1">&#39;RLO2&#39;</span>
    <span class="n">state_history</span><span class="p">[</span><span class="n">cond_RLO2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RLO2&#39;</span>
    <span class="n">state_history</span><span class="p">[</span><span class="n">cond_RLO1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RLO1&#39;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;state_history&#39;</span><span class="p">,</span> <span class="n">state_history</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="n">event_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;event_history&#39;</span><span class="p">))</span>
    <span class="n">cond_CC2</span> <span class="o">=</span> <span class="n">event_history</span> <span class="o">==</span> <span class="s1">&#39;CC1&#39;</span>
    <span class="n">cond_CC1</span> <span class="o">=</span> <span class="n">event_history</span> <span class="o">==</span> <span class="s1">&#39;CC2&#39;</span>
    <span class="n">event_history</span><span class="p">[</span><span class="n">cond_CC2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CC2&#39;</span>
    <span class="n">event_history</span><span class="p">[</span><span class="n">cond_CC1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CC1&#39;</span>
    <span class="n">cond_oRLO2</span> <span class="o">=</span> <span class="n">event_history</span> <span class="o">==</span> <span class="s1">&#39;oRLO1&#39;</span>
    <span class="n">cond_oRLO1</span> <span class="o">=</span> <span class="n">event_history</span> <span class="o">==</span> <span class="s1">&#39;oRLO2&#39;</span>
    <span class="n">event_history</span><span class="p">[</span><span class="n">cond_oRLO2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;oRLO2&#39;</span>
    <span class="n">event_history</span><span class="p">[</span><span class="n">cond_oRLO1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;oRLO1&#39;</span>
    <span class="n">cond_oCE2</span> <span class="o">=</span> <span class="n">event_history</span> <span class="o">==</span> <span class="s1">&#39;oCE1&#39;</span>
    <span class="n">cond_oCE1</span> <span class="o">=</span> <span class="n">event_history</span> <span class="o">==</span> <span class="s1">&#39;oCE2&#39;</span>
    <span class="n">event_history</span><span class="p">[</span><span class="n">cond_oCE2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;oCE2&#39;</span>
    <span class="n">event_history</span><span class="p">[</span><span class="n">cond_oCE1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;oCE1&#39;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s1">&#39;event_history&#39;</span><span class="p">,</span> <span class="n">event_history</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;t_sync_rad_&#39;</span><span class="p">,</span> <span class="s1">&#39;t_sync_conv_&#39;</span><span class="p">,</span> <span class="s1">&#39;rl_relative_overflow_&#39;</span><span class="p">]:</span>

        <span class="n">value1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">value2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
        <span class="n">value1_history</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;1_history&#39;</span><span class="p">)</span>
        <span class="n">value2_history</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;2_history&#39;</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">value2</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;1_history&#39;</span><span class="p">,</span> <span class="n">value2_history</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;2_history&#39;</span><span class="p">,</span> <span class="n">value1_history</span><span class="p">)</span></div>



<div class="viewcode-block" id="set_binary_to_failed">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.set_binary_to_failed">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_binary_to_failed</span><span class="p">(</span><span class="n">binary</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Set the properties of the binary to indicate that it has failed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    binary : BinaryStar</span>
<span class="sd">        The binary to set to failed.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">binary</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;ERR&quot;</span>
    <span class="n">binary</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span></div>



<div class="viewcode-block" id="infer_star_state">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.infer_star_state">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">infer_star_state</span><span class="p">(</span><span class="n">star_mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surface_h1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">center_h1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">center_he4</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">center_c12</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">log_LH</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_LHe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_Lnuc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">star_CO</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infer the star state (corresponding to termination flags 2 and 3).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">star_CO</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">star_mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">star_mass</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s2">&quot;massless_remnant&quot;</span>
        <span class="k">elif</span> <span class="p">((((</span><span class="n">surface_h1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">surface_h1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span> <span class="ow">or</span>
               <span class="p">((</span><span class="n">center_h1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">center_h1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span> <span class="ow">or</span>
               <span class="p">((</span><span class="n">center_he4</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">center_he4</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span> <span class="ow">or</span>
               <span class="p">((</span><span class="n">center_c12</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">center_c12</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span> <span class="ow">or</span>
               <span class="p">(</span><span class="n">star_mass</span> <span class="o">&lt;</span> <span class="n">STATE_NS_STARMASS_LOWER_LIMIT</span><span class="p">))</span> <span class="ow">and</span>
              <span class="p">(</span><span class="n">star_mass</span> <span class="o">&lt;=</span> <span class="n">STATE_WD_STARMASS_UPPER_LIMIT</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s2">&quot;WD&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">star_mass</span> <span class="o">&lt;=</span> <span class="n">STATE_NS_STARMASS_UPPER_LIMIT</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;NS&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;BH&quot;</span>

    <span class="k">if</span> <span class="n">surface_h1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">STATE_UNDETERMINED</span>

    <span class="n">rich_in</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;H-rich&quot;</span> <span class="k">if</span> <span class="n">surface_h1</span> <span class="o">&gt;</span> <span class="n">THRESHOLD_HE_NAKED_ABUNDANCE</span>
               <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;accreted_He&quot;</span> <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">surface_h1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">round</span><span class="p">(</span><span class="n">center_h1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
               <span class="k">else</span> <span class="s2">&quot;stripped_He&quot;</span><span class="p">))</span>
    <span class="n">burning_H</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_LH</span> <span class="o">&gt;</span> <span class="n">LOG10_BURNING_THRESHOLD</span>
                 <span class="ow">and</span> <span class="n">log_LH</span> <span class="o">-</span> <span class="n">log_Lnuc</span> <span class="o">&gt;</span> <span class="n">REL_LOG10_BURNING_THRESHOLD</span><span class="p">)</span>
    <span class="n">burning_He</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_LHe</span> <span class="o">&gt;</span> <span class="n">LOG10_BURNING_THRESHOLD</span>
                  <span class="ow">and</span> <span class="n">log_LHe</span> <span class="o">-</span> <span class="n">log_Lnuc</span> <span class="o">&gt;</span> <span class="n">REL_LOG10_BURNING_THRESHOLD</span><span class="p">)</span>

    <span class="n">H_in_core</span> <span class="o">=</span> <span class="n">center_h1</span> <span class="o">&gt;</span> <span class="n">THRESHOLD_CENTRAL_ABUNDANCE</span>
    <span class="n">He_in_core</span> <span class="o">=</span> <span class="n">center_he4</span> <span class="o">&gt;</span> <span class="n">THRESHOLD_CENTRAL_ABUNDANCE</span>
    <span class="n">C_in_core</span> <span class="o">=</span> <span class="n">center_c12</span> <span class="o">&gt;</span> <span class="n">THRESHOLD_CENTRAL_ABUNDANCE</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">H_in_core</span> <span class="ow">or</span> <span class="n">He_in_core</span><span class="p">):</span>   <span class="c1"># H and He are depleted</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">C_in_core</span><span class="p">:</span>
            <span class="n">burning</span> <span class="o">=</span> <span class="s2">&quot;Central_C_depletion&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">burning</span> <span class="o">=</span> <span class="s2">&quot;Central_He_depleted&quot;</span>
        <span class="c1"># from now on, either H or He in core</span>
    <span class="k">elif</span> <span class="n">H_in_core</span><span class="p">:</span>                     <span class="c1"># no matter what the He abundance is</span>
        <span class="k">if</span> <span class="n">burning_H</span><span class="p">:</span>
            <span class="n">burning</span> <span class="o">=</span> <span class="s2">&quot;Core_H_burning&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">burning</span> <span class="o">=</span> <span class="s2">&quot;non_burning&quot;</span>
    <span class="k">else</span><span class="p">:</span>                               <span class="c1"># from now on: only He, not H in core</span>
        <span class="k">if</span> <span class="n">burning_He</span><span class="p">:</span>
            <span class="n">burning</span> <span class="o">=</span> <span class="s2">&quot;Core_He_burning&quot;</span>
        <span class="k">elif</span> <span class="n">burning_H</span><span class="p">:</span>
            <span class="n">burning</span> <span class="o">=</span> <span class="s2">&quot;Shell_H_burning&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">burning</span> <span class="o">=</span> <span class="s2">&quot;non_burning&quot;</span>
        
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rich_in</span><span class="p">,</span> <span class="n">burning</span><span class="p">)</span></div>



<div class="viewcode-block" id="infer_mass_transfer_case">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.infer_mass_transfer_case">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">infer_mass_transfer_case</span><span class="p">(</span><span class="n">rl_relative_overflow</span><span class="p">,</span>
                             <span class="n">lg_mtransfer_rate</span><span class="p">,</span>
                             <span class="n">donor_state</span><span class="p">,</span>
                             <span class="n">dominating_star</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infer the mass-transfer case of a given star.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rl_relative_overflow : float</span>
<span class="sd">        Relative Roche lobe overflowing parameter.</span>
<span class="sd">    lg_mtransfer_rate : float</span>
<span class="sd">        The mass transfer rate in log_10.</span>
<span class="sd">    donor_state : str</span>
<span class="sd">        Values of star parameters at a specific step.</span>
<span class="sd">    dominating_star : bool (default: True)</span>
<span class="sd">        Whether this star is the orgin of the mass transfer rate.</span>
<span class="sd">    verbose : bool (default: False)</span>
<span class="sd">        In case we want additional information printed to standard output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The mass-transfer case integer flag.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rl_relative_overflow</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lg_mtransfer_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MT_CASE_NO_RLO</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">rl_relative_overflow</span> <span class="o">&lt;=</span> <span class="n">RL_RELATIVE_OVERFLOW_THRESHOLD</span><span class="p">)</span> <span class="ow">and</span>
        <span class="p">((</span><span class="n">lg_mtransfer_rate</span> <span class="o">&lt;=</span> <span class="n">LG_MTRANSFER_RATE_THRESHOLD</span><span class="p">)</span> <span class="ow">or</span>
         <span class="p">(</span><span class="ow">not</span> <span class="n">dominating_star</span><span class="p">))):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;checking rl_relative_overflow / lg_mtransfer_rate,&quot;</span><span class="p">,</span>
                  <span class="n">rl_relative_overflow</span><span class="p">,</span> <span class="n">lg_mtransfer_rate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MT_CASE_NO_RLO</span>

    <span class="k">if</span> <span class="s2">&quot;non_burning&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MT_CASE_NONBURNING</span>
    <span class="k">elif</span> <span class="s2">&quot;H-rich&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;Core_H_burning&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MT_CASE_A</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Core_He_burning&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span>
                <span class="ow">or</span> <span class="s2">&quot;Shell_H_burning&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">MT_CASE_B</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Central_He_depleted&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span>
                <span class="ow">or</span> <span class="s2">&quot;Central_C_depletion&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">MT_CASE_C</span>
    <span class="k">elif</span> <span class="s2">&quot;stripped_He&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;Core_He_burning&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MT_CASE_BA</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Central_He_depleted&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span>
                <span class="ow">or</span> <span class="s2">&quot;Central_C_depletion&quot;</span> <span class="ow">in</span> <span class="n">donor_state</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">MT_CASE_BB</span>
    <span class="k">return</span> <span class="n">MT_CASE_UNDETERMINED</span></div>



<div class="viewcode-block" id="cumulative_mass_transfer_numeric">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.cumulative_mass_transfer_numeric">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cumulative_mass_transfer_numeric</span><span class="p">(</span><span class="n">MT_cases</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Summarize the history of MT cases in a short list of integers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    MT_cases : array-like</span>
<span class="sd">        A list of the integer MT flags at sequential history steps. If the</span>
<span class="sd">        cases are instead given in string format they are converted first.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of int</span>
<span class="sd">        A shorter list of integer MT flags, following these rules:</span>
<span class="sd">        i.   If undetermined MT at any step, it is indicated in the beginning</span>
<span class="sd">             (as a warning) and ignored later.</span>
<span class="sd">        ii.  If no RLO anywhere, then this is the only element in the returned</span>
<span class="sd">             list (or the second if undetermined MT at any step). Intermediate</span>
<span class="sd">             no-RLO phases (between RLO cases) are ignored.</span>
<span class="sd">        iii. Consequent same cases are reported only once (e.g., A, A, A -&gt; A.)</span>

<span class="sd">    The end result is a list of integers indicating whether undetermined MT</span>
<span class="sd">    anywhere, if no RLO everywhere, or &quot;changes&quot; of MT cases.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">MT_cases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">MT_CASE_UNDETERMINED</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">MT_cases</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="n">MT_STR_TO_CASE</span><span class="p">[</span><span class="n">case</span><span class="p">]</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">MT_cases</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="n">MT_cases</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># if undetermined MT anywhere, report it at the beginning and forget it</span>
    <span class="k">if</span> <span class="n">MT_CASE_UNDETERMINED</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MT_CASE_UNDETERMINED</span><span class="p">)</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">cases</span> <span class="k">if</span> <span class="n">case</span> <span class="o">!=</span> <span class="n">MT_CASE_UNDETERMINED</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># if no RLO at all steps, report this, otherwise forget about these phases</span>
    <span class="k">if</span> <span class="n">MT_CASE_NO_RLO</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">cases</span> <span class="k">if</span> <span class="n">case</span> <span class="o">!=</span> <span class="n">MT_CASE_NO_RLO</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MT_CASE_NO_RLO</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># from now on... undetermined, and no_RLO are not in the list...</span>
    <span class="n">curr_case</span> <span class="o">=</span> <span class="n">cases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_case</span><span class="p">)</span>
    <span class="n">prev_case</span> <span class="o">=</span> <span class="n">curr_case</span>
    <span class="k">for</span> <span class="n">curr_case</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">curr_case</span> <span class="o">!=</span> <span class="n">prev_case</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_case</span><span class="p">)</span>
            <span class="n">prev_case</span> <span class="o">=</span> <span class="n">curr_case</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="cumulative_mass_transfer_string">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.cumulative_mass_transfer_string">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cumulative_mass_transfer_string</span><span class="p">(</span><span class="n">cumulative_integers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a cumulative MT sequence to a string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cumulative_integers : list of int</span>
<span class="sd">        Typically, the output of `cumulative_mass_transfer_numeric`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A summarization of the mass-tranfer cases in the form of a string, as</span>
<span class="sd">        opposed to the output of `cumulative_mass_transfer_numeric` (see this</span>
<span class="sd">        function to understand the rules of summarization). The character `?`</span>
<span class="sd">        in the beginning of the string indicates undetermined MT case at some</span>
<span class="sd">        point of the evolution. `no_RLO` indicates no RLO at any evolutionary</span>
<span class="sd">        step. `caseA`, `caseB`, etc., denote the corresponding MT cases. When</span>
<span class="sd">        multiple cases are found, they are indicated only when the begin, and</span>
<span class="sd">        are combined using `/`. For example:</span>

<span class="sd">        ?no_RLO     : undetermined MT at few steps, otherwise no RLO.</span>
<span class="sd">        caseA       : case A MT only (possible no_RLO at some points).</span>
<span class="sd">        ?caseA/B    : undetermined MT somewhere, then case A, then case B.</span>
<span class="sd">        caseA/B/A   : case A, then B, and A again (although unphysical).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cumulative_integers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;?&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">added_case_word</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">integer</span> <span class="ow">in</span> <span class="n">cumulative_integers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">integer</span> <span class="o">==</span> <span class="n">MT_CASE_UNDETERMINED</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;?&quot;</span>
        <span class="k">elif</span> <span class="n">integer</span> <span class="o">==</span> <span class="n">MT_CASE_NO_RLO</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;no_RLO&quot;</span>
        <span class="k">elif</span> <span class="p">((</span><span class="n">integer</span> <span class="ow">in</span> <span class="n">MT_CASE_TO_STR</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">integer</span><span class="o">-</span><span class="mi">10</span> <span class="ow">in</span> <span class="n">MT_CASE_TO_STR</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">added_case_word</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;case_&quot;</span>
                <span class="n">added_case_word</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>
            <span class="k">if</span> <span class="n">integer</span> <span class="ow">in</span> <span class="n">MT_CASE_TO_STR</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">MT_CASE_TO_STR</span><span class="p">[</span><span class="n">integer</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="c1"># from star 1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">MT_CASE_TO_STR</span><span class="p">[</span><span class="n">integer</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span> <span class="c1"># from star 2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Unknown MT case: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">integer</span><span class="p">),</span>\
                  <span class="s2">&quot;InappropriateValueWarning&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="cumulative_mass_transfer_flag">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.cumulative_mass_transfer_flag">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cumulative_mass_transfer_flag</span><span class="p">(</span><span class="n">MT_cases</span><span class="p">,</span> <span class="n">shift_cases</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the cumulative MT string from a list of integer MT casses.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    MT_cases: list of integers</span>
<span class="sd">        A list of MT cases.</span>
<span class="sd">    shift_cases: bool</span>
<span class="sd">        Flag to shift non-physical cases like A1 after B1 will turn into B1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A string summarizing the mass transfer cases.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">shift_cases</span><span class="p">:</span>
        <span class="n">case_1_min</span> <span class="o">=</span> <span class="n">MT_CASE_NO_RLO</span>
        <span class="n">case_1_max</span> <span class="o">=</span> <span class="n">MT_CASE_UNDETERMINED</span>
        <span class="n">case_2_min</span> <span class="o">=</span> <span class="n">case_1_min</span><span class="o">+</span><span class="mi">10</span>
        <span class="n">case_2_max</span> <span class="o">=</span> <span class="n">case_1_max</span><span class="o">+</span><span class="mi">10</span>
        <span class="n">corrected_MT_cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">MT_cases</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">MT</span><span class="o">&lt;=</span><span class="n">case_1_max</span><span class="p">):</span>
                <span class="c1"># star 1 is donor</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">MT</span><span class="o">&lt;</span><span class="n">case_1_min</span><span class="p">):</span> <span class="c1"># replace MT case</span>
                    <span class="n">corrected_MT_cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case_1_min</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">corrected_MT_cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">MT</span><span class="o">&gt;</span><span class="n">case_1_min</span><span class="p">):</span> <span class="c1"># update earliest possible MT case</span>
                    <span class="n">case_1_min</span> <span class="o">=</span> <span class="n">MT</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">MT</span><span class="o">&lt;=</span><span class="n">case_2_max</span><span class="p">):</span>
                <span class="c1"># star 2 is donor</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">MT</span><span class="o">&lt;</span><span class="n">case_2_min</span><span class="p">):</span> <span class="c1"># replace MT case</span>
                    <span class="n">corrected_MT_cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case_2_min</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">corrected_MT_cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">MT</span><span class="o">&gt;</span><span class="n">case_2_min</span><span class="p">):</span> <span class="c1"># update earliest possible MT case</span>
                    <span class="n">case_2_min</span> <span class="o">=</span> <span class="n">MT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># unknown donor</span>
                <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;MT case with unknown donor: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MT</span><span class="p">),</span>\
                      <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
                <span class="n">corrected_MT_cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">corrected_MT_cases</span> <span class="o">=</span> <span class="n">MT_cases</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cumulative_mass_transfer_string</span><span class="p">(</span>
        <span class="n">cumulative_mass_transfer_numeric</span><span class="p">(</span><span class="n">corrected_MT_cases</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="get_i_He_depl">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.get_i_He_depl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_i_He_depl</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the index of He depletion in the history</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    history: numpy-array</span>
<span class="sd">        Stellar history from MESA</span>
<span class="sd">    </span>
<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    int</span>
<span class="sd">        index of He depletion (-1 if no He depletion is found)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;surface_h1&#39;</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="ow">and</span>
        <span class="p">(</span><span class="s1">&#39;center_h1&#39;</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="ow">and</span>
        <span class="p">(</span><span class="s1">&#39;center_he4&#39;</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="ow">and</span>
        <span class="p">(</span><span class="s1">&#39;center_c12&#39;</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="ow">and</span>
        <span class="p">(</span><span class="s1">&#39;log_LH&#39;</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="ow">and</span>
        <span class="p">(</span><span class="s1">&#39;log_LHe&#39;</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="ow">and</span>
        <span class="p">(</span><span class="s1">&#39;log_Lnuc&#39;</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
        <span class="n">n_history</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;center_he4&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_history</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">infer_star_state</span><span class="p">(</span><span class="n">surface_h1</span><span class="o">=</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;surface_h1&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">center_h1</span><span class="o">=</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;center_h1&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">center_he4</span><span class="o">=</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;center_he4&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">center_c12</span><span class="o">=</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;center_c12&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">log_LH</span><span class="o">=</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;log_LH&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">log_LHe</span><span class="o">=</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;log_LHe&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">log_Lnuc</span><span class="o">=</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;log_Lnuc&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">star_CO</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Central_He_depleted&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span> 
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>



<div class="viewcode-block" id="calculate_Patton20_values_at_He_depl">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.calculate_Patton20_values_at_He_depl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_Patton20_values_at_He_depl</span><span class="p">(</span><span class="n">star</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the carbon core mass and abundance very close to ignition.</span>

<span class="sd">    This is important for using the Patton+2020 SN prescription</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    star: SingleStar object holding the history of its attributes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    It updates the following values in the star object</span>
<span class="sd">    co_core_mass_at_He_depletion: float</span>
<span class="sd">        co_core_mass at He core depletion</span>
<span class="sd">        (almost at the same time as carbon core ignition)</span>
<span class="sd">    avg_c_in_c_core_at_He_depletion : float</span>
<span class="sd">        avg carbon abundance inside CO_core_mass at He core depletion</span>
<span class="sd">        (almost at the same time as carbon core ignition)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">co_core_mass_at_He_depletion</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">avg_c_in_c_core_at_He_depletion</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">star</span><span class="o">.</span><span class="n">state_history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;H-rich_Central_He_depleted&quot;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">state_history</span><span class="p">):</span>
            <span class="n">i_He_depl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">state_history</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;H-rich_Central_He_depleted&quot;</span><span class="p">)</span>
            <span class="n">co_core_mass_at_He_depletion</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">co_core_mass_history</span><span class="p">[</span><span class="n">i_He_depl</span><span class="p">]</span>
            <span class="n">avg_c_in_c_core_at_He_depletion</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">avg_c_in_c_core_history</span><span class="p">[</span>
                <span class="n">i_He_depl</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;stripped_He_Central_He_depleted&quot;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">state_history</span><span class="p">):</span>
            <span class="n">i_He_depl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">state_history</span><span class="p">)</span>
                                  <span class="o">==</span> <span class="s2">&quot;stripped_He_Central_He_depleted&quot;</span><span class="p">)</span>
            <span class="n">co_core_mass_at_He_depletion</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">co_core_mass_history</span><span class="p">[</span><span class="n">i_He_depl</span><span class="p">]</span>
            <span class="n">avg_c_in_c_core_at_He_depletion</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">avg_c_in_c_core_history</span><span class="p">[</span>
                <span class="n">i_He_depl</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">co_core_mass_at_He_depletion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">avg_c_in_c_core_at_He_depletion</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># return co_core_mass_at_He_depletion, avg_c_in_c_core_at_He_depletion</span>
    <span class="n">star</span><span class="o">.</span><span class="n">co_core_mass_at_He_depletion</span> <span class="o">=</span> <span class="n">co_core_mass_at_He_depletion</span>
    <span class="n">star</span><span class="o">.</span><span class="n">avg_c_in_c_core_at_He_depletion</span> <span class="o">=</span> <span class="n">avg_c_in_c_core_at_He_depletion</span></div>



<div class="viewcode-block" id="CEE_parameters_from_core_abundance_thresholds">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.CEE_parameters_from_core_abundance_thresholds">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">CEE_parameters_from_core_abundance_thresholds</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the envelope mass for different core boundary abundance thresholds.</span>

<span class="sd">    The results are meant to be used in collabration with the respective</span>
<span class="sd">    `lambda_CE_*cent`, `lambda_CE_pure_He_star_10cent`.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    star: SingleStar object holding the history of its attributes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    It updates the following values in the star object</span>
<span class="sd">    m_core_CE_1cent: float</span>
<span class="sd">        core mass (using an element abundance of 1%)</span>
<span class="sd">    m_core_CE_10cent: float</span>
<span class="sd">        core mass (using an element abundance of 10%)</span>
<span class="sd">    m_core_CE_30cent: float</span>
<span class="sd">        core mass (using an element abundance of 30%)</span>
<span class="sd">    m_core_CE_pure_He_star_10cent: float</span>
<span class="sd">        core mass (using an element abundance of 10% in He)</span>
<span class="sd">    r_core_CE_1cent: float</span>
<span class="sd">        core radius (using an element abundance of 1%)</span>
<span class="sd">    r_core_CE_10cent: float</span>
<span class="sd">        core radius (using an element abundance of 10%)</span>
<span class="sd">    r_core_CE_30cent: float</span>
<span class="sd">        core radius (using an element abundance of 30%)</span>
<span class="sd">    r_core_CE_pure_He_star_10cent: float</span>
<span class="sd">        core radius (using an element abundance of 10% in He)</span>
<span class="sd">    lambda_CE_1cent: float</span>
<span class="sd">        lambda value (using an element abundance of 1%)</span>
<span class="sd">    lambda_CE_10cent: float</span>
<span class="sd">        lambda value (using an element abundance of 10%)</span>
<span class="sd">    lambda_CE_30cent: float</span>
<span class="sd">        lambda value (using an element abundance of 30%)</span>
<span class="sd">    lambda_CE_pure_He_star_10cent: float</span>
<span class="sd">        lambda value (using an element abundance of 10% in He)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">mass</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="n">star</span><span class="o">.</span><span class="n">log_R</span>
    <span class="n">star_state</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">state</span>
    <span class="n">m_core_CE_1cent</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">m_core_CE_10cent</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">m_core_CE_30cent</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">m_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">r_core_CE_1cent</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">r_core_CE_10cent</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">r_core_CE_30cent</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">r_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">profile</span>              <span class="c1"># final profile of a star in a MESA run</span>

    <span class="k">if</span> <span class="n">profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">mass_prof</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span>

        <span class="n">m_core</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">r_core</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="s2">&quot;H-rich&quot;</span> <span class="ow">in</span> <span class="n">star_state</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">element_frac</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]:</span>
                <span class="n">ind_core</span> <span class="o">=</span> <span class="n">calculate_core_boundary</span><span class="p">(</span>
                    <span class="n">mass_prof</span><span class="p">,</span> <span class="n">star_state</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span>
                    <span class="n">core_element_fraction_definition</span><span class="o">=</span><span class="n">element_frac</span><span class="p">)</span>
                <span class="n">lambda_CE</span><span class="p">,</span> <span class="n">m_core</span><span class="p">,</span> <span class="n">r_core</span> <span class="o">=</span> <span class="n">calculate_lambda_from_profile</span><span class="p">(</span>
                    <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">donor_star_state</span><span class="o">=</span><span class="n">star_state</span><span class="p">,</span>
                    <span class="n">m1_i</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">radius1</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                    <span class="n">core_element_fraction_definition</span><span class="o">=</span><span class="n">element_frac</span><span class="p">,</span>
                    <span class="n">ind_core</span><span class="o">=</span><span class="n">ind_core</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">element_frac</span> <span class="o">==</span> <span class="mf">0.01</span><span class="p">:</span>
                    <span class="n">m_core_CE_1cent</span> <span class="o">=</span> <span class="n">m_core</span>
                    <span class="n">r_core_CE_1cent</span> <span class="o">=</span> <span class="n">r_core</span>
                    <span class="n">lambda_CE_1cent</span> <span class="o">=</span> <span class="n">lambda_CE</span>
                <span class="k">elif</span> <span class="n">element_frac</span> <span class="o">==</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="n">m_core_CE_10cent</span> <span class="o">=</span> <span class="n">m_core</span>
                    <span class="n">r_core_CE_10cent</span> <span class="o">=</span> <span class="n">r_core</span>
                    <span class="n">lambda_CE_10cent</span> <span class="o">=</span> <span class="n">lambda_CE</span>
                <span class="k">if</span> <span class="n">element_frac</span> <span class="o">==</span> <span class="mf">0.3</span><span class="p">:</span>
                    <span class="n">m_core_CE_30cent</span> <span class="o">=</span> <span class="n">m_core</span>
                    <span class="n">r_core_CE_30cent</span> <span class="o">=</span> <span class="n">r_core</span>
                    <span class="n">lambda_CE_30cent</span> <span class="o">=</span> <span class="n">lambda_CE</span>

            <span class="c1"># calculate also potential CO core, for consistency</span>
            <span class="k">for</span> <span class="n">element_frac</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">]:</span>
                <span class="n">ind_core</span> <span class="o">=</span> <span class="n">calculate_core_boundary</span><span class="p">(</span>
                    <span class="n">mass_prof</span><span class="p">,</span> <span class="n">star_state</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span>
                    <span class="n">core_element_fraction_definition</span><span class="o">=</span><span class="n">element_frac</span><span class="p">,</span>
                    <span class="n">CO_core_in_Hrich_star</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">lambda_CE</span><span class="p">,</span> <span class="n">m_core</span><span class="p">,</span> <span class="n">r_core</span> <span class="o">=</span> <span class="n">calculate_lambda_from_profile</span><span class="p">(</span>
                    <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">donor_star_state</span><span class="o">=</span><span class="n">star_state</span><span class="p">,</span>
                    <span class="n">m1_i</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">radius1</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                    <span class="n">core_element_fraction_definition</span><span class="o">=</span><span class="n">element_frac</span><span class="p">,</span>
                    <span class="n">ind_core</span><span class="o">=</span><span class="n">ind_core</span><span class="p">,</span> <span class="n">CO_core_in_Hrich_star</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">m_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">m_core</span>
                <span class="n">r_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">r_core</span>
                <span class="n">lambda_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">lambda_CE</span>
        <span class="k">elif</span> <span class="s2">&quot;stripped_He&quot;</span> <span class="ow">in</span> <span class="n">star_state</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">element_frac</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">]:</span>
                <span class="n">ind_core</span> <span class="o">=</span> <span class="n">calculate_core_boundary</span><span class="p">(</span>
                    <span class="n">mass_prof</span><span class="p">,</span> <span class="n">star_state</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span>
                    <span class="n">core_element_fraction_definition</span><span class="o">=</span><span class="n">element_frac</span><span class="p">)</span>
                <span class="n">lambda_CE</span><span class="p">,</span> <span class="n">m_core</span><span class="p">,</span> <span class="n">r_core</span> <span class="o">=</span> <span class="n">calculate_lambda_from_profile</span><span class="p">(</span>
                    <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">donor_star_state</span><span class="o">=</span><span class="n">star_state</span><span class="p">,</span>
                    <span class="n">m1_i</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">radius1</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                    <span class="n">core_element_fraction_definition</span><span class="o">=</span><span class="n">element_frac</span><span class="p">,</span>
                    <span class="n">ind_core</span><span class="o">=</span><span class="n">ind_core</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">m_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">m_core</span>
                <span class="n">m_core_CE_1cent</span> <span class="o">=</span> <span class="n">mass</span>
                <span class="n">m_core_CE_10cent</span> <span class="o">=</span> <span class="n">mass</span>
                <span class="n">m_core_CE_30cent</span> <span class="o">=</span> <span class="n">mass</span>
                <span class="n">r_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">r_core</span>
                <span class="n">r_core_CE_1cent</span> <span class="o">=</span> <span class="n">radius</span>
                <span class="n">r_core_CE_10cent</span> <span class="o">=</span> <span class="n">radius</span>
                <span class="n">r_core_CE_30cent</span> <span class="o">=</span> <span class="n">radius</span>
                <span class="n">lambda_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">lambda_CE</span>
                <span class="n">lambda_CE_1cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">lambda_CE_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">lambda_CE_30cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># CO-object or undetermined_evolutionary_state?</span>
            <span class="n">m_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">m_core_CE_1cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">m_core_CE_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">m_core_CE_30cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">r_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">r_core_CE_1cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">r_core_CE_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">r_core_CE_30cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">lambda_CE_1cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">lambda_CE_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">lambda_CE_30cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">lambda_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;star state </span><span class="si">{}</span><span class="s1"> is not what expected during the &#39;</span>
                      <span class="s1">&#39;CEE_parameters_from_core_abundance_thresholds.&#39;</span><span class="o">.</span>
                      <span class="nb">format</span><span class="p">(</span><span class="n">star_state</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>                                                       <span class="c1"># no profile</span>
        <span class="n">m_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">m_core_CE_1cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">m_core_CE_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">m_core_CE_30cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">r_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">r_core_CE_1cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">r_core_CE_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">r_core_CE_30cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">lambda_CE_1cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">lambda_CE_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">lambda_CE_30cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">lambda_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;star_state&quot;</span><span class="p">,</span> <span class="n">star_state</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;m_core_CE_1cent,m_core_CE_10cent,m_core_CE_30cent,&quot;</span>
              <span class="s2">&quot;m_core_CE_pure_He_star_10cent&quot;</span><span class="p">,</span>
              <span class="n">m_core_CE_1cent</span><span class="p">,</span> <span class="n">m_core_CE_10cent</span><span class="p">,</span> <span class="n">m_core_CE_30cent</span><span class="p">,</span>
              <span class="n">m_core_CE_pure_He_star_10cent</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;r_core_CE_1cent,r_core_CE_10cent,r_core_CE_30cent,&quot;</span>
              <span class="s2">&quot;r_core_CE_pure_He_star_10cent&quot;</span><span class="p">,</span>
              <span class="n">r_core_CE_1cent</span><span class="p">,</span> <span class="n">r_core_CE_10cent</span><span class="p">,</span> <span class="n">r_core_CE_30cent</span><span class="p">,</span>
              <span class="n">r_core_CE_pure_He_star_10cent</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lambda_CE_1cent,lambda_CE_10cent,lambda_CE_30cent,&quot;</span>
              <span class="s2">&quot;lambda_CE_pure_He_star_10cent&quot;</span><span class="p">,</span>
              <span class="n">lambda_CE_1cent</span><span class="p">,</span> <span class="n">lambda_CE_10cent</span><span class="p">,</span> <span class="n">lambda_CE_30cent</span><span class="p">,</span>
              <span class="n">lambda_CE_pure_He_star_10cent</span><span class="p">)</span>

    <span class="n">star</span><span class="o">.</span><span class="n">m_core_CE_1cent</span> <span class="o">=</span> <span class="n">m_core_CE_1cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">m_core_CE_10cent</span> <span class="o">=</span> <span class="n">m_core_CE_10cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">m_core_CE_30cent</span> <span class="o">=</span> <span class="n">m_core_CE_30cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">m_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">m_core_CE_pure_He_star_10cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">r_core_CE_1cent</span> <span class="o">=</span> <span class="n">r_core_CE_1cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">r_core_CE_10cent</span> <span class="o">=</span> <span class="n">r_core_CE_10cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">r_core_CE_30cent</span> <span class="o">=</span> <span class="n">r_core_CE_30cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">r_core_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">r_core_CE_pure_He_star_10cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">lambda_CE_1cent</span> <span class="o">=</span> <span class="n">lambda_CE_1cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">lambda_CE_10cent</span> <span class="o">=</span> <span class="n">lambda_CE_10cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">lambda_CE_30cent</span> <span class="o">=</span> <span class="n">lambda_CE_30cent</span>
    <span class="n">star</span><span class="o">.</span><span class="n">lambda_CE_pure_He_star_10cent</span> <span class="o">=</span> <span class="n">lambda_CE_pure_He_star_10cent</span></div>



<div class="viewcode-block" id="initialize_empty_array">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.initialize_empty_array">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">initialize_empty_array</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize an empty record array with NaNs and empty strings.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubsctype</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">colname</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubsctype</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">colname</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1">#TODO: handle h5py.string_dtype()</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="calculate_core_boundary">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.calculate_core_boundary">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_core_boundary</span><span class="p">(</span><span class="n">donor_mass</span><span class="p">,</span>
                            <span class="n">donor_star_state</span><span class="p">,</span>
                            <span class="n">profile</span><span class="p">,</span>
                            <span class="n">mc1_i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">core_element_fraction_definition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">CO_core_in_Hrich_star</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the shell where the core is - envelope boundary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    donor_mass : array</span>
<span class="sd">        Profile column of enclosed mass of the star.</span>
<span class="sd">    donor_star_state : string</span>
<span class="sd">        The POSYDON evolutionary state of the donor star</span>
<span class="sd">    profile : numpy.array</span>
<span class="sd">        Donor&#39;s star profile from MESA</span>
<span class="sd">    mc1_i : float</span>
<span class="sd">        core mass and total mass of the donor star.</span>
<span class="sd">    core_element_fraction_definition : float</span>
<span class="sd">        The mass fraction of the envelope abundant chemical element at</span>
<span class="sd">        the core-envelope boundary to derive the donor&#39;s core mass from</span>
<span class="sd">        the profile</span>
<span class="sd">    CO_core_in_Hrich_star: Bool</span>
<span class="sd">        This should be true if we want to calculate the boundary of CO core in</span>
<span class="sd">        a H-rich star (and not of the helium core).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ind_core : int</span>
<span class="sd">        The value of the cell position of the core - envelope boundary, at the</span>
<span class="sd">        donor&#39;s MESA  profile (for a profile that starts from the surface).</span>
<span class="sd">        More specifically, it returns the index of the first cell (starting</span>
<span class="sd">        from the surface), that the elements conditions for the core are met.</span>
<span class="sd">        - Returns 0 for a star that is all core</span>
<span class="sd">        - Returns -1 for a star that is all envelope.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the threshold of the elements that need to be high in the core</span>
    <span class="n">core_element_high_fraction_definition</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="c1"># ENHANCEMENT: this list needs to be imported from e.g. flow_chart.py</span>
    <span class="n">STAR_STATES_H_RICH</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;H-rich_Core_H_burning&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H-rich_Shell_H_burning&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H-rich_Core_He_burning&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H-rich_Central_He_depleted&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H-rich_Core_C_burning&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H-rich_Central_C_depletion&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H-rich_non_burning&quot;</span><span class="p">,</span>
        <span class="s2">&quot;accreted_He_Core_H_burning&quot;</span><span class="p">,</span>
        <span class="s2">&quot;accreted_He_non_burning&quot;</span>
    <span class="p">]</span>
    <span class="c1"># ENHANCEMENT: this list needs to be imported from e.g. flow_chart.py</span>
    <span class="n">STAR_STATE_He</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;accreted_He_Core_He_burning&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stripped_He_Core_He_burning&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stripped_He_Central_He_depleted&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stripped_He_Central_C_depletion&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stripped_He_non_burning&#39;</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">core_element_fraction_definition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">donor_star_state</span> <span class="ow">in</span> <span class="n">STAR_STATES_H_RICH</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;x_mass_fraction_H&#39;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;y_mass_fraction_He&#39;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;z_mass_fraction_metals&#39;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">CO_core_in_Hrich_star</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;x_mass_fraction_H&#39;</span><span class="p">]</span>
                <span class="n">element_core</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;y_mass_fraction_He&#39;</span><span class="p">],</span>
                                      <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;z_mass_fraction_metals&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;x_mass_fraction_H&#39;</span><span class="p">],</span>
                                 <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;y_mass_fraction_He&#39;</span><span class="p">])</span>
                <span class="n">element_core</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;z_mass_fraction_metals&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">donor_star_state</span> <span class="ow">in</span> <span class="n">STAR_STATE_He</span>
              <span class="ow">and</span> <span class="s1">&#39;x_mass_fraction_H&#39;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
              <span class="ow">and</span> <span class="s1">&#39;y_mass_fraction_He&#39;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
              <span class="ow">and</span> <span class="s1">&#39;z_mass_fraction_metals&#39;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="c1"># Recalculate the core from a chemical mass fraction threshold.</span>
            <span class="c1"># Here we assume Xelement=0.1 is the default MESA core definition.</span>
            <span class="c1"># element = profile[&#39;y_mass_fraction_He&#39;]</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;x_mass_fraction_H&#39;</span><span class="p">],</span>
                             <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;y_mass_fraction_He&#39;</span><span class="p">])</span>
            <span class="n">element_core</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;z_mass_fraction_metals&#39;</span><span class="p">]</span>
        <span class="c1"># ind_core=np.argmax(element[::-1]&gt;=core_element_fraction_definition)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind_core</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Stellar profile columns were not enough to calculate the&quot;</span><span class="o">+</span>\
                  <span class="s2">&quot; core-envelope boundaries for CE, entire star is now&quot;</span><span class="o">+</span>\
                  <span class="s2">&quot; considered an envelope&quot;</span><span class="p">,</span> <span class="s2">&quot;ApproximationWarning&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ind_core</span>

        <span class="c1"># starting from the surface, both conditions become True when element</span>
        <span class="c1"># (of which the envelope is rich) decreases and the element_core which</span>
        <span class="c1"># is in the core increases.</span>
        <span class="n">both_conditions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">element</span> <span class="o">&lt;=</span> <span class="n">core_element_fraction_definition</span><span class="p">)</span><span class="o">.</span><span class="fm">__and__</span><span class="p">(</span>
                <span class="n">element_core</span> <span class="o">&gt;=</span> <span class="n">core_element_high_fraction_definition</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">both_conditions</span><span class="p">):</span>
            <span class="c1"># the whole star is an envelope, from surface towards the core</span>
            <span class="c1"># the &quot;both_conditions&quot; never becomes True</span>
            <span class="n">ind_core</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># starting from the surface we find the first time that we get True</span>
            <span class="n">ind_core</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">both_conditions</span><span class="p">)</span>
            <span class="c1"># This includes the case that the whole star is an &quot;core&quot;, as it</span>
            <span class="c1"># will find only &quot;True&quot; in both_conditions and will return</span>
            <span class="c1"># ind_core=0 (first, surface cell for a MESA profile)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">mc1_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># calculate the cell position of the core boundary. In principle you</span>
        <span class="c1"># calculate index of the first time the inequality becomes False (your</span>
        <span class="c1"># lowest value) for your MESA profile, so starting from the surface.</span>
        <span class="n">ind_core</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">donor_mass</span> <span class="o">&gt;=</span> <span class="n">mc1_i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not possible to calculate the core boundary of the donor in CE&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ind_core</span></div>



<div class="viewcode-block" id="period_evol_wind_loss">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.period_evol_wind_loss">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">period_evol_wind_loss</span><span class="p">(</span><span class="n">M_current</span><span class="p">,</span> <span class="n">M_init</span><span class="p">,</span> <span class="n">Mcomp</span><span class="p">,</span> <span class="n">P_init</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate analytically the period widening due to wind mass loss [1]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M_current : float</span>
<span class="sd">        Current mass of the mass losing star (Msun)</span>
<span class="sd">    M_init : float</span>
<span class="sd">        Initial mass of the mass losing star when the calculation starts (Msun)</span>
<span class="sd">    Mcomp : float</span>
<span class="sd">        (Constant) mass of the companion star (Msun)</span>
<span class="sd">    P_init : float</span>
<span class="sd">        Initial binary period when the calculation starts (days)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     float</span>
<span class="sd">        Current binary period  in days</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Tauris, T. M., &amp; van den Heuvel, E. 2006, Compact stellar X-ray</span>
<span class="sd">        sources, 1, 623</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log10P</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_current</span><span class="o">+</span><span class="n">Mcomp</span><span class="p">)</span>
              <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_init</span><span class="o">+</span><span class="n">Mcomp</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">P_init</span><span class="p">))</span>
    <span class="k">return</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">log10P</span></div>



<div class="viewcode-block" id="separation_evol_wind_loss">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.separation_evol_wind_loss">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">separation_evol_wind_loss</span><span class="p">(</span><span class="n">M_current</span><span class="p">,</span> <span class="n">M_init</span><span class="p">,</span> <span class="n">Mcomp</span><span class="p">,</span> <span class="n">A_init</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate analytically the separation widening due to wind mass loss [1]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M_current : float</span>
<span class="sd">        Current mass of the mass losing star (Msun)</span>
<span class="sd">    M_init : float</span>
<span class="sd">        Initial mass of the mass losing star when the calculation starts (Msun)</span>
<span class="sd">    Mcomp : float</span>
<span class="sd">        (Constant) mass of the companion star (Msun)</span>
<span class="sd">    A_init : float</span>
<span class="sd">        Initial binary separation when the calculation starts (Rsun)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     float</span>
<span class="sd">        Current binary separation  in Rsun</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Tauris, T. M., &amp; van den Heuvel, E. 2006, Compact stellar X-ray</span>
<span class="sd">        sources, 1, 623.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log10A</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_current</span><span class="o">+</span><span class="n">Mcomp</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_init</span><span class="o">+</span><span class="n">Mcomp</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">A_init</span><span class="p">))</span>
    <span class="k">return</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">log10A</span></div>



<div class="viewcode-block" id="period_change_stable_MT">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.period_change_stable_MT">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">period_change_stable_MT</span><span class="p">(</span><span class="n">period_i</span><span class="p">,</span> <span class="n">Mdon_i</span><span class="p">,</span> <span class="n">Mdon_f</span><span class="p">,</span> <span class="n">Macc_i</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change the binary period after a semi-detached stable MT phase.</span>

<span class="sd">    Calculated in Sorensen, Fragos et al.  2017A&amp;A...597A..12S.</span>
<span class="sd">    Note that MT efficiencies are assumed constant (i.e., not time-dependent)</span>
<span class="sd">    throughout the MT phase.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    period_i : float</span>
<span class="sd">        Initial period</span>
<span class="sd">    Mdon_i: float</span>
<span class="sd">        Initial donor mass</span>
<span class="sd">    Mdon_f: float</span>
<span class="sd">        Final donor mass (should be in the same unit&#39;s of Mdon_i)</span>
<span class="sd">    Mdon_i: float</span>
<span class="sd">        Initial accretor&#39;s mass (should be in the same unit&#39;s of Mdon_i)</span>
<span class="sd">    alpha : float [0-1]</span>
<span class="sd">        Fraction of DM_don (= Mdon_i - Mdon_f) from the donor,</span>
<span class="sd">        lost from the donor&#39;s vicinity</span>
<span class="sd">    beta : float [0-1]</span>
<span class="sd">        Fraction of Mdot from the L1 point (= (1-alpha)*DM_don),</span>
<span class="sd">        lost from the accretor&#39;s vicinity.</span>
<span class="sd">        The final accreted rate is (1-beta)(1-alpha)*DM_don</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    period_f : float</span>
<span class="sd">        final period at the end of stable MT, in the same units as period_i</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DM_don</span> <span class="o">=</span> <span class="n">Mdon_i</span> <span class="o">-</span> <span class="n">Mdon_f</span>    <span class="c1"># mass lost from donor (&gt;0)</span>
    <span class="k">if</span> <span class="n">DM_don</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Donor gains mass from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Mdon_i</span><span class="p">,</span>
                                                                 <span class="n">Mdon_f</span><span class="p">))</span>
    <span class="n">Macc_f</span> <span class="o">=</span> <span class="n">Macc_i</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">DM_don</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">beta</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">beta</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;In period_change_stable_MT, mass transfer &quot;</span>
                         <span class="s2">&quot;efficiencies, alpha, beta: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2"> are not in the &quot;</span>
                         <span class="s2">&quot;[0-1] range.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">beta</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>      <span class="c1"># Eq. 7 of Sorensen+Fragos et al. 2017</span>
        <span class="n">period_f</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_i</span> <span class="o">*</span> <span class="p">(</span><span class="n">Mdon_f</span><span class="o">/</span><span class="n">Mdon_i</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">Macc_f</span><span class="o">/</span><span class="n">Macc_i</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="p">(</span><span class="n">beta</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
                    <span class="o">*</span> <span class="p">((</span><span class="n">Mdon_i</span> <span class="o">+</span> <span class="n">Macc_i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Mdon_f</span> <span class="o">+</span> <span class="n">Macc_f</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># fully non-conservative MT. Eq. 8 of Sorensen+Fragos et al. 2017,</span>
        <span class="c1"># were we already assumed beta=1</span>
        <span class="n">period_f</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_i</span> <span class="o">*</span> <span class="p">(</span><span class="n">Mdon_f</span><span class="o">/</span><span class="n">Mdon_i</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Mdon_f</span> <span class="o">-</span> <span class="n">Mdon_i</span><span class="p">)</span><span class="o">/</span><span class="n">Macc_f</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">((</span><span class="n">Mdon_i</span> <span class="o">+</span> <span class="n">Macc_i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Mdon_f</span> <span class="o">+</span> <span class="n">Macc_f</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">period_f</span></div>



<div class="viewcode-block" id="linear_interpolation_between_two_cells">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.linear_interpolation_between_two_cells">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">linear_interpolation_between_two_cells</span><span class="p">(</span><span class="n">array_y</span><span class="p">,</span> <span class="n">array_x</span><span class="p">,</span> <span class="n">x_target</span><span class="p">,</span>
                                           <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interpolate quantities between two star profile shells.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">bot</span><span class="p">)):</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">array_x</span> <span class="o">&gt;=</span> <span class="n">x_target</span><span class="p">)</span>
        <span class="n">bot</span> <span class="o">=</span> <span class="n">top</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">bot</span><span class="p">):</span>
        <span class="n">bot</span> <span class="o">=</span> <span class="n">top</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">top</span><span class="p">):</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">bot</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">top</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_y</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;top=</span><span class="si">{}</span><span class="s2"> is too large, use last element in array_y&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top</span><span class="p">),</span>
              <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">top</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_x</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;array_x too short, use y at top=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top</span><span class="p">),</span>
              <span class="s2">&quot;InterpolationWarning&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array_y</span><span class="p">[</span><span class="n">top</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;bot=</span><span class="si">{}</span><span class="s2"> is too small, use first element&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bot</span><span class="p">),</span>
              <span class="s2">&quot;ReplaceValueWarning&quot;</span><span class="p">)</span>
        <span class="n">bot</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">top</span> <span class="o">==</span> <span class="n">bot</span><span class="p">:</span>
        <span class="n">y_target</span> <span class="o">=</span> <span class="n">array_y</span><span class="p">[</span><span class="n">top</span><span class="p">]</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;linear interpolation occured between the same point: x_target,&quot;</span>
              <span class="s2">&quot; top, bot, len(array_x), y_target = </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>\
              <span class="n">x_target</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_x</span><span class="p">),</span> <span class="n">y_target</span><span class="p">),</span>
              <span class="s2">&quot;InterpolationWarning&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">bot</span> <span class="o">&gt;</span> <span class="n">top</span><span class="p">:</span>
        <span class="n">y_target</span> <span class="o">=</span> <span class="n">array_y</span><span class="p">[</span><span class="n">top</span><span class="p">]</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;bot=</span><span class="si">{}</span><span class="s2"> is too large: use y at top=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="n">top</span><span class="p">),</span>
              <span class="s2">&quot;InterpolationWarning&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_top</span> <span class="o">=</span> <span class="n">array_x</span><span class="p">[</span><span class="n">top</span><span class="p">]</span>
        <span class="n">x_bot</span> <span class="o">=</span> <span class="n">array_x</span><span class="p">[</span><span class="n">bot</span><span class="p">]</span>

        <span class="n">y_top</span> <span class="o">=</span> <span class="n">array_y</span><span class="p">[</span><span class="n">top</span><span class="p">]</span>
        <span class="n">y_bot</span> <span class="o">=</span> <span class="n">array_y</span><span class="p">[</span><span class="n">bot</span><span class="p">]</span>

        <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_top</span> <span class="o">-</span> <span class="n">y_bot</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_top</span> <span class="o">-</span> <span class="n">x_bot</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_top</span><span class="o">*</span><span class="n">x_bot</span> <span class="o">-</span> <span class="n">y_bot</span><span class="o">*</span><span class="n">x_top</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_top</span> <span class="o">-</span> <span class="n">x_bot</span><span class="p">)</span>
        <span class="n">y_target</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_target</span> <span class="o">-</span> <span class="n">const</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;linear interpolation&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;x_target, top, bot, len(array_x)&quot;</span><span class="p">,</span>
                  <span class="n">x_target</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_x</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;x_top, x_bot, y_top, y_bot, y_target&quot;</span><span class="p">,</span>
                  <span class="n">x_top</span><span class="p">,</span> <span class="n">x_bot</span><span class="p">,</span> <span class="n">y_top</span><span class="p">,</span> <span class="n">y_bot</span><span class="p">,</span> <span class="n">y_target</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y_target</span></div>



<div class="viewcode-block" id="calculate_lambda_from_profile">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.calculate_lambda_from_profile">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_lambda_from_profile</span><span class="p">(</span>
        <span class="n">profile</span><span class="p">,</span> <span class="n">donor_star_state</span><span class="p">,</span>  <span class="n">m1_i</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">radius1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="n">common_envelope_option_for_lambda</span><span class="o">=</span><span class="n">DEFAULT_CE_OPTION_FOR_LAMBDA</span><span class="p">,</span>
        <span class="n">core_element_fraction_definition</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ind_core</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">common_envelope_alpha_thermal</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">CO_core_in_Hrich_star</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate common-enevelope lambda from the profile of a star.</span>

<span class="sd">     We also pass a more accurate calculation of the donor core mass for the</span>
<span class="sd">     purposes of common-envelope evolution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile : numpy.array</span>
<span class="sd">        Donor&#39;s star profile from MESA</span>
<span class="sd">    donor_star_state : string</span>
<span class="sd">        The POSYDON evolutionary state of the donor star</span>
<span class="sd">    common_envelope_option_for_lambda : str</span>
<span class="sd">        Available options:</span>
<span class="sd">        * &#39;default_lambda&#39;: using for lambda the constant value of</span>
<span class="sd">        common_envelope_lambda_default parameter</span>
<span class="sd">        * &#39;lambda_from_profile_gravitational&#39;: calculating the lambda</span>
<span class="sd">        parameter from the donor&#39;s profile by using the gravitational</span>
<span class="sd">        binding energy from the surface to the core</span>
<span class="sd">        (needing &quot;mass&quot;, and &quot;radius&quot; as columns in the profile)</span>
<span class="sd">        * &#39;lambda_from_profile_gravitational_plus_internal&#39;: as above</span>
<span class="sd">         but taking into account a factor of common_envelope_alpha_thermal *</span>
<span class="sd">         internal energy too in the binding energy (needing also &quot;energy&quot; as</span>
<span class="sd">         column in the profile)</span>
<span class="sd">        * &#39;lambda_from_profile_gravitational_plus_internal_minus_recombination&#39;</span>
<span class="sd">        as above but not taking into account the recombination energy in the</span>
<span class="sd">        internal energy (needing also &quot;y_mass_fraction_He&quot;, &quot;x_mass_fraction_H&quot;</span>
<span class="sd">        &quot;neutral_fraction_H&quot;, &quot;neutral_fraction_He&quot;, and &quot;avg_charge_He&quot; as</span>
<span class="sd">        column in the profile)</span>
<span class="sd">    core_element_fraction_definition : float</span>
<span class="sd">        The mass fraction of the envelope abundant chemical element at</span>
<span class="sd">        the core-envelope boundary to derive the donor&#39;s core mass from</span>
<span class="sd">        the profile.</span>
<span class="sd">    ind_core : int</span>
<span class="sd">        The value of the cell position of the core - envelope boundary, at the</span>
<span class="sd">        donor&#39;s MESA  profile (for a profile that starts from the surface).</span>
<span class="sd">        More specifically, it returns the index of the first cell (starting</span>
<span class="sd">        from the surface), that the elements conditions for the core are met.</span>
<span class="sd">        It is 0 for a star that is all core and -1 for a star that is all</span>
<span class="sd">        envelope. If it is not given (None), it will be calculated inside the</span>
<span class="sd">        function.</span>
<span class="sd">    common_envelope_alpha_thermal : float</span>
<span class="sd">        Used and explained depending on the common_envelope_option_for_lambda</span>
<span class="sd">        option above.</span>
<span class="sd">    tolerance : float</span>
<span class="sd">        The tolerance of numerical difference in two floats when comparing</span>
<span class="sd">        and testing results.</span>
<span class="sd">    CO_core_in_Hrich_star: Bool</span>
<span class="sd">        This should be true if we want to calculate the boundary of CO core in</span>
<span class="sd">        a H-rich star (and not of the helium core).</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        In case we want information about the CEE.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lambda_CE: float</span>
<span class="sd">        lambda_CE for the envelope of the donor in CEE,</span>
<span class="sd">        calculated from profile</span>
<span class="sd">    mc1_i: float</span>
<span class="sd">        More accurate calculation of the donor core mass for the purposes</span>
<span class="sd">        of CEE.</span>
<span class="sd">    rc1_i: float</span>
<span class="sd">        More accurate calculation of the donor core radius for the purposes</span>
<span class="sd">        of CEE.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get mass and radius and dm from profile</span>
    <span class="n">donor_mass</span><span class="p">,</span> <span class="n">donor_radius</span><span class="p">,</span> <span class="n">donor_dm</span> <span class="o">=</span> <span class="n">get_mass_radius_dm_from_profile</span><span class="p">(</span>
        <span class="n">profile</span><span class="p">,</span> <span class="n">m1_i</span><span class="p">,</span> <span class="n">radius1</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>
    <span class="c1"># if pd.isna(m1_i) or pd.isna(radius1)</span>
    <span class="n">m1_i</span> <span class="o">=</span> <span class="n">donor_mass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">radius1</span> <span class="o">=</span> <span class="n">donor_radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">specific_internal_energy</span> <span class="o">=</span> <span class="n">get_internal_energy_from_profile</span><span class="p">(</span>
        <span class="n">common_envelope_option_for_lambda</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ind_core</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># To be used in a MESA profile (so one that starts from the surface)</span>
        <span class="n">ind_core</span> <span class="o">=</span> <span class="n">calculate_core_boundary</span><span class="p">(</span><span class="n">donor_mass</span><span class="p">,</span> <span class="n">donor_star_state</span><span class="p">,</span>
                                           <span class="n">profile</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                           <span class="n">core_element_fraction_definition</span><span class="p">,</span>
                                           <span class="n">CO_core_in_Hrich_star</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ind_core</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>       <span class="c1"># all star is a core, immediate successful ejection</span>
        <span class="n">Ebind_i</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">lambda_CE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">mc1_i</span> <span class="o">=</span> <span class="n">m1_i</span>
        <span class="n">rc1_i</span> <span class="o">=</span> <span class="n">radius1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ind_core</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># all star is an envelope, calculate for whole star</span>
            <span class="n">Ebind_i</span> <span class="o">=</span> <span class="n">calculate_binding_energy</span><span class="p">(</span>
                <span class="n">donor_mass</span><span class="p">,</span> <span class="n">donor_radius</span><span class="p">,</span> <span class="n">donor_dm</span><span class="p">,</span> <span class="n">specific_internal_energy</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">donor_mass</span><span class="p">),</span> <span class="n">common_envelope_alpha_thermal</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">mc1_i</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rc1_i</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;H-rich&quot;</span> <span class="ow">in</span> <span class="n">donor_star_state</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">CO_core_in_Hrich_star</span><span class="p">:</span>
                    <span class="n">elem_prof</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;x_mass_fraction_H&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">elem_prof</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;y_mass_fraction_He&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;stripped_He&quot;</span> <span class="ow">in</span> <span class="n">donor_star_state</span><span class="p">:</span>
                <span class="n">elem_prof</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;y_mass_fraction_He&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;state </span><span class="si">{}</span><span class="s2"> not supported in CEE&quot;</span>\
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">donor_star_state</span><span class="p">))</span>
            <span class="n">mc1_i</span> <span class="o">=</span> <span class="n">linear_interpolation_between_two_cells</span><span class="p">(</span>
                <span class="n">donor_mass</span><span class="p">,</span> <span class="n">elem_prof</span><span class="p">,</span> <span class="n">core_element_fraction_definition</span><span class="p">,</span>
                <span class="n">ind_core</span><span class="p">,</span> <span class="n">ind_core</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">rc1_i</span> <span class="o">=</span> <span class="n">linear_interpolation_between_two_cells</span><span class="p">(</span>
                <span class="n">donor_radius</span><span class="p">,</span> <span class="n">elem_prof</span><span class="p">,</span> <span class="n">core_element_fraction_definition</span><span class="p">,</span>
                <span class="n">ind_core</span><span class="p">,</span> <span class="n">ind_core</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

            <span class="c1"># linear interpolation</span>
            <span class="n">Ebind_i_top</span> <span class="o">=</span> <span class="n">calculate_binding_energy</span><span class="p">(</span>
                <span class="n">donor_mass</span><span class="p">,</span> <span class="n">donor_radius</span><span class="p">,</span> <span class="n">donor_dm</span><span class="p">,</span> <span class="n">specific_internal_energy</span><span class="p">,</span>
                <span class="n">ind_core</span><span class="p">,</span> <span class="n">common_envelope_alpha_thermal</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">Ebind_i_bot</span> <span class="o">=</span> <span class="n">calculate_binding_energy</span><span class="p">(</span>
                <span class="n">donor_mass</span><span class="p">,</span> <span class="n">donor_radius</span><span class="p">,</span> <span class="n">donor_dm</span><span class="p">,</span> <span class="n">specific_internal_energy</span><span class="p">,</span>
                <span class="n">ind_core</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">common_envelope_alpha_thermal</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">lambda_CE_top</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="n">m1_i</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
                                 <span class="o">*</span> <span class="p">(</span><span class="n">m1_i</span> <span class="o">-</span> <span class="n">donor_mass</span><span class="p">[</span><span class="n">ind_core</span><span class="p">])</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
                                 <span class="o">/</span> <span class="p">(</span><span class="n">Ebind_i_top</span><span class="o">*</span><span class="n">radius1</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Rsun</span><span class="p">))</span>
                <span class="n">lambda_CE_bot</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="n">m1_i</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
                                 <span class="o">*</span> <span class="p">(</span><span class="n">m1_i</span> <span class="o">-</span> <span class="n">donor_mass</span><span class="p">[</span><span class="n">ind_core</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
                                 <span class="o">/</span> <span class="p">(</span><span class="n">Ebind_i_bot</span><span class="o">*</span><span class="n">radius1</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Rsun</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lambda_CE_top, lambda_CE_bot&quot;</span><span class="p">,</span>
                      <span class="n">lambda_CE_top</span><span class="p">,</span> <span class="n">lambda_CE_bot</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="p">((</span><span class="n">core_element_fraction_definition</span><span class="o">-</span><span class="n">elem_prof</span><span class="p">[</span><span class="n">ind_core</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                      <span class="o">/</span> <span class="p">(</span><span class="n">elem_prof</span><span class="p">[</span><span class="n">ind_core</span><span class="p">]</span> <span class="o">-</span> <span class="n">elem_prof</span><span class="p">[</span><span class="n">ind_core</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">Ebind_i</span> <span class="o">=</span> <span class="n">Ebind_i_bot</span> <span class="o">+</span> <span class="n">weight</span><span class="o">*</span><span class="p">(</span><span class="n">Ebind_i_top</span> <span class="o">-</span> <span class="n">Ebind_i_bot</span><span class="p">)</span>
        <span class="c1"># lambda of the donor is calculated from the profile</span>
        <span class="n">lambda_CE</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="n">m1_i</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
                     <span class="o">*</span> <span class="p">(</span><span class="n">m1_i</span> <span class="o">-</span> <span class="n">mc1_i</span><span class="p">)</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Msun</span><span class="o">/</span><span class="p">(</span><span class="n">Ebind_i</span><span class="o">*</span><span class="n">radius1</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Rsun</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;m1_i, radius1, len(profile) vs ind_core, mc1_i, rc1_i&quot;</span><span class="p">,</span>
              <span class="n">m1_i</span><span class="p">,</span> <span class="n">radius1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">donor_mass</span><span class="p">),</span> <span class="s2">&quot; vs &quot;</span><span class="p">,</span> <span class="n">ind_core</span><span class="p">,</span> <span class="n">mc1_i</span><span class="p">,</span> <span class="n">rc1_i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ebind_i from profile &quot;</span><span class="p">,</span> <span class="n">Ebind_i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lambda_CE &quot;</span><span class="p">,</span> <span class="n">lambda_CE</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lambda_CE</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tolerance</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">lambda_CE</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;lambda_CE has a negative value&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lambda_CE</span><span class="p">,</span> <span class="n">mc1_i</span><span class="p">,</span> <span class="n">rc1_i</span></div>



<div class="viewcode-block" id="get_mass_radius_dm_from_profile">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.get_mass_radius_dm_from_profile">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_mass_radius_dm_from_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">m1_i</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                    <span class="n">radius1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TODO: add summary.</span>

<span class="sd">    Reads and returns the profile columms of enclosed mass radius and</span>
<span class="sd">    mass per shell of the donor star from a MESA profile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m1_i : float</span>
<span class="sd">        m1_i is the value passed from the singlestar object,</span>
<span class="sd">        for testing purposes only</span>
<span class="sd">    radius1 : float</span>
<span class="sd">        radius1 is the value passed from the singlestar object,</span>
<span class="sd">        for testing purposes only</span>
<span class="sd">    profile : numpy.array</span>
<span class="sd">        Donor&#39;s star profile from MESA</span>
<span class="sd">    tolerance : float</span>
<span class="sd">        The tolerance of numerical difference in two floats when comparing and</span>
<span class="sd">        testing results.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    donor_mass : array</span>
<span class="sd">        Profile column of enclosed mass of the star.</span>
<span class="sd">    donor_radius : array</span>
<span class="sd">        Profile column of the radius the star.</span>
<span class="sd">    donor_dm : array</span>
<span class="sd">        Profile mass per shell of the star.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">((</span><span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">((</span><span class="s2">&quot;radius&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;log_R&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))):</span>
        <span class="n">donor_mass</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;radius&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="n">donor_radius</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#if (&quot;log_R&quot; in profile.dtype.names):</span>
            <span class="n">donor_radius</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;log_R&quot;</span><span class="p">]</span>

        <span class="c1"># checking if mass of profile agrees with the mass of the binary object</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">donor_mass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Donor mass from the binary class object &quot;</span>
                          <span class="s2">&quot;and the profile do not agree&quot;</span><span class="p">,</span> <span class="s2">&quot;ClassificationWarning&quot;</span><span class="p">)</span>
            
        <span class="c1"># checking if radius of profile agrees with the radius of the binary</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">donor_radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Donor radius from the binary class object &quot;</span>
                          <span class="s2">&quot;and the profile do not agree&quot;</span><span class="p">,</span> <span class="s2">&quot;ClassificationWarning&quot;</span><span class="p">)</span>

        <span class="c1"># MANOS: if dm exists as a column, else calculate it from mass column</span>
        <span class="k">if</span> <span class="s2">&quot;dm&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">donor_dm</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">]</span>
            <span class="c1"># dm in MESA is in cgs, not in MSsun units, so we transform it</span>
            <span class="n">donor_dm</span> <span class="o">=</span> <span class="n">donor_dm</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">donor_dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">donor_mass</span><span class="p">),</span>
                                       <span class="p">[</span><span class="n">donor_mass</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One or many of the mass and/or radius needed columns&quot;</span>
                         <span class="s2">&quot; in the profile is not provided for the CEE&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">donor_mass</span><span class="p">,</span> <span class="n">donor_radius</span><span class="p">,</span> <span class="n">donor_dm</span></div>



<div class="viewcode-block" id="get_internal_energy_from_profile">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.get_internal_energy_from_profile">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_internal_energy_from_profile</span><span class="p">(</span><span class="n">common_envelope_option_for_lambda</span><span class="p">,</span>
                                     <span class="n">profile</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the specific internal energy per shell of the donor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    common_envelope_option_for_lambda : str</span>
<span class="sd">        Available options:</span>
<span class="sd">        * &#39;default_lambda&#39;: using for lambda the constant value of</span>
<span class="sd">        common_envelope_lambda_default parameter</span>
<span class="sd">        * &#39;lambda_from_profile_gravitational&#39;: calculating the lambda</span>
<span class="sd">        parameter from the donor&#39;s profile by using the gravitational</span>
<span class="sd">        binding energy from the surface to the core</span>
<span class="sd">        (needing &quot;mass&quot;, and &quot;radius&quot; as columns in the profile)</span>
<span class="sd">        * &#39;lambda_from_profile_gravitational_plus_internal&#39;: as above</span>
<span class="sd">         but taking into account a factor of common_envelope_alpha_thermal *</span>
<span class="sd">         internal energy too in the binding energy (needing also &quot;energy&quot; as</span>
<span class="sd">         column in the profile)</span>
<span class="sd">        * &#39;lambda_from_profile_gravitational_plus_internal_minus_recombination&#39;</span>
<span class="sd">        as above but not taking into account the recombination energy in the</span>
<span class="sd">        internal energy (needing also &quot;y_mass_fraction_He&quot;, &quot;x_mass_fraction_H&quot;</span>
<span class="sd">        &quot;neutral_fraction_H&quot;, &quot;neutral_fraction_He&quot;, and &quot;avg_charge_He&quot; as</span>
<span class="sd">        column in the profile)</span>
<span class="sd">    profile : numpy.array</span>
<span class="sd">        Donor&#39;s star profile from MESA</span>
<span class="sd">    tolerance : float</span>
<span class="sd">        The tolerance of numerical difference in two floats when comparing</span>
<span class="sd">        and testing results.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    specific_donor_internal_energy : array</span>
<span class="sd">        Value of the specific internal energy per shell of the donor</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">common_envelope_option_for_lambda</span>
            <span class="o">==</span> <span class="s2">&quot;lambda_from_profile_gravitational&quot;</span><span class="p">):</span>
        <span class="c1"># initiate specific internal energy as 0</span>
        <span class="n">specific_donor_internal_energy</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">common_envelope_option_for_lambda</span>
           <span class="o">!=</span> <span class="s2">&quot;lambda_from_profile_gravitational&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s2">&quot;energy&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Profile does not include internal energy -- &quot;</span>
                      <span class="s2">&quot;proceeding with &#39;lambda_from_profile_gravitational&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;ApproximationWarning&quot;</span><span class="p">)</span>
        <span class="c1"># initiate specific internal energy as 0</span>
        <span class="n">specific_donor_internal_energy</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">common_envelope_option_for_lambda</span>
           <span class="o">==</span> <span class="s2">&quot;lambda_from_profile_gravitational_plus_internal&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;energy&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
        <span class="c1"># specific internal energy - if we would have used the &quot;total_energy&quot;</span>
        <span class="c1"># it would include (internal+potential+kinetic+rotation)</span>
        <span class="n">specific_donor_internal_energy</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">specific_donor_internal_energy</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tolerance</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CEE problem calculating internal energy, &quot;</span>
                            <span class="s2">&quot;giving negative values.&quot;</span><span class="p">)</span>

        <span class="n">specific_donor_H2recomb_energy</span> <span class="o">=</span> <span class="n">calculate_H2recombination_energy</span><span class="p">(</span>
            <span class="n">profile</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>
        <span class="c1"># we still need to subtract the H2 recombination energy which is</span>
        <span class="c1"># included in the &quot;energy&quot; column of the profile</span>
        <span class="c1"># internal_energy - H2 recombination energy per shell</span>
        <span class="n">specific_donor_internal_energy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">specific_donor_internal_energy</span> <span class="o">-</span> <span class="n">specific_donor_H2recomb_energy</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">specific_donor_internal_energy</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tolerance</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;CEE problem calculating recombination (and H2 recombination) &quot;</span>
                <span class="s2">&quot;energy, remaining internal energy giving negative values.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">common_envelope_option_for_lambda</span> <span class="o">==</span> <span class="s2">&quot;lambda_from_profile_&quot;</span>
           <span class="s2">&quot;gravitational_plus_internal_minus_recombination&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;energy&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
        <span class="c1"># specific internal energy. If we have used the &quot;total_energy&quot; it would</span>
        <span class="c1"># include (internal+potential+kinetic+rotation)</span>
        <span class="n">specific_donor_internal_energy</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">specific_donor_internal_energy</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tolerance</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CEE problem calculating internal energy, &quot;</span>
                            <span class="s2">&quot;giving negative values.&quot;</span><span class="p">)</span>

        <span class="c1"># we still need to subtract the H2 recombination energy which is</span>
        <span class="c1"># included in the &quot;energy&quot; column of the profile</span>
        <span class="n">specific_donor_H2recomb_energy</span> <span class="o">=</span> <span class="n">calculate_H2recombination_energy</span><span class="p">(</span>
            <span class="n">profile</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>
        <span class="n">specific_donor_recomb_energy</span> <span class="o">=</span> <span class="n">calculate_recombination_energy</span><span class="p">(</span>
            <span class="n">profile</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>
        <span class="c1"># internal_energy - recombination energy - H2 recombination energy per</span>
        <span class="c1"># shell (so I think it is left with thermal + radiation)</span>
        <span class="n">specific_donor_internal_energy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">specific_donor_internal_energy</span>
            <span class="o">-</span> <span class="n">specific_donor_recomb_energy</span>
            <span class="o">-</span> <span class="n">specific_donor_H2recomb_energy</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">specific_donor_internal_energy</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tolerance</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;CEE problem calculating recombination (and H2 recombination) &quot;</span>
                <span class="s2">&quot;energy, remaining internal energy giving negative values.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported: common_envelope_option_for_lambda = </span><span class="si">{}</span><span class="s2">&quot;</span>\
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">common_envelope_option_for_lambda</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">specific_donor_internal_energy</span></div>



<div class="viewcode-block" id="calculate_H2recombination_energy">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.calculate_H2recombination_energy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_H2recombination_energy</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the recombination energy of H2 per shell in erg.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile : array</span>
<span class="sd">        Donor&#39;s star profile from MESA</span>
<span class="sd">    tolerance : float</span>
<span class="sd">        The tolerance of numerical difference in two floats when comparing</span>
<span class="sd">        and testing results.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    specific_donor_H2recomb_energy : array</span>
<span class="sd">        recombination energy of H2 per shell in ergs</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;x_mass_fraction_H&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Profile does not include Hydrogen mass fraction &quot;</span>
                      <span class="s2">&quot;calculate H2 recombination energy -- &quot;</span>
                      <span class="s2">&quot;H2 recombination energy is assumed 0&quot;</span><span class="p">,</span> <span class="s2">&quot;ApproximationWarning&quot;</span><span class="p">)</span>
        <span class="n">specific_donor_H2recomb_energy</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Dissociation energy [cm^1] from Cheng+2018:</span>
        <span class="c1"># https://journals.aps.org/prl/abstract/10.1103/PhysRevLett.121.013001</span>
        <span class="n">specific_donor_H2recomb_energy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">35999.582894</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">inversecm2erg</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">H_weight</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;x_mass_fraction_H&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">avo</span><span class="p">)</span>
        <span class="c1"># http://www.nat.vu.nl/~griessen/STofHinM/ChapIIHatomMoleculeGas.pdf</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">specific_donor_H2recomb_energy</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tolerance</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CEE problem calculating H2 recombination energy, &quot;</span>
                            <span class="s2">&quot;giving negative values&quot;</span><span class="p">)</span>
    <span class="c1"># return specific_donor_H2recomb_energy * const.ev2erg</span>
    <span class="k">return</span> <span class="n">specific_donor_H2recomb_energy</span></div>



<div class="viewcode-block" id="calculate_recombination_energy">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.calculate_recombination_energy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_recombination_energy</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the recombination energy per shell in erg.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile : numpy.array</span>
<span class="sd">        Donor&#39;s star profile from MESA</span>
<span class="sd">    tolerance : float</span>
<span class="sd">        The tolerance of numerical difference in two floats when comparing</span>
<span class="sd">        and testing results.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    specific_donor_recomb_energy : array</span>
<span class="sd">        recombination energy per shell in ergs</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">((</span><span class="s2">&quot;y_mass_fraction_He&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;x_mass_fraction_H&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;neutral_fraction_H&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;neutral_fraction_He&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;avg_charge_He&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Profile does not include mass fractions and ionizations&quot;</span>
                      <span class="s2">&quot; of elements to calculate recombination energy &quot;</span>
                      <span class="s2">&quot;-- recombination energy is assumed 0&quot;</span><span class="p">,</span> <span class="s2">&quot;ApproximationWarning&quot;</span><span class="p">)</span>
        <span class="n">specific_donor_recomb_energy</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># from MESA/binary/private/binary_ce.f90</span>
        <span class="n">frac_HI</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;neutral_fraction_H&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frac_HI</span><span class="p">)):</span>
            <span class="c1"># TODO: For some reason this is a bit &gt; 1 in the outer envelope.</span>
            <span class="c1">#       Maybe not important but better to solve it.</span>
            <span class="n">frac_HI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">frac_HI</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">frac_HII</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">frac_HI</span>

        <span class="n">frac_HeI</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;neutral_fraction_He&quot;</span><span class="p">]</span>
        <span class="n">avg_charge_He</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;avg_charge_He&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frac_HeI</span><span class="p">)):</span>
            <span class="n">frac_HeI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">frac_HeI</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># knowing the frac_HeI and the avg_charge_He,</span>
            <span class="c1"># we can solve for frac_HeII and frac_HeIII</span>
            <span class="n">avg_charge_He</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">avg_charge_He</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frac_HeII</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">frac_HeI</span> <span class="o">-</span> <span class="n">avg_charge_He</span>
        <span class="n">frac_HeIII</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">frac_HeII</span> <span class="o">-</span> <span class="n">frac_HeI</span>

        <span class="n">specific_donor_recomb_energy</span> <span class="o">=</span> <span class="n">profile_recomb_energy</span><span class="p">(</span>
            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;x_mass_fraction_H&#39;</span><span class="p">],</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;y_mass_fraction_He&#39;</span><span class="p">],</span>
            <span class="n">frac_HII</span><span class="p">,</span> <span class="n">frac_HeII</span><span class="p">,</span> <span class="n">frac_HeIII</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">specific_donor_recomb_energy</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tolerance</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CEE problem calculating recombination energy, &quot;</span>
                            <span class="s2">&quot;giving negative values.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">specific_donor_recomb_energy</span></div>



<div class="viewcode-block" id="profile_recomb_energy">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.profile_recomb_energy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">profile_recomb_energy</span><span class="p">(</span><span class="n">x_mass_fraction_H</span><span class="p">,</span> <span class="n">y_mass_fraction_He</span><span class="p">,</span>
                          <span class="n">frac_HII</span><span class="p">,</span> <span class="n">frac_HeII</span><span class="p">,</span> <span class="n">frac_HeIII</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the recombination energy per shell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_mass_fraction_H : array</span>
<span class="sd">        Mass fraction of H per shell</span>
<span class="sd">    y_mass_fraction_He : array</span>
<span class="sd">        Mass fraction of He per shell.</span>
<span class="sd">    frac_HII : array</span>
<span class="sd">        Fraction of single ionized H per shell.</span>
<span class="sd">    frac_HeII : array</span>
<span class="sd">        Fraction of single ionized He per shell.</span>
<span class="sd">    frac_HeIII : array</span>
<span class="sd">        Fraction of double ionized He per shell.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    recomb_energy : 1D numpy.arrays</span>
<span class="sd">        recombination energy per shell in ergs</span>
<span class="sd">        (same dimension as x_mass_fraction_H and y_mass_fraction_He)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">recomb_energy</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">54.4177650</span> <span class="o">*</span> <span class="n">frac_HeIII</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">He_weight</span>
        <span class="o">*</span> <span class="n">y_mass_fraction_He</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">avo</span>
        <span class="o">+</span> <span class="mf">24.587388</span> <span class="o">*</span> <span class="p">(</span><span class="n">frac_HeII</span> <span class="o">+</span> <span class="n">frac_HeIII</span><span class="p">)</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">He_weight</span>
        <span class="o">*</span> <span class="n">y_mass_fraction_He</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">avo</span>
        <span class="o">+</span> <span class="mf">13.598434</span> <span class="o">*</span> <span class="n">frac_HII</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">H_weight</span>
        <span class="o">*</span> <span class="n">x_mass_fraction_H</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">avo</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">recomb_energy</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2erg</span></div>



<div class="viewcode-block" id="calculate_binding_energy">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.calculate_binding_energy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_binding_energy</span><span class="p">(</span><span class="n">donor_mass</span><span class="p">,</span> <span class="n">donor_radius</span><span class="p">,</span> <span class="n">donor_dm</span><span class="p">,</span>
                             <span class="n">specific_internal_energy</span><span class="p">,</span>
                             <span class="n">ind_core</span><span class="p">,</span>
                             <span class="n">factor_internal_energy</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span>
                             <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the total binding energy of the envelope of the star.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    donor_mass : array</span>
<span class="sd">        Enclosed mass coordinate of the donor star from its profile.</span>
<span class="sd">    donor_radius : array</span>
<span class="sd">        Radius coordinate of the donor star from its profile.</span>
<span class="sd">    donor_dm : array</span>
<span class="sd">        Mass enclosed per shell in the donor star&#39;s profile.</span>
<span class="sd">    specific_internal_energy : array</span>
<span class="sd">        Specific internal energy of the donor star.</span>
<span class="sd">    ind_core : int</span>
<span class="sd">        The value of the shell position of the core - envelope boundary,</span>
<span class="sd">        at the donor&#39;s MESA profile</span>
<span class="sd">    factor_internal_energy : float</span>
<span class="sd">        The factor to multiply with internal energy to be taken into</span>
<span class="sd">        account when we calculate the  binding energy of the enevelope</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        In case we want information about the CEE  (the default is False).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Ebind_i : float</span>
<span class="sd">        The total binding energy of the envelope of the star</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sum of gravitational energy from surface to core boundary</span>
    <span class="n">Grav_energy</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Sum of internal energy from surface to core boundary. This is 0 if</span>
    <span class="c1"># &#39;lambda_from_profile_gravitational&#39; or (thermal+radiation+recombination)</span>
    <span class="c1"># for &quot;lambda_from_profile_gravitational_plus_internal&quot; or</span>
    <span class="c1"># (thermal+radiation) for</span>
    <span class="c1"># &quot;lambda_from_profile_gravitational_plus_internal_minus_recombination&quot;</span>
    <span class="n">U_i</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="c1"># sum from surface to the core. Your core boundary is in element [ind_core]</span>
    <span class="c1"># in a normal MESA (and POSYDON) profile</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind_core</span><span class="p">):</span>
        <span class="n">Grav_energy_of_cell</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="n">donor_mass</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                               <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span> <span class="o">*</span> <span class="n">donor_dm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
                               <span class="o">/</span> <span class="p">(</span><span class="n">donor_radius</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Rsun</span><span class="p">))</span>
        <span class="c1"># integral of gravitational energy as we go deeper into the star</span>
        <span class="n">Grav_energy</span> <span class="o">=</span> <span class="n">Grav_energy</span> <span class="o">+</span> <span class="n">Grav_energy_of_cell</span>
        <span class="n">U_i</span> <span class="o">=</span> <span class="n">U_i</span> <span class="o">+</span> <span class="n">specific_internal_energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">donor_dm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Msun</span>

    <span class="k">if</span> <span class="n">Grav_energy</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Grav_energy</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CEE problem calculating gravitational energy, &quot;</span>
                            <span class="s2">&quot;giving positive values.&quot;</span><span class="p">)</span>
        
    <span class="c1"># binding energy of the enevelope equals its gravitational energy +</span>
    <span class="c1"># an a_th fraction of its internal energy</span>
    <span class="n">Ebind_i</span> <span class="o">=</span> <span class="n">Grav_energy</span> <span class="o">+</span> <span class="n">factor_internal_energy</span> <span class="o">*</span> <span class="n">U_i</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Ebind_i</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">):</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;Ebind_i of the envelope is positive&quot;</span><span class="p">,</span> <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;integration of gravitational energy surface to core &quot;</span>
              <span class="s2">&quot;[Grav_energy], integration of internal energy surface to &quot;</span>
              <span class="s2">&quot;core [U_i] (0 if not taken into account) &quot;</span><span class="p">,</span> <span class="n">Grav_energy</span><span class="p">,</span> <span class="n">U_i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ebind = Grav_energy + factor_internal_energy*U_i  :  &quot;</span><span class="p">,</span> <span class="n">Ebind_i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Ebind_i</span></div>


<div class="viewcode-block" id="calculate_Mejected_for_integrated_binding_energy">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.calculate_Mejected_for_integrated_binding_energy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_Mejected_for_integrated_binding_energy</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">Ebind_threshold</span><span class="p">,</span>
                             <span class="n">mc1_i</span><span class="p">,</span> <span class="n">rc1_i</span><span class="p">,</span>
                             <span class="n">m1_i</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">radius1</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                             <span class="n">factor_internal_energy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span>
                             <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the mass lost from the envelope for an energy budget of Ebind_threshold</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile : numpy.array</span>
<span class="sd">        Donor&#39;s star profile from MESA</span>
<span class="sd">    Ebind_threshold : float</span>
<span class="sd">        Orbital energy used from the spiral in to partial unbind the envelope. Positive</span>
<span class="sd">        We integrate from surface to calcualte the partial loss of mass during CE that merges.</span>
<span class="sd">    factor_internal_energy : float</span>
<span class="sd">        The factor to multiply with internal energy to be taken into</span>
<span class="sd">        account when we calculate the  binding energy of the enevelope</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        In case we want information about the CEE  (the default is False).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Ebind_i : float</span>
<span class="sd">        The total binding energy of the envelope of the star</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">donor_mass</span><span class="p">,</span> <span class="n">donor_radius</span><span class="p">,</span> <span class="n">donor_dm</span> <span class="o">=</span> <span class="n">get_mass_radius_dm_from_profile</span><span class="p">(</span>
        <span class="n">profile</span><span class="p">,</span> <span class="n">m1_i</span><span class="p">,</span> <span class="n">radius1</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>
    <span class="n">specific_internal_energy</span> <span class="o">=</span> <span class="n">get_internal_energy_from_profile</span><span class="p">(</span>
        <span class="n">common_envelope_option_for_lambda</span> <span class="o">=</span> <span class="s2">&quot;lambda_from_profile_gravitational_plus_internal_minus_recombination&quot;</span><span class="p">,</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="p">,</span> <span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span><span class="p">)</span>

    <span class="c1"># Sum of gravitational energy from surface towards inside</span>
    <span class="n">Grav_energy</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># Sum of internal energy from surface towards.</span>
    <span class="n">U_energy</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># sum from surface to the core. Your threshold is in element [ind_threshold]</span>
    <span class="c1"># in a normal MESA (and POSYDON) profile</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Ebind_so_far</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># the integration from surface going inwards of the binding energy (negative in principle)</span>

    <span class="k">while</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Ebind_so_far</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Ebind_threshold</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">donor_mass</span><span class="p">)):</span>
        <span class="n">Grav_energy_of_cell</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">const</span><span class="o">.</span><span class="n">standard_cgrav</span> <span class="o">*</span> <span class="n">donor_mass</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                               <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Msun</span> <span class="o">*</span> <span class="n">donor_dm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
                               <span class="o">/</span> <span class="p">(</span><span class="n">donor_radius</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Rsun</span><span class="p">))</span>
        <span class="c1"># integral of gravitational energy as we go deeper into the star</span>
        <span class="n">Grav_energy</span> <span class="o">=</span> <span class="n">Grav_energy</span> <span class="o">+</span> <span class="n">Grav_energy_of_cell</span>
        <span class="n">U_energy</span> <span class="o">=</span> <span class="n">U_energy</span> <span class="o">+</span> <span class="n">specific_internal_energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">donor_dm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">Msun</span>
        <span class="n">Ebind_so_far</span> <span class="o">=</span> <span class="n">Grav_energy</span> <span class="o">+</span> <span class="n">factor_internal_energy</span> <span class="o">*</span> <span class="n">U_energy</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">ind_threshold</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">donor_mass</span><span class="p">[</span><span class="n">ind_threshold</span><span class="p">]</span><span class="o">&lt;</span> <span class="n">mc1_i</span> <span class="ow">or</span>  <span class="n">donor_radius</span><span class="p">[</span><span class="n">ind_threshold</span><span class="p">]</span><span class="o">&lt;</span><span class="n">rc1_i</span><span class="p">:</span>
        <span class="n">Pwarn</span><span class="p">(</span><span class="s2">&quot;partial mass ejected is greater than the envelope mass&quot;</span><span class="p">,</span> <span class="s2">&quot;EvolutionWarning&quot;</span><span class="p">)</span>   
        <span class="n">mass_threshold</span> <span class="o">=</span> <span class="n">mc1_i</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mass_threshold</span> <span class="o">=</span> <span class="n">donor_mass</span><span class="p">[</span><span class="n">ind_threshold</span><span class="p">]</span>

    <span class="n">M_ejected</span> <span class="o">=</span> <span class="n">donor_mass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mass_threshold</span>

    <span class="k">return</span> <span class="n">M_ejected</span></div>


<div class="viewcode-block" id="convert_metallicity_to_string">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.convert_metallicity_to_string">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_metallicity_to_string</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if metallicity is supported by POSYDON v2.&quot;&quot;&quot;</span>
    <span class="c1"># check supported metallicity</span>
    <span class="n">valid_Z</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2e+00</span><span class="p">,</span><span class="mf">1e+00</span><span class="p">,</span><span class="mf">4.5e-01</span><span class="p">,</span><span class="mf">2e-01</span><span class="p">,</span><span class="mf">1e-01</span><span class="p">,</span><span class="mf">1e-02</span><span class="p">,</span><span class="mf">1e-03</span><span class="p">,</span><span class="mf">1e-04</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Z</span> <span class="ow">in</span> <span class="n">valid_Z</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Metallicity </span><span class="si">{</span><span class="n">Z</span><span class="si">}</span><span class="s1"> not supported! Available metallicities in POSYDON v2 are </span><span class="si">{</span><span class="n">valid_Z</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Z</span><span class="si">:</span><span class="s1">1.1e</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="rotate">
<a class="viewcode-back" href="../../../api_reference/posydon.utils.html#posydon.utils.common_functions.rotate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rotate</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate rotation matrix to rotate a vector about an arbitrary axis by</span>
<span class="sd">        a given angle</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axis : array of length 3</span>
<span class="sd">        Axis to rotate about</span>
<span class="sd">    angle : float</span>
<span class="sd">        Angle, in radians, through which to rotate about axis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rotation_matrix : 3x3 array</span>
<span class="sd">        Array such that rotation_matrix.dot(vector) rotates vector</span>
<span class="sd">        about the given axis by the given angle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axis should be of dimension 3&quot;</span><span class="p">)</span>
    <span class="c1"># normalize the axis vector</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axis is a point&quot;</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span> <span class="o">/</span> <span class="n">norm</span>
        
    <span class="c1"># calculate the cosine and sine of the angle</span>
    <span class="n">cos_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">sin_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

    <span class="c1"># construct the rotation matrix</span>
    <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">cos_theta</span> <span class="o">+</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">),</span>
            <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_theta</span><span class="p">,</span>
            <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_theta</span><span class="p">],</span>
            <span class="p">[</span><span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_theta</span><span class="p">,</span>
            <span class="n">cos_theta</span> <span class="o">+</span> <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">),</span>
            <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_theta</span><span class="p">],</span>
            <span class="p">[</span><span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_theta</span><span class="p">,</span>
            <span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_theta</span><span class="p">,</span>
            <span class="n">cos_theta</span> <span class="o">+</span> <span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)]</span>
        <span class="p">])</span>

    <span class="k">return</span> <span class="n">rotation_matrix</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Tassos Fragos.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      Version: 2.0.2
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        
        <dl>
            <dt> v2</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v2.0.6/index.html">2.0</a></dd>
            
            <dd><a href="https://posydon.org/POSYDON/v2.1.4/index.html">2.1</a></dd>
            
        </dl>
        
        <dl>
            <dt> v1</dt>
            
            <dd><a href="https://posydon.org/POSYDON/v1.0.5/index.html">1.0</a></dd>
            
        </dl>
        
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>